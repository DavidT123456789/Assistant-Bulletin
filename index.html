<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimestre en Main - L'assistant IA pour vos bulletins</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        /* CSS non modifié, il est donc omis pour la lisibilité */
        :root {
            --bg-color: #f8fafc;
            --text-color: #334155;
            --header-bg-start: #4f46e5;
            --header-bg-end: #7c3aed;
            --section-bg: white;
            --section-shadow: rgba(0,0,0,0.07);
            --border-color: #e2e8f0;
            --label-color: #475569;
            --input-border: #cbd5e0;
            --input-focus: #6366f1;
            --appreciation-bg: #f0fdf4;
            --appreciation-border: #22c55e;
            --appreciation-text-color: #374151;
            --student-name-color: #1e293b;
            --summary-details-color: #64748b;
            --button-primary-start: #6366f1;
            --button-primary-end: #8b5cf6;
            --button-secondary-start: #64748b;
            --button-secondary-end: #475569;
            --button-danger: #ef4444;
            --button-warning-start: #f59e0b;
            --button-warning-end: #f97316;
            --modal-bg: #ffffff;
            --modal-overlay: rgba(0,0,0,0.5);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --progress-bg: #e5e7eb;
            --progress-fill: #6366f1;

            --evolution-very-positive-bg: rgba(5, 150, 105, 0.15);
            --evolution-very-positive-text: #047857;
            --evolution-positive-bg: rgba(16, 185, 129, 0.15);
            --evolution-positive-text: #059669;
            --evolution-stable-bg: rgba(100, 116, 139, 0.15);
            --evolution-stable-text: #475569;
            --evolution-negative-bg: rgba(245, 158, 11, 0.15);
            --evolution-negative-text: #d97706;
            --evolution-very-negative-bg: rgba(239, 68, 68, 0.15);
            --evolution-very-negative-text: #dc2626;

            --animated-bg-color1: #f0f4f8;
            --animated-bg-color2: #e6eaf0;

            --notification-success-bg: rgba(16, 185, 129, 0.8);
            --notification-error-bg: rgba(239, 68, 68, 0.8);
            --notification-warning-bg: rgba(245, 158, 11, 0.8);
            --notification-info-bg: rgba(230, 230, 250, 0.9);

            --stat-total-bg: rgba(99, 102, 241, 0.1);
            --stat-total-border: #6366f1;
            --stat-average-bg: rgba(6, 182, 212, 0.1);
            --stat-average-border: #06b6d4;
            --stat-progress-bg: rgba(16, 185, 129, 0.1);
            --stat-progress-border: #10b981;
            --stat-stable-bg: rgba(100, 116, 139, 0.1);
            --stat-stable-border: #64748b;
            --stat-regression-bg: rgba(239, 68, 68, 0.1);
            --stat-regression-border: #ef4444;
            --stat-words-bg: rgba(251, 191, 36, 0.1);
            --stat-words-border: #facc15;

            --statut-bg: #e0f2fe;
            --statut-text: #0284c7;

            --header-pill-bg: rgba(0, 0, 0, 0.2);
            --header-pill-active-bg: #fff;
            --header-pill-active-text: #4f46e5;
            --header-glass-bg: rgba(255, 255, 255, 0.1);
            --header-glass-border: rgba(255, 255, 255, 0.15);
            
            --tag-pill-bg: rgba(99, 102, 241, 0.1);
            --tag-pill-text: #4f46e5;
            --tag-pill-custom-bg: rgba(168, 85, 247, 0.1);
            --tag-pill-custom-text: #9333ea;
            --tag-pill-evolution-bg: rgba(22, 163, 74, 0.1);
            --tag-pill-evolution-text: #15803d;

            --ai-glow-color: rgba(139, 92, 246, 0.6);
            --ai-border-color: #a855f7;
        }

        [data-theme="dark"] {
            --bg-color: #0b1120;
            --text-color: #e2e8f0;
            --header-bg-start: #24224b;
            --header-bg-end: #1a1936;
            --section-bg: #161f32;
            --section-shadow: rgba(0,0,0,0.3);
            --border-color: #2d3748;
            --label-color: #cbd5e0;
            --input-border: #4a5568;
            --appreciation-bg: #1a233a;
            --appreciation-border: #059669;
            --appreciation-text-color: #e5e7eb;
            --student-name-color: #f1f5f9;
            --summary-details-color: #a0aec0;
            --modal-bg: #161f32;
            --progress-bg: #2d3748;
            --button-warning-start: #d97706;
            --button-warning-end: #c2410c;

            --evolution-very-positive-bg: rgba(6, 182, 212, 0.15);
            --evolution-very-positive-text: #22d3ee;
            --evolution-positive-bg: rgba(5, 150, 105, 0.15);
            --evolution-positive-text: #10b981;
            --evolution-stable-bg: rgba(100, 116, 139, 0.15);
            --evolution-stable-text: #94a3b8;
            --evolution-negative-bg: rgba(251, 191, 36, 0.15);
            --evolution-negative-text: #facc15;
            --evolution-very-negative-bg: rgba(239, 68, 68, 0.15);
            --evolution-very-negative-text: #f87171;

            --animated-bg-color1: #111827;
            --animated-bg-color2: #0f172a;

            --notification-success-bg: rgba(5, 150, 105, 0.8);
            --notification-error-bg: rgba(239, 68, 68, 0.8);
            --notification-warning-bg: rgba(251, 191, 36, 0.8);
            --notification-info-bg: rgba(55, 65, 81, 0.9);

            --stat-total-bg: rgba(99, 102, 241, 0.15);
            --stat-average-bg: rgba(6, 182, 212, 0.15);
            --stat-progress-bg: rgba(16, 185, 129, 0.15);
            --stat-stable-bg: rgba(100, 116, 139, 0.15);
            --stat-regression-bg: rgba(239, 68, 68, 0.15);
            --stat-words-bg: rgba(251, 191, 36, 0.15);

            --statut-bg: #075985;
            --statut-text: #7dd3fc;
            
            --header-pill-bg: rgba(0, 0, 0, 0.2);
            --header-pill-active-bg: #6366f1;
            --header-pill-active-text: #fff;
            --header-glass-bg: rgba(255, 255, 255, 0.08);
            --header-glass-border: rgba(255, 255, 255, 0.1);

            --tag-pill-bg: rgba(99, 102, 241, 0.2);
            --tag-pill-text: #a5b4fc;
            --tag-pill-custom-bg: rgba(168, 85, 247, 0.2);
            --tag-pill-custom-text: #d8b4fe;
            --tag-pill-evolution-bg: rgba(22, 163, 74, 0.2);
            --tag-pill-evolution-text: #86efac;

            --ai-glow-color: rgba(167, 139, 250, 0.5);
            --ai-border-color: #a855f7;
        }

        html { scroll-behavior: smooth; }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1400px; margin: 0 auto; padding: 20px;
            background: linear-gradient(135deg, var(--animated-bg-color1) 0%, var(--animated-bg-color2) 100%);
            background-size: 200% 200%; color: var(--text-color); line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; position: relative;
        }
        body.modal-open {
            overflow: hidden;
        }
        hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 30px 0;
        }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--input-border); border-radius: 10px; border: 2px solid var(--bg-color); }
        ::-webkit-scrollbar-thumb:hover { background: var(--input-focus); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* Logo Styles */
        .trimestre-logo {
            width: 54px; height: 54px; border-radius: 14px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            position: relative; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease; cursor: pointer; flex-shrink: 0;
        }
        .trimestre-logo:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        .trimestre-document {
            position: absolute; top: 10px; left: 10px; width: 25px; height: 32px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1.5px solid #6366f1; border-radius: 4px;
            box-shadow: 0 3px 12px rgba(99, 102, 241, 0.2);
        }
        .trimestre-document::before {
            content: ''; position: absolute; top: 6px; left: 5px; width: 13px; height: 1.5px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 1px;
        }
        .trimestre-document::after {
            content: ''; position: absolute; top: 10px; left: 5px; width: 10px; height: 1.5px;
            background: #cbd5e1; border-radius: 1px;
        }
        .trimestre-ai-hand {
            position: absolute; bottom: 8px; right: 8px; width: 18px; height: 14px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899); border-radius: 9px 9px 2px 2px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.25);
        }
        .trimestre-stars { position: absolute; top: 5px; right: 5px; width: 17px; height: 15px; }
        .trimestre-star1, .trimestre-star2, .trimestre-star3 { position: absolute; animation: trimestre-twinkle 3s ease-in-out infinite; }
        .trimestre-star1 { top: 0; left: 5px; font-size: 8px; color: #fbbf24; }
        .trimestre-star2 { top: 6px; right: 0; font-size: 6px; color: #8b5cf6; animation-delay: 1s; }
        .trimestre-star3 { bottom: 0; left: 0; font-size: 7px; color: #ec4899; animation-delay: 2s; }
        @keyframes trimestre-twinkle {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .header {
            background: linear-gradient(120deg, var(--header-bg-start) 0%, var(--header-bg-end) 100%);
            color: white; padding: 25px 30px; border-radius: 20px;
            text-align: center; margin-bottom: 30px;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; gap: 20px;
            transition: box-shadow 0.5s ease-in-out;
        }

        /* Styles pour l'en-tête en mode IA Premium */
        .header::before {
            content: '';
            position: absolute;
            top: 0; left: -150%;
            width: 40%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            z-index: 0;
        }
        .header.ai-active::before {
            opacity: 1;
            animation: header-shine 2.5s ease-out 1; /* Animation unique */
        }
        @keyframes header-shine {
            from { left: -100%; }
            to { left: 150%; }
        }
        .header.ai-active {
            box-shadow: 0 10px 40px -10px var(--ai-glow-color), 0 0 0 2px var(--ai-glow-color);
        }
        
        .header-top-row {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }

        .header h1 {
            margin: 0; font-size: 2.2em; font-weight: 700;
            display: flex; flex-direction:column; justify-content: center; align-items: center; gap: 5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            flex-grow: 1;
        }
        .header h1 .main-title {
            display: flex; align-items: center; gap: 15px;
        }
        .header h1 .main-title-text { line-height: 1.1; }
        .header h1 small {
            font-size: 0.5em; font-weight: 400; opacity: 0.8; letter-spacing: 0.5px; margin-top: 5px;
        }

        .header-badges, .header-actions {
            flex-shrink: 0; display: flex; align-items: center; gap: 8px;
        }
        
        .badge {
            background: var(--header-glass-bg); color: white; padding: 8px 15px; border-radius: 50px;
            font-size: 0.9em; font-weight: 500; display: flex; align-items: center; gap: 8px;
            border: 1px solid var(--header-glass-border); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }

        #aiModeBadge {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            animation: ai-badge-pulse 2.5s infinite ease-in-out;
            border-color: rgba(255, 255, 255, 0.3);
        }

        @keyframes ai-badge-pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(236, 72, 153, 0.6);
            }
        }

        .icon-button {
            background: var(--header-glass-bg); border: 1px solid var(--header-glass-border);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border-radius: 12px; width: 40px; height: 40px; color: white; cursor: pointer;
            font-size: 1.1em; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; box-shadow: none;
        }
        .icon-button:hover {
            background: rgba(255, 255, 255, 0.2); transform: scale(1.05);
        }
        
        .header-selectors {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px; position: relative; z-index: 1;
        }

        .quarter-selector, .generation-mode-selector, .subject-filter {
            background: var(--header-pill-bg); border-radius: 50px; padding: 4px; height: 44px;
            display: flex; align-items: center; transition: all 0.3s ease;
        }
        
        .quarter-selector input[type="radio"],
        .generation-mode-selector input[type="radio"] { display: none; }
        
        .quarter-selector label,
        .generation-mode-selector label {
            display: flex; align-items: center; justify-content: center; height: 36px; padding: 0 18px;
            font-size: 0.9em; font-weight: 500; color: rgba(255, 255, 255, 0.85); border-radius: 30px;
            cursor: pointer; transition: all 0.25s ease-in-out; white-space: nowrap;
        }
        
        .quarter-selector label:hover,
        .generation-mode-selector label:hover {
             color: #fff; background-color: rgba(255, 255, 255, 0.05);
        }
        
        .quarter-selector input[type="radio"]:checked + label,
        .generation-mode-selector input[type="radio"]:checked + label {
            background-color: var(--header-pill-active-bg); color: var(--header-pill-active-text);
            font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        .subject-filter { position: relative; }

        .subject-filter select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background: transparent; border: none; height: 100%; padding: 0 35px 0 18px;
            font-size: 0.9em; font-weight: 500; color: rgba(255, 255, 255, 0.85);
            cursor: pointer; transition: color 0.25s ease-in-out;
        }
        .subject-filter select:focus { outline: none; }
        .subject-filter select:hover { color: #fff; }

        .subject-filter::after {
            content: '▼'; font-size: 0.65em; color: rgba(255, 255, 255, 0.8); pointer-events: none;
            position: absolute; right: 18px; top: 50%; transform: translateY(-50%);
        }
        .subject-filter select option { background-color: var(--header-bg-start); color: white; }

        .generation-mode-selector .info-icon { margin-left: 8px; color: inherit; }
        
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .input-section, .output-section { background: var(--section-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px var(--section-shadow); transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .input-section.fade-in { animation: fadeInScale 0.3s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .section-header { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 15px; padding-bottom: 0; border-bottom: none; position: relative; z-index: 1; }
        .section-title { color: var(--label-color); margin: 0; font-size: 1.8em; font-weight: 700; display: flex; align-items: center; gap: 12px; text-align: left; margin-bottom: 15px; width: 100%; border-bottom: 2px solid var(--border-color); padding-bottom: 15px;}
        .section-title > span:first-child { flex-grow: 1; display: flex; align-items: center; gap: 12px;}
        .section-title .icon { font-size: 1.2em; color: var(--input-focus); }
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 45px 12px 15px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 14px; background-color: var(--section-bg); color: var(--text-color); transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--input-focus); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--summary-details-color); font-size: 1.2em; }
        .controls-grid { display: grid; gap: 15px; margin-bottom: 20px; }
        .controls-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .controls-row .btn-danger { margin-left: auto; }
        .sort-control { display: flex; align-items: center; gap: 8px; }
        .sort-control label { margin-bottom: 0; font-size: 0.9em; font-weight: 500; }
        .btn { background: linear-gradient(135deg, var(--button-primary-start) 0%, var(--button-primary-end) 100%); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5); filter: brightness(1.1); }
        .btn:active:not(:disabled) { transform: translateY(0); box-shadow: 0 2px 10px rgba(0,0,0,0.1); filter: brightness(1.0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: linear-gradient(135deg, var(--button-secondary-start) 0%, var(--button-secondary-end) 100%); }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 10px 30px rgba(100, 116, 139, 0.5); }
        .btn-danger { background: var(--button-danger); }
        .btn-danger:hover:not(:disabled) { box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5); }
        .btn-warning { background: linear-gradient(135deg, var(--button-warning-start) 0%, var(--button-warning-end) 100%); }
        .btn-warning:hover:not(:disabled) { box-shadow: 0 10px 30px rgba(245, 158, 11, 0.5); }
        .btn.btn-ai {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }
        .btn.btn-ai:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.6);
            transform: translateY(-3px);
            filter: brightness(1.1);
        }
        .btn-small { padding: 8px 12px; font-size: 12px; }
        .btn-link {
            background: none;
            border: none;
            color: var(--input-focus);
            text-decoration: underline;
            padding: 0;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-link:hover { text-decoration: none; }
        .student-form, .import-section { margin-bottom: 25px; padding: 25px; border: 2px solid var(--border-color); border-radius: 12px; background-color: var(--bg-color); transition: all 0.3s ease; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-weight: 600; margin-bottom: 8px; color: var(--label-color); font-size: 14px; transition: color 0.3s ease; }
        .label-with-action { display: flex; justify-content: space-between; align-items: center; }
        .label-with-action button { padding: 2px 6px; font-size: 10px; line-height: 1; height: auto; }
        input, textarea, select { padding: 12px 15px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 14px; background-color: var(--section-bg); color: var(--text-color); transition: all 0.3s ease; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--input-focus); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); transform: translateY(-1px); }
        [data-theme="dark"] #refinementContext {
            background-color: var(--section-bg);
            color: var(--text-color);
            border-color: var(--input-border);
        }
        #appT1, #appT2 {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .input-error { border-color: var(--error-color) !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important; }
        .input-success { border-color: var(--success-color) !important; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important; }
        .error-message { color: var(--error-color); font-size: 12px; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        textarea { min-height: 80px; resize: vertical; }
        .mass-import-buttons, .single-student-form-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 20px; }
        .settings-modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }
        .appreciation-result { 
            background: var(--appreciation-bg); 
            border: 2px solid var(--appreciation-border); /* Default green border */
            border-radius: 12px; padding: 25px; margin-bottom: 20px; 
            transition: all 0.3s ease; position: relative; overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); opacity: 0; 
            transform: translateY(20px); 
            animation: slideInFadeIn 0.5s ease-out forwards; 
        }
        .appreciation-result.ai-generated { border-color: var(--ai-border-color); }
        .appreciation-result.has-error { border-color: var(--error-color); background: rgba(239, 68, 68, 0.05); }
        [data-theme="dark"] .appreciation-result.has-error { background: rgba(239, 68, 68, 0.1); }
        
        .appreciation-result:focus-within, .appreciation-result:focus { 
            outline: 2px solid var(--input-focus); 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); 
        }
        .appreciation-result.hidden { display: none; }
        .appreciation-result.is-editing {
            box-shadow: 0 0 0 4px var(--input-focus);
            transform: scale(1.01);
        }
        .appreciation-result:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        @keyframes slideInFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .appreciation-result.highlight { animation: highlightPulse 2s ease-out; }
        @keyframes highlightPulse { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .student-name { font-weight: 700; color: var(--student-name-color); font-size: 1.2em; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .student-grades-display { font-size: 0.75em; font-weight: 500; color: var(--summary-details-color); margin-left: 10px; }
        .student-summary-details { font-size: 13px; color: var(--summary-details-color); margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; }
        .detail-chip { background: rgba(99, 102, 241, 0.1); color: var(--input-focus); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        #currentQuarterDisplayInputSection { margin-left: auto; }
        .statut-chip { background: var(--statut-bg); color: var(--statut-text); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .appreciation-text { font-style: italic; line-height: 1.8; color: var(--appreciation-text-color); margin-bottom: 15px; text-align: justify; }
        .word-count { text-align: right; font-size: 13px; color: var(--summary-details-color); margin-bottom: 15px; font-weight: 500; }
        .evolution-indicator { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; gap: 5px; }
        .evolution-very-positive { background-color: var(--evolution-very-positive-bg); color: var(--evolution-very-positive-text); }
        .evolution-positive { background-color: var(--evolution-positive-bg); color: var(--evolution-positive-text); }
        .evolution-stable { background-color: var(--evolution-stable-bg); color: var(--evolution-stable-text); }
        .evolution-negative { background-color: rgba(245, 158, 11, 0.15); color: var(--evolution-negative-text); }
        .evolution-very-negative { background-color: rgba(239, 68, 68, 0.15); color: var(--evolution-very-negative-text); }
        .appreciation-actions { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .appreciation-actions-left { display: flex; gap: 10px; flex-wrap: wrap; }
        .copy-btn.copied { background: var(--success-color); color: white; }
        .copy-btn.was-copied {
            background: var(--bg-color);
            color: var(--success-color);
            border: 1px solid var(--success-color);
            cursor: default;
        }
        .copy-btn.was-copied:hover {
            transform: none;
            box-shadow: none;
            filter: none;
        }
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 8px; background-color: var(--progress-bg); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--progress-fill), var(--button-primary-end)); border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        .progress-text { text-align: center; margin-top: 8px; font-size: 14px; color: var(--summary-details-color); font-weight: 500; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--section-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px var(--section-shadow); }
        .stat-card.total-color { background-color: var(--stat-total-bg); border-color: var(--stat-total-border); }
        .stat-card.average-color { background-color: var(--stat-average-bg); border-color: var(--stat-average-border); }
        .stat-card.progress-color { background-color: var(--stat-progress-bg); border-color: var(--stat-progress-border); }
        .stat-card.stable-color { background-color: var(--stat-stable-bg); border-color: var(--stat-stable-border); }
        .stat-card.regression-color { background-color: var(--stat-regression-bg); border-color: var(--stat-regression-border); }
        .stat-card.words-color { background-color: var(--stat-words-bg); border-color: var(--stat-words-border); }
        .stat-number { font-size: 2em; font-weight: 700; color: var(--input-focus); margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: var(--summary-details-color); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; transition: color 0.2s ease; display: block; padding: 5px 0; }
        .stat-label:hover { color: var(--text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: var(--modal-overlay); align-items: center; justify-content: center; }
        #helpModal { z-index: 1001; } /* Ensure help is on top of welcome */
        .modal-content { background-color: var(--modal-bg); padding: 30px; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); animation: modalSlideIn 0.3s ease-out; border: 1px solid var(--border-color); position: relative; }
        .modal-content.slide-in-right { animation: slideInFromRight 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .modal-content.slide-in-left { animation: slideInFromLeft 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .modal-content p { text-align: left; }
        .modal-body .link-to-settings { color: var(--input-focus); text-decoration: underline; font-weight: 500; cursor: pointer; }
        .modal-body .link-to-settings:hover { text-decoration: none; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideInFromRight { from { opacity: 0.5; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInFromLeft { from { opacity: 0.5; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .modal-title { margin: 0; color: var(--label-color); font-size: 1.5em; font-weight: 600; text-align: left; flex-grow: 1; }
        .modal-title .student-name-in-title { color: var(--text-color); font-weight: 700; }
        .modal-title .statut-in-title { margin-left: 10px; font-size: 0.7em; vertical-align: middle; }
        .close-button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--summary-details-color); padding: 5px; border-radius: 5px; position: absolute; right: 15px; top: 15px; }
        .close-button:hover { color: var(--text-color); background: rgba(0,0,0,0.1); }
        #notification-container { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 2000; pointer-events: none; width: 300px; max-width: calc(100% - 40px); align-items: flex-end; }
        .notification { padding: 15px 20px; border-radius: 10px; color: white; font-weight: 500; transform: translateX(400px); transition: transform 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); border: 1px solid rgba(255, 255, 255, 0.2); pointer-events: auto; width: 100%; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--notification-success-bg); }
        .notification.error { background: var(--notification-error-bg); }
        .notification.warning { background: var(--notification-warning-bg); }
        .notification.info { background: var(--notification-info-bg); color: var(--text-color); border: 1px solid rgba(0, 0, 0, 0.1); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        [data-theme="dark"] .notification.info { background: var(--notification-info-bg); color: var(--text-color); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        
        .import-section h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* Welcome Modal Styles */
        #welcomeModal .modal-content { max-width: 650px; }
        .welcome-step { display: none; flex-direction: column; align-items: center; text-align: center; animation: fadeInScale 0.4s ease-out forwards; }
        .welcome-step.active { display: flex; }
        .welcome-icon { font-size: 4em; margin-bottom: 20px; color: var(--input-focus); }
        #welcomeModal .modal-body { padding-top: 0; }
        #welcomeModal h3 { color: var(--text-color); font-size: 1.4em; margin-bottom: 15px; }
        #welcomeModal p { font-size: 1em; text-align: center; line-height: 1.6; }
        .welcome-nav-container { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); width: 100%;}
        #welcome-dots { display: flex; gap: 8px; flex-grow: 1; justify-content: center; margin: 0 20px;}
        #welcome-dots .dot { width: 10px; height: 10px; background-color: var(--input-border); border-radius: 50%; transition: background-color 0.3s ease; }
        #welcome-dots .dot.active { background-color: var(--input-focus); }
        #welcome-finish-options { display: none; gap: 10px; }

        .comparison-table { width: 100%; margin-top: 20px; border-collapse: collapse; text-align: left; }
        .comparison-table th, .comparison-table td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); }
        .comparison-table th { color: var(--label-color); font-size: 0.9em; }
        .comparison-table td { font-size: 0.95em; }
        .comparison-table td:nth-child(2) { background-color: rgba(100, 116, 139, 0.05); }
        .comparison-table td:nth-child(3) { background-color: rgba(99, 102, 241, 0.05); }
        [data-theme="dark"] .comparison-table td:nth-child(2) { background-color: rgba(100, 116, 139, 0.1); }
        [data-theme="dark"] .comparison-table td:nth-child(3) { background-color: rgba(99, 102, 241, 0.1); }
        .api-key-input-group { position: relative; }
        .api-key-validation-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--summary-details-color); font-size: 1.1em; opacity: 0; transition: opacity 0.3s; }
        .api-key-validation-icon.visible { opacity: 1; }

        @media (max-width: 900px) { /* Adjusted breakpoint for better wrapping */
            .header {
                padding-left: 15px;
                padding-right: 15px;
            }
            .header-top-row {
                flex-direction: column;
                gap: 15px;
            }
            .header-badges { order: 1; }
            .header h1 { order: 2; font-size: 1.8em; }
            .header-actions { order: 3; }

            .header-selectors {
                flex-direction: column;
                gap: 10px;
                display: flex;
            }
            .quarter-selector,
            .generation-mode-selector,
            .subject-filter {
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .controls-row { flex-direction: column; align-items: flex-start; }
            .controls-row .btn-danger { margin-left: 0; margin-top: 10px; }
            .stats-container { grid-template-columns: repeat(2, 1fr); }
            .refinement-comparison { flex-direction: column; }
            .comparison-table { font-size: 0.8em; }
            .comparison-table th, .comparison-table td { padding: 8px; }
        }

        [data-quarter-mode="T1"] [data-quarter-field="T2"],
        [data-quarter-mode="T1"] [data-quarter-field="T3"] { display: none !important; }
        [data-quarter-mode="T2"] [data-quarter-field="T3"] { display: none !important; }
        [data-quarter-field] { display: none; } /* Hide by default */
        [data-quarter-mode="T1"] .quarter-input-group[data-quarter-field="T1"],
        [data-quarter-mode="T2"] .quarter-input-group[data-quarter-field="T2"],
        [data-quarter-mode="T3"] .quarter-input-group[data-quarter-field="T3"] { display: block; }
        [data-quarter-mode="T2"] .quarter-input-group[data-quarter-field="T1"],
        [data-quarter-mode="T3"] .quarter-input-group[data-quarter-field="T1"],
        [data-quarter-mode="T3"] .quarter-input-group[data-quarter-field="T2"] { display: block; }

        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 100000;
            font-weight: normal;
            min-width: 220px;
            max-width: 500px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }
        .tooltip:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Tooltip position fix for header selectors */
        .generation-mode-selector .info-icon.tooltip::after {
            bottom: auto; 
            top: 50%;
            left: calc(100% + 10px);
            transform: translateY(-50%) translateX(10px);
        }
        .generation-mode-selector .info-icon.tooltip:hover::after {
             transform: translateY(-50%) translateX(0);
        }


        #templatesTabContent h3 .info-icon {
            margin-left: auto;
        }
        #templatesTabContent h3 .info-icon.tooltip::after {
            bottom: auto;
            top: 50%;
            left: auto;
            right: calc(100% + 8px);
            transform: translateY(-50%);
            max-width: 300px;
        }
        #templatesTabContent h3 .info-icon.tooltip:hover::after {
            transform: translateY(-50%);
        }

        .input-mode-tabs { display: flex; margin-top: 15px; border-bottom: 2px solid var(--border-color); width: 100%; }
        .input-mode-tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: var(--summary-details-color); transition: all 0.3s ease; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .input-mode-tab:hover { color: var(--text-color); }
        .input-mode-tab.active { color: var(--input-focus); border-bottom: 2px solid var(--input-focus); }
        .tab-content { padding-top: 10px; }
        
        .refinement-options { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding-top: 10px; }
        .refinement-options .options-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; width: 100%; }
        .refinement-options .options-group button {
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
            font-weight: 500;
        }
        .refinement-options .options-group button:hover:not(:disabled) {
            border-color: var(--input-focus);
            color: var(--input-focus);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .refinement-options .options-group button.active {
            background-color: var(--input-focus);
            border-color: var(--input-focus);
            color: white;
            font-weight: 600;
        }

        .refinement-comparison { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; align-items: center; }
        .refinement-comparison > div { flex: 1; min-width: 300px; }
        .refinement-swap-btn {
            background: none; border: 1px solid var(--border-color);
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.2em; color: var(--label-color);
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .refinement-swap-btn:hover {
            transform: rotate(180deg) scale(1.1);
            background-color: var(--bg-color);
            color: var(--input-focus);
            border-color: var(--input-focus);
        }
        .refinement-box { background: var(--appreciation-bg); border: 1px solid var(--appreciation-border); border-radius: 10px; padding: 15px; min-height: 120px; color: var(--appreciation-text-color); white-space: pre-wrap; margin-bottom: 10px; text-align: justify; position: relative; }
        .refinement-box.placeholder { color: var(--summary-details-color); font-style: italic; text-align: center; display: flex; align-items: center; justify-content: center;}
        .refinement-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refinement-box-header h4 { margin: 0; color: var(--label-color); font-size: 1.1em; font-weight: bold; }
        .refinement-box-copy-btn {
            background: none; border: none; font-size: 1.1em; color: var(--summary-details-color);
            cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; padding: 5px; border-radius: 5px;
        }
        .refinement-box-copy-btn:hover { color: var(--text-color); transform: scale(1.1); }
        .refinement-box.editable {
            background: var(--section-bg);
            border-color: var(--input-focus);
            cursor: text;
        }
        .refinement-box.editable:focus-within {
             box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .refinement-header-details {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .refinement-info-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .refinement-info-group.right {
            justify-content: flex-end;
        }
        .refinement-grades {
            font-weight: 500;
            color: var(--summary-details-color);
        }
        .evolution-indicator.icon-only {
            display: inline-grid;
            place-items: center;
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 1em;
        }
        .refinement-header-details .student-summary-details {
            gap: 8px 15px;
            margin-bottom: 0;
            align-items: center;
        }

        .refinement-actions-bottom { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        
        .next-steps-section, .strengths-weaknesses-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid var(--border-color);
        }
        .next-steps-section h3, .strengths-weaknesses-section h3 { color: var(--label-color); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .next-steps-list { list-style: none; padding: 0; min-height: 40px; display: flex; flex-direction: column; }
        .next-steps-list li { background: rgba(99, 102, 241, 0.05); border-left: 4px solid var(--input-focus); padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; color: var(--text-color); font-size: 0.95em; text-align: left; }
        
        .strengths-weaknesses-list { list-style: none; padding: 0; min-height: 80px; display: flex; flex-direction: column;}
        .strengths-weaknesses-list ul { list-style: none; margin-left: 0; padding-left: 0; margin-bottom: 15px; }
        .strengths-weaknesses-list h4 { display: flex; align-items: center; gap: 8px; margin-top: 15px; margin-bottom: 10px; font-size: 1.1em; font-weight: 700; }
        .strengths-weaknesses-list .strengths-title { color: var(--success-color); }
        .strengths-weaknesses-list .weaknesses-title { color: var(--error-color); }
        .strengths-weaknesses-list li { padding: 8px 12px; margin-bottom: 6px; border-radius: 6px; color: var(--text-color); font-size: 0.95em; text-align: left; }
        .strengths-weaknesses-list .strengths-list li { background: rgba(16, 185, 129, 0.05); border-left: 3px solid var(--success-color); }
        .strengths-weaknesses-list .weaknesses-list li { background: rgba(239, 68, 68, 0.05); border-left: 3px solid var(--error-color); }

        .settings-tab-container {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            width: 100%;
            flex-wrap: wrap;
        }
        .settings-tab {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--summary-details-color);
            transition: all 0.3s ease;
            margin-bottom: -2px;
            flex: 1;
            text-align: center;
            white-space: normal;
            position: relative;
        }
        .settings-tab:hover {
            color: var(--text-color);
            background-color: rgba(0,0,0,0.03);
        }
        [data-theme="dark"] .settings-tab:hover {
            background-color: rgba(255,255,255,0.03);
        }
        .settings-tab.active {
            color: var(--input-focus);
            font-weight: 700;
            border-bottom-color: var(--input-focus);
            background-color: transparent;
        }

        .tab-content h3 { margin-top: 25px; margin-bottom: 15px; color: var(--label-color); font-size: 1.3em; font-weight: 700; display: flex; align-items: center; gap: 8px; border-top: 1px solid var(--border-color); padding-top: 25px;}
        .tab-content h3:first-of-type { margin-top: 15px; border-top: none; padding-top: 0; }
        .template-group {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--section-bg);
        }
        .template-group h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--label-color);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: none;
            padding-top: 0;
        }
        .tab-content small { color: var(--summary-details-color); font-size: 0.85em; display: block; margin-top: 5px; }
        .tab-content label { color: var(--text-color); font-weight: 600; font-size: 1em; }
        .tab-content .label-with-icon { display: flex; align-items: center; gap: 8px; }
        .tab-content .label-with-icon .fa-arrow-trend-up { color: var(--success-color); }
        .tab-content .label-with-icon .fa-arrow-trend-down { color: var(--warning-color); }

        #optionsTabContent .form-group, #templatesTabContent .form-group { margin-bottom: 15px; }
        #optionsTabContent .form-group:last-of-type { margin-bottom: 0; }
        #vocabulaireSection .form-group {
            margin-bottom: 25px;
        }
        
        /* Details modal new layout */
        .details-quarters-container + hr {
            margin: 25px 0;
        }
        .details-quarters-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .details-quarter-block {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            background-color: var(--bg-color);
        }
        .details-quarter-block h4 {
            margin: 0 0 15px 0;
            color: var(--label-color);
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .details-quarter-block h4 .grade-display {
            font-size: 0.8em;
            font-weight: 500;
            color: var(--text-color);
        }

        .details-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .details-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .details-content-inner { padding: 0 15px 15px 15px; color: var(--appreciation-text-color); font-style: italic; line-height: 1.6; }
        .ai-model-info { display: flex; align-items: center; gap: 8px; margin-top: 20px; font-size: 0.9em; color: var(--summary-details-color); }
        .ai-model-info .tooltip::after { bottom: 150%; }
        .details-inline-group, .form-group-inline { display: flex; align-items: baseline; gap: 10px; margin-bottom: 8px; }
        .details-inline-group label, .form-group-inline label { margin-bottom: 0; white-space: nowrap; flex-shrink: 0; }
        .details-inline-group p, .form-group-inline p { margin: 0; font-weight: 600; color: var(--text-color); flex-grow: 1; text-align: left; }
        .details-inline-group p.statut-chip { flex-grow: 0; }
        .appreciation-text-display { font-style: italic; line-height: 1.6; color: var(--appreciation-text-color); background-color: var(--appreciation-bg); border: 1px solid var(--appreciation-border); border-radius: 8px; padding: 12px 15px; margin-top: 8px; white-space: pre-wrap; text-align: justify; }
        .loading-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: 10px; display: flex; align-items: center; gap: 12px; font-size: 16px; z-index: 1000; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); display: none; min-width: 200px; justify-content: center; }
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .help-list { list-style: none; padding: 0; margin: 0; }
        .help-list li { margin-bottom: 8px; color: var(--text-color); font-size: 0.95em; text-align: left; }
        .help-code-block { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap; word-break: break-all; margin-top: 10px; text-align: left !important; }
        
        .pwa-install-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--section-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 20px; z-index: 1500; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .pwa-install-banner.show { opacity: 1; visibility: visible; }
        .pwa-install-banner p { margin: 0; color: var(--text-color); font-size: 1em; }
        .pwa-install-banner .actions { display: flex; gap: 10px; }
        .pwa-install-banner .btn { padding: 8px 15px; font-size: 0.9em; }
        .drop-zone { border: 2px dashed var(--input-border); border-radius: 10px; padding: 20px; text-align: center; color: var(--summary-details-color); font-size: 1.1em; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease; background-color: var(--bg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .drop-zone.highlight { background-color: rgba(99, 102, 241, 0.1); border-color: var(--input-focus); color: var(--input-focus); }
        .drop-zone p { margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em; }
        .drop-zone .icon { font-size: 1.5em; }
        .btn-import-file { background: var(--button-secondary-start); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-import-file:hover { background: var(--button-secondary-end); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .ai-icon {
            display: inline-block;
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            opacity: 0;
            transform: scale(0.5);
        }
        .ai-icon.active {
            opacity: 1;
            transform: scale(1);
        }
        .generic-api-key-group { /* Styles for new API key groups */ }

        /* Vocabulary management list */
        #vocabulaireSection .options-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .vocab-list-container {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--bg-color);
            margin-top: 15px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }
        .vocab-list-container.disabled {
            background-color: var(--bg-color);
            opacity: 0.6;
            pointer-events: none;
        }
        .vocab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-color);
        }
        .vocab-item:last-child {
            border-bottom: none;
        }
        .vocab-item-text {
            flex-grow: 1;
            margin-right: 10px;
            text-align: left;
        }
        .vocab-item-actions button {
            background: none;
            border: none;
            color: var(--summary-details-color);
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 8px;
            transition: color 0.2s ease;
        }
        .vocab-item-actions button:hover {
            color: var(--input-focus);
        }
        .vocab-add-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .vocab-add-form.disabled {
             pointer-events: none;
        }
        .vocab-add-form.disabled input, .vocab-add-form.disabled button {
            background-color: var(--summary-details-color);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .vocab-add-form input {
            flex-grow: 1;
        }

        /* Preview section in single student form */
        #singleAppreciationPreview {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed var(--input-focus);
            border-radius: 10px;
            background-color: rgba(99, 102, 241, 0.05);
            color: var(--summary-details-color);
            min-height: 50px;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            text-align: center;
            font-style: italic;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #singleAppreciationPreview.show {
            display: flex;
            animation: fadeInScale 0.4s ease-out;
        }
        #singleAppreciationPreview.has-content {
            color: var(--text-color);
            text-align: justify;
            justify-content: flex-start;
        }

        .template-conditional-info {
            background-color: transparent;
            border: none;
            margin-bottom: 20px;
        }
        .template-conditional-info summary {
            font-weight: 600;
            color: var(--label-color);
            padding: 12px 15px;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .template-conditional-info summary > b {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .template-conditional-info .info-icon {
            margin-left: 10px;
            color: var(--summary-details-color);
        }
        .template-conditional-info .details-content {
            padding: 15px;
            margin-top: -1px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            background-color: var(--section-bg);
        }
        .template-conditional-info p {
            margin: 0 0 8px 0;
            line-height: 1.5;
            text-align: left;
        }
        .template-conditional-info p:last-child {
            margin-bottom: 0;
        }
        .template-conditional-info code {
            background-color: var(--bg-color);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            border: 1px solid var(--border-color);
        }
        
        /* Accordion for help/template section */
        details {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-color);
            transition: background-color 0.2s;
        }
        details.settings-accordion {
            background-color: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        details.settings-accordion[open] {
            background-color: var(--section-bg);
        }
        details.settings-accordion > summary {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--label-color);
            padding: 15px 20px;
            cursor: pointer;
        }
        details.settings-accordion .details-content {
             padding: 0 20px 20px 20px;
        }
        details[open] {
            background-color: var(--section-bg);
        }
        summary {
            font-weight: 600;
            color: var(--label-color);
            padding: 12px 15px;
            cursor: pointer;
            list-style: none; /* Hide default arrow */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary:hover {
            background-color: rgba(0,0,0,0.02);
        }
        [data-theme="dark"] summary:hover {
             background-color: rgba(255,255,255,0.03);
        }
        summary::-webkit-details-marker { display: none; } /* Hide default arrow in Chrome/Safari */
        summary::after {
            content: '▶';
            transition: transform 0.2s;
            font-size: 0.8em;
        }
        details[open] > summary::after {
            transform: rotate(90deg);
        }
        .details-content {
            padding: 0 15px 15px 15px;
        }

        /* Subject management */
        #subjectManagementContainer {
             border: 1px solid var(--border-color);
             border-radius: 10px;
             max-height: 250px;
             overflow-y: auto;
             margin-bottom: 15px;
        }
        .subject-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }
        .subject-list-item:last-child { border-bottom: none; }
        .subject-list-item:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }
        .subject-list-item.active {
            background-color: rgba(99, 102, 241, 0.1);
            font-weight: 700;
            color: var(--input-focus);
        }
        .subject-delete-btn {
            background: none;
            border: none;
            color: var(--summary-details-color);
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
            transition: color 0.2s ease;
        }
        .subject-delete-btn:hover {
            color: var(--error-color);
        }
        
        /* Tag helpers */
        .tag-helper-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 8px;
        }
        .tag-pill {
            background-color: var(--tag-pill-bg);
            color: var(--tag-pill-text);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative; /* For tooltip */
        }
        .tag-pill:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }
        .tag-pill.disabled {
            background-color: var(--summary-details-color);
            color: var(--bg-color);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .tag-pill.disabled:hover {
            filter: none;
            transform: none;
        }
        .tag-pill.custom {
            background-color: var(--tag-pill-custom-bg);
            color: var(--tag-pill-custom-text);
        }
        .tag-pill.evolution {
            background-color: var(--tag-pill-evolution-bg);
            color: var(--tag-pill-evolution-text);
        }
        .tag-helper-details > summary {
            padding: 8px 12px;
            font-size: 0.9em;
        }
        .tag-pill.tooltip::after {
             bottom: calc(100% + 5px);
             font-size: 11px;
             padding: 6px 10px;
             max-width: 250px;
             white-space: normal;
             text-align: left;
             line-height: 1.4;
             z-index: 10001;
        }
        
        /* Empty state card */
        #empty-state-card {
            text-align: center;
            padding: 40px 20px;
            margin-top: 20px;
            background-color: var(--bg-color);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            color: var(--summary-details-color);
        }
        #empty-state-card .icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: var(--input-focus);
        }
        #empty-state-card h3 {
            color: var(--text-color);
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        /* Styles pour la modale d'aide améliorée */
        .help-section {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0;
            margin-bottom: 0;
        }
        .help-section:last-of-type {
            border-bottom: none;
        }
        .help-section summary {
            padding: 15px 0;
            transition: background-color 0.2s;
            border-radius: 6px;
        }
        .help-section summary h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            font-size: 1.1em;
        }
        .help-section .details-content {
            padding: 0 15px 20px 15px;
            border-left: 3px solid var(--border-color);
            margin: 0 5px 10px 5px;
        }
        .help-section .details-content ol {
            padding-left: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .help-section .details-content ol li {
            margin-bottom: 10px;
            text-align: left;
        }
        .help-section .details-content p {
            display: inline;
        }
        .help-action-button {
            margin-left: 5px;
        }
        #helpLoadSampleBtn {
            padding: 6px 12px;
            font-size: 1em;
        }
        .details-content-inner { /* Pour les accordéons imbriqués */
            padding: 10px 0 0 0;
        }

        /* Styles pour le sélecteur de format dans l'aide */
        .help-format-selector {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 4px;
            display: inline-flex;
            margin-top: 10px;
            border: 1px solid var(--border-color);
        }
        .help-format-selector button {
            background: none;
            border: none;
            padding: 6px 12px;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--summary-details-color);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .help-format-selector button.active {
            background-color: var(--input-focus);
            color: white;
            font-weight: 600;
        }
        
        /* Styles pour l'éditeur de template amélioré */
        .template-editor {
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 14px;
            background-color: var(--section-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-family: inherit;
            min-height: 80px;
            line-height: 1.8;
        }
        .template-editor[contenteditable="false"] {
            opacity: 0.6;
            background-color: var(--summary-details-color);
            cursor: not-allowed;
        }
        .template-editor:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }
        .editor-tag {
            display: inline-block;
            background-color: var(--tag-pill-bg);
            color: var(--tag-pill-text);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            margin: 0 2px;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
            position: relative;
            cursor: pointer;
        }
        
        .editor-tag:active {
            cursor: grabbing;
        }
        .editor-tag .delete-tag {
            display: none;
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            font-size: 10px;
            cursor: pointer;
        }
        .template-editor[contenteditable="true"] .editor-tag:hover .delete-tag {
            display: block;
        }

        /* Styles pour la navigation dans la modale détails */
        .modal-nav {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-left: auto;
        }
        .modal-nav-btn {
            background: none;
            border: none;
            color: var(--summary-details-color);
            cursor: pointer;
            font-size: 1.5em;
            transition: color 0.2s ease;
        }
        .modal-nav-btn:hover:not(:disabled) {
            color: var(--text-color);
        }
        .modal-nav-btn:disabled {
            color: var(--border-color);
            cursor: not-allowed;
        }

        /* Styles pour la grille d'options compacte */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .options-grid .form-group {
            margin-bottom: 0;
        }
        .form-group-inline {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 10px;
        }
        .form-group-inline label {
            white-space: nowrap;
        }
        .form-group-inline p {
            margin: 0;
            font-weight: 500;
        }
        .template-preview-details {
            margin-top: 15px;
            border: 1px dashed var(--border-color);
            background-color: transparent;
        }
        .template-preview-details summary {
            font-size: 0.9em;
            font-weight: 500;
            padding: 8px 12px;
        }
        .template-preview-details .details-content {
            padding: 0;
        }

        /* Styles pour la saisie individuelle améliorée */
        .quarter-input-group {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: var(--section-bg);
        }
        .quarter-input-group h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--label-color);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #singleStudentFormDiv hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 25px 0;
        }

        #actions-irreversibles-container {
            margin-top: 25px;
        }
        
        .analysis-loading-state {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--summary-details-color);
            font-style: italic;
        }

        /* Back to top button */
        #backToTopBtn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        #backToTopBtn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top-row">
            <div class="header-badges">
                <div id="aiModeBadge" class="badge ai-mode-badge" style="display: none;" title="Le mode de génération par Intelligence Artificielle est actif.">
                    <span>✨ IA+</span>
                </div>
            </div>
            <h1>
                <div class="main-title">
                     <div class="trimestre-logo">
                        <div class="trimestre-document"></div>
                        <div class="trimestre-ai-hand"></div>
                        <div class="trimestre-stars">
                            <div class="trimestre-star1">★</div>
                            <div class="trimestre-star2">✦</div>
                            <div class="trimestre-star3">✨</div>
                        </div>
                    </div>
                    <span class="main-title-text">Trimestre en Main</span>
                </div>
                <small>L'assistant IA pour vos bulletins</small>
            </h1>
            <div class="header-actions">
                <button id="helpButton" class="icon-button" title="Aide et astuces">❓</button>
                <button id="darkModeToggle" class="icon-button" title="Changer de thème">🌓</button>
                <button class="icon-button" id="settingsButton" title="Paramètres">⚙️</button>
            </div>
        </div>
        <div class="header-selectors">
            <div class="quarter-selector">
                <input type="radio" id="quarterT1" name="quarterModeRadio" value="T1">
                <label for="quarterT1">Trimestre 1</label>
                <input type="radio" id="quarterT2" name="quarterModeRadio" value="T2">
                <label for="quarterT2">Trimestre 2</label>
                <input type="radio" id="quarterT3" name="quarterModeRadio" value="T3">
                <label for="quarterT3">Trimestre 3</label>
            </div>
            <div class="subject-filter">
                <select id="subjectSelect"></select>
            </div>
            <div class="generation-mode-selector">
                <input type="radio" id="modeTemplate" name="generationModeRadio" value="Template">
                <label for="modeTemplate">Automate <span class="info-icon tooltip" data-tooltip="Génère une appréciation en remplissant automatiquement le template avec les données de l'élève. Aucune génération de texte par l'IA."><i class="fas fa-info-circle"></i></span></label>
                <input type="radio" id="modeAI" name="generationModeRadio" value="AI">
                <label for="modeAI">Génération IA <span class="info-icon tooltip" data-tooltip="Génère une appréciation complète en utilisant l'intelligence artificielle. L'IA adapte le texte en fonction des données de l'élève et du template sélectionné."><i class="fas fa-info-circle"></i></span></label>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="input-section" id="inputSection">
            <div class="section-header">
                 <h2 class="section-title">
                    <span><span class="icon">📝</span> Saisie des données</span>
                    <span id="currentQuarterDisplayInputSection" class="detail-chip"></span>
                </h2>
                <div class="input-mode-tabs" role="tablist">
                    <div id="massImportTab" class="input-mode-tab active" role="tab" aria-selected="true" aria-controls="massImportSection">Import en masse</div>
                    <div id="singleStudentTab" class="input-mode-tab" role="tab" aria-selected="false" aria-controls="singleStudentFormDiv">Saisie individuelle</div>
                </div>
            </div>

            <div id="massImportSection" class="import-section" role="tabpanel" aria-labelledby="massImportTab">
                <h3 style="margin-top: 0; color: var(--label-color);">
                    <span>📋 Données à importer :</span>
                    <span class="tooltip" id="massDataTooltip" data-tooltip="Format: NOM Prénom | Statut | Moy T1 | App T1 | Moy T2 | App T2 | Moy T3. Les champs sont séparés par un '|'. Les champs après 'Nom Prénom' sont optionnels selon le trimestre.">ℹ️</span>
                </h3>

                <div id="dropZone" class="drop-zone">
                    <p><span class="icon">📁</span> Glissez-déposez votre fichier ici</p>
                    <button class="btn-import-file" id="importFileBtn">
                        <i class="fas fa-file-upload"></i> Cliquez pour importer
                    </button>
                </div>

                <div class="form-group">
                    <div class="label-with-action">
                        <label for="massData">Collez vos données :</label>
                        <button class="btn-link" id="loadSampleDataLink">Tester avec des données d'exemple</button>
                    </div>
                    <textarea id="massData" placeholder="Exemple: MARTIN Lucas | | 12,5 | Bon travail... | 13,8 | Progression notable... | 14,2"
                              style="min-height: 120px; font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0/0 élèves traités</div>
                </div>

                <div class="mass-import-buttons">
                    <button class="btn btn-secondary" id="clearImportBtn">
                        🗑️ Vider
                    </button>
                    <button class="btn" id="importGenerateBtn">
                        ✨ Importer et générer
                    </button>
                    <button class="btn btn-danger" id="cancelImportBtn" style="display: none; margin-left: auto;">
                        <i class="fas fa-stop-circle"></i> Annuler l'import
                    </button>
                </div>
            </div>

            <div id="singleStudentFormDiv" class="student-form" style="display: none;" role="tabpanel" aria-labelledby="singleStudentTab">
                <form id="actualSingleStudentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Nom :</label>
                            <input type="text" id="nom" placeholder="Nom de famille">
                            <div class="error-message" id="nomError" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="prenom">Prénom :</label>
                            <input type="text" id="prenom" placeholder="Prénom">
                            <div class="error-message" id="prenomError" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="statut">Statut particulier :</label>
                            <select id="statut">
                                <option value="">Aucun</option>
                                <option value="Nouveau T2">Nouveau T2</option>
                                <option value="Parti">Parti</option>
                            </select>
                        </div>
                    </div>

                    <hr/>

                    <div class="quarter-input-group" data-quarter-field="T1">
                        <h3><i class="fas fa-calendar-alt"></i> Trimestre 1</h3>
                        <div class="form-row" style="margin-bottom: 0;">
                            <div class="form-group">
                                <label for="moyT1">Moyenne T1 (/20) :</label>
                                <input type="text" id="moyT1" placeholder="ex: 14.5">
                                <div class="error-message" id="moyT1Error" style="display: none;"></div>
                            </div>
                            <div class="form-group full-width">
                                <label for="appT1">Appréciation T1 :</label>
                                <textarea id="appT1" placeholder="Appréciation du premier trimestre..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="quarter-input-group" data-quarter-field="T2">
                        <h3><i class="fas fa-calendar-alt"></i> Trimestre 2</h3>
                        <div class="form-row" style="margin-bottom: 0;">
                            <div class="form-group">
                                <label for="moyT2">Moyenne T2 (/20) :</label>
                                <input type="text" id="moyT2" placeholder="ex: 15.2">
                                <div class="error-message" id="moyT2Error" style="display: none;"></div>
                            </div>
                            <div class="form-group full-width">
                                <label for="appT2">Appréciation T2 :</label>
                                <textarea id="appT2" placeholder="Appréciation du deuxième trimestre..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="quarter-input-group" data-quarter-field="T3">
                        <h3><i class="fas fa-calendar-alt"></i> Trimestre 3</h3>
                        <div class="form-row" style="margin-bottom: 0;">
                            <div class="form-group full-width">
                                 <label for="moyT3">Moyenne T3 (/20) :</label>
                                 <input type="text" id="moyT3" placeholder="ex: 16.1">
                                 <div class="error-message" id="moyT3Error" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <hr/>

                    <div class="form-group full-width">
                        <label for="negativeInstructions"><i class="fas fa-info-circle"></i> Contexte ou instructions pour cet élève :</label>
                        <textarea id="negativeInstructions" placeholder="Ex: Mentionner son rôle de délégué, tenir compte de ses 2 semaines d'absence..."></textarea>
                        <small>Ajoutez ici des contraintes ou des requêtes spécifiques pour cette appréciation.</small>
                    </div>

                    <div id="singleAppreciationPreview" class="appreciation-text-display" role="status" aria-live="polite">
                        <i class="fas fa-eye" style="margin-right: 10px;"></i> Cliquez sur "Prévisualiser" pour voir un aperçu ici
                    </div>

                    <div class="single-student-form-buttons">
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none;">
                            Annuler la modification
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetFormBtn">
                            🔄 Réinitialiser
                        </button>
                        <button type="button" class="btn btn-secondary" id="previewAppreciationBtn">
                            👁️ Prévisualiser
                        </button>
                        <button type="button" class="btn" id="generateAppreciationBtn">
                            ✨ Générer l'appréciation
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="output-section">
            <div class="section-header" style="border-bottom: 2px solid var(--border-color); padding-bottom: 15px;">
                <h2 class="section-title" style="border-bottom:none; padding-bottom:0; margin-bottom:0;">
                    <span><span class="icon">📋</span> Appréciations générées</span>
                </h2>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Rechercher un élève...">
                <span class="search-icon">🔍</span>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card total-color" data-stat-id="totalCount" tabindex="0" role="button" aria-label="Détails du total d'élèves">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card average-color" data-stat-id="avgGradeOutput" tabindex="0" role="button" aria-label="Détails de la moyenne générale">
                    <div class="stat-number" id="avgGradeOutput">-</div>
                    <div class="stat-label">Moyenne</div>
                </div>
                <div class="stat-card progress-color" data-stat-id="progressCount" tabindex="0" role="button" aria-label="Détails des élèves en progrès">
                    <div class="stat-number" id="progressCount">0</div>
                    <div class="stat-label">En progrès</div>
                </div>
                <div class="stat-card stable-color" data-stat-id="stableCount" tabindex="0" role="button" aria-label="Détails des élèves stables">
                    <div class="stat-number" id="stableCount">0</div>
                    <div class="stat-label">Stable</div>
                </div>
                <div class="stat-card regression-color" data-stat-id="regressionCount" tabindex="0" role="button" aria-label="Détails des élèves en régression">
                    <div class="stat-number" id="regressionCount">0</div>
                    <div class="stat-label">En régression</div>
                </div>
                <div class="stat-card words-color" data-stat-id="avgWords" tabindex="0" role="button" aria-label="Détails des mots par appréciation">
                    <div class="stat-number" id="avgWords">0</div>
                    <div class="stat-label">Mots/app</div>
                </div>
            </div>

            <div class="controls-grid">
                <div class="controls-row">
                    <button class="btn btn-small" id="copyAllBtn" tabindex="0">
                        📋 Tout Copier
                    </button>
                     <button class="btn btn-secondary btn-small" id="regenerateAllBtn" tabindex="0" title="Régénérer toutes les appréciations affichées avec les paramètres actuels.">
                        🔄 Tout Régénérer
                    </button>
                    <button class="btn btn-warning btn-small" id="regenerateErrorsBtn" tabindex="0" title="Régénérer uniquement les appréciations qui ont rencontré une erreur." style="display: none;">
                        ⚠️ Régénérer les erreurs
                    </button>
                    <button class="btn btn-small" id="exportJsonBtn" tabindex="0">
                        ⬇️ Exporter JSON
                    </button>
                    <button class="btn btn-small" id="exportCsvBtn" tabindex="0">
                        📊 Exporter CSV
                    </button>
                    <button class="btn btn-danger btn-small" id="clearAllResultsBtn" tabindex="0">
                        🗑️ Effacer tout
                    </button>
                </div>
                 <div class="controls-row">
                    <div class="sort-control">
                        <label for="sortSelect">Trier par :</label>
                        <select id="sortSelect" style="padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border-color);" tabindex="0">
                            <option value="name" selected>Nom A-Z</option>
                            <option value="recent">Plus récents</option>
                            <option value="grade">Moyenne</option>
                            <option value="progress">Évolution</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="results" role="region" aria-live="polite"></div>
            <div id="empty-state-card" style="display: none;">
                <div class="icon">✨</div>
                <h3>Prêt à générer des appréciations !</h3>
                <p>Commencez par utiliser le formulaire de saisie à gauche ou importez vos données en masse pour voir les résultats apparaître ici.</p>
            </div>
            <p id="noResultsMessage" style="text-align: center; color: var(--summary-details-color); margin-top: 30px; display: none;">Aucun résultat ne correspond à votre recherche.</p>
        </div>
    </div>

    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="settingsModalTitle">⚙️ Paramètres</h2>
                <button class="close-button" id="closeSettingsModalBtn" aria-label="Fermer les paramètres">×</button>
            </div>

            <div class="settings-tab-container" role="tablist">
                 <button class="settings-tab active" data-tab="options" role="tab" aria-selected="true" aria-controls="optionsTabContent" tabindex="0">Réglages de Génération</button>
                 <button class="settings-tab" data-tab="templates" role="tab" aria-selected="false" aria-controls="templatesTabContent" tabindex="0">Matières & Modèles</button>
                 <button class="settings-tab" data-tab="advanced" role="tab" aria-selected="false" aria-controls="advancedTabContent" tabindex="0">Connexion & Données</button>
            </div>

            <div id="templatesTabContent" class="tab-content" style="display: none;" role="tabpanel">
                 <details class="settings-accordion" open>
                    <summary><i class="fas fa-book" style="margin-right: 8px;"></i> Gestion et sélection des matières</summary>
                    <div class="details-content" style="padding-top: 15px;">
                        <p style="font-size: 0.9em; color: var(--summary-details-color); margin: 0 0 15px 0;">Sélectionnez une matière ci-dessous pour modifier ses modèles et son vocabulaire. La matière "Standard" 🔒 est un modèle non-modifiable.</p>
                        <div id="subjectManagementContainer"></div>
                        <div class="vocab-add-form" style="margin-top: 5px;">
                            <input type="text" id="addSubjectInput" placeholder="Nom de la nouvelle matière">
                            <div class="error-message" id="addSubjectInputError" style="display: none;"></div>
                            <button class="btn btn-small" id="addSubjectBtn">Ajouter la matière</button>
                        </div>
                    </div>
                </details>

                <h3>
                    <i class="fas fa-edit"></i>
                    Édition des Modèles (<span id="currentSubjectTemplate"></span>)
                </h3>
                
                <details class="template-conditional-info">
                    <summary>
                        <b><i class="fas fa-lightbulb"></i> Astuces & Balises</b>
                    </summary>
                    <div class="details-content">
                        <p><b>Logique simple :</b> <code>{{if moyT3 > 15}}Excellent !{{else}}Bon travail.{{/if}}</code></p>
                        <p><b>Briques de phrases :</b> <code>{{brique:NomDeLaBrique}}</code></p>
                        <p><b>Blocs d'évolution :</b> <code>{{evolution:positive}}A bien progressé.{{/evolution:positive}}</code></p>
                    </div>
                </details>
                
                <div class="template-group">
                    <h3><i class="fas fa-calendar-check"></i> Modèle T1</h3>
                    <div class="form-group">
                        <div class="label-with-action">
                            <label for="promptTemplateT1">Contenu du modèle :</label>
                            <button class="btn btn-secondary btn-small" data-reset-template="T1" title="Réinitialiser ce modèle">Réinit.</button>
                        </div>
                        <div id="promptTemplateT1" class="template-editor" contenteditable="true" aria-label="Éditeur de template pour le Trimestre 1"></div>
                        <details class="tag-helper-details"><summary>Insérer une balise...</summary><div class="tag-helper-container" id="tagsT1"></div></details>
                        <details class="template-preview-details"><summary>Aperçu dynamique</summary><div class="details-content"><div class="refinement-box"><p id="templatePreviewT1"></p></div></div></details>
                    </div>
                </div>

                <div class="template-group">
                    <h3><i class="fas fa-calendar-check"></i> Modèle T2</h3>
                    <div class="form-group">
                         <div class="label-with-action">
                            <label for="promptTemplateT2">Contenu du modèle :</label>
                            <button class="btn btn-secondary btn-small" data-reset-template="T2" title="Réinitialiser ce modèle">Réinit.</button>
                        </div>
                        <div id="promptTemplateT2" class="template-editor" contenteditable="true" aria-label="Éditeur de template pour le Trimestre 2"></div>
                        <details class="tag-helper-details"><summary>Insérer une balise...</summary><div class="tag-helper-container" id="tagsT2"></div></details>
                        <details class="template-preview-details"><summary>Aperçu dynamique</summary><div class="details-content"><div class="refinement-box"><p id="templatePreviewT2"></p></div></div></details>
                    </div>
                </div>

                <div class="template-group">
                    <h3><i class="fas fa-calendar-check"></i> Modèle T3</h3>
                    <div class="form-group">
                         <div class="label-with-action">
                            <label for="promptTemplateT3">Contenu du modèle :</label>
                            <button class="btn btn-secondary btn-small" data-reset-template="T3" title="Réinitialiser ce modèle">Réinit.</button>
                        </div>
                        <div id="promptTemplateT3" class="template-editor" contenteditable="true" aria-label="Éditeur de template pour le Trimestre 3"></div>
                        <details class="tag-helper-details"><summary>Insérer une balise...</summary><div class="tag-helper-container" id="tagsT3"></div></details>
                        <details class="template-preview-details"><summary>Aperçu dynamique</summary><div class="details-content"><div class="refinement-box"><p id="templatePreviewT3"></p></div></div></details>
                    </div>
                </div>
                
                <details class="settings-accordion" id="vocabulaireSection">
                     <summary>
                        <i class="fas fa-spell-check" style="margin-right: 8px;"></i> Bibliothèque de vocabulaire et briques de phrases (<span id="currentSubjectVocab"></span>)
                        <span class="info-icon tooltip" id="vocabStandardInfo" style="margin-left: 8px; display: none;" data-tooltip="Le vocabulaire du mode Standard est universel et non-modifiable. Pour créer un vocabulaire personnalisé, ajoutez une nouvelle matière.">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </summary>
                    <div class="details-content" style="padding-top:15px;">
                        <div class="options-grid">
                            <div class="form-group">
                                <label for="addCompetenceInput">Compétences</label>
                                <div id="vocabCompetencesList" class="vocab-list-container"></div>
                                <div class="vocab-add-form">
                                    <input type="text" id="addCompetenceInput" placeholder="Ajouter une compétence">
                                    <button class="btn btn-small" id="addCompetenceBtn">Ajouter</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="addQualiteInput">Qualités</label>
                                <div id="vocabQualitesList" class="vocab-list-container"></div>
                                <div class="vocab-add-form">
                                    <input type="text" id="addQualiteInput" placeholder="Ajouter une qualité">
                                    <button class="btn btn-small" id="addQualiteBtn">Ajouter</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="addActiviteInput">Activités</label>
                                <div id="vocabActivitesList" class="vocab-list-container"></div>
                                <div class="vocab-add-form">
                                    <input type="text" id="addActiviteInput" placeholder="Ajouter une activité">
                                    <button class="btn btn-small" id="addActiviteBtn">Ajouter</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label>Briques de phrases</label>
                            <div id="phraseBricksList" class="vocab-list-container"></div>
                            <div class="vocab-add-form">
                                <input type="text" id="addBrickNameInput" placeholder="Nom de la brique (ex: intro)">
                                <input type="text" id="addBrickTextInput" placeholder="Texte de la brique (ex: Bonjour)">
                                <button class="btn btn-small" id="addBrickBtn">Ajouter</button>
                            </div>
                            <small>Utilisez <code>{{brique:NomDeLaBrique}}</code> dans vos templates.</small>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                        <button class="btn btn-secondary btn-small" id="resetVocabBtn">Réinitialiser ce vocabulaire</button>
                        </div>
                    </div>
                </details>
            </div>
            
            <div id="optionsTabContent" class="tab-content active" role="tabpanel" >
                <h3><i class="fas fa-sliders-h" style="margin-right: 8px;"></i> Seuils d'Évolution</h3>
                <div class="options-grid">
                    <div class="form-group">
                        <label for="evolutionThresholdPositive" class="label-with-icon"><i class="fas fa-arrow-trend-up"></i> Seuil de progression notable (pts) :</label>
                        <input type="number" id="evolutionThresholdPositive" step="0.1" min="0" value="0.5">
                        <small>Différence minimale pour une progression "notable".</small>
                    </div>
                    <div class="form-group">
                        <label for="evolutionThresholdVeryPositive" class="label-with-icon"><i class="fas fa-arrow-trend-up"></i> Seuil de très forte progression (pts) :</label>
                        <input type="number" id="evolutionThresholdVeryPositive" step="0.1" min="0" value="2.0">
                        <small>Différence minimale pour une "très forte progression".</small>
                    </div>
                </div>
                <div class="options-grid">
                    <div class="form-group">
                        <label for="evolutionThresholdNegative" class="label-with-icon"><i class="fas fa-arrow-trend-down"></i> Seuil de léger recul (pts) :</label>
                        <input type="number" id="evolutionThresholdNegative" step="0.1" max="0" value="-0.5">
                        <small>Différence maximale pour un "léger recul".</small>
                    </div>
                    <div class="form-group">
                        <label for="evolutionThresholdVeryNegative" class="label-with-icon"><i class="fas fa-arrow-trend-down"></i> Seuil de forte baisse (pts) :</label>
                        <input type="number" id="evolutionThresholdVeryNegative" step="0.1" max="0" value="-2.0">
                        <small>Différence maximale pour une "forte baisse".</small>
                    </div>
                </div>
                
                <h3><i class="fas fa-brain" style="margin-right: 8px;"></i> Paramètres Spécifiques à l'IA</h3>
                <div class="form-group">
                    <label for="wordCountLimit">Nombre de mots max. pour l'appréciation :</label>
                    <input type="number" id="wordCountLimit" min="10" value="80">
                    <small>L'IA tentera de respecter cette limite.</small>
                </div>
                <div class="form-group">
                    <label for="negativeInstructionsGlobal">Instructions générales pour l'IA :</label>
                    <textarea id="negativeInstructionsGlobal" placeholder="Ex: 'Adopter un ton bienveillant', 'Ne pas utiliser le mot 'élève''..."></textarea>
                    <small>Ces instructions s'appliqueront à toutes les générations IA.</small>
                </div>
                 <details class="settings-accordion">
                    <summary><i class="fas fa-cogs" style="margin-right: 8px;"></i> Prompts Système de l'IA (Avancé)</summary>
                    <div class="details-content">
                        <p style="font-size: 0.9em; color: var(--summary-details-color); margin-top: 15px;">Modifiez les instructions de base données à l'IA pour chaque trimestre. <strong>Attention :</strong> des modifications importantes peuvent altérer la qualité des résultats.</p>
                        <div class="form-group" style="margin-top: 20px;">
                            <div class="label-with-action">
                                <label for="systemPromptT1">Prompt Système T1</label>
                                <button class="btn btn-secondary btn-small" data-reset-prompt="T1">Réinit.</button>
                            </div>
                            <textarea id="systemPromptT1"></textarea>
                        </div>
                         <div class="form-group">
                            <div class="label-with-action">
                                <label for="systemPromptT2">Prompt Système T2</label>
                                <button class="btn btn-secondary btn-small" data-reset-prompt="T2">Réinit.</button>
                            </div>
                            <textarea id="systemPromptT2"></textarea>
                        </div>
                         <div class="form-group">
                            <div class="label-with-action">
                                <label for="systemPromptT3">Prompt Système T3</label>
                                <button class="btn btn-secondary btn-small" data-reset-prompt="T3">Réinit.</button>
                            </div>
                            <textarea id="systemPromptT3"></textarea>
                        </div>
                    </div>
                </details>
            </div>

            <div id="advancedTabContent" class="tab-content" style="display: none;" role="tabpanel">
                 <details class="settings-accordion" open>
                    <summary><i class="fas fa-key" style="margin-right: 8px;"></i> Paramètres des API</summary>
                    <div class="details-content" style="padding-top: 20px;">
                        <div class="form-group">
                            <label for="aiModelSelect">Modèle d'IA à utiliser :</label>
                            <select id="aiModelSelect">
                                <option value="openai-gpt-3.5-turbo">OpenAI GPT-3.5 Turbo (Recommandé)</option>
                                <option value="openai-gpt-4o">OpenAI GPT-4o</option>
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                <option value="deepseek-chat">DeepSeek Chat (Direct ou OpenRouter)</option>
                                <option value="mistral-large-latest">Mistral Large (non implémenté)</option>
                                <option value="mistral-small-latest">Mistral Small (non implémenté)</option>
                                <option value="qwen-turbo">Qwen Turbo (non implémenté)</option>
                                <option value="qwen-plus">Qwen Plus (non implémenté)</option>
                            </select>
                            <small>Choisissez le modèle d'IA pour la génération des appréciations.</small>
                        </div>
                        <div class="form-group api-key-input-group" id="openaiApiKeyGroup" style="display: flex;">
                            <label for="openaiApiKey" class="label-with-action">
                                <span>Clé API OpenAI :</span>
                                <button id="getApiKeyHelpBtn" class="btn-link" style="font-size: 0.9em; margin-left: 8px; text-decoration: none;">(?) Obtenir une clé</button>
                            </label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="openaiApiKey" placeholder="sk-..." style="flex-grow: 1;">
                                <button id="validateApiKeyBtn" class="btn btn-secondary btn-small">Vérifier</button>
                            </div>
                            <small>Votre clé API OpenAI. Elle est stockée localement dans votre navigateur et n'est jamais partagée.</small>
                            <div class="error-message" id="openaiApiKeyError" style="display: none;"></div>
                        </div>
                        <div class="form-group" id="geminiApiKeyGroup" style="display: none;">
                            <label for="geminiApiKey">Clé API Gemini :</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="geminiApiKey" placeholder="AIzaSy... (Votre clé API Gemini)" style="flex-grow: 1;">
                                <button id="validateGeminiApiKeyBtn" class="btn btn-secondary btn-small">Vérifier</button>
                            </div>
                            <small id="geminiApiKeyHint" style="color: var(--summary-details-color);">Votre clé API Gemini. Elle est stockée localement dans votre navigateur et n'est jamais partagée.</small>
                            <div class="error-message" id="geminiApiKeyError" style="display: none;"></div>
                        </div>
                        <div class="form-group generic-api-key-group" id="deepseekApiKeyGroup" style="display: none;">
                            <label for="deepseekApiKey">Clé API DeepSeek (Direct ou OpenRouter) :</label>
                            <input type="password" id="deepseekApiKey" placeholder="Votre clé API DeepSeek ou OpenRouter (sk-or-...)">
                            <small>Votre clé API DeepSeek ou OpenRouter. Stockée localement.</small>
                            <div class="error-message" id="deepseekApiKeyError" style="display: none;"></div>
                        </div>
                        <div class="form-group generic-api-key-group" id="mistralApiKeyGroup" style="display: none;">
                            <label for="mistralApiKey">Clé API Mistral :</label>
                            <input type="password" id="mistralApiKey" placeholder="Votre clé API Mistral">
                            <small>Votre clé API Mistral. Stockée localement.</small>
                            <div class="error-message" id="mistralApiKeyError" style="display: none;"></div>
                        </div>
                        <div class="form-group generic-api-key-group" id="qwenApiKeyGroup" style="display: none;">
                            <label for="qwenApiKey">Clé API Qwen (Alibaba Cloud) :</label>
                            <input type="password" id="qwenApiKey" placeholder="Votre clé API Qwen">
                            <small>Votre clé API Qwen. Stockée localement.</small>
                            <div class="error-message" id="qwenApiKeyError" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>Coût de l'IA <span class="tooltip" data-tooltip="Basé sur les tarifs publics des API. Le coût réel peut varier."><i class="fas fa-info-circle"></i></span></label>
                            <p style="font-size: 0.9em; margin: 0;">Coût estimé de la session : <b id="sessionCost">0.000$</b></p>
                        </div>
                    </div>
                </details>
                
                <details class="settings-accordion">
                    <summary><i class="fas fa-database" style="margin-right: 8px;"></i> Maintenance des Données</summary>
                     <div class="details-content" style="padding-top: 20px;">
                        <div class="form-group">
                            <label>Import / Export des données</label>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary btn-small" id="importSettingsBtn">⬆️ Importer Paramètres</button>
                                <button class="btn btn-secondary btn-small" id="exportSettingsBtn">⬇️ Exporter Paramètres</button>
                            </div>
                            <small>Sauvegardez ou chargez vos paramètres (matières, templates, etc.) via un fichier JSON.</small>
                        </div>
                        <div class="form-group-inline">
                            <label>Version de l'application :</label>
                            <p><b id="appVersionDisplay"></b></p>
                        </div>
                        <div id="actions-irreversibles-container" style="display:block; margin-top: 15px;">
                            <details style="border-color: var(--error-color);">
                                <summary style="font-weight: 700; color: var(--error-color);">Actions Irréversibles</summary>
                                <div class="details-content" style="padding-top: 15px;">
                                    <button class="btn btn-danger btn-small" id="resetAllSettingsBtn">🔴 Réinitialiser TOUS les paramètres</button>
                                    <small>Attention : cette action réinitialisera les matières, templates, vocabulaires et clés API à leurs valeurs par défaut. Les données des élèves ne seront pas affectées.</small>
                                </div>
                            </details>
                        </div>
                    </div>
                </details>
            </div>
            
            <div class="settings-modal-buttons">
                <button class="btn btn-secondary" id="cancelSettingsBtn" tabindex="0">Annuler</button>
                <button class="btn" id="saveSettingsBtn" tabindex="0">💾 Enregistrer les modifications</button>
            </div>
        </div>
    </div>
    <div id="studentDetailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="studentDetailsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="studentDetailsModalTitle">Analyse de l'élève</h2>
                <div class="modal-nav">
                    <button id="prevStudentBtn" class="modal-nav-btn" title="Élève précédent (Flèche gauche)">←</button>
                    <button id="nextStudentBtn" class="modal-nav-btn" title="Élève suivant (Flèche droite)">→</button>
                </div>
                <button class="close-button" id="closeStudentDetailsModalBtn" aria-label="Fermer l'analyse de l'élève">×</button>
            </div>
            
            <div id="details-quarters-container" class="details-quarters-container">
                <div id="details-quarter-T1" class="details-quarter-block" style="display: none;">
                    <h4>Trimestre 1 <span class="grade-display" id="detailsMoyT1"></span></h4>
                    <p id="detailsAppT1" class="appreciation-text-display"></p>
                </div>
                <div id="details-quarter-T2" class="details-quarter-block" style="display: none;">
                    <h4>Trimestre 2 <span class="grade-display" id="detailsMoyT2"></span></h4>
                    <p id="detailsAppT2" class="appreciation-text-display"></p>
                </div>
                <div id="details-quarter-T3" class="details-quarter-block" style="display: none;">
                     <h4>Trimestre 3 <span class="grade-display" id="detailsMoyT3"></span></h4>
                     <p id="detailsGeneratedAppreciation" class="appreciation-text-display"></p>
                </div>
            </div>

            <hr id="details-analysis-separator" style="display:none;" />

            <div id="strengthsWeaknessesSection" class="strengths-weaknesses-section" style="display: none; border-top:none; padding-top: 0; margin-top:0;">
                <h3><i class="fas fa-chart-line"></i> Forces et Faiblesses </h3>
                <div id="strengthsWeaknessesContent" class="strengths-weaknesses-list">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>

            <div id="nextStepsSection" class="next-steps-section" style="display: none; border-top:none; padding-top: 0; margin-top:0;">
                <h3><i class="fas fa-lightbulb"></i> Pistes d'amélioration </h3>
                <ul id="nextStepsList" class="next-steps-list">
                    <!-- Contenu généré dynamiquement -->
                </ul>
            </div>
            
             <details id="technicalDetailsAccordion" class="settings-accordion" style="display: none;">
                <summary><i class="fas fa-microchip" style="margin-right: 8px;"></i> Détails techniques de la génération</summary>
                <div class="details-content" style="padding-top: 15px;">
                     <details class="settings-accordion">
                        <summary>Prompt de l'appréciation</summary>
                        <div class="details-content">
                            <div class="help-code-block" id="detailsAppreciationPrompt" style="font-size: 0.8em; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </details>
                     <details class="settings-accordion">
                        <summary>Prompt Forces/Faiblesses</summary>
                        <div class="details-content">
                            <div class="help-code-block" id="detailsSWPrompt" style="font-size: 0.8em; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </details>
                     <details class="settings-accordion">
                        <summary>Prompt Pistes d'amélioration</summary>
                        <div class="details-content">
                            <div class="help-code-block" id="detailsNSPrompt" style="font-size: 0.8em; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </details>
                    
                    <div id="detailsTokenUsageSection" class="details-section" style="border: none; padding-bottom: 0; margin-bottom: 0;">
                        <h4 style="color: var(--label-color); margin:0 0 10px 0; font-size: 1.1em; font-weight: 600;" class="tooltip" data-tooltip="Un 'token' est un morceau de mot utilisé par l'IA. Cette répartition est utile pour suivre les coûts si vous utilisez une API payante.">
                            Utilisation des Tokens par génération
                        </h4>
                        <div id="detailsTokenUsageContent" class="details-content-inner" style="font-size: 0.9em;">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                    </div>
                </div>
            </details>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="closeDetailsModalBtn" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>

    <div id="refinementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="refinementModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="refinementModalTitle">Améliorer l'appréciation</h2>
                <div class="modal-nav">
                    <button id="prevRefinementStudentBtn" class="modal-nav-btn" title="Élève précédent (Flèche gauche)">←</button>
                    <button id="nextRefinementStudentBtn" class="modal-nav-btn" title="Élève suivant (Flèche droite)">→</button>
                </div>
                <button class="close-button" id="closeRefinementModalBtn" aria-label="Fermer l'amélioration d'appréciation">×</button>
            </div>
            
            <div id="refinementHeaderDetails" class="refinement-header-details">
                <!-- Contenu généré dynamiquement -->
            </div>

            <div class="refinement-options">
                <div class="form-group full-width" style="margin: 0; margin-bottom: 20px;">
                    <label for="refinementContext" style="text-align: left;">1. Ajouter un élément de contexte (optionnel)</label>
                     <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="refinementContext" placeholder="Ex: Est bavard, a fait de gros efforts..." style="flex-grow: 1;">
                        <button class="btn btn-ai btn-small" id="refineWithContextBtn" tabindex="0" title="Générer un aperçu avec ce contexte">✨ Intégrer</button>
                     </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="margin-bottom: 10px;">2. Changer le style de la phrase (optionnel)</label>
                    <div class="options-group" id="refineStyleOptions">
                        <button class="btn btn-secondary btn-small" data-refine-type="concise">Rendre concise</button>
                        <button class="btn btn-secondary btn-small" data-refine-type="detailed">Rendre détaillée</button>
                        <button class="btn btn-secondary btn-small" data-refine-type="encouraging">Rendre encourageante</button>
                        <button class="btn btn-secondary btn-small" data-refine-type="formal">Rendre formelle</button>
                    </div>
                </div>
                 <div id="refinement-error-actions" style="display: none; justify-content: center; margin-top: 10px;">
                    <!-- Bouton Régénérer injecté ici -->
                </div>
            </div>

            <div class="refinement-comparison">
                <div>
                    <div class="refinement-box-header">
                        <h4>Originale :</h4>
                        <button class="refinement-box-copy-btn" data-action="copy-original" title="Copier le texte original"><i class="fas fa-copy"></i></button>
                    </div>
                    <div id="originalAppreciationText" class="refinement-box editable" contenteditable="true"></div>
                    <div class="word-count" id="originalWordCount">0 mots</div>
                </div>
                <button id="swapRefinementBtn" class="refinement-swap-btn" title="Intervertir les textes">⇄</button>
                <div>
                    <div class="refinement-box-header">
                         <h4>Suggérée :</h4>
                         <button class="refinement-box-copy-btn" data-action="copy-suggested" title="Copier le texte suggéré"><i class="fas fa-copy"></i></button>
                    </div>
                    <p id="suggestedAppreciationText" class="refinement-box placeholder">Cliquez sur un bouton d'amélioration pour générer un aperçu.</p>
                    <div class="word-count" id="suggestedWordCount">0 mots</div>
                </div>
            </div>
            <div class="refinement-actions-bottom">
                 <div>
                    <button class="btn btn-secondary btn-small" id="resetRefinementBtn" tabindex="0">🔄 Réinitialiser</button>
                 </div>
                 <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="cancelRefinementBtn" tabindex="0">Annuler</button>
                    <button class="btn" id="applyRefinedAppreciationBtn" tabindex="0">💾 Appliquer les modifications</button>
                 </div>
            </div>
        </div>
    </div>

    <div id="statDetailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="statDetailsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="statDetailsModalTitle"></h2>
                <button class="close-button" id="closeStatDetailsModalBtn" aria-label="Fermer les détails de la statistique">×</button>
            </div>
            <div class="modal-body">
                <p id="statDetailsContent"></p>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="UI.closeModal(DOM.statDetailsModal)" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="helpModalTitle">❓ Aide et Astuces</h2>
                <button class="close-button" id="closeHelpModalBtn" aria-label="Fermer l'aide">×</button>
            </div>
    
            <div class="help-content-container">
    
                <details class="help-section" open>
                    <summary>
                        <h3><i class="fas fa-rocket" style="color: var(--input-focus);"></i> Démarrage Rapide</h3>
                    </summary>
                    <div class="details-content">
                        <p>L'application démarre avec la matière <strong>"Standard"</strong>. Vous pouvez l'utiliser directement ou créer vos propres matières (et leurs modèles de phrases) dans les <strong>Paramètres (⚙️)</strong>.</p>
                        <ol style="margin-top:10px;">
                            <li>Sélectionnez le <strong>trimestre</strong> désiré.</li>
                            <li>Choisissez votre méthode : <strong>Import en masse</strong> ou <strong>Saisie individuelle</strong>.</li>
                            <li>Entrez vos données et cliquez sur <strong>"Générer"</strong> !</li>
                        </ol>
                        <p style="margin-top:15px">Besoin de revoir le guide de bienvenue ? <button class="btn-link" id="relaunchWelcomeGuideBtn">Cliquez ici</button>.</p>
                    </div>
                </details>

                <details class="help-section" id="apiKeyHelpSection">
                    <summary>
                        <h3><i class="fas fa-key" style="color: var(--warning-color);"></i> Obtenir votre clé API OpenAI (ChatGPT)</h3>
                    </summary>
                    <div class="details-content">
                        <p>Pour que l'IA puisse rédiger vos appréciations, l'application a besoin d'une "clé" pour communiquer avec le service ChatGPT d'OpenAI. Voici comment en obtenir une :</p>
                        <ol>
                            <li><strong>Créez un compte :</strong> Rendez-vous sur <a href="https://platform.openai.com/signup" target="_blank" rel="noopener noreferrer" class="btn-link">platform.openai.com</a> et créez un compte. C'est le site des développeurs, pas le site grand public de ChatGPT.</li>
                            <li><strong>Accédez aux clés API :</strong> Une fois connecté, cliquez sur votre icône de profil en haut à droite, puis sur "View API keys".</li>
                            <li><strong>Créez une nouvelle clé :</strong> Cliquez sur le bouton "+ Create new secret key". Donnez-lui un nom (par exemple, "Assistant Bulletin") et cliquez sur "Create secret key".</li>
                            <li><strong>Copiez la clé :</strong> Une clé secrète (commençant par <code>sk-...</code>) va s'afficher. <strong>Copiez-la immédiatement et gardez-la précieusement !</strong> C'est la seule fois où vous la verrez en entier.</li>
                            <li><strong>Collez la clé :</strong> Revenez dans les <a href="#" class="link-to-settings btn-link" data-target-tab="advanced" data-target-element="openaiApiKey">paramètres</a> de cette application, et collez cette clé dans le champ "Clé API OpenAI".</li>
                        </ol>
                        <p style="margin-top: 15px; font-weight: 600;">Important :</p>
                        <ul class="help-list" style="font-size: 0.9em;">
                           <li><i class="fas fa-credit-card"></i> OpenAI offre souvent des crédits gratuits lors de l'inscription pour tester l'API. Une fois ces crédits épuisés, l'utilisation de l'IA devient payante (paiement à l'utilisation) et nécessite d'ajouter un moyen de paiement à votre compte OpenAI (section <a href="https://platform.openai.com/account/billing/overview" target="_blank" rel="noopener noreferrer" class="btn-link">Facturation</a>).</li>
                           <li><i class="fas fa-lock"></i> Votre clé API est personnelle et secrète. Ne la partagez pas. Elle est stockée de manière sécurisée uniquement dans votre navigateur sur votre ordinateur.</li>
                        </ul>
                    </div>
                </details>
    
                <details class="help-section">
                    <summary>
                        <h3><i class="fas fa-list-ol" style="color: var(--success-color);"></i> Comprendre le format d'import</h3>
                    </summary>
                    <div class="details-content">
                        <p>Pour l'import en masse, collez votre liste d'élèves en respectant le format de colonnes séparées par "|". Le format requis dépend du trimestre sélectionné :</p>
                        
                        <div class="help-format-selector" id="helpFormatSelector">
                            <button data-format="T1" class="active">Trimestre 1</button>
                            <button data-format="T2">Trimestre 2</button>
                            <button data-format="T3">Trimestre 3</button>
                        </div>

                        <div id="helpFormatDisplay">
                            <p style="margin-top:15px; font-weight: 600;">Structure attendue :</p>
                            <div class="help-code-block" id="helpFormatStructure"></div>
                            <p style="margin-top:15px; font-weight: 600;">Exemple concret :</p>
                            <div class="help-code-block" id="helpFormatExample"></div>
                        </div>

                        <details style="margin-top: 15px;">
                            <summary style="font-size: 0.9em;">Pourquoi le format change-t-il ? (En savoir plus)</summary>
                            <div class="details-content-inner">
                                <p style="font-size: 0.9em; color: var(--summary-details-color);">Pour calculer une évolution et générer des appréciations contextuelles, l'application a besoin des données des trimestres précédents :</p>
                                <ul class="help-list" style="font-size: 0.9em;">
                                    <li><b>Pour le T2 :</b> les données du T1 sont utilisées pour calculer l'évolution T1-T2.</li>
                                    <li><b>Pour le T3 :</b> les données du T2 sont essentielles pour calculer l'évolution T2-T3.</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </details>
                
                <details class="help-section">
                    <summary>
                        <h3><i class="fas fa-shield-halved" style="color: #10b981;"></i> Confidentialité de vos Données</h3>
                    </summary>
                     <div class="details-content">
                        <p><strong>Votre confiance est notre priorité. Voici comment vos données sont gérées :</strong></p>
                        <ul class="help-list" style="font-size: 0.9em; margin-top: 10px; list-style: none; padding: 0;">
                            <li style="margin-bottom: 15px;"><i class="fas fa-database" style="color: var(--input-focus); margin-right: 8px;"></i> <strong>Stockage 100% Local :</strong> Toutes les informations que vous saisissez (listes d'élèves, notes, appréciations, paramètres, et même votre clé API) sont sauvegardées <strong>uniquement sur votre propre ordinateur</strong>, dans le stockage sécurisé de votre navigateur.</li>
                            <li style="margin-bottom: 15px;"><i class="fas fa-paper-plane" style="color: var(--success-color); margin-right: 8px;"></i> <strong>Mode IA :</strong> Lorsque vous générez une appréciation avec l'IA, seules les données de l'élève en cours de traitement sont envoyées à OpenAI. Ces données ne sont pas utilisées pour entraîner leurs modèles et sont supprimées après 30 jours, conformément à leur politique de confidentialité.</li>
                            <li style="margin-bottom: 15px;"><i class="fas fa-lock" style="color: var(--error-color); margin-right: 8px;"></i> <strong>Votre Clé API :</strong> Votre clé est le secret qui vous identifie auprès d'OpenAI. Elle n'est jamais partagée et reste sur votre machine.</li>
                        </ul>
                         <p><span class="badge" style="background-color: var(--success-color); color: white; display:inline-flex;">✅ RGPD Conforme</span></p>
                    </div>
                </details>
    
                <details class="help-section">
                    <summary>
                        <h3><i class="fas fa-palette" style="color: var(--button-primary-end);"></i> Personnaliser les Appréciations</h3>
                    </summary>
                    <div class="details-content">
                        <p>Prenez le contrôle total sur le style des appréciations. Utilisez les <strong>Paramètres (⚙️)</strong> pour :</p>
                        <ul class="help-list">
                            <li><strong>Modèles de phrases :</strong> Modifiez les templates pour chaque matière. Le modèle "Standard" est non modifiable mais sert de base pour vos nouvelles matières.</li>
                            <li><strong>Vocabulaire :</strong> Pour chaque matière personnalisée, enrichissez le vocabulaire (compétences, qualités, etc.) que l'IA utilisera.</li>
                            <li><strong>Briques de phrases :</strong> Créez des blocs de texte réutilisables avec <code>{{brique:nom}}</code> dans vos templates.</li>
                             <li><strong>Prompts Système :</strong> Pour les utilisateurs avancés, modifiez les instructions de base de l'IA dans `Paramètres > Réglages de Génération`.</li>
                        </ul>
                        <button class="btn btn-secondary help-action-button" id="helpGoToSettingsBtn"><i class="fas fa-cogs"></i> Accéder aux paramètres</button>
                    </div>
                </details>
    
                <details class="help-section">
                    <summary>
                        <h3><i class="fas fa-microchip" style="color: var(--summary-details-color);"></i> Pour les experts : Comprendre l'IA</h3>
                    </summary>
                    <div class="details-content">
                        <p style="font-size: 0.9em; color: var(--summary-details-color);">
                            Les textes ci-dessous sont des exemples de la requête envoyée à l'IA, construite dynamiquement avec vos paramètres.
                        </p>
                        <details style="margin-top: 15px;">
                            <summary>Prompt de Génération Principal</summary>
                            <div class="details-content-inner"><div class="help-code-block" id="mainGenerationPromptDisplay"></div></div>
                        </details>
                        <details>
                            <summary>Prompts d'Amélioration</summary>
                            <div class="details-content-inner">
                                <h4 style="margin-top: 15px;">Rendre concise :</h4>
                                <div class="help-code-block" id="refineConcisePromptDisplay"></div>
                                <h4 style="margin-top: 15px;">Rendre détaillée :</h4>
                                <div class="help-code-block" id="refineDetailedPromptDisplay"></div>
                                <h4 style="margin-top: 15px;">Rendre encourageante :</h4>
                                <div class="help-code-block" id="refineEncouragingPromptDisplay"></div>
                                <h4 style="margin-top: 15px;">Rendre formelle :</h4>
                                <div class="help-code-block" id="refineFormalPromptDisplay"></div>
                            </div>
                        </details>
                        <details>
                            <summary>Prompt pour les Forces/Faiblesses</summary>
                            <div class="details-content-inner"><div class="help-code-block" id="strengthsWeaknessesPromptDisplay"></div></div>
                        </details>
                        <details>
                             <summary>Prompt pour les Pistes d'Amélioration</summary>
                             <div class="details-content-inner"><div class="help-code-block" id="nextStepsPromptDisplay"></div></div>
                        </details>
                    </div>
                </details>
            </div>
    
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="UI.closeModal(DOM.helpModal)" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>

    <div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="welcomeModalTitle">🎉 Bienvenue dans Trimestre en Main !</h2>
            </div>
            <div class="modal-body">

                <div id="welcome-step-1" class="welcome-step active">
                    <div class="welcome-icon">🚀</div>
                    <h3>Étape 1 : Le Mode Automate</h3>
                    <p>Commencez avec le mode <strong>Automate</strong> par défaut.<br>Il est rapide, efficace, et ne nécessite <strong>aucune configuration</strong>.</p>
                    <p style="margin-top: 15px; font-size: 0.9em; color: var(--summary-details-color);">Il vous suffit de copier-coller votre liste d'élèves pour générer des appréciations basées sur des modèles.</p>
                </div>

                <div id="welcome-step-2" class="welcome-step">
                    <div class="welcome-icon">✨</div>
                    <h3>Étape 2 : Débloquez la puissance de l'IA (Optionnel)</h3>
                    <p>Le mode <strong>Génération IA</strong> crée des textes uniques et naturels. Pour l'activer, ajoutez simplement une clé API OpenAI.</p>
                     <div class="form-group api-key-input-group" style="margin-top:20px; text-align: left;">
                        <label for="welcomeApiKey" style="text-align: left; width: 100%;">
                            Entrez votre Clé API OpenAI ici :
                            <button id="getApiKeyHelpBtnWelcome" class="btn-link" style="font-size: 0.9em; margin-left: 8px; text-decoration: none;">(?) Obtenir une clé</button>
                        </label>
                        <input type="password" id="welcomeApiKey" placeholder="sk-...">
                        <small>Votre clé sera sauvegardée en toute sécurité dans votre navigateur.</small>
                    </div>
                </div>

                <div id="welcome-step-3" class="welcome-step">
                    <div class="welcome-icon">✅</div>
                    <h3>Vous êtes prêt !</h3>
                     <p>Tout est configuré. Vous pouvez maintenant commencer à générer vos appréciations.</p>
                     <p style="margin-top: 15px; font-size: 0.9em; color: var(--summary-details-color);">Pour un essai rapide, n'hésitez pas à utiliser le bouton ci-dessous.</p>
                     <div style="margin-top: 20px;">
                        <button class="btn" id="welcomeLoadSampleBtn"><i class="fas fa-wand-magic-sparkles" style="margin-right: 8px;"></i>Charger des données d'exemple</button>
                     </div>
                </div>
            </div>
            
            <div class="welcome-nav-container">
                 <button class="btn btn-secondary" id="welcomePrevBtn" style="visibility: hidden;">Précédent</button>
                 <div id="welcome-dots">
                    <span class="dot active"></span><span class="dot"></span><span class="dot"></span>
                 </div>
                 <button class="btn" id="welcomeNextBtn">Suivant</button>
                 <div id="welcome-finish-options">
                    <button class="btn btn-secondary" id="welcomeFinishBtn">Terminer</button>
                    <button class="btn" id="welcomeFinishAndHideBtn">Terminer et ne plus afficher</button>
                 </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json,.csv,.txt" style="display: none;">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Génération en cours...</div>
    </div>

    <div id="pwaInstallBanner" class="pwa-install-banner">
        <p>Installez cette application pour un accès rapide et hors ligne !</p>
        <div class="actions">
            <button id="pwaInstallBtn" class="btn" tabindex="0">Installer l'application</button>
            <button id="pwaDismissBtn" class="btn btn-secondary" tabindex="0">Non merci</button>
        </div>
    </div>
    <button id="backToTopBtn" class="icon-button" title="Retour en haut">↑</button>
</body>
</html>
<script>
        // ====================================================================
        // CHANGELOG (par rapport à V1.19)
        // 1. [FEATURE] Aide : Les exemples de prompts dans la modale "Aide et astuces" sont désormais générés dynamiquement, garantissant qu'ils reflètent toujours la logique actuelle de l'application, y compris la nouvelle logique pour "Rendre détaillé".
        // 2. [UX] Modale Améliorer : Le libellé du trimestre a été simplifié pour une meilleure lisibilité (ex: "Trimestre 2" au lieu de "Trimestre T2").
        // 3. [UX] Modale Analyser : L'affichage du trimestre et de la moyenne a été rendu plus clair et lisible (ex: "Trimestre 2 | Moyenne : 10,5").
        // ====================================================================

        // ====================================================================
        // 1. Configuration et Variables Globales
        // ====================================================================
        const APP_VERSION = "1.20";

        const CONFIG = {
            get API_KEY() { return typeof __api_key !== 'undefined' ? __api_key : ""; }, // For Canvas environment
            AUTO_SAVE_INTERVAL_MS: 30000,
            DEBOUNCE_TIME_MS: 300,
            DEFAULT_WORD_COUNT_LIMIT: 80,
            DEFAULT_INSTRUCTIONS_GLOBAL: "Adopter un ton bienveillant. Ne pas utiliser le mot 'performance'. Privilégier des termes comme 'résultats', 'niveau', 'travail', 'apprentissages', 'compétences'.",
            LS_APP_STATE_KEY: 'appreciationGeneratorState_v4.8',
            LS_FIRST_VISIT_KEY: 'appreciationGeneratorFirstVisit_v4',
            OPENROUTER_API_BASE: 'https://openrouter.ai/api/v1',
            DEEPSEEK_API_BASE: 'https://api.deepseek.com',
            OPENAI_API_BASE: 'https://api.openai.com/v1',
        };
        
        const COSTS_PER_MILLION_TOKENS = {
            'gemini-2.0-flash': { input: 0.35, output: 0.70 },
            'openai-gpt-3.5-turbo': { input: 0.50, output: 1.50 },
            'openai-gpt-4o': { input: 5.00, output: 15.00 },
            'deepseek/deepseek-chat': { input: 0.14, output: 0.28 }, // OpenRouter pricing for Deepseek
            'deepseek-chat': { input: 0.14, output: 0.28 } // Direct pricing is similar
        };
        
        const DEFAULT_SYSTEM_PROMPTS = {
            T1: "En tant que professeur de {matiere}, génère une appréciation pour l'élève {prenom} {nom} pour le T1. Reste concis (max {word_limit} mots).",
            T2: "En tant que professeur de {matiere}, génère une appréciation pour l'élève {prenom} {nom} pour le T2, en tenant compte de son évolution depuis le T1. Reste concis (max {word_limit} mots).",
            T3: "En tant que professeur de {matiere}, génère une appréciation de bilan pour {prenom} {nom} pour le T3, en considérant l'ensemble de son année. Reste concis (max {word_limit} mots)."
        };

        const DEFAULT_VOCABULAIRE = {
            competences: ['démarche de projet', 'compétences techniques', 'analyse', 'conception', 'réalisation', 'méthodologie', 'rigueur', 'autonomie'],
            qualites: ['créativité', 'innovation', 'collaboration', 'persévérance', 'curiosité', 'esprit critique', 'organisation'],
            activites: ['projets', 'recherches', 'réalisations pratiques', 'démarches d\'investigation', 'travaux collaboratifs'],
            phraseBricks: {
                "introduction_positive": "Dès le début de ce trimestre, {{prenom}} a fait preuve d'un engagement remarquable.",
                "conclusion_encouragement": "Je l'encourage à maintenir cette dynamique positive et à continuer ses efforts.",
                "transition_progression": "Suite à ses efforts constants, on observe une nette progression dans ses résultats."
            }
        };

        const DEFAULT_PROMPT_TEMPLATES = {
            "Standard": {
                templates: {
                    "T1": "{{niveauGlobal}}. {{prenom}} montre un bon investissement dans le travail demandé. {{encouragement}}",
                    "T2": "Les résultats sont en {{evolution_phrase}}. {{niveauGlobal}}. {{prenom}} doit continuer à renforcer ses {{competence_aleatoire}}.",
                    "T3": "{{if moyT3 >= 14}}Un excellent troisième trimestre qui vient confirmer un bilan annuel très positif. {{prenom}} a fait preuve de rigueur et d'autonomie. {{encouragement}}{{else if moyT3 >= 10}}Un troisième trimestre satisfaisant. Le travail est sérieux malgré {{evolution_phrase}}. {{prenom}} gagnerait à s’investir davantage dans {{activite_aleatoire}} pour continuer à développer ses compétences.{{else}}Trimestre insuffisant. Le travail et l'implication de {{prenom}} restent trop justes. Des efforts soutenus sont nécessaires pour consolider les acquis. Il/elle ne doit pas hésiter à solliciter de l'aide pour se fixer des objectifs clairs.{{/if}}"
                },
                vocabulaire: JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE))
            },
            "Technologie": {
                 templates: {
                    "T1": `{{niveauGlobal}} : {{prenom}} a débuté ce trimestre avec {{moyT1}} de moyenne. Il/Elle a montré une bonne {{qualite_aleatoire}} dans ses {{activite_aleatoire}}. {{encouragement}}`,
                    "T2": `{{niveauGlobal}} : {{prenom}} a montré une bonne {{qualite_aleatoire}} dans ses {{activite_aleatoire}} et a obtenu {{moyT2}} de moyenne. Je l'encourage à renforcer sa {{competence_aleatoire}}.`,
                    "T3": `L'année a été globalement positive pour {{prenom}}. Après une forte progression, il a connu un léger ralentissement ce trimestre. Son engagement reste toutefois très appréciable. Qu'il continue à travailler sa motivation et sa régularité pour consolider ses acquis.`
                },
                vocabulaire: JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE))
            },
            "Mathématiques": {
                 templates: {
                    "T1": `En mathématiques, {{prenom}} a obtenu une moyenne de {{moyT1}}. Il/Elle a démontré une bonne compréhension des concepts de {{competence_aleatoire}}. {{encouragement}}`,
                    "T2": `Avec une moyenne de {{moyT2}} en mathématiques, {{prenom}} {{evolution_phrase}}. Il/Elle doit continuer à travailler sa {{qualite_aleatoire}}.`,
                    "T3": `L'année a été globalement positive pour {{prenom}}. Après une forte progression, il a connu un léger ralentissement ce trimestre. Son engagement reste toutefois très appréciable. Qu'il continue à travailler sa motivation et sa régularité pour consolider ses acquis.`
                },
                vocabulaire: JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE))
            },
             "Français": {
                 templates: {
                    "T1": `En français, {{prenom}} a obtenu une moyenne de {{moyT1}}. Ses compétences en {{competence_aleatoire}} sont notables. {{encouragement}}`,
                    "T2": `Avec une moyenne de {{moyT2}} en français, {{prenom}} {{evolution_phrase}}. Il/Elle est invité(e) à soigner sa {{qualite_aleatoire}}.`,
                    "T3": `L'année a été globalement positive pour {{prenom}}. Après une forte progression, il a connu un léger ralentissement ce trimestre. Son engagement reste toutefois très appréciable. Qu'il continue à travailler sa motivation et sa régularité pour consolider ses acquis.`
                },
                vocabulaire: JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE))
            }
        };

        const DEFAULT_EVOLUTION_THRESHOLDS = {
            positive: 0.5, veryPositive: 2.0, negative: -0.5, veryNegative: -2.0
        };

        let appState = {
            subjects: JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES)),
            systemPrompts: JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PROMPTS)),
            evolutionThresholds: { ...DEFAULT_EVOLUTION_THRESHOLDS },
            currentQuarterMode: 'T1', currentSubject: 'Standard', generationMode: 'Template',
            generatedResults: [], filteredResults: [], currentEditingId: null, currentRefiningAppreciationId: null,
            currentDetailViewIndex: -1, currentRefiningIndex: -1, sessionCost: 0, currentSettingsSubject: 'Standard',
            currentInputMode: 'mass', wordCountLimit: CONFIG.DEFAULT_WORD_COUNT_LIMIT, currentAIModel: 'openai-gpt-3.5-turbo',
            openaiApiKey: '', geminiApiKey: '', mistralApiKey: '', qwenApiKey: '', deepseekApiKey: '',
            instructionsGlobal: CONFIG.DEFAULT_INSTRUCTIONS_GLOBAL,
            isMassImportCancelled: false,
            refinementEdits: {},
        };
        
        let lastFocusedElement;
        let activeModal = null;
        let stackedModal = null;
        const editorHistory = {};
        let lastSelectionRange = null;

        const DOM = {
            appVersionDisplay: document.getElementById('appVersionDisplay'),
            darkModeToggle: document.getElementById('darkModeToggle'), settingsButton: document.getElementById('settingsButton'),
            helpButton: document.getElementById('helpButton'), quarterRadios: document.querySelectorAll('input[name="quarterModeRadio"]'),
            subjectSelect: document.getElementById('subjectSelect'), generationModeRadios: document.querySelectorAll('input[name="generationModeRadio"]'),
            inputSection: document.getElementById('inputSection'), massImportTab: document.getElementById('massImportTab'),
            singleStudentTab: document.getElementById('singleStudentTab'), massImportSection: document.getElementById('massImportSection'),
            singleStudentFormDiv: document.getElementById('singleStudentFormDiv'), actualSingleStudentForm: document.getElementById('actualSingleStudentForm'),
            massData: document.getElementById('massData'), massDataTooltip: document.getElementById('massDataTooltip'),
            progressContainer: document.getElementById('progressContainer'), progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'), importGenerateBtn: document.getElementById('importGenerateBtn'),
            clearImportBtn: document.getElementById('clearImportBtn'), loadSampleDataLink: document.getElementById('loadSampleDataLink'),
            cancelImportBtn: document.getElementById('cancelImportBtn'),
            currentQuarterDisplayInputSection: document.getElementById('currentQuarterDisplayInputSection'), dropZone: document.getElementById('dropZone'),
            importFileBtn: document.getElementById('importFileBtn'), nomInput: document.getElementById('nom'),
            prenomInput: document.getElementById('prenom'), statutSelect: document.getElementById('statut'),
            moyT1Input: document.getElementById('moyT1'), appT1Textarea: document.getElementById('appT1'),
            moyT2Input: document.getElementById('moyT2'), appT2Textarea: document.getElementById('appT2'),
            moyT3Input: document.getElementById('moyT3'), nomError: document.getElementById('nomError'),
            prenomError: document.getElementById('prenomError'), moyT1Error: document.getElementById('moyT1Error'),
            moyT2Error: document.getElementById('moyT2Error'), moyT3Error: document.getElementById('moyT3Error'),
            negativeInstructions: document.getElementById('negativeInstructions'),
            previewAppreciationBtn: document.getElementById('previewAppreciationBtn'),
            singleAppreciationPreview: document.getElementById('singleAppreciationPreview'),
            generateAppreciationBtn: document.getElementById('generateAppreciationBtn'), resetFormBtn: document.getElementById('resetFormBtn'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            resultsDiv: document.getElementById('results'), searchInput: document.getElementById('searchInput'),
            totalCountStat: document.getElementById('totalCount'), avgGradeOutputStat: document.getElementById('avgGradeOutput'),
            progressCountStat: document.getElementById('progressCount'), stableCountStat: document.getElementById('stableCount'),
            regressionCountStat: document.getElementById('regressionCount'), avgWordsStat: document.getElementById('avgWords'),
            clearAllResultsBtn: document.getElementById('clearAllResultsBtn'), copyAllBtn: document.getElementById('copyAllBtn'),
            regenerateAllBtn: document.getElementById('regenerateAllBtn'),
            regenerateErrorsBtn: document.getElementById('regenerateErrorsBtn'),
            exportJsonBtn: document.getElementById('exportJsonBtn'), exportCsvBtn: document.getElementById('exportCsvBtn'), 
            sortSelect: document.getElementById('sortSelect'), fileInput: document.getElementById('fileInput'), 
            settingsModal: document.getElementById('settingsModal'), closeSettingsModalBtn: document.getElementById('closeSettingsModalBtn'), 
            settingsPromptT1: document.getElementById('promptTemplateT1'), settingsPromptT2: document.getElementById('promptTemplateT2'), 
            settingsPromptT3: document.getElementById('promptTemplateT3'),
            systemPromptT1: document.getElementById('systemPromptT1'), systemPromptT2: document.getElementById('systemPromptT2'),
            systemPromptT3: document.getElementById('systemPromptT3'),
            resetVocabBtn: document.getElementById('resetVocabBtn'),
            settingsEvolutionThresholdPositive: document.getElementById('evolutionThresholdPositive'),
            settingsEvolutionThresholdVeryPositive: document.getElementById('evolutionThresholdVeryPositive'),
            settingsEvolutionThresholdNegative: document.getElementById('evolutionThresholdNegative'),
            settingsEvolutionThresholdVeryNegative: document.getElementById('evolutionThresholdVeryNegative'),
            vocabCompetencesList: document.getElementById('vocabCompetencesList'),
            addCompetenceInput: document.getElementById('addCompetenceInput'),
            addCompetenceBtn: document.getElementById('addCompetenceBtn'),
            vocabQualitesList: document.getElementById('vocabQualitesList'),
            addQualiteInput: document.getElementById('addQualiteInput'),
            addQualiteBtn: document.getElementById('addQualiteBtn'),
            vocabActivitesList: document.getElementById('vocabActivitesList'),
            addActiviteInput: document.getElementById('addActiviteInput'),
            addActiviteBtn: document.getElementById('addActiviteBtn'),
            phraseBricksList: document.getElementById('phraseBricksList'),
            addBrickNameInput: document.getElementById('addBrickNameInput'),
            addBrickTextInput: document.getElementById('addBrickTextInput'),
            addBrickBtn: document.getElementById('addBrickBtn'),
            resetAllSettingsBtn: document.getElementById('resetAllSettingsBtn'), 
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            cancelSettingsBtn: document.getElementById('cancelSettingsBtn'), settingsTabs: document.querySelectorAll('.settings-tab'),
            templatesTabContent: document.getElementById('templatesTabContent'), optionsTabContent: document.getElementById('optionsTabContent'),
            advancedTabContent: document.getElementById('advancedTabContent'),
            currentSubjectTemplate: document.getElementById('currentSubjectTemplate'),
            currentSubjectVocab: document.getElementById('currentSubjectVocab'),
            vocabAddForms: document.querySelectorAll('.vocab-add-form'),
            vocabContainers: document.querySelectorAll('.vocab-list-container'),
            subjectManagementContainer: document.getElementById('subjectManagementContainer'),
            addSubjectInput: document.getElementById('addSubjectInput'),
            addSubjectBtn: document.getElementById('addSubjectBtn'),
            wordCountLimitInput: document.getElementById('wordCountLimit'),
            negativeInstructionsGlobal: document.getElementById('negativeInstructionsGlobal'),
            aiModelSelect: document.getElementById('aiModelSelect'), openaiApiKey: document.getElementById('openaiApiKey'),
            openaiApiKeyGroup: document.getElementById('openaiApiKeyGroup'), openaiApiKeyError: document.getElementById('openaiApiKeyError'),
            openaiApiKeyValidationIcon: document.getElementById('openaiApiKeyValidationIcon'),
            validateApiKeyBtn: document.getElementById('validateApiKeyBtn'),
            geminiApiKey: document.getElementById('geminiApiKey'), geminiApiKeyGroup: document.getElementById('geminiApiKeyGroup'),
            geminiApiKeyError: document.getElementById('geminiApiKeyError'), geminiApiKeyHint: document.getElementById('geminiApiKeyHint'),
            validateGeminiApiKeyBtn: document.getElementById('validateGeminiApiKeyBtn'),
            mistralApiKey: document.getElementById('mistralApiKey'), mistralApiKeyGroup: document.getElementById('mistralApiKeyGroup'),
            mistralApiKeyError: document.getElementById('mistralApiKeyError'), qwenApiKey: document.getElementById('qwenApiKey'),
            qwenApiKeyGroup: document.getElementById('qwenApiKeyGroup'), qwenApiKeyError: document.getElementById('qwenApiKeyError'),
            deepseekApiKey: document.getElementById('deepseekApiKey'), deepseekApiKeyGroup: document.getElementById('deepseekApiKeyGroup'),
            deepseekApiKeyError: document.getElementById('deepseekApiKeyError'), 
            getApiKeyHelpBtn: document.getElementById('getApiKeyHelpBtn'),
            sessionCost: document.getElementById('sessionCost'),
            mainGenerationPromptDisplay: document.getElementById('mainGenerationPromptDisplay'),
            refineConcisePromptDisplay: document.getElementById('refineConcisePromptDisplay'),
            refineDetailedPromptDisplay: document.getElementById('refineDetailedPromptDisplay'),
            refineEncouragingPromptDisplay: document.getElementById('refineEncouragingPromptDisplay'),
            refineFormalPromptDisplay: document.getElementById('refineFormalPromptDisplay'),
            nextStepsPromptDisplay: document.getElementById('nextStepsPromptDisplay'),
            strengthsWeaknessesPromptDisplay: document.getElementById('strengthsWeaknessesPromptDisplay'),
            studentDetailsModal: document.getElementById('studentDetailsModal'),
            studentDetailsModalTitle: document.getElementById('studentDetailsModalTitle'),
            closeStudentDetailsModalBtn: document.getElementById('closeStudentDetailsModalBtn'),
            nextStudentBtn: document.getElementById('nextStudentBtn'), prevStudentBtn: document.getElementById('prevStudentBtn'),
            detailsAnalysisSeparator: document.getElementById('details-analysis-separator'),
            detailsQuarterT1: document.getElementById('details-quarter-T1'), detailsMoyT1: document.getElementById('detailsMoyT1'), detailsAppT1: document.getElementById('detailsAppT1'),
            detailsQuarterT2: document.getElementById('details-quarter-T2'), detailsMoyT2: document.getElementById('detailsMoyT2'), detailsAppT2: document.getElementById('detailsAppT2'),
            detailsQuarterT3: document.getElementById('details-quarter-T3'), detailsMoyT3: document.getElementById('detailsMoyT3'), detailsGeneratedAppreciation: document.getElementById('detailsGeneratedAppreciation'),
            technicalDetailsAccordion: document.getElementById('technicalDetailsAccordion'),
            detailsAppreciationPrompt: document.getElementById('detailsAppreciationPrompt'),
            detailsSWPrompt: document.getElementById('detailsSWPrompt'),
            detailsNSPrompt: document.getElementById('detailsNSPrompt'),
            detailsTokenUsageSection: document.getElementById('detailsTokenUsageSection'),
            detailsTokenUsageContent: document.getElementById('detailsTokenUsageContent'),
            strengthsWeaknessesSection: document.getElementById('strengthsWeaknessesSection'),
            strengthsWeaknessesContent: document.getElementById('strengthsWeaknessesContent'),
            nextStepsSection: document.getElementById('nextStepsSection'), nextStepsList: document.getElementById('nextStepsList'),
            closeDetailsModalBtn: document.getElementById('closeDetailsModalBtn'),
            refinementModal: document.getElementById('refinementModal'),
            closeRefinementModalBtn: document.getElementById('closeRefinementModalBtn'),
            refinementModalTitle: document.getElementById('refinementModalTitle'),
            refinementHeaderDetails: document.getElementById('refinementHeaderDetails'),
            originalAppreciationText: document.getElementById('originalAppreciationText'),
            suggestedAppreciationText: document.getElementById('suggestedAppreciationText'),
            originalWordCount: document.getElementById('originalWordCount'),
            suggestedWordCount: document.getElementById('suggestedWordCount'),
            refineStyleOptions: document.getElementById('refineStyleOptions'),
            swapRefinementBtn: document.getElementById('swapRefinementBtn'),
            cancelRefinementBtn: document.getElementById('cancelRefinementBtn'),
            applyRefinedAppreciationBtn: document.getElementById('applyRefinedAppreciationBtn'),
            resetRefinementBtn: document.getElementById('resetRefinementBtn'),
            prevRefinementStudentBtn: document.getElementById('prevRefinementStudentBtn'),
            nextRefinementStudentBtn: document.getElementById('nextRefinementStudentBtn'),
            refinementContext: document.getElementById('refinementContext'),
            refineWithContextBtn: document.getElementById('refineWithContextBtn'),
            refinementErrorActions: document.getElementById('refinement-error-actions'),
            statDetailsModal: document.getElementById('statDetailsModal'), statDetailsTitle: document.getElementById('statDetailsModalTitle'),
            statDetailsContent: document.getElementById('statDetailsContent'), closeStatDetailsModalBtn: document.getElementById('closeStatDetailsModalBtn'),
            helpModal: document.getElementById('helpModal'), closeHelpModalBtn: document.getElementById('closeHelpModalBtn'),
            helpLoadSampleBtn: document.getElementById('helpLoadSampleBtn'),
            relaunchWelcomeGuideBtn: document.getElementById('relaunchWelcomeGuideBtn'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'), pwaInstallBanner: document.getElementById('pwaInstallBanner'),
            pwaInstallBtn: document.getElementById('pwaInstallBtn'), pwaDismissBtn: document.getElementById('pwaDismissBtn'),
            aiModeBadge: document.getElementById('aiModeBadge'),
            emptyStateCard: document.getElementById('empty-state-card'),
            noResultsMessage: document.getElementById('noResultsMessage'),
            importSettingsBtn: document.getElementById('importSettingsBtn'),
            exportSettingsBtn: document.getElementById('exportSettingsBtn'),
            welcomeModal: document.getElementById('welcomeModal'),
            welcomeApiKeyInput: document.getElementById('welcomeApiKey'),
            getApiKeyHelpBtnWelcome: document.getElementById('getApiKeyHelpBtnWelcome'),
            welcomePrevBtn: document.getElementById('welcomePrevBtn'),
            welcomeNextBtn: document.getElementById('welcomeNextBtn'),
            welcomeLoadSampleBtn: document.getElementById('welcomeLoadSampleBtn'),
            welcomeFinishBtn: document.getElementById('welcomeFinishBtn'),
            welcomeFinishAndHideBtn: document.getElementById('welcomeFinishAndHideBtn'),
            welcomeFinishOptions: document.getElementById('welcome-finish-options'),
            welcomeDots: document.getElementById('welcome-dots'),
            actionsIrreversiblesContainer: document.getElementById('actions-irreversibles-container'),
            vocabulaireSection: document.getElementById('vocabulaireSection'),
            vocabStandardInfo: document.getElementById('vocabStandardInfo'),
            backToTopBtn: document.getElementById('backToTopBtn'),
        };

        // ====================================================================
        // 2. Gestion du Stockage Local (localStorage)
        // ====================================================================

        const StorageManager = {
            loadAppState() {
                try {
                    const savedState = localStorage.getItem(CONFIG.LS_APP_STATE_KEY);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        if (parsedState.generatedResults) appState.generatedResults = parsedState.generatedResults;
                        if (parsedState.settings) {
                            Object.assign(appState, parsedState.settings);
                        } else { 
                             Object.assign(appState, parsedState);
                        }

                        // Migration from old structure (promptTemplates/vocabulaire) to new (subjects)
                        if (appState.promptTemplates && !appState.subjects) {
                            appState.subjects = {};
                            for (const subjectName in appState.promptTemplates) {
                                appState.subjects[subjectName] = {
                                    templates: appState.promptTemplates[subjectName],
                                    vocabulaire: JSON.parse(JSON.stringify(appState.vocabulaire || DEFAULT_VOCABULAIRE))
                                };
                            }
                            delete appState.promptTemplates;
                            delete appState.vocabulaire;
                        }

                        // Ensure Standard subject exists and has all vocab keys
                        if (!appState.subjects.Standard) {
                            appState.subjects.Standard = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES.Standard));
                        }
                        for (const subjectName in appState.subjects) {
                            if (!appState.subjects[subjectName].vocabulaire) {
                                appState.subjects[subjectName].vocabulaire = JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE));
                            } else {
                                for(const vocabKey in DEFAULT_VOCABULAIRE) {
                                    if(!appState.subjects[subjectName].vocabulaire[vocabKey]) {
                                        appState.subjects[subjectName].vocabulaire[vocabKey] = JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE[vocabKey]));
                                    }
                                }
                            }
                        }
                        
                        appState.instructionsGlobal = appState.instructionsGlobal ?? CONFIG.DEFAULT_INSTRUCTIONS_GLOBAL;
                        appState.systemPrompts = appState.systemPrompts || JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PROMPTS));

                        appState.generatedResults.forEach(result => {
                            if (!result.studentData.quarterMode) result.studentData.quarterMode = 'T3';
                            if (!result.studentData.subject) result.studentData.subject = 'Standard';
                            if (!result.studentData.generationMode) result.studentData.generationMode = 'AI';
                            if (result.strengthsWeaknesses === undefined) result.strengthsWeaknesses = null;
                            if (result.nextSteps === undefined) result.nextSteps = null;
                            if (result.tokenUsage === undefined || !result.tokenUsage.appreciation) {
                                const oldTokenUsage = result.tokenUsage;
                                result.tokenUsage = {
                                    appreciation: oldTokenUsage || null,
                                    sw: null,
                                    ns: null
                                };
                            }
                            if (result.studentData.negativeInstructions === undefined) result.studentData.negativeInstructions = '';
                            if (result.studentData.prompts === undefined) {
                                result.studentData.prompts = {
                                    appreciation: result.studentData.promptUsed || null,
                                    sw: null,
                                    ns: null
                                };
                                delete result.studentData.promptUsed;
                            }
                            if (result.copied === undefined) result.copied = false;
                        });
                    } else {
                        // For a brand new user
                        appState.currentAIModel = 'openai-gpt-3.5-turbo';
                        appState.generationMode = 'Template';
                        appState.currentSubject = 'Standard';
                    }
                } catch (e) {
                    console.error("Erreur lors du chargement de l'état depuis localStorage:", e);
                    UI.showNotification("Erreur lors du chargement des données sauvegardées. Réinitialisation.", 'error');
                    localStorage.removeItem(CONFIG.LS_APP_STATE_KEY);
                    appState = {
                        subjects: JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES)),
                        systemPrompts: JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PROMPTS)),
                        evolutionThresholds: { ...DEFAULT_EVOLUTION_THRESHOLDS },
                        currentQuarterMode: 'T1', currentSubject: 'Standard', generationMode: 'Template',
                        generatedResults: [], filteredResults: [], currentEditingId: null,
                        currentRefiningAppreciationId: null, currentInputMode: 'mass', currentDetailViewIndex: -1, currentRefiningIndex: -1, sessionCost: 0,
                        currentSettingsSubject: 'Standard',
                        wordCountLimit: CONFIG.DEFAULT_WORD_COUNT_LIMIT, currentAIModel: 'openai-gpt-3.5-turbo',
                        openaiApiKey: '', geminiApiKey: '', mistralApiKey: '', qwenApiKey: '', deepseekApiKey: '',
                        instructionsGlobal: CONFIG.DEFAULT_INSTRUCTIONS_GLOBAL, 
                        isMassImportCancelled: false,
                        refinementEdits: {},
                    };
                }

                if (!appState.subjects || Object.keys(appState.subjects).length === 0 || !appState.subjects['Standard']) {
                    appState.subjects = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES));
                } else {
                     for (const subjectName in DEFAULT_PROMPT_TEMPLATES) {
                        if (!appState.subjects[subjectName]) {
                            appState.subjects[subjectName] = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES[subjectName]));
                        }
                    }
                }
                
                if (!appState.subjects[appState.currentSubject]) {
                    appState.currentSubject = 'Standard';
                }
                appState.currentSettingsSubject = appState.currentSubject;

                if (appState.generationMode === 'AI' && !UI.checkAPIKeyPresence(true)) {
                    appState.generationMode = 'Template';
                }
                
                console.log('État de l\'application chargé.');
                StorageManager.saveAppState();
            },
            
            saveAppState() {
                 const settings = {
                    subjects: appState.subjects,
                    systemPrompts: appState.systemPrompts,
                    evolutionThresholds: appState.evolutionThresholds,
                    wordCountLimit: appState.wordCountLimit,
                    currentAIModel: appState.currentAIModel,
                    openaiApiKey: appState.openaiApiKey,
                    geminiApiKey: appState.geminiApiKey,
                    mistralApiKey: appState.mistralApiKey,
                    qwenApiKey: appState.qwenApiKey,
                    deepseekApiKey: appState.deepseekApiKey,
                    instructionsGlobal: appState.instructionsGlobal,
                    currentQuarterMode: appState.currentQuarterMode,
                    currentSubject: appState.currentSubject,
                    currentInputMode: appState.currentInputMode,
                    generationMode: appState.generationMode,
                };

                const dataToSave = {
                    version: APP_VERSION,
                    generatedResults: appState.generatedResults,
                    settings: settings
                };

                localStorage.setItem(CONFIG.LS_APP_STATE_KEY, JSON.stringify(dataToSave));
            },

            resetAllSettings() {
                UI.showCustomConfirm("Voulez-vous vraiment réinitialiser TOUS les paramètres ? Cela inclut toutes les matières, templates, vocabulaires et clés API. Les données d'élèves ne seront pas affectées. Cette action est irréversible.", () => {
                    appState.subjects = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES));
                    appState.systemPrompts = JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PROMPTS));
                    appState.evolutionThresholds = { ...DEFAULT_EVOLUTION_THRESHOLDS };
                    appState.currentSubject = 'Standard';
                    appState.currentSettingsSubject = 'Standard';
                    appState.wordCountLimit = CONFIG.DEFAULT_WORD_COUNT_LIMIT;
                    appState.currentAIModel = 'openai-gpt-3.5-turbo';
                    appState.openaiApiKey = '';
                    appState.geminiApiKey = '';
                    appState.mistralApiKey = '';
                    appState.qwenApiKey = '';
                    appState.deepseekApiKey = '';
                    appState.instructionsGlobal = CONFIG.DEFAULT_INSTRUCTIONS_GLOBAL;
                    if (UI.checkAPIKeyPresence(true)) { appState.generationMode = 'AI'; } else { appState.generationMode = 'Template'; }
                    
                    StorageManager.saveAppState(); 

                    UI.updateSettingsPromptFields();
                    UI.updateSettingsFields();
                    UI.populateSubjectSelect();
                    UI.setGenerationMode(appState.generationMode);
                    UI.renderVocabLists();
                    UI.showNotification('Tous les paramètres ont été réinitialisés.', 'success');
                });
            },

            exportToJson() {
                const dataToExport = {
                    appVersion: APP_VERSION,
                    settings: {
                        subjects: appState.subjects,
                        systemPrompts: appState.systemPrompts,
                        evolutionThresholds: appState.evolutionThresholds,
                        wordCountLimit: appState.wordCountLimit,
                        instructionsGlobal: appState.instructionsGlobal,
                        currentAIModel: appState.currentAIModel,
                    },
                    generatedResults: appState.generatedResults
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trimestre-en-main_export_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UI.showNotification('État de l\'application exporté en JSON.', 'success');
            },

            exportSettings() {
                const settingsToExport = {
                    appVersion: APP_VERSION,
                    subjects: appState.subjects,
                    systemPrompts: appState.systemPrompts,
                    evolutionThresholds: appState.evolutionThresholds,
                    wordCountLimit: appState.wordCountLimit,
                    instructionsGlobal: appState.instructionsGlobal,
                    currentAIModel: appState.currentAIModel,
                };
                const dataStr = JSON.stringify(settingsToExport, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trimestre-en-main_settings_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UI.showNotification('Paramètres exportés avec succès !', 'success');
            },
            
            importSettings(fileContent) {
                try {
                    const importedData = JSON.parse(fileContent);
                    const settings = importedData.settings || importedData;

                    if (settings.subjects) {
                        appState.subjects = settings.subjects;
                        appState.systemPrompts = settings.systemPrompts || appState.systemPrompts;
                        appState.evolutionThresholds = settings.evolutionThresholds || appState.evolutionThresholds;
                        appState.wordCountLimit = settings.wordCountLimit || appState.wordCountLimit;
                        appState.instructionsGlobal = settings.instructionsGlobal ?? appState.instructionsGlobal;
                        appState.currentAIModel = settings.currentAIModel || appState.currentAIModel;

                        StorageManager.saveAppState();
                        App.updateUIOnLoad(); 
                        UI.showNotification('Paramètres importés avec succès !', 'success');
                    } else {
                        throw new Error('Fichier de paramètres invalide (structure "subjects" manquante).');
                    }
                } catch (error) {
                    console.error('Erreur importation paramètres:', error);
                    UI.showNotification(`Erreur importation : ${error.message}`, 'error');
                }
            }
        };

        // ====================================================================
        // 3. Fonctions Utilitaires Générales
        // ====================================================================

        const Utils = {
            validateInput(input) {
                const value = input.value.trim();
                const errorElement = document.getElementById(input.id + 'Error');
                let isValid = true; let errorMessage = '';
                if (input.id === 'nom' || input.id === 'prenom') {
                    if (value.length === 0) { isValid = false; errorMessage = 'Ce champ est requis'; }
                    else if (!/^[a-zA-ZÀ-ÿ\s\-']+$/.test(value)) { isValid = false; errorMessage = 'Caractères invalides détectés'; }
                } else if (input.id === 'addSubjectInput') {
                    if (value.length === 0) { isValid = false; errorMessage = 'Ce champ est requis'; }
                    else if (appState.subjects[value]) { isValid = false; errorMessage = 'Cette matière existe déjà'; }
                }
                if (isValid) { input.classList.remove('input-error'); if (errorElement) errorElement.style.display = 'none'; }
                else { input.classList.add('input-error'); if (errorElement) { errorElement.textContent = '⚠️ ' + errorMessage; errorElement.style.display = 'block'; } }
                return isValid;
            },
            validateGrade(input) {
                const valueStr = input.value.trim().replace(',', '.');
                const errorElement = document.getElementById(input.id + 'Error');
                let isValid = true; let errorMessage = '';
                if (valueStr === '') { input.classList.remove('input-error'); if (errorElement) errorElement.style.display = 'none'; return true; }
                const value = parseFloat(valueStr);
                if (isNaN(value) || value < 0 || value > 20) { isValid = false; errorMessage = 'La note doit être entre 0 et 20'; }
                if (isValid) { input.classList.remove('input-error'); if (errorElement) errorElement.style.display = 'none'; }
                else { input.classList.add('input-error'); if (errorElement) { errorElement.textContent = '⚠️ ' + errorMessage; errorElement.style.display = 'block'; } }
                return isValid;
            },
            countWords(text) { if (typeof text !== 'string') return 0; return text.trim().split(/\s+/).filter(word => word.length > 0).length; },
            getRandomElement(array) { if (!array || array.length === 0) return ''; return array[Math.floor(Math.random() * array.length)]; },
            isNumeric(str) {
                if (typeof str !== 'string' && typeof str !== 'number') return false;
                if (typeof str === 'number') return str >= 0 && str <= 20;
                const cleaned = str.replace(',', '.'); const num = parseFloat(cleaned);
                return !isNaN(num) && num >= 0 && num <= 20;
            },
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => { clearTimeout(timeout); func(...args); };
                    clearTimeout(timeout); timeout = setTimeout(later, wait);
                };
            },
            parseStudentLine(line, quarterMode) {
                line = line.trim(); if (!line) return null;
                const parts = line.split('|').map(p => p.trim());
                const nomPrenomCombined = parts[0];
                const { nom, prenom } = Utils.parseNomPrenom(nomPrenomCombined);
                const isEmptyEffectively = (!nom && !prenom) && parts.slice(1).every(p => p === '');
                if (isEmptyEffectively) { console.warn("Ligne entièrement vide ignorée (après parsing nom/prénom):", line); return null; }
                const statut = parts[1] || '';
                const moyT1Str = parts[2]?.replace(',', '.'); const moyT1 = Utils.isNumeric(moyT1Str) ? parseFloat(moyT1Str) : null;
                const appT1 = parts[3] || '';
                const moyT2Str = parts[4]?.replace(',', '.'); const moyT2 = (parts.length > 4 && Utils.isNumeric(moyT2Str)) ? parseFloat(moyT2Str) : null;
                const appT2 = (parts.length > 5) ? parts[5] : '';
                const moyT3Str = parts[6]?.replace(',', '.'); const moyT3 = (parts.length > 6 && Utils.isNumeric(moyT3Str)) ? parseFloat(moyT3Str) : null;
                const negativeInstructions = (parts.length > 7) ? parts[7] : '';
                if (!nom && !prenom && !statut && moyT1 === null && !appT1 && moyT2 === null && !appT2 && moyT3 === null && !negativeInstructions) { console.warn("Ligne considérée comme vide (aucun champ significatif après parsing):", line); return null; }
                return { nom, prenom, statut, moyT1, appT1, moyT2, appT2, moyT3, quarterMode, negativeInstructions };
            },
            parseNomPrenom(fullNameCombined) {
                const words = fullNameCombined.split(/\s+/).filter(s => s.length > 0);
                if (words.length === 0) return { nom: '', prenom: '' };
                if (words.length === 1) return { nom: '', prenom: words[0] };
                const prenom = words.pop(); const nom = words.join(' ');
                return { nom: nom.toUpperCase(), prenom };
            },
            cleanMarkdown(text) { if (typeof text !== 'string') return text; 
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
            },
            applyConditionalLogic(template, studentData, evolutions) {
                let processedTemplate = template;
                
                const relevantEvolution = AppreciationsManager.getRelevantEvolution(evolutions, studentData.quarterMode);
                const evolutionType = relevantEvolution ? relevantEvolution.type : 'stable';
                const evolutionRegex = /{{evolution:(positive|negative|stable)}}(.*?){{\/evolution:\1}}/gs;
                
                processedTemplate = processedTemplate.replace(evolutionRegex, (match, type, content) => {
                    const isPositive = evolutionType === 'very-positive' || evolutionType === 'positive';
                    const isNegative = evolutionType === 'very-negative' || evolutionType === 'negative';

                    if (type === 'positive' && isPositive) return content;
                    if (type === 'negative' && isNegative) return content;
                    if (type === 'stable' && evolutionType === 'stable') return content;
                    
                    return ''; 
                });

                const ifRegex = /{{if\s+([^}]+?)\s*([<>=!]+)\s*([^}]+?)\s*}}(.*?)(?:{{else}}(.*?))?{{\/if}}/gs;
                processedTemplate = processedTemplate.replace(ifRegex, (match, field, operator, value, truePart, falsePart) => {
                    const studentDataForEval = { ...studentData, evolution: relevantEvolution };
                    const fieldValueStr = String(studentDataForEval[field.trim()]).replace(',', '.');
                    let fieldValue = studentDataForEval[field.trim()]; let conditionMet = false;
                    let parsedValueStr = String(value).trim().replace(',', '.'); let parsedValue = parsedValueStr;
                    if (!isNaN(parseFloat(fieldValueStr)) && !isNaN(parseFloat(parsedValueStr))) { fieldValue = parseFloat(fieldValueStr); parsedValue = parseFloat(parsedValueStr); }
                    else { fieldValue = String(fieldValue).toLowerCase(); parsedValue = String(parsedValue).toLowerCase(); }
                    switch (operator.trim()) {
                        case '>': conditionMet = fieldValue > parsedValue; break; case '<': conditionMet = fieldValue < parsedValue; break;
                        case '>=': conditionMet = fieldValue >= parsedValue; break; case '<=': conditionMet = fieldValue <= parsedValue; break;
                        case '==': conditionMet = fieldValue == parsedValue; break; case '!=': conditionMet = fieldValue != parsedValue; break;
                        default: conditionMet = false;
                    }
                    return conditionMet ? truePart.trim() : (falsePart ? falsePart.trim() : '');
                });
                return processedTemplate;
            },
            applyPhraseBricks(template, phraseBricks) { const regex = /{{brique:([^}]+)}}/g; return template.replace(regex, (match, brickName) => { return phraseBricks[brickName.trim()] || ''; }); },
            decodeHtmlEntities(text) { if (typeof text !== 'string') return text; const textarea = document.createElement('textarea'); textarea.innerHTML = text; return textarea.value; },
            translateErrorMessage(englishMessage) {
                if (typeof englishMessage !== 'string') return String(englishMessage);
                if (englishMessage.includes('Failed to fetch')) return "Échec de la connexion au service IA. Vérifiez votre connexion internet ou si le service est en ligne.";
                if (englishMessage.includes('quota') || englishMessage.includes('429')) return "Quota API dépassé ou limite de requêtes atteinte.";
                if (englishMessage.includes('401')) return "Authentification échouée. Vérifiez votre clé API.";
                if (englishMessage.includes('402') && englishMessage.includes('more credits')) return "Crédits API insuffisants. Le service (ex: OpenRouter) requiert un paiement pour continuer. Veuillez recharger votre compte sur leur site.";
                return englishMessage;
            },
            insertNodeAtCursor(editor, node) {
                editor.focus();
                const selection = window.getSelection();
                
                let range = lastSelectionRange && editor.contains(lastSelectionRange.commonAncestorContainer) 
                    ? lastSelectionRange 
                    : null;

                if (!range && selection.getRangeAt && selection.rangeCount > 0) {
                     range = selection.getRangeAt(0);
                }
                
                if (range) {
                    range.deleteContents();
                    
                    const spaceBefore = document.createTextNode(' ');
                    const spaceAfter = document.createTextNode(' ');
                    range.insertNode(spaceAfter);
                    range.insertNode(node);
                    range.insertNode(spaceBefore);

                    range.setStartAfter(node);
                    range.collapse(true);
                    
                    selection.removeAllRanges();
                    selection.addRange(range);
                    lastSelectionRange = range;
                } else {
                    editor.appendChild(document.createTextNode(' '));
                    editor.appendChild(node);
                    editor.appendChild(document.createTextNode(' '));
                }
                editor.focus();
            },
            serializeEditorToString(editor) {
                let str = '';
                editor.childNodes.forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        str += node.textContent;
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('editor-tag')) {
                        str += node.dataset.tag;
                    }
                });
                return str.replace(/\s+/g, ' ').trim();
            },
            renderTemplateToEditor(editorId, templateString) {
                const editor = document.getElementById(editorId);
                if (!editor) return;

                const observer = editorHistory[editorId]?.observer;
                if (observer) observer.disconnect();

                editor.innerHTML = '';
                if (!templateString) return;

                const regex = /({{[^}]+}})/g;
                let lastIndex = 0;
                let match;

                while ((match = regex.exec(templateString)) !== null) {
                    if (match.index > lastIndex) {
                        editor.appendChild(document.createTextNode(templateString.substring(lastIndex, match.index)));
                    }
                    const tag = match[0];
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'editor-tag';
                    tagSpan.contentEditable = 'false';
                    tagSpan.dataset.tag = tag;
                    tagSpan.textContent = tag;
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'delete-tag';
                    deleteBtn.textContent = '×';
                    tagSpan.appendChild(deleteBtn);

                    editor.appendChild(tagSpan);
                    lastIndex = regex.lastIndex;
                }

                if (lastIndex < templateString.length) {
                    editor.appendChild(document.createTextNode(templateString.substring(lastIndex)));
                }
                
                App.setupEditorObserver(editorId);
            },
        };

        // ====================================================================
        // 4. Gestion de l'Interface Utilisateur (UI)
        // ====================================================================
        const UI = {
            showNotification(message, type = 'success') {
                let notificationContainer = document.getElementById('notification-container');
                if (!notificationContainer) { notificationContainer = document.createElement('div'); notificationContainer.id = 'notification-container'; document.body.appendChild(notificationContainer); }
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
                notification.innerHTML = `${icon} ${message}`;
                notificationContainer.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => { if (notification.parentNode) notificationContainer.removeChild(notification); if (notificationContainer.children.length === 0 && notificationContainer.parentNode) { document.body.removeChild(notificationContainer); } }, 300);
                }, 3000);
            },
            showCustomConfirm(message, onConfirm) {
                const modalId = 'customConfirmModal'; let modal = document.getElementById(modalId);
                if (!modal) {
                    modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                    modal.setAttribute('role', 'alertdialog'); modal.setAttribute('aria-modal', 'true'); modal.setAttribute('aria-labelledby', 'confirmModalTitle');
                    modal.innerHTML = `<div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="confirmModalTitle">Confirmation</h2><button class="close-button" id="confirmCloseBtn" aria-label="Fermer la confirmation">×</button></div><p id="confirmMessage" style="margin-bottom: 25px;"></p><div style="display: flex; justify-content: flex-end; gap: 10px;"><button class="btn btn-secondary" id="confirmCancel" tabindex="0">Annuler</button><button class="btn btn-danger" id="confirmOk" tabindex="0">Confirmer</button></div></div>`;
                    document.body.appendChild(modal);
                }
                document.getElementById('confirmMessage').textContent = message; UI.openModal(modal);
                const confirmOk = document.getElementById('confirmOk'); const confirmCancel = document.getElementById('confirmCancel'); const confirmCloseBtn = document.getElementById('confirmCloseBtn');
                const newConfirmOk = confirmOk.cloneNode(true); confirmOk.parentNode.replaceChild(newConfirmOk, confirmOk);
                const newConfirmCancel = confirmCancel.cloneNode(true); confirmCancel.parentNode.replaceChild(newConfirmCancel, confirmCancel);
                const newConfirmCloseBtn = confirmCloseBtn.cloneNode(true); confirmCloseBtn.parentNode.replaceChild(newConfirmCloseBtn, confirmCloseBtn);
                newConfirmOk.addEventListener('click', () => { onConfirm(); UI.closeModal(modal); });
                newConfirmCancel.addEventListener('click', () => UI.closeModal(modal));
                newConfirmCloseBtn.addEventListener('click', () => UI.closeModal(modal));
            },
            toggleDarkMode() { const currentTheme = document.documentElement.getAttribute('data-theme'); document.documentElement.setAttribute('data-theme', currentTheme === 'dark' ? '' : 'dark'); UI.updateDarkModeButtonIcon(); },
            updateDarkModeButtonIcon() { if (DOM.darkModeToggle) { const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; DOM.darkModeToggle.innerHTML = isDark ? '☀️' : '🌙'; DOM.darkModeToggle.title = isDark ? 'Mode clair' : 'Mode sombre'; } },
            setQuarterMode(mode) {
                appState.currentQuarterMode = mode; document.documentElement.setAttribute('data-quarter-mode', appState.currentQuarterMode);
                DOM.quarterRadios.forEach(radio => radio.checked = (radio.value === mode)); UI.updateMassImportTooltip(mode);
                if (DOM.currentQuarterDisplayInputSection) DOM.currentQuarterDisplayInputSection.textContent = `Mode ${mode}`;
                if (DOM.inputSection) { DOM.inputSection.classList.remove('fade-in'); void DOM.inputSection.offsetWidth; DOM.inputSection.classList.add('fade-in'); }
                if (DOM.settingsModal.style.display === 'flex') {
                    UI.renderTagHelpers();
                }
                StorageManager.saveAppState();
            },
            updateMassImportTooltip(mode) {
                let tooltipText = "Format: NOM Prénom | Statut | Moy T1 | App T1";
                if (mode === 'T2') tooltipText += " | Moy T2 | App T2"; else if (mode === 'T3') tooltipText += " | Moy T2 | App T2 | Moy T3";
                tooltipText += ". Les champs sont séparés par un '|'. Les champs après 'Nom Prénom' sont optionnels selon le trimestre.";
                if (DOM.massDataTooltip) DOM.massDataTooltip.setAttribute('data-tooltip', tooltipText);
            },
            setInputMode(mode) {
                appState.currentInputMode = mode; const isMassMode = mode === 'mass';
                if (DOM.massImportSection) DOM.massImportSection.style.display = isMassMode ? 'block' : 'none';
                if (DOM.singleStudentFormDiv) DOM.singleStudentFormDiv.style.display = isMassMode ? 'none' : 'block';
                if (DOM.massImportTab) DOM.massImportTab.classList.toggle('active', isMassMode);
                if (DOM.massImportTab) DOM.massImportTab.setAttribute('aria-selected', isMassMode);
                if (DOM.singleStudentTab) DOM.singleStudentTab.classList.toggle('active', !isMassMode);
                if (DOM.singleStudentTab) DOM.singleStudentTab.setAttribute('aria-selected', !isMassMode);
                if (!isMassMode) AppreciationsManager.resetForm();
                if (DOM.inputSection) { DOM.inputSection.classList.remove('fade-in'); void DOM.inputSection.offsetWidth; DOM.inputSection.classList.add('fade-in'); }
                DOM.singleAppreciationPreview.classList.remove('show', 'has-content');
                DOM.singleAppreciationPreview.innerHTML = '<i class="fas fa-eye" style="margin-right: 10px;"></i> Cliquez sur "Prévisualiser" pour voir un aperçu ici';
                StorageManager.saveAppState();
            },
            setGenerationMode(mode) {
                appState.generationMode = mode; DOM.generationModeRadios.forEach(radio => radio.checked = (radio.value === mode));
                StorageManager.saveAppState(); UI.updateGenerateButtonIcons(); UI.updateHeaderPremiumLook(); AppreciationsManager.renderResults();
            },
            updateGenerateButtonIcons() {
                const isAIMode = appState.generationMode === 'AI'; 
                const icon = isAIMode ? '✨' : '🤖';
                if (DOM.importGenerateBtn) {
                    DOM.importGenerateBtn.innerHTML = `${icon} Importer et générer`;
                    DOM.importGenerateBtn.classList.toggle('btn-ai', isAIMode);
                }
                if (DOM.generateAppreciationBtn) {
                    DOM.generateAppreciationBtn.innerHTML = `${icon} Générer l'appréciation`;
                    DOM.generateAppreciationBtn.classList.toggle('btn-ai', isAIMode);
                }
                if (DOM.previewAppreciationBtn) {
                    DOM.previewAppreciationBtn.style.display = isAIMode ? 'inline-flex' : 'none';
                }
            },
            updateHeaderPremiumLook() {
                const header = document.querySelector('.header');
                if (!header || !DOM.aiModeBadge) return;

                const isAiActive = appState.generationMode === 'AI' && UI.checkAPIKeyPresence(true);

                // Re-trigger animation by removing and adding the class
                header.classList.remove('ai-active');
                void header.offsetWidth;

                if (isAiActive) {
                    header.classList.add('ai-active');
                    DOM.aiModeBadge.style.display = 'flex';
                } else {
                    DOM.aiModeBadge.style.display = 'none';
                }
            },
            showLoadingOverlay(message = 'Génération en cours...') { if (DOM.loadingOverlay) DOM.loadingOverlay.style.display = 'flex'; if (DOM.loadingText) DOM.loadingText.textContent = message; },
            hideLoadingOverlay() { if (DOM.loadingOverlay) DOM.loadingOverlay.style.display = 'none'; },
            showInlineSpinner(element) {
                element.dataset.originalContent = element.innerHTML;
                element.innerHTML = `<div class="loading-spinner" style="margin: auto;"></div>`;
                element.disabled = true;
            },
            hideInlineSpinner(element) {
                if (element.dataset.originalContent) {
                    element.innerHTML = element.dataset.originalContent;
                    delete element.dataset.originalContent;
                }
                element.disabled = false;
            },
            openModal(modalElement) {
                if (modalElement) {
                    if (activeModal && modalElement.id === 'helpModal') {
                        stackedModal = activeModal;
                    } else {
                        lastFocusedElement = document.activeElement;
                    }
                    modalElement.style.display = 'flex';
                    activeModal = modalElement;
                    document.body.classList.add('modal-open');

                    if(modalElement.id === 'refinementModal') {
                        const contextInput = document.getElementById('refinementContext');
                        if (contextInput) {
                            contextInput.value = '';
                            setTimeout(() => contextInput.focus(), 100);
                        }
                    }

                    const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'); 
                    if (focusableElements.length > 0) { 
                        const firstFocusable = Array.from(focusableElements).find(el => el.offsetParent !== null && !el.disabled);
                        if(firstFocusable && modalElement.id !== 'refinementModal') firstFocusable.focus();
                    }
                } 
            },
            closeModal(modalElement) { 
                if (modalElement) {
                    modalElement.style.display = 'none';

                    if (stackedModal && modalElement.id === 'helpModal') {
                        activeModal = stackedModal;
                        stackedModal = null;
                        return; // Ne pas retirer la classe modal-open et ne pas redonner le focus
                    }

                    document.body.classList.remove('modal-open');
                    if (modalElement.id !== 'helpModal') {
                        modalElement.querySelectorAll('details[open]').forEach(detail => detail.removeAttribute('open'));
                    }
                    if (lastFocusedElement) {
                        lastFocusedElement.focus();
                        lastFocusedElement = null;
                    }
                    activeModal = null;
                } 
            },
            closeAllModals() { [DOM.settingsModal, DOM.studentDetailsModal, DOM.refinementModal, DOM.statDetailsModal, DOM.helpModal, DOM.welcomeModal, document.getElementById('customConfirmModal')].forEach(modal => { if (modal) UI.closeModal(modal); }); },
            updateSettingsPromptFields() {
                const subjectName = appState.currentSettingsSubject;
                const subjectData = appState.subjects[subjectName] || appState.subjects['Standard'];
                const templates = subjectData.templates;
                const isStandard = subjectName === "Standard";

                Utils.renderTemplateToEditor('promptTemplateT1', templates.T1 || '');
                Utils.renderTemplateToEditor('promptTemplateT2', templates.T2 || '');
                Utils.renderTemplateToEditor('promptTemplateT3', templates.T3 || '');
                
                [DOM.settingsPromptT1, DOM.settingsPromptT2, DOM.settingsPromptT3].forEach(editor => {
                    editor.contentEditable = !isStandard;
                    editor.style.cursor = isStandard ? 'not-allowed' : 'text';
                    editor.closest('.template-group').querySelectorAll('button, details').forEach(el => el.style.display = isStandard ? 'none' : '');
                });

                if (DOM.currentSubjectTemplate) DOM.currentSubjectTemplate.textContent = subjectName;
                UI.renderVocabLists();
                UI.renderTagHelpers();
                App.updateTemplatePreview('promptTemplateT1');
                App.updateTemplatePreview('promptTemplateT2');
                App.updateTemplatePreview('promptTemplateT3');
            },
            updateSettingsFields() {
                if (DOM.settingsEvolutionThresholdPositive) DOM.settingsEvolutionThresholdPositive.value = appState.evolutionThresholds.positive;
                if (DOM.settingsEvolutionThresholdVeryPositive) DOM.settingsEvolutionThresholdVeryPositive.value = appState.evolutionThresholds.veryPositive;
                if (DOM.settingsEvolutionThresholdNegative) DOM.settingsEvolutionThresholdNegative.value = appState.evolutionThresholds.negative;
                if (DOM.settingsEvolutionThresholdVeryNegative) DOM.settingsEvolutionThresholdVeryNegative.value = appState.evolutionThresholds.veryNegative;
                if (DOM.wordCountLimitInput) DOM.wordCountLimitInput.value = appState.wordCountLimit;
                if (DOM.negativeInstructionsGlobal) DOM.negativeInstructionsGlobal.value = appState.instructionsGlobal;
                if (DOM.systemPromptT1) DOM.systemPromptT1.value = appState.systemPrompts.T1;
                if (DOM.systemPromptT2) DOM.systemPromptT2.value = appState.systemPrompts.T2;
                if (DOM.systemPromptT3) DOM.systemPromptT3.value = appState.systemPrompts.T3;
                if (DOM.aiModelSelect) DOM.aiModelSelect.value = appState.currentAIModel;
                if (DOM.openaiApiKey) DOM.openaiApiKey.value = appState.openaiApiKey;
                if (DOM.geminiApiKey) DOM.geminiApiKey.value = appState.geminiApiKey;
                if (DOM.mistralApiKey) DOM.mistralApiKey.value = appState.mistralApiKey;
                if (DOM.qwenApiKey) DOM.qwenApiKey.value = appState.qwenApiKey;
                if (DOM.deepseekApiKey) DOM.deepseekApiKey.value = appState.deepseekApiKey;
                if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = APP_VERSION;
                if (DOM.sessionCost) DOM.sessionCost.textContent = `${appState.sessionCost.toFixed(4)}$`;
                UI.toggleAIKeyFields(); App.renderSubjectManagementList();
            },
            updateAIPromptDisplays() {
                const studentDataExample = { nom: "MARTIN", prenom: "Lucas", moyT1: 12.5, moyT2: 13.8, moyT3: 14.2, appT1: "Bon travail en début d'année, des bases solides.", appT2: "Progression notable, continue ses efforts.", statut: "", quarterMode: "T2", subject: appState.currentSubject, generatedAppreciation: "Appréciation générée pour l'élève...", negativeInstructions: "" };
                
                const prompts = AppreciationsManager.getAllPrompts(studentDataExample);
                
                if (DOM.mainGenerationPromptDisplay) DOM.mainGenerationPromptDisplay.textContent = prompts.appreciation;
                if (DOM.strengthsWeaknessesPromptDisplay) DOM.strengthsWeaknessesPromptDisplay.textContent = prompts.sw;
                if (DOM.nextStepsPromptDisplay) DOM.nextStepsPromptDisplay.textContent = prompts.ns;
            
                // Dynamic prompt for refine section
                const originalTextExample = "Ceci est une appréciation originale.";
                const refinePrompts = {
                    concise: AppreciationsManager.getRefinementPrompt('concise', originalTextExample),
                    detailed: AppreciationsManager.getRefinementPrompt('detailed', originalTextExample),
                    encouraging: AppreciationsManager.getRefinementPrompt('encouraging', originalTextExample),
                    formal: AppreciationsManager.getRefinementPrompt('formal', originalTextExample)
                };
            
                if(DOM.refineConcisePromptDisplay) DOM.refineConcisePromptDisplay.textContent = refinePrompts.concise;
                if(DOM.refineDetailedPromptDisplay) DOM.refineDetailedPromptDisplay.textContent = refinePrompts.detailed;
                if(DOM.refineEncouragingPromptDisplay) DOM.refineEncouragingPromptDisplay.textContent = refinePrompts.encouraging;
                if(DOM.refineFormalPromptDisplay) DOM.refineFormalPromptDisplay.textContent = refinePrompts.formal;
            },
            updateStats() {
                const total = appState.generatedResults.length;
                const filtered = appState.filteredResults.length;
                if (DOM.totalCountStat) DOM.totalCountStat.textContent = filtered !== total ? `${filtered}/${total}` : total;
                if (filtered > 0) {
                    let totalGrades = 0, gradeCount = 0, progressCount = 0, stableCount = 0, regressionCount = 0, totalWords = 0, errorFreeAppreciationsCount = 0;
                    appState.filteredResults.forEach(result => {
                        if (!result.errorMessage) {
                            errorFreeAppreciationsCount++;
                            let grade = result.studentData[`moy${result.studentData.quarterMode}`];
                            if (grade !== null && typeof grade === 'number') { totalGrades += grade; gradeCount++; }
                            const relevantEvolution = AppreciationsManager.getRelevantEvolution(result.evolutions, result.studentData.quarterMode);
                            if (relevantEvolution) {
                                if (['very-positive', 'positive'].includes(relevantEvolution.type)) progressCount++;
                                else if (relevantEvolution.type === 'stable') stableCount++;
                                else if (['negative', 'very-negative'].includes(relevantEvolution.type)) regressionCount++;
                            }
                            totalWords += Utils.countWords(result.appreciation);
                        }
                    });
                    if (DOM.avgGradeOutputStat) DOM.avgGradeOutputStat.textContent = gradeCount > 0 ? (totalGrades / gradeCount).toFixed(1) : '-';
                    if (DOM.progressCountStat) DOM.progressCountStat.textContent = progressCount;
                    if (DOM.stableCountStat) DOM.stableCountStat.textContent = stableCount;
                    if (DOM.regressionCountStat) DOM.regressionCountStat.textContent = regressionCount;
                    if (DOM.avgWordsStat) DOM.avgWordsStat.textContent = errorFreeAppreciationsCount > 0 ? Math.round(totalWords / errorFreeAppreciationsCount) : 0;
                } else {
                    if (DOM.avgGradeOutputStat) DOM.avgGradeOutputStat.textContent = '-'; if (DOM.progressCountStat) DOM.progressCountStat.textContent = '0';
                    if (DOM.stableCountStat) DOM.stableCountStat.textContent = '0'; if (DOM.regressionCountStat) DOM.regressionCountStat.textContent = '0';
                    if (DOM.avgWordsStat) DOM.avgWordsStat.textContent = '0';
                }
            },
            updateProgressBar(current, total) { const progress = total > 0 ? (current / total) * 100 : 0; if (DOM.progressFill) DOM.progressFill.style.width = `${progress}%`; if (DOM.progressText) DOM.progressText.textContent = `${current}/${total} élèves traités`; },
            resetProgressBar() { if (DOM.progressContainer) DOM.progressContainer.style.display = 'none'; UI.updateProgressBar(0,0); },
            showSettingsTab(tabName) {
                DOM.settingsModal.querySelectorAll('.tab-content').forEach(content => { content.style.display = 'none'; content.classList.remove('active'); });
                DOM.settingsModal.querySelectorAll('.settings-tab').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-selected', 'false'); });
                const tabContent = document.getElementById(`${tabName}TabContent`); if (tabContent) { tabContent.style.display = 'block'; tabContent.classList.add('active'); }
                const tabButton = DOM.settingsModal.querySelector(`.settings-tab[data-tab="${tabName}"]`); if (tabButton) { tabButton.classList.add('active'); tabButton.setAttribute('aria-selected', 'true'); }
            },
            showStatDetails(statId) {
                let title = '', content = ''; const thresholds = appState.evolutionThresholds;
                switch (statId) {
                    case 'totalCount': title = "Total d'élèves"; content = "Nombre total d'appréciations générées et affichées (filtrées si recherche active)."; break;
                    case 'avgGradeOutput': title = "Moyenne générale"; content = "Moyenne des notes du trimestre en cours pour les élèves affichés (notes valides uniquement)."; break;
                    case 'progressCount': title = "Élèves en progrès"; content = `Élèves avec progression 'notable' (≥${thresholds.positive}pts) ou 'très forte' (≥${thresholds.veryPositive}pts) vs trimestre précédent. Les seuils sont <a href="#" class="link-to-settings" data-target-tab="options" data-target-element="evolutionThresholdPositive">paramétrables</a>.`; break;
                    case 'stableCount': title = "Élèves stables"; content = `Élèves dont la moyenne est restée stable (variation < seuils de progrès/régression) vs trimestre précédent. Les seuils sont <a href="#" class="link-to-settings" data-target-tab="options" data-target-element="evolutionThresholdPositive">paramétrables</a>.`; break;
                    case 'regressionCount': title = "Élèves en régression"; content = `Élèves avec recul 'léger' (≤${thresholds.negative}pts) ou 'forte baisse' (≤${thresholds.veryNegative}pts) vs trimestre précédent. Les seuils sont <a href="#" class="link-to-settings" data-target-tab="options" data-target-element="evolutionThresholdNegative">paramétrables</a>.`; break;
                    case 'avgWords': title = "Mots par appréciation"; content = "Nombre moyen de mots par appréciation générée (hors erreurs)."; break;
                    default: title = "Information"; content = "Détails non disponibles.";
                }
                const titleElement = document.getElementById('statDetailsModalTitle');
                if (titleElement) titleElement.textContent = title; 
                
                if (DOM.statDetailsContent) {
                    DOM.statDetailsContent.innerHTML = content;
                    const link = DOM.statDetailsContent.querySelector('.link-to-settings');
                    if (link) {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            UI.closeModal(DOM.statDetailsModal);
                            UI.openModal(DOM.settingsModal);
                            const tab = link.dataset.targetTab;
                            const elementId = link.dataset.targetElement;
                            UI.showSettingsTab(tab);
                            setTimeout(() => {
                                const targetElement = document.getElementById(elementId);
                                if (targetElement) {
                                    targetElement.focus();
                                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                        });
                    }
                }
                UI.openModal(DOM.statDetailsModal);
            },
            toggleAIKeyFields() {
                if (!DOM.aiModelSelect) return; const selectedModel = DOM.aiModelSelect.value;
                const keyGroups = { openai: DOM.openaiApiKeyGroup, gemini: DOM.geminiApiKeyGroup, mistral: DOM.mistralApiKeyGroup, qwen: DOM.qwenApiKeyGroup, deepseek: DOM.deepseekApiKeyGroup };
                Object.values(keyGroups).forEach(group => { if (group) group.style.display = 'none'; });
                [DOM.openaiApiKeyError, DOM.geminiApiKeyError, DOM.mistralApiKeyError, DOM.qwenApiKeyError, DOM.deepseekApiKeyError].forEach(el => { if(el) el.style.display = 'none';});
                if (selectedModel.startsWith('openai')) { if (keyGroups.openai) keyGroups.openai.style.display = 'block'; }
                else if (selectedModel.startsWith('gemini')) { if (keyGroups.gemini) keyGroups.gemini.style.display = 'block'; if (DOM.geminiApiKeyHint) { DOM.geminiApiKeyHint.textContent = CONFIG.API_KEY ? 'Clé Canvas détectée. Laissez vide pour utiliser la clé par défaut ou saisissez la vôtre pour la remplacer.' : 'Saisissez votre clé API Gemini (Ex: AIzaSy...). Elle est stockée localement et n\'est jamais partagée.'; if (DOM.geminiApiKey) DOM.geminiApiKey.placeholder = CONFIG.API_KEY ? 'AIzaSy... (Clé Canvas/Utilisateur)' : 'AIzaSy... (Votre clé API Gemini)'; } }
                else if (selectedModel.startsWith('mistral')) { if (keyGroups.mistral) keyGroups.mistral.style.display = 'block'; }
                else if (selectedModel.startsWith('qwen')) { if (keyGroups.qwen) keyGroups.qwen.style.display = 'block'; }
                else if (selectedModel.startsWith('deepseek')) { if (keyGroups.deepseek) keyGroups.deepseek.style.display = 'block'; }
            },
            checkAPIKeyPresence(silent = false) {
                const model = appState.currentAIModel; let keyToCheck = ''; let keyName = ''; let errorElementId = '';
                if (model.startsWith('gemini')) { keyToCheck = appState.geminiApiKey || CONFIG.API_KEY; keyName = 'Gemini'; errorElementId = 'geminiApiKeyError'; }
                else if (model.startsWith('openai')) { keyToCheck = appState.openaiApiKey; keyName = 'OpenAI'; errorElementId = 'openaiApiKeyError'; }
                else if (model.startsWith('deepseek')) { keyToCheck = appState.deepseekApiKey; keyName = 'DeepSeek/OpenRouter'; errorElementId = 'deepseekApiKeyError'; }
                else if (model.startsWith('mistral')) { keyToCheck = appState.mistralApiKey; keyName = 'Mistral'; errorElementId = 'mistralApiKeyError'; }
                else if (model.startsWith('qwen')) { keyToCheck = appState.qwenApiKey; keyName = 'Qwen'; errorElementId = 'qwenApiKeyError'; }
                const errorElement = document.getElementById(errorElementId);
                if (keyName && !keyToCheck) {
                    if (!silent) {
                        UI.showNotification(`Clé API ${keyName} manquante. Configurez-la dans les paramètres ou le mode Automate sera utilisé.`, 'warning');
                        if (errorElement && DOM.settingsModal.style.display === 'flex' && DOM.advancedTabContent.style.display === 'block') { errorElement.textContent = `⚠️ Clé API ${keyName} requise pour ce modèle.`; errorElement.style.display = 'block'; }
                    }
                    return false;
                }
                if (errorElement) errorElement.style.display = 'none'; return true;
            },
            renderVocabList(containerElement, vocabArray, type) {
                containerElement.innerHTML = ''; if (vocabArray.length === 0) { containerElement.innerHTML = '<p style="color: var(--summary-details-color); text-align: center; font-style: italic;">Aucun élément.</p>'; return; }
                vocabArray.forEach((item, index) => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'vocab-item';
                    itemDiv.innerHTML = `<span class="vocab-item-text" contenteditable="true" data-index="${index}" data-type="${type}" tabindex="0">${item}</span><div class="vocab-item-actions"><button data-action="delete" data-index="${index}" data-type="${type}" aria-label="Supprimer cet élément">🗑️</button></div>`;
                    containerElement.appendChild(itemDiv);
                });
            },
            renderPhraseBricksList(containerElement, phraseBricksObject) {
                containerElement.innerHTML = ''; const keys = Object.keys(phraseBricksObject);
                if (keys.length === 0) { containerElement.innerHTML = '<p style="color: var(--summary-details-color); text-align: center; font-style: italic;">Aucune brique de phrase.</p>'; return; }
                keys.forEach((key) => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'vocab-item';
                    itemDiv.innerHTML = `<span class="vocab-item-text" contenteditable="true" data-key="${key}" data-type="phraseBrick" tabindex="0"><b>${key}</b>: ${phraseBricksObject[key]}</span><div class="vocab-item-actions"><button data-action="delete" data-key="${key}" data-type="phraseBrick" aria-label="Supprimer cette brique de phrase">🗑️</button></div>`;
                    containerElement.appendChild(itemDiv);
                });
            },
            renderVocabLists() {
                const subject = appState.subjects[appState.currentSettingsSubject];
                if (!subject) return;

                const vocab = subject.vocabulaire;
                const isStandard = appState.currentSettingsSubject === 'Standard';

                UI.renderVocabList(DOM.vocabCompetencesList, vocab.competences, 'competences');
                UI.renderVocabList(DOM.vocabQualitesList, vocab.qualites, 'qualites');
                UI.renderVocabList(DOM.vocabActivitesList, vocab.activites, 'activites');
                UI.renderPhraseBricksList(DOM.phraseBricksList, vocab.phraseBricks);
                
                DOM.vocabContainers.forEach(c => c.classList.toggle('disabled', isStandard));
                DOM.vocabAddForms.forEach(f => f.classList.toggle('disabled', isStandard));
                DOM.resetVocabBtn.style.display = isStandard ? 'none' : 'inline-flex';
                DOM.vocabStandardInfo.style.display = isStandard ? 'inline-flex' : 'none';

                if (DOM.currentSubjectVocab) DOM.currentSubjectVocab.textContent = appState.currentSettingsSubject;
            },
            populateSubjectSelect() {
                if (!DOM.subjectSelect) return;
                const selectedValue = appState.currentSubject;
                DOM.subjectSelect.innerHTML = '';
                
                const subjects = Object.keys(appState.subjects);
                const sortedSubjects = ["Standard", ...subjects.filter(s => s !== "Standard").sort()];

                sortedSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    DOM.subjectSelect.appendChild(option);
                });

                if (subjects.includes(selectedValue)) {
                    DOM.subjectSelect.value = selectedValue;
                } else {
                    DOM.subjectSelect.value = "Standard";
                    appState.currentSubject = "Standard";
                }
                App.renderSubjectManagementList();
            },
            renderTagHelpers() {
                const subjectVocab = appState.subjects[appState.currentSettingsSubject]?.vocabulaire || DEFAULT_VOCABULAIRE;
                const createTag = (name, tooltip, className = '') => ({ name, tooltip, className });

                const baseTags = [
                    createTag('{{prenom}}', "Insère le prénom de l'élève."),
                    createTag('{{niveauGlobal}}', "Insère une appréciation globale (ex: 'Bon travail') basée sur la note actuelle."),
                    createTag('{{encouragement}}', "Insère une phrase d'encouragement aléatoire."),
                    createTag('{{competence_aleatoire}}', "Insère une compétence aléatoire de votre liste de vocabulaire.", 'custom'),
                    createTag('{{qualite_aleatoire}}', "Insère une qualité aléatoire de votre liste de vocabulaire.", 'custom'),
                    createTag('{{activite_aleatoire}}', "Insère une activité aléatoire de votre liste de vocabulaire.", 'custom'),
                ];
                const quarterTags = {
                    T1: [ createTag('{{moyT1}}', 'Insère la moyenne du T1.'), createTag('{{appT1}}', 'Insère l\'appréciation du T1.') ],
                    T2: [ createTag('{{moyT1}}', 'Insère la moyenne du T1.'), createTag('{{appT1}}', 'Insère l\'appréciation du T1.'), createTag('{{moyT2}}', 'Insère la moyenne du T2.'), createTag('{{appT2}}', 'Insère l\'appréciation du T2.'), createTag('{{evolution_phrase}}', 'Insère une phrase décrivant l\'évolution T1-T2.', 'evolution') ],
                    T3: [ createTag('{{moyT1}}', 'Insère la moyenne du T1.'), createTag('{{appT1}}', 'Insère l\'appréciation du T1.'), createTag('{{moyT2}}', 'Insère la moyenne du T2.'), createTag('{{appT2}}', 'Insère l\'appréciation du T2.'), createTag('{{moyT3}}', 'Insère la moyenne du T3.'), createTag('{{evolution_phrase}}', 'Insère une phrase décrivant l\'évolution T2-T3.', 'evolution') ]
                };

                const evolutionBlocks = [
                    createTag('{{evolution:positive}}...{{/evolution:positive}}', "Ce bloc de texte ne s'affichera QUE si l'élève est en progression.", 'evolution'),
                    createTag('{{evolution:stable}}...{{/evolution:stable}}', "Ce bloc de texte ne s'affichera QUE si l'élève est stable.", 'evolution'),
                    createTag('{{evolution:negative}}...{{/evolution:negative}}', "Ce bloc de texte ne s'affichera QUE si l'élève est en régression.", 'evolution')
                ];

                ['T1', 'T2', 'T3'].forEach(q => {
                    const container = document.getElementById(`tags${q}`);
                    if (!container) return;
                    container.innerHTML = '';
                    
                    let availableTags = [...baseTags, ...quarterTags[q]];
                    if (q !== 'T1') {
                        availableTags.push(...evolutionBlocks);
                    }
                    
                    Object.keys(subjectVocab.phraseBricks).sort().forEach(brickName => {
                        availableTags.push(createTag(`{{brique:${brickName}}}`, `Insère la brique de phrase personnalisée : "${subjectVocab.phraseBricks[brickName]}"`, 'custom'));
                    });
                    
                    availableTags.forEach(tag => {
                        const pill = document.createElement('span');
                        pill.className = `tag-pill tooltip ${tag.className}`;
                        pill.textContent = tag.name;
                        pill.dataset.targetEditor = `promptTemplate${q}`;
                        pill.setAttribute('data-tooltip', tag.tooltip);
                        container.appendChild(pill);
                    });
                });
            },
            updateHelpImportFormat(formatType) {
                const structureEl = document.getElementById('helpFormatStructure');
                const exampleEl = document.getElementById('helpFormatExample');
                if (!structureEl || !exampleEl) return;

                const formats = {
                    T1: {
                        structure: "NOM Prénom | Statut | Moy T1 | App T1",
                        example: "DUPONT Chloé | | 14,5 | Très bon début de trimestre, élève sérieuse et engagée."
                    },
                    T2: {
                        structure: "NOM Prénom | Statut | Moy T1 | App T1 | Moy T2 | App T2",
                        example: "PETIT Léo | Nouveau T2 | 11,0 | Débuts corrects. | 12,8 | A montré une belle progression et plus d'aisance."
                    },
                    T3: {
                        structure: "NOM Prénom | Statut | Moy T1 | App T1 | Moy T2 | App T2 | Moy T3",
                        example: "MERCIER Manon | | 16,2 | Excellent T1. | 15,5 | Léger recul mais reste solide. | 16,8"
                    }
                };

                const selectedFormat = formats[formatType] || formats.T1;
                structureEl.textContent = selectedFormat.structure;
                exampleEl.textContent = selectedFormat.example;

                const selector = document.getElementById('helpFormatSelector');
                if(selector) {
                    selector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    selector.querySelector(`button[data-format="${formatType}"]`).classList.add('active');
                }
            },
            updateWordCount(elementId, text) {
                const el = document.getElementById(elementId);
                if(el) {
                    const count = Utils.countWords(text);
                    el.textContent = `${count} mot${count > 1 ? 's' : ''}`;
                }
            },
            updateControlButtons() {
                const visibleResults = appState.filteredResults;
                const hasErrors = visibleResults.some(r => r.errorMessage);

                DOM.regenerateAllBtn.disabled = visibleResults.length === 0;
                DOM.regenerateErrorsBtn.style.display = hasErrors ? 'inline-flex' : 'none';
            }
        };

        // ====================================================================
        // 5. Gestion des Appréciations
        // ====================================================================
        const AppreciationsManager = {
            createResultObject(nom, prenom, appreciation, evolutions, studentData, prompts, tokenUsage, errorMessage = null) {
                const uniqueId = Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                return {
                    id: uniqueId, nom, prenom, appreciation, evolutions,
                    studentData: {
                        ...studentData,
                        generatedAppreciation: appreciation,
                        quarterMode: appState.currentQuarterMode,
                        subject: appState.currentSubject,
                        generationMode: appState.generationMode,
                        negativeInstructions: studentData.negativeInstructions || '',
                        currentAIModel: appState.currentAIModel,
                        prompts: prompts || { appreciation: null, sw: null, ns: null }
                    },
                    errorMessage, timestamp: new Date().toISOString(), strengthsWeaknesses: null, nextSteps: null,
                    tokenUsage: tokenUsage || { appreciation: null, sw: null, ns: null },
                    copied: false
                };
            },
            getRelevantEvolution(evolutions, currentQuarter) {
                if (currentQuarter === 'T1' || !evolutions) return null;
                if (currentQuarter === 'T3') return evolutions.find(e => e.periode === 'T2-T3') || evolutions.find(e => e.periode === 'T1-T3');
                if (currentQuarter === 'T2') return evolutions.find(e => e.periode === 'T1-T2');
                return null;
            },
            analyserEvolution(t1, t2, t3) {
                const evolutions = []; const thresholds = appState.evolutionThresholds;
                const determineEvolutionType = (diff) => {
                    if (diff === null || isNaN(diff)) return 'stable';
                    if (diff >= thresholds.veryPositive) return 'very-positive';
                    if (diff >= thresholds.positive) return 'positive';
                    if (diff <= thresholds.veryNegative) return 'very-negative';
                    if (diff <= thresholds.negative) return 'negative';
                    return 'stable';
                };

                const calculateAndPush = (v1, v2, periode) => {
                    if (v1 !== null && v2 !== null && typeof v1 === 'number' && typeof v2 === 'number') {
                        const diff = v2 - v1;
                        const roundedDiff = parseFloat(diff.toFixed(2));
                        evolutions.push({ type: determineEvolutionType(roundedDiff), valeur: roundedDiff, periode });
                    }
                };

                calculateAndPush(t1, t2, 'T1-T2');
                calculateAndPush(t2, t3, 'T2-T3');
                calculateAndPush(t1, t3, 'T1-T3');

                return evolutions;
            },
            determineNiveauGlobal(grade) {
                if (grade === null || typeof grade !== 'number') return 'Niveau non renseigné';
                if (grade >= 17) return 'Très bon travail'; if (grade >= 14) return 'Bon travail';
                if (grade >= 10) return 'Travail satisfaisant'; if (grade >= 7) return 'Travail insuffisant';
                return 'Travail très insuffisant';
            },
            getEncouragementPhrase() {
                const encouragements = ["Il/Elle est encouragé(e) à poursuivre ses efforts.", "Il/Elle doit continuer sur cette voie.", "Une persévérance constante est attendue.", "Je l'encourage à maintenir ce niveau d'engagement.", "Il/Elle peut encore progresser avec de l'investissement."];
                return Utils.getRandomElement(encouragements);
            },
            getEvolutionPhrase(evolutions, currentQuarter) {
                const relevantEvolution = this.getRelevantEvolution(evolutions, currentQuarter);
                if (!relevantEvolution) return "son évolution n'a pas pu être déterminée.";
                const diff = relevantEvolution.valeur;
                 if (diff === null || isNaN(diff)) return "un niveau stable (données antérieures manquantes)";
                const absDiff = Math.abs(diff).toFixed(1).replace('.',',');
                switch (relevantEvolution.type) {
                    case 'very-positive': return `une très forte progression de ${absDiff} point(s)`;
                    case 'positive': return `une bonne progression de ${absDiff} point(s)`;
                    case 'stable': return `un niveau stable`;
                    case 'negative': return `un léger recul de ${absDiff} point(s)`;
                    case 'very-negative': return `une forte baisse de ${absDiff} point(s)`;
                    default: return `une évolution non déterminée`;
                }
            },
            getAllPrompts(studentData) {
                const { nom, prenom, statut, moyT1, appT1, moyT2, appT2, moyT3, quarterMode, negativeInstructions } = studentData;
                const evolutions = this.analyserEvolution(moyT1, moyT2, moyT3);
                const templateText = this.buildAppreciationTextFromTemplate(studentData);
                const fullInstructions = [appState.instructionsGlobal, negativeInstructions].filter(Boolean).join('. ').trim();
                const instructionsPart = fullInstructions ? ` Instructions supplémentaires : "${fullInstructions}".` : '';
                
                let systemPrompt = appState.systemPrompts[quarterMode] || DEFAULT_SYSTEM_PROMPTS[quarterMode];
                systemPrompt = systemPrompt.replace('{matiere}', appState.currentSubject)
                                         .replace('{prenom}', prenom)
                                         .replace('{nom}', nom)
                                         .replace('{word_limit}', appState.wordCountLimit);

                const appreciationPrompt = `${systemPrompt}${instructionsPart}\n\nContexte et Template :\n${templateText}\n\nInformations complètes de l'élève :\nNom : ${nom}\nPrénom : ${prenom}\nStatut : ${statut || 'Aucun'}\nMoyenne T1 : ${moyT1 !== null && typeof moyT1 === 'number' ? moyT1.toFixed(1).replace('.', ',') : 'N/A'}\nAppréciation T1 : "${appT1 || 'Non renseigné'}"\nMoyenne T2 : ${moyT2 !== null && typeof moyT2 === 'number' ? moyT2.toFixed(1).replace('.', ',') : 'N/A'}\nAppréciation T2 : "${appT2 || 'Non renseigné'}"\nMoyenne T3 : ${moyT3 !== null && typeof moyT3 === 'number' ? moyT3.toFixed(1).replace('.', ',') : 'N/A'}\nTrimestre actuel : ${quarterMode}\nÉvolution des moyennes : ${JSON.stringify(evolutions)}`;
                const swPrompt = `Analyse les informations suivantes et suggère 2-3 points forts et 2-3 points faibles. Formate ta réponse en deux listes avec les titres "Points Forts:" et "Points Faibles:". N'invente pas d'informations.${instructionsPart}\n\nDonnées de l'élève :\nMoyennes : T1: ${moyT1?.toFixed(1) || 'N/A'}, T2: ${moyT2?.toFixed(1) || 'N/A'}, T3: ${moyT3?.toFixed(1) || 'N/A'}\nAppréciation actuelle : "${studentData.generatedAppreciation || 'Non générée'}"`;
                const nsPrompt = `Analyse les données suivantes et suggère les 3 pistes d'amélioration les plus pertinentes, concrètes et actionnables pour cet élève en ${appState.currentSubject}. Retourne une liste numérotée.${instructionsPart}\n\nDonnées de l'élève :\nAppréciation actuelle : "${studentData.generatedAppreciation || 'Non générée'}"\nMoyennes : T1: ${moyT1?.toFixed(1) || 'N/A'}, T2: ${moyT2?.toFixed(1) || 'N/A'}, T3: ${moyT3?.toFixed(1) || 'N/A'}`;
                
                return { appreciation: appreciationPrompt, sw: swPrompt, ns: nsPrompt, instructionsPart };
            },
            getRefinementPrompt(refineType, originalText) {
                const contextInstruction = DOM.refinementContext.value.trim();
                let instructionParts = [];
            
                if (refineType === 'detailed') {
                    const originalWordCount = Utils.countWords(originalText);
                    const targetWordCount = Math.round(Math.min(originalWordCount * 1.3, appState.wordCountLimit * 1.2));
                    instructionParts.push(`plus détaillée (autour de ${targetWordCount} mots)`);
                } else {
                    const styleMap = { 'concise': 'plus concise (max 30 mots)', 'encouraging': 'plus encourageante', 'formal': 'plus formelle' };
                    if (styleMap[refineType]) {
                        instructionParts.push(`en la rendant ${styleMap[refineType]}`);
                    }
                }
            
                if (contextInstruction && refineType === 'context') {
                    instructionParts.push(`en tenant compte de ce nouvel élément : "${contextInstruction}"`);
                }
            
                if (instructionParts.length === 0) return null;
            
                return `Reformule l'appréciation suivante : "${originalText}", ${instructionParts.join(' et ')}. Retourne UNIQUEMENT le texte de l'appréciation reformulée, sans aucun commentaire, sans guillemets et sans mention du nombre de mots.`;
            },
            buildAppreciationTextFromTemplate(studentData) {
                const { prenom, moyT1, appT1, moyT2, appT2, moyT3, quarterMode, statut } = studentData;
                const subjectData = appState.subjects[appState.currentSubject] || appState.subjects['Standard'];
                let template = subjectData.templates?.[quarterMode] || DEFAULT_PROMPT_TEMPLATES['Standard'].templates[quarterMode];
                if (!template) return "Erreur : Template non trouvé.";
                
                const evolutions = this.analyserEvolution(moyT1, moyT2, moyT3);
                const currentGrade = quarterMode === 'T1' ? moyT1 : quarterMode === 'T2' ? moyT2 : moyT3;
                const studentDataForTemplate = { prenom, moyT1, moyT2, moyT3, statut, quarterMode, niveauGlobal: AppreciationsManager.determineNiveauGlobal(currentGrade), evolution_phrase: AppreciationsManager.getEvolutionPhrase(evolutions, quarterMode), encouragement: AppreciationsManager.getEncouragementPhrase(), competence_aleatoire: Utils.getRandomElement(subjectData.vocabulaire.competences), qualite_aleatoire: Utils.getRandomElement(subjectData.vocabulaire.qualites), activite_aleatoire: Utils.getRandomElement(subjectData.vocabulaire.activites), appT1, appT2 };
                
                let appreciationText = Utils.applyConditionalLogic(template, studentDataForTemplate, evolutions);
                appreciationText = Utils.applyPhraseBricks(appreciationText, subjectData.vocabulaire.phraseBricks);
                
                appreciationText = appreciationText.replace(/{{([^}]+)}}/g, (match, p1) => studentDataForTemplate[p1.trim()] ?? match);

                return appreciationText.replace(/{{[^}]+}}/g, '').trim();
            },
            async generateAppreciation(studentData, isPreview = false) {
                const evolutions = this.analyserEvolution(studentData.moyT1, studentData.moyT2, studentData.moyT3);
                let appreciation = '', prompts = {}, tokenUsage = { appreciation: null, sw: null, ns: null };

                if (appState.generationMode === 'AI') {
                    if (!UI.checkAPIKeyPresence()) {
                        throw new Error("Clé API manquante. Appréciation générée via template.");
                    }
                    prompts = this.getAllPrompts({ ...studentData, generatedAppreciation: '' });
                    const aiResponse = await this.callAI(prompts.appreciation);
                    appreciation = aiResponse.text; tokenUsage.appreciation = aiResponse.usage;
                    if (Utils.countWords(appreciation) > appState.wordCountLimit * 1.2) { appreciation = appreciation.split(/\s+/).slice(0, appState.wordCountLimit).join(' ') + '...'; }
                } else {
                    appreciation = this.buildAppreciationTextFromTemplate(studentData);
                }

                if (isPreview) return appreciation;
                return this.createResultObject(studentData.nom, studentData.prenom, appreciation, evolutions, studentData, prompts, tokenUsage, null);
            },
            async callAI(prompt, isValidation = false, apiKeyOverride = null) {
                let apiKey, apiUrl, modelForPayload;
                const headers = { 'Content-Type': 'application/json' };
                let payload = {};

                if (isValidation) {
                    apiKey = apiKeyOverride;
                    apiUrl = `${CONFIG.OPENAI_API_BASE}/models`;
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'GET', headers });
                    if (!response.ok) throw new Error(`Clé API invalide ou problème réseau (${response.status})`);
                    return { text: 'Validation réussie', usage: null };
                }
                
                const selectedModelOption = appState.currentAIModel;
                
                if (selectedModelOption.startsWith('gemini')) {
                    apiKey = apiKeyOverride || appState.geminiApiKey || CONFIG.API_KEY; if (!apiKey) throw new Error(`Clé API Gemini non configurée.`);
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModelOption}:generateContent?key=${apiKey}`; payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                } else if (selectedModelOption.startsWith('openai')) {
                    apiKey = apiKeyOverride || appState.openaiApiKey; if (!apiKey) throw new Error(`Clé API OpenAI non configurée.`);
                    apiUrl = `${CONFIG.OPENAI_API_BASE}/chat/completions`; headers['Authorization'] = `Bearer ${apiKey}`;
                    modelForPayload = selectedModelOption.replace('openai-', ''); payload = { model: modelForPayload, messages: [{ role: "user", content: prompt }] };
                } else if (selectedModelOption.startsWith('deepseek')) {
                    apiKey = appState.deepseekApiKey; if (!apiKey) throw new Error(`Clé API DeepSeek/OpenRouter non configurée.`);
                    const isUsingOpenRouter = apiKey.startsWith('sk-or-');
                    if (isUsingOpenRouter) { apiUrl = `${CONFIG.OPENROUTER_API_BASE}/chat/completions`; headers['Authorization'] = `Bearer ${apiKey}`; headers['HTTP-Referer'] = `${window.location.protocol}//${window.location.hostname}`; headers['X-Title'] = `Trimestre en Main`; modelForPayload = 'deepseek/deepseek-chat'; }
                    else { apiUrl = `${CONFIG.DEEPSEEK_API_BASE}/chat/completions`; headers['Authorization'] = `Bearer ${apiKey}`; modelForPayload = 'deepseek-chat'; }
                    headers['Accept'] = `application/json`; payload = { model: modelForPayload, messages: [{ role: "user", content: prompt }], };
                } else if (selectedModelOption.startsWith('mistral') || selectedModelOption.startsWith('qwen')) {
                    const modelName = selectedModelOption.startsWith('mistral') ? 'Mistral' : 'Qwen';
                    console.warn(`L'appel à l'API ${modelName} (${selectedModelOption}) n'est pas encore implémenté.`);
                    UI.showNotification(`L'API ${modelName} (${selectedModelOption}) n'est pas encore prise en charge pour la génération.`, 'warning');
                    return { text: `(Appel à ${modelName} API pour '${selectedModelOption}' non implémenté)`, usage: null };
                } else { throw new Error("Modèle d'IA non supporté ou configuration d'appel manquante."); }
                
                const response = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
                const result = await response.json();

                if (!response.ok) { console.error("Erreur API:", result); let errorMessage = `Erreur API ${response.status}`; const errorDetails = result.error?.message || result.error || result.message || result.detail; if (errorDetails) errorMessage += `: ${errorDetails}`; throw new Error(errorMessage); }
                
                let textResult = '';
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) { textResult = result.candidates[0].content.parts[0].text; }
                else if (result.choices?.[0]?.message?.content) { textResult = result.choices[0].message.content; }
                else { throw new Error("Réponse de l'IA inattendue ou non gérée pour le modèle sélectionné."); }

                let inputTokens = 0, outputTokens = 0;
                if (result.usage) { 
                    inputTokens = result.usage.prompt_tokens;
                    outputTokens = result.usage.completion_tokens;
                } else if (selectedModelOption.startsWith('gemini') && result.usageMetadata) { 
                    inputTokens = result.usageMetadata.promptTokenCount;
                    outputTokens = result.usageMetadata.candidatesTokenCount;
                }
                
                const modelKey = (selectedModelOption.startsWith('deepseek') && apiKey.startsWith('sk-or-')) ? 'deepseek/deepseek-chat' : (selectedModelOption.startsWith('openai') ? selectedModelOption.replace('openai-','') : selectedModelOption);
                if(COSTS_PER_MILLION_TOKENS[modelKey]) {
                    const cost = (inputTokens / 1000000 * COSTS_PER_MILLION_TOKENS[modelKey].input) +                                  (outputTokens / 1000000 * COSTS_PER_MILLION_TOKENS[modelKey].output);
                    appState.sessionCost += cost;
                    DOM.sessionCost.textContent = `${appState.sessionCost.toFixed(4)}$`;
                }
                
                const usageData = { prompt_tokens: inputTokens, completion_tokens: outputTokens, total_tokens: inputTokens + outputTokens };
                return { text: textResult, usage: usageData };
            },
            async generateSingleAppreciation(isPreview = false) {
                [DOM.nomError, DOM.prenomError, DOM.moyT1Error, DOM.moyT2Error, DOM.moyT3Error].forEach(el => { if(el) el.style.display = 'none'; });
                let isValid = Utils.validateInput(DOM.nomInput) && Utils.validateInput(DOM.prenomInput);
                isValid = Utils.validateGrade(DOM.moyT1Input) && isValid;
                isValid = Utils.validateGrade(DOM.moyT2Input) && isValid;
                isValid = Utils.validateGrade(DOM.moyT3Input) && isValid;
                if (!isValid) { 
                    if (!isPreview) UI.showNotification('Veuillez corriger les erreurs.', 'error'); 
                    return; 
                }
                
                if (isPreview) {
                    DOM.previewAppreciationBtn.disabled = true;
                    UI.showInlineSpinner(DOM.previewAppreciationBtn);
                } else {
                    UI.showLoadingOverlay('Génération en cours...');
                }

                const parseGradeInput = (inputElement) => { const valueStr = inputElement.value.trim().replace(',', '.'); return valueStr === '' ? null : parseFloat(valueStr); };
                const studentData = { nom: DOM.nomInput.value.trim().toUpperCase(), prenom: DOM.prenomInput.value.trim(), statut: DOM.statutSelect.value, moyT1: parseGradeInput(DOM.moyT1Input), appT1: DOM.appT1Textarea.value.trim(), moyT2: parseGradeInput(DOM.moyT2Input), appT2: DOM.appT2Textarea.value.trim(), moyT3: parseGradeInput(DOM.moyT3Input), quarterMode: appState.currentQuarterMode, subject: appState.currentSubject, negativeInstructions: DOM.negativeInstructions.value.trim() };
                try {
                    const result = await AppreciationsManager.generateAppreciation(studentData, false); // Always generate full object
                    
                    if (isPreview) {
                        DOM.singleAppreciationPreview.innerHTML = Utils.decodeHtmlEntities(Utils.cleanMarkdown(result.appreciation));
                        DOM.singleAppreciationPreview.classList.add('show', 'has-content');
                    } else {
                        if (appState.currentEditingId) {
                            const index = appState.generatedResults.findIndex(r => r.id === appState.currentEditingId);
                            if (index > -1) {
                                result.id = appState.currentEditingId; 
                                appState.generatedResults[index] = result;
                                UI.showNotification('Appréciation modifiée !', 'success');
                                const editedCard = document.querySelector(`.appreciation-result[data-id="${result.id}"]`);
                                if(editedCard) editedCard.classList.remove('is-editing');
                            }
                        } else {
                            appState.generatedResults.unshift(result);
                            UI.showNotification('Appréciation générée !', 'success');
                        }
                        
                        AppreciationsManager.resetForm();
                        AppreciationsManager.renderResults();
                    }
                } catch (error) {
                    console.error('Erreur génération:', error);
                    const translatedError = Utils.translateErrorMessage(error.message);
                    UI.showNotification(`Erreur : ${translatedError}`, 'error');
                    if (isPreview) { DOM.singleAppreciationPreview.textContent = `Erreur : ${translatedError}`; DOM.singleAppreciationPreview.classList.add('show', 'has-content'); }
                } finally {
                    if (isPreview) {
                        DOM.previewAppreciationBtn.disabled = false;
                        UI.hideInlineSpinner(DOM.previewAppreciationBtn);
                    } else {
                        UI.hideLoadingOverlay();
                    }
                }
            },
            async processMassImport() {
                const massData = DOM.massData.value.trim();
                if (!massData) { UI.showNotification('Veuillez coller des données ou importer un fichier.', 'warning'); return; }
                const lines = massData.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) { UI.showNotification('Aucune donnée valide à traiter.', 'warning'); return; }
                if (DOM.progressContainer) DOM.progressContainer.style.display = 'block';
                UI.updateProgressBar(0, lines.length);
                if (DOM.cancelImportBtn) DOM.cancelImportBtn.style.display = 'inline-flex';
                appState.isMassImportCancelled = false;
                
                for (let i = 0; i < lines.length; i++) {
                    if (appState.isMassImportCancelled) { UI.showNotification('Importation annulée.', 'warning'); break; }
                    UI.updateProgressBar(i + 1, lines.length);
                    const studentData = Utils.parseStudentLine(lines[i], appState.currentQuarterMode);
                    let result;
                    if (studentData) {
                        if (!studentData.nom && !studentData.prenom) { console.warn(`Ligne ignorée (sans nom/prénom) : ${lines[i]}`); await new Promise(resolve => setTimeout(resolve, 10)); continue; }
                        try {
                            result = await AppreciationsManager.generateAppreciation(studentData);
                        } catch (error) {
                            console.error(`Erreur pour ${studentData.nom || 'Élève'} ${studentData.prenom || 'Inconnu'}:`, error);
                            const translatedError = Utils.translateErrorMessage(error.message);
                            const templateFallbackApp = AppreciationsManager.buildAppreciationTextFromTemplate(studentData);
                            result = AppreciationsManager.createResultObject(studentData.nom || 'Erreur Nom', studentData.prenom || 'Erreur Prénom', templateFallbackApp, [], studentData, {}, {}, `Erreur IA: ${translatedError}. Remplacement par template.`);
                        }
                        appState.generatedResults.unshift(result);
                        AppreciationsManager.renderResults(); 
                    }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                if (!appState.isMassImportCancelled) {
                    UI.showNotification(`${lines.length} lignes traitées.`, 'success');
                }
                
                UI.resetProgressBar();
                if (DOM.cancelImportBtn) DOM.cancelImportBtn.style.display = 'none';
                appState.isMassImportCancelled = false;
                StorageManager.saveAppState();
            },
            async regenerateVisible(onlyErrors = false) {
                const resultsToRegen = appState.filteredResults.filter(r => !onlyErrors || r.errorMessage);

                if (resultsToRegen.length === 0) {
                    UI.showNotification(onlyErrors ? "Aucune erreur à régénérer." : "Aucune appréciation à régénérer.", "warning");
                    return;
                }
                
                const confirmMessage = onlyErrors
                    ? `Voulez-vous vraiment régénérer les ${resultsToRegen.length} appréciations en erreur ?`
                    : `Voulez-vous vraiment régénérer les ${resultsToRegen.length} appréciations affichées ? Cela utilisera les paramètres actuels.`;

                UI.showCustomConfirm(confirmMessage, async () => {
                    UI.showLoadingOverlay('Régénération en cours...');
                    let successCount = 0;
                    
                    for (const resultToRegen of resultsToRegen) {
                        const originalIndex = appState.generatedResults.findIndex(r => r.id === resultToRegen.id);
                        if (originalIndex !== -1) {
                            try {
                                const newResult = await AppreciationsManager.generateAppreciation(resultToRegen.studentData);
                                newResult.id = resultToRegen.id; // Keep same ID
                                appState.generatedResults[originalIndex] = newResult;
                                successCount++;
                            } catch (error) {
                                console.error(`Erreur régénération pour ${resultToRegen.prenom}:`, error);
                                const translatedError = Utils.translateErrorMessage(error.message);
                                const templateFallbackApp = AppreciationsManager.buildAppreciationTextFromTemplate(resultToRegen.studentData);
                                const errorResult = AppreciationsManager.createResultObject(resultToRegen.nom, resultToRegen.prenom, templateFallbackApp, resultToRegen.evolutions, resultToRegen.studentData, {}, {}, `Erreur IA: ${translatedError}. Remplacement par template.`);
                                errorResult.id = resultToRegen.id;
                                appState.generatedResults[originalIndex] = errorResult;
                            }
                        }
                    }
                    AppreciationsManager.renderResults();
                    UI.hideLoadingOverlay();
                    UI.showNotification(`${successCount}/${resultsToRegen.length} appréciations régénérées avec succès.`, "success");
                });
            },
            resetForm() {
                if (appState.currentEditingId) {
                    const card = document.querySelector(`.appreciation-result[data-id="${appState.currentEditingId}"]`);
                    if(card) card.classList.remove('is-editing');
                    appState.currentEditingId = null;
                }
                if (DOM.actualSingleStudentForm) DOM.actualSingleStudentForm.reset();
                [DOM.nomError, DOM.prenomError, DOM.moyT1Error, DOM.moyT2Error, DOM.moyT3Error].forEach(el => { if(el) el.style.display = 'none'; });
                document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
                
                DOM.generateAppreciationBtn.innerHTML = "✨ Générer l'appréciation";
                DOM.cancelEditBtn.style.display = 'none';
                DOM.resetFormBtn.style.display = 'inline-flex';
                UI.updateGenerateButtonIcons();

                DOM.singleAppreciationPreview.classList.remove('show', 'has-content');
                DOM.singleAppreciationPreview.innerHTML = '<i class="fas fa-eye" style="margin-right: 10px;"></i> Cliquez sur "Prévisualiser" pour voir un aperçu ici';
            },
            editAppreciation(id) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (!result) return;

                if (appState.currentEditingId) {
                    const previouslyEditingCard = document.querySelector(`.appreciation-result[data-id="${appState.currentEditingId}"]`);
                    if (previouslyEditingCard) previouslyEditingCard.classList.remove('is-editing');
                }

                UI.setInputMode('single');
                appState.currentEditingId = id;
                const card = document.querySelector(`.appreciation-result[data-id="${id}"]`);
                if(card) {
                    card.classList.add('is-editing');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                UI.setQuarterMode(result.studentData.quarterMode || appState.currentQuarterMode);
                DOM.subjectSelect.value = result.studentData.subject || appState.currentSubject;
                appState.currentSubject = DOM.subjectSelect.value;
                DOM.nomInput.value = result.nom;
                DOM.prenomInput.value = result.prenom;
                DOM.statutSelect.value = result.studentData.statut || '';
                DOM.moyT1Input.value = result.studentData.moyT1 !== null && typeof result.studentData.moyT1 === 'number' ? result.studentData.moyT1.toString().replace('.', ',') : '';
                DOM.appT1Textarea.value = result.studentData.appT1 || '';
                DOM.moyT2Input.value = result.studentData.moyT2 !== null && typeof result.studentData.moyT2 === 'number' ? result.studentData.moyT2.toString().replace('.', ',') : '';
                DOM.appT2Textarea.value = result.studentData.appT2 || '';
                DOM.moyT3Input.value = result.studentData.moyT3 !== null && typeof result.studentData.moyT3 === 'number' ? result.studentData.moyT3.toString().replace('.', ',') : '';
                DOM.negativeInstructions.value = result.studentData.negativeInstructions || '';
                
                DOM.generateAppreciationBtn.innerHTML = `💾 Mettre à jour`;
                DOM.cancelEditBtn.style.display = 'inline-flex';
                DOM.resetFormBtn.style.display = 'none';
                
                UI.showNotification(`Modification de ${result.prenom} ${result.nom}.`, 'info');
                if (DOM.inputSection) DOM.inputSection.scrollIntoView({ behavior: 'smooth' });
            },
            deleteAppreciation(id) {
                const indexToDelete = appState.generatedResults.findIndex(r => r.id === id);
                UI.showCustomConfirm('Supprimer cette appréciation ?', () => {
                    const deletedResult = document.querySelector(`.appreciation-result[data-id="${id}"]`);
                    let elementToFocusAfterDelete = null;
                    if (deletedResult) {
                        elementToFocusAfterDelete = deletedResult.nextElementSibling || deletedResult.previousElementSibling;
                    }
                    
                    appState.generatedResults = appState.generatedResults.filter(result => result.id !== id);
                    AppreciationsManager.renderResults();
                    UI.showNotification('Appréciation supprimée.', 'success');

                    if (elementToFocusAfterDelete) {
                        elementToFocusAfterDelete.focus();
                    } else if (appState.generatedResults.length === 0) {
                        DOM.searchInput.focus();
                    }
                });
            },
            copyAppreciation(id, buttonElement) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (result?.appreciation) {
                    const appreciationText = Utils.decodeHtmlEntities(result.appreciation);
                    navigator.clipboard.writeText(appreciationText).then(() => {
                        result.copied = true;
                        StorageManager.saveAppState();
                        if (buttonElement) {
                            buttonElement.innerHTML = '✅ Copié !';
                            buttonElement.classList.add('copied');
                            buttonElement.disabled = true;
                            setTimeout(() => {
                                buttonElement.innerHTML = '✔ Copié';
                                buttonElement.classList.remove('copied');
                                buttonElement.classList.add('was-copied');
                                buttonElement.disabled = false;
                            }, 2000);
                        }
                        UI.showNotification('Appréciation copiée !', 'success');
                    }).catch(err => {
                         UI.showNotification('Échec de la copie.', 'error');
                         console.error('Erreur de copie:', err);
                    });
                } else UI.showNotification('Appréciation introuvable ou vide.', 'error');
            },
            copyRefinementText(type) {
                const textEl = type === 'original' ? DOM.originalAppreciationText : DOM.suggestedAppreciationText;
                const text = textEl.textContent.trim();
                const initialText = 'Cliquez sur un bouton d\'amélioration pour générer un aperçu.';
                if (text && text !== 'Génération en cours...' && text !== initialText && !text.startsWith('Erreur')) {
                    navigator.clipboard.writeText(text).then(() => {
                        UI.showNotification(`Texte ${type === 'original' ? 'original' : 'suggéré'} copié !`, 'success');
                    }).catch(err => {
                        UI.showNotification('Échec de la copie.', 'error');
                        console.error('Erreur de copie:', err);
                    });
                } else {
                    UI.showNotification('Aucun texte valide à copier.', 'warning');
                }
            },
            copyAllResults() {
                if (appState.filteredResults.length === 0) { UI.showNotification("Aucune appréciation à copier.", 'warning'); return; }
                const formattedText = appState.filteredResults.map(r => `${r.nom} ${r.prenom}\n${Utils.decodeHtmlEntities(r.appreciation)}`).join('\n\n');
                navigator.clipboard.writeText(formattedText).then(() => {
                    UI.showNotification(`${appState.filteredResults.length} appréciations copiées !`, 'success');
                }).catch(err => {
                    UI.showNotification("Erreur lors de la copie.", 'error');
                    console.error("Erreur de copie massive:", err);
                });
            },
            showAppreciationDetails(id) {
                const resultIndex = appState.filteredResults.findIndex(r => r.id === id);
                if (resultIndex === -1) return;
                
                appState.currentDetailViewIndex = resultIndex;
                const result = appState.filteredResults[resultIndex];
                
                if (result) {
                    let titleHtml = `Analyse de : <span class="student-name-in-title">${result.prenom} ${result.nom}</span>`;
                    if (result.studentData.statut) {
                        titleHtml += `<span class="statut-chip statut-in-title">${result.studentData.statut}</span>`;
                    }
                    DOM.studentDetailsModalTitle.innerHTML = titleHtml;
            
                    const quarters = ['T1', 'T2', 'T3'];
                    let hasData = false;
                    quarters.forEach(q => {
                        const qBlock = document.getElementById(`details-quarter-${q}`);
                        const qMoyEl = document.getElementById(`detailsMoy${q}`);
                        const qAppEl = (q === 'T3') ? document.getElementById('detailsGeneratedAppreciation') : document.getElementById(`detailsApp${q}`);
                        
                        const moy = result.studentData[`moy${q}`];
                        const app = (q === 'T3') ? result.appreciation : result.studentData[`app${q}`];
            
                        if ((moy !== null && typeof moy === 'number') || (app && app.trim() !== '')) {
                            qBlock.style.display = 'block';
                            hasData = true;
                            const moyText = (moy !== null && typeof moy === 'number') ? `Moyenne : ${moy.toFixed(1).replace('.', ',')}` : '';
                            qBlock.querySelector('h4').innerHTML = `Trimestre ${q.replace('T', '')} <span class="grade-display">${moyText}</span>`;
                            qAppEl.innerHTML = Utils.cleanMarkdown(Utils.decodeHtmlEntities(app || 'Non renseigné'));
                        } else {
                            qBlock.style.display = 'none';
                        }
                    });
            
                    DOM.prevStudentBtn.disabled = resultIndex === 0;
                    DOM.nextStudentBtn.disabled = resultIndex === appState.filteredResults.length - 1;
            
                    if (!activeModal) { UI.openModal(DOM.studentDetailsModal); }
            
                    const isAIMode = result.studentData.generationMode === 'AI';
            
                    DOM.technicalDetailsAccordion.style.display = isAIMode ? 'block' : 'none';
                    [DOM.strengthsWeaknessesSection, DOM.nextStepsSection, DOM.detailsAnalysisSeparator].forEach(sec => {
                        if(sec) sec.style.display = isAIMode ? 'block' : 'none';
                    });
                    
                    if (isAIMode) {
                        const prompts = result.studentData.prompts || {};
                        DOM.detailsAppreciationPrompt.textContent = prompts.appreciation || 'Prompt non disponible.';
                        DOM.detailsSWPrompt.textContent = prompts.sw || 'Prompt non généré.';
                        DOM.detailsNSPrompt.textContent = prompts.ns || 'Prompt non généré.';
                        const tokens = result.tokenUsage || {};
                        let tokenHtml = '';
                        const formatTokenUsage = (label, usage) => {
                            if (!usage) return `<p><b>${label}:</b> N/A</p>`;
                            return `<p><b>${label}:</b> ${usage.total_tokens} tokens (P: ${usage.prompt_tokens}, C: ${usage.completion_tokens})</p>`;
                        };
                        tokenHtml += formatTokenUsage('Appréciation', tokens.appreciation);
                        tokenHtml += formatTokenUsage('Forces/Faiblesses', tokens.sw);
                        tokenHtml += formatTokenUsage('Pistes', tokens.ns);
                        DOM.detailsTokenUsageContent.innerHTML = tokenHtml;
                        
                        DOM.strengthsWeaknessesContent.innerHTML = `<div class="analysis-loading-state"><div class="loading-spinner" style="width: 16px; height: 16px;"></div><span>Génération de l'analyse...</span></div>`;
                        DOM.nextStepsList.innerHTML = `<li><div class="analysis-loading-state"><div class="loading-spinner" style="width: 16px; height: 16px;"></div><span>Génération des pistes...</span></div></li>`;
                        App.fetchAnalysesForStudent(id);
                    }
                }
            },
            parseStrengthsWeaknesses(text) {
                if (!text) return '';
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                let html = '', inStrengths = false, inWeaknesses = false;

                for (const line of lines) {
                    const lowerLine = line.toLowerCase().replace(/(\*|_|:)/g, '').trim();
                    const isStrengthHeader = lowerLine.includes('point') && lowerLine.includes('fort') || lowerLine.includes('force');
                    const isWeaknessHeader = (lowerLine.includes('point') && lowerLine.includes('faible')) || (lowerLine.includes('axe') && lowerLine.includes('amélioration')) || lowerLine.includes('faiblesse');

                    if (isStrengthHeader) {
                        if (inWeaknesses) html += '</ul>';
                        if (!inStrengths) {
                            html += '<h4 class="strengths-title"><i class="fas fa-thumbs-up"></i> Points Forts</h4><ul class="strengths-list">';
                            inStrengths = true;
                            inWeaknesses = false;
                        }
                        if (lowerLine === 'points forts') continue;
                    } else if (isWeaknessHeader) {
                        if (inStrengths) html += '</ul>';
                        if (!inWeaknesses) {
                            html += '<h4 class="weaknesses-title"><i class="fas fa-thumbs-down"></i> Points Faibles / Axes d\'Amélioration</h4><ul class="weaknesses-list">';
                            inStrengths = false;
                            inWeaknesses = true;
                        }
                        if (lowerLine === 'points faibles' || lowerLine === 'axes d\'amélioration' || lowerLine === 'points faibles / axes d\'amélioration') continue;
                    }

                    if (line.startsWith('* ') || line.startsWith('- ') || /^\d+\.\s/.test(line)) {
                        const itemText = line.replace(/^(\* |- |\d+\.\s)/, '');
                         if (inStrengths) { html += `<li>${Utils.cleanMarkdown(itemText)}</li>`; }
                         else if (inWeaknesses) { html += `<li>${Utils.cleanMarkdown(itemText)}</li>`; }
                    }
                }

                if (inStrengths || inWeaknesses) html += '</ul>';
                
                if (!html) {
                    return `<p>${Utils.cleanMarkdown(text.replace(/\n/g, '<br>'))}</p>`;
                }
                
                return html;
            },
            async generateStrengthsWeaknesses(id, silent = false) {
                 const result = appState.generatedResults.find(r => r.id === id);
                if (!result || !UI.checkAPIKeyPresence(silent)) {
                     throw new Error("Conditions non remplies pour la génération.");
                }
                try {
                    const prompts = this.getAllPrompts(result.studentData);
                    result.studentData.prompts.sw = prompts.sw;

                    const aiResponse = await AppreciationsManager.callAI(prompts.sw);
                    result.strengthsWeaknesses = aiResponse.text; 
                    result.tokenUsage.sw = aiResponse.usage;
                    StorageManager.saveAppState();
                    if (!silent) UI.showNotification('Analyse générée.', 'success');
                } catch (error) {
                    console.error("Erreur forces/faiblesses:", error);
                    if (!silent) UI.showNotification(`Erreur : ${Utils.translateErrorMessage(error.message)}`, 'error');
                    throw error; // Re-throw to be handled by the caller
                }
            },
            async generateNextSteps(id, silent = false) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (!result || !UI.checkAPIKeyPresence(silent)) {
                     throw new Error("Conditions non remplies pour la génération.");
                }
                try {
                    const prompts = this.getAllPrompts(result.studentData);
                    result.studentData.prompts.ns = prompts.ns;
                    
                    const aiResponse = await AppreciationsManager.callAI(prompts.ns); 
                    const nextStepsRaw = aiResponse.text;
                    const nextSteps = nextStepsRaw.split('\n').map(line => line.trim()).filter(line => line.match(/^\d+\.\s*(.*)/)).map(line => line.replace(/^\d+\.\s*/, '')).slice(0, 3);
                    result.nextSteps = nextSteps;
                    result.tokenUsage.ns = aiResponse.usage;
                    StorageManager.saveAppState();
                    if (!silent) UI.showNotification('Pistes générées.', 'success');
                } catch (error) {
                    console.error("Erreur pistes:", error);
                    if (!silent) UI.showNotification(`Erreur : ${Utils.translateErrorMessage(error.message)}`, 'error');
                    throw error; // Re-throw to be handled by the caller
                }
            },
            refineAppreciation(id) {
                const resultIndex = appState.filteredResults.findIndex(r => r.id === id);
                if (resultIndex === -1) return;
                const result = appState.filteredResults[resultIndex];

                if (result.studentData.generationMode !== 'AI' && !result.errorMessage) {
                    UI.showNotification("L'amélioration IA n'est disponible que pour les appréciations générées par IA.", 'info');
                }

                appState.currentRefiningAppreciationId = id; 
                appState.currentRefiningIndex = resultIndex;

                const edits = appState.refinementEdits[id] || {};
                
                // Header Details
                const { studentData, evolutions, errorMessage } = result;
                const relevantEvolution = this.getRelevantEvolution(evolutions, studentData.quarterMode);
                const isAiMode = studentData.generationMode === 'AI';
                let evoIndicatorHtml = '';
                if (relevantEvolution && typeof relevantEvolution.valeur === 'number') {
                    const icons = {'very-positive':'📈', 'positive':'↗', 'stable':'➡️', 'negative':'↘', 'very-negative':'📉'};
                    const labels = {'very-positive':'Très fort progrès', 'positive':'Progrès', 'stable':'Stable', 'negative':'Léger recul', 'very-negative':'Forte baisse'};
                    evoIndicatorHtml = `<span class="evolution-indicator evolution-${relevantEvolution.type} icon-only tooltip" data-tooltip="${labels[relevantEvolution.type] || relevantEvolution.type}">${icons[relevantEvolution.type] || ''}</span>`;
                }

                const { icon: generationIcon, tooltip: generationTooltip, text: generationText } = this.getGenerationModeInfo(result);
                const generationIconHtml = `<span class="ai-icon tooltip active" style="display:inline-block; vertical-align: middle; margin-left: 5px;" data-tooltip="${generationTooltip}">${generationIcon}</span>`;
                
                DOM.refinementModalTitle.innerHTML = `Améliorer : <span class="student-name-in-title">${result.prenom} ${result.nom}</span> ${generationIconHtml}`;

                const moyT1Disp = `Moyenne T1 : ${studentData.moyT1 !== null ? studentData.moyT1.toFixed(1).replace('.', ',') : 'NC'}`;
                const moyT2Disp = `Moyenne T2 : ${studentData.moyT2 !== null ? studentData.moyT2.toFixed(1).replace('.', ',') : 'NC'}`;
                const moyT3Disp = `Moyenne T3 : ${studentData.moyT3 !== null ? studentData.moyT3.toFixed(1).replace('.', ',') : 'NC'}`;

                DOM.refinementHeaderDetails.innerHTML = `
                    <div class="refinement-info-group">
                        <span class="refinement-grades">${moyT1Disp} | ${moyT2Disp} | ${moyT3Disp}</span>
                        ${evoIndicatorHtml}
                        ${studentData.statut ? `<span class="statut-chip">${studentData.statut}</span>` : ''}
                    </div>
                    <div class="refinement-info-group right">
                        <span class="detail-chip">Trimestre ${studentData.quarterMode.replace('T', '')}</span>
                        <span class="detail-chip">Matière : ${studentData.subject}</span>
                        <span class="detail-chip">Mode : ${generationText}</span>
                    </div>`;

                // Main Content
                DOM.originalAppreciationText.textContent = edits.originalText ?? Utils.decodeHtmlEntities(result.appreciation);
                
                const refinementOptionsElements = [DOM.refineStyleOptions, DOM.refineWithContextBtn, DOM.refinementContext];
                DOM.suggestedAppreciationText.classList.remove('placeholder');

                if (!isAiMode && !errorMessage) {
                    DOM.suggestedAppreciationText.innerHTML = `<i>Les options d'amélioration par IA ne sont pas disponibles pour les appréciations générées par l'Automate. Vous pouvez modifier le texte "Original" manuellement.</i>`;
                    DOM.suggestedAppreciationText.classList.add('placeholder');
                    refinementOptionsElements.forEach(el => {
                        el.disabled = true;
                        el.style.opacity = '0.5';
                    });
                } else {
                    DOM.suggestedAppreciationText.textContent = edits.suggestedText ?? 'Cliquez sur un bouton d\'amélioration pour générer un aperçu.';
                    if(!edits.suggestedText) DOM.suggestedAppreciationText.classList.add('placeholder');
                    refinementOptionsElements.forEach(el => {
                        el.disabled = false;
                        el.style.opacity = '1';
                    });
                }

                DOM.refinementContext.value = edits.context ?? '';
                DOM.refinementErrorActions.style.display = 'none';
                if (errorMessage) {
                    const regenBtn = `<button class="btn btn-warning btn-small" data-id="${id}" data-action="regenerate">🔄 Régénérer</button>`;
                    DOM.refinementErrorActions.innerHTML = regenBtn;
                    DOM.refinementErrorActions.style.display = 'flex';
                }

                DOM.prevRefinementStudentBtn.disabled = resultIndex === 0;
                DOM.nextRefinementStudentBtn.disabled = resultIndex === appState.filteredResults.length - 1;
                
                UI.updateWordCount('originalWordCount', DOM.originalAppreciationText.textContent);
                UI.updateWordCount('suggestedWordCount', DOM.suggestedAppreciationText.textContent);

                if (!activeModal || activeModal.id !== 'refinementModal') {
                    UI.openModal(DOM.refinementModal);
                }
            },
            async generateRefinedAppreciation(refineType, button) {
                const result = appState.generatedResults.find(r => r.id === appState.currentRefiningAppreciationId);
                if (!result || !UI.checkAPIKeyPresence()) return;

                const parent = button.closest('.options-group, .form-group');
                if (parent) {
                    const activeSpinner = parent.querySelector('.loading-spinner');
                    if (activeSpinner) return; // Already loading
                }

                UI.showInlineSpinner(button);
                DOM.suggestedAppreciationText.textContent = 'Génération en cours...';
                DOM.suggestedAppreciationText.classList.remove('placeholder');

                const appreciationSource = DOM.originalAppreciationText.textContent.trim();
                const prompt = AppreciationsManager.getRefinementPrompt(refineType, appreciationSource);

                if (!prompt) {
                    UI.showNotification("Veuillez choisir un style ou entrer un contexte.", "warning");
                    UI.hideInlineSpinner(button);
                    DOM.suggestedAppreciationText.textContent = 'Action requise.';
                    DOM.suggestedAppreciationText.classList.add('placeholder');
                    return;
                }

                try {
                    const aiResponse = await AppreciationsManager.callAI(prompt);
                    let refinedText = aiResponse.text.trim();
                    if ((refinedText.startsWith('"') && refinedText.endsWith('"')) || (refinedText.startsWith("'") && refinedText.endsWith("'"))) {
                        refinedText = refinedText.substring(1, refinedText.length - 1);
                    }
                    refinedText = refinedText.replace(/\s*\([^)]*\)$/, '').trim();
                    DOM.suggestedAppreciationText.textContent = Utils.decodeHtmlEntities(refinedText);
                    UI.updateWordCount('suggestedWordCount', refinedText);
                } catch (error) {
                    console.error("Erreur amélioration:", error);
                    let msg = `Erreur : ${Utils.translateErrorMessage(error.message)}`;
                    UI.showNotification(msg, 'error');
                    DOM.suggestedAppreciationText.textContent = `Erreur : ${msg}`;
                    DOM.suggestedAppreciationText.classList.add('placeholder');
                    UI.updateWordCount('suggestedWordCount', '');
                } finally {
                    UI.hideInlineSpinner(button);
                }
            },
            applyRefinedAppreciation() {
                const id = appState.currentRefiningAppreciationId;
                const result = appState.generatedResults.find(r => r.id === id);
                
                if (result) {
                    const newAppreciation = DOM.originalAppreciationText.textContent.trim();
                    result.appreciation = newAppreciation;
                    result.copied = false; 
                    delete appState.refinementEdits[id];
                    
                    AppreciationsManager.renderResults(); 
                    UI.closeModal(DOM.refinementModal); 
                    UI.showNotification('Appréciation mise à jour !', 'success');
                } else { 
                    UI.showNotification('Impossible de trouver l\'appréciation à mettre à jour.', 'error'); 
                }
            },
            swapRefinementTexts() {
                const originalText = DOM.originalAppreciationText.textContent;
                const suggestedText = DOM.suggestedAppreciationText.textContent;
                const initialSuggestedText = 'Cliquez sur un bouton d\'amélioration pour générer un aperçu.';
                if (suggestedText.trim() && !suggestedText.includes(initialSuggestedText) && !suggestedText.startsWith("Erreur")) {
                    DOM.originalAppreciationText.textContent = suggestedText;
                    DOM.suggestedAppreciationText.textContent = originalText;
                    DOM.suggestedAppreciationText.classList.remove('placeholder');
                    App.saveRefinementEdit();
                    UI.updateWordCount('originalWordCount', suggestedText);
                    UI.updateWordCount('suggestedWordCount', originalText);
                } else {
                    UI.showNotification("Impossible d'intervertir avec un texte suggéré vide ou en erreur.", "warning");
                }
            },
            async regenerateFailedAppreciation(id, button) {
                const resultIndex = appState.generatedResults.findIndex(r => r.id === id);
                if (resultIndex === -1) return;
                
                const originalResult = appState.generatedResults[resultIndex];
                originalResult.copied = false;
                UI.showInlineSpinner(button);

                try {
                    const newResult = await AppreciationsManager.generateAppreciation(originalResult.studentData);
                    newResult.id = id;
                    appState.generatedResults[resultIndex] = newResult;
                    UI.showNotification(`Nouvelle tentative pour ${originalResult.prenom} réussie.`, 'success');
                    if(activeModal?.id === 'refinementModal') {
                        AppreciationsManager.refineAppreciation(id);
                    }
                } catch(error) {
                    console.error(`Erreur regénération pour ${originalResult.prenom}:`, error);
                    const translatedError = Utils.translateErrorMessage(error.message);
                    const templateFallbackApp = AppreciationsManager.buildAppreciationTextFromTemplate(originalResult.studentData);
                    const regeneratedResult = AppreciationsManager.createResultObject(originalResult.nom, originalResult.prenom, templateFallbackApp, originalResult.evolutions, originalResult.studentData, {}, {}, `Nouvelle Erreur IA: ${translatedError}. Remplacement par template.`);
                    regeneratedResult.id = id;
                    appState.generatedResults[resultIndex] = regeneratedResult;
                    UI.showNotification(`Échec nouvelle tentative pour ${originalResult.prenom}.`, 'error');
                } finally {
                    AppreciationsManager.renderResults();
                    StorageManager.saveAppState();
                }
            },
            renderResults() {
                if (document.activeElement?.contentEditable === 'true') { return; }

                const searchTerm = DOM.searchInput.value.toLowerCase();
                const sortOrder = DOM.sortSelect.value;
                const filteredAndSortedResults = appState.generatedResults
                    .filter(result => {
                        const nom = result.nom || '';
                        const prenom = result.prenom || '';
                        const appreciation = result.appreciation || '';
                        return `${nom} ${prenom} ${Utils.decodeHtmlEntities(appreciation)}`.toLowerCase().includes(searchTerm);
                    })
                    .sort((a, b) => {
                        if (sortOrder === 'recent') return new Date(b.timestamp) - new Date(a.timestamp);
                        if (sortOrder === 'name') return `${a.nom} ${a.prenom}`.localeCompare(`${b.nom} ${b.prenom}`);
                        if (sortOrder === 'grade') {
                            const studentDataA = a.studentData || {};
                            const studentDataB = b.studentData || {};
                            const gradeA = studentDataA[`moy${studentDataA.quarterMode}`] ?? -1;
                            const gradeB = studentDataB[`moy${studentDataB.quarterMode}`] ?? -1;
                            return gradeB - gradeA;
                        }
                        if (sortOrder === 'progress') {
                            const getEvolutionRank = (res) => {
                                const evo = AppreciationsManager.getRelevantEvolution(res.evolutions, res.studentData.quarterMode);
                                if (!evo) return 0;
                                return {'very-positive': 5, 'positive': 4, 'stable': 3, 'negative': 2, 'very-negative': 1}[evo.type] || 0;
                            };
                            return getEvolutionRank(b) - getEvolutionRank(a);
                        }
                        return 0;
                    });
                
                appState.filteredResults = filteredAndSortedResults;

                DOM.resultsDiv.innerHTML = '';
                if (appState.generatedResults.length === 0) {
                     DOM.emptyStateCard.style.display = 'block';
                     DOM.noResultsMessage.style.display = 'none';
                } else if (appState.filteredResults.length === 0) {
                    DOM.emptyStateCard.style.display = 'none';
                    DOM.noResultsMessage.style.display = 'block';
                } else {
                    DOM.emptyStateCard.style.display = 'none';
                    DOM.noResultsMessage.style.display = 'none';
                    const fragment = document.createDocumentFragment();
                    appState.filteredResults.forEach(result => {
                        const resultElement = document.createElement('div');
                        resultElement.className = 'appreciation-result';
                        
                        if(result.errorMessage) resultElement.classList.add('has-error');
                        else if (result.studentData.generationMode === 'AI') resultElement.classList.add('ai-generated');
                        if (result.id === appState.currentEditingId) resultElement.classList.add('is-editing');

                        resultElement.dataset.id = result.id;
                        resultElement.tabIndex = -1;
                        resultElement.innerHTML = AppreciationsManager.createResultHtml(result);
                        fragment.appendChild(resultElement);
                    });
                    DOM.resultsDiv.appendChild(fragment);
                }

                UI.updateStats();
                UI.updateControlButtons();
                StorageManager.saveAppState();
            },
            getGenerationModeInfo(result) {
                const studentData = result.studentData || {};
                const isAIMode = studentData.generationMode === 'AI';
                let tooltip = isAIMode ? "Généré par IA" : "Généré par Automate";
                
                if (isAIMode && result.tokenUsage?.appreciation) {
                    tooltip += ` (${studentData.currentAIModel || appState.currentAIModel}, ${result.tokenUsage.appreciation.total_tokens} tokens)`;
                }
                
                return {
                    isAI: isAIMode,
                    icon: isAIMode ? '✨' : '🤖',
                    text: isAIMode ? 'IA' : 'Automate',
                    tooltip: tooltip
                };
            },
            createResultHtml(result) {
                const studentData = result.studentData || {};
                const moyT1Disp = `T1: ${studentData.moyT1 !== null && typeof studentData.moyT1 === 'number' ? studentData.moyT1.toFixed(1).replace('.', ',') : 'NC'}`;
                const moyT2Disp = `T2: ${studentData.moyT2 !== null && typeof studentData.moyT2 === 'number' ? studentData.moyT2.toFixed(1).replace('.', ',') : 'NC'}`;
                const moyT3Disp = `T3: ${studentData.moyT3 !== null && typeof studentData.moyT3 === 'number' ? studentData.moyT3.toFixed(1).replace('.', ',') : 'NC'}`;
                let allMoyDisp = [moyT1Disp, moyT2Disp, moyT3Disp].join(' | ');
                if (allMoyDisp) allMoyDisp = `<span class="student-grades-display">(${allMoyDisp})</span>`;
                
                let evoIndicatorHtml = '';
                const relevantEvolution = AppreciationsManager.getRelevantEvolution(result.evolutions, studentData.quarterMode);
                if (relevantEvolution && typeof relevantEvolution.valeur === 'number') {
                    const icons = {'very-positive':'📈', 'positive':'↗', 'stable':'➡️', 'negative':'↘', 'very-negative':'📉'};
                    const labels = {'very-positive':'Très fort progrès', 'positive':'Progrès', 'stable':'Stable', 'negative':'Léger recul', 'very-negative':'Forte baisse'};
                    evoIndicatorHtml = `<span class="evolution-indicator evolution-${relevantEvolution.type}" data-tooltip="Évolution ${relevantEvolution.periode} : ${relevantEvolution.valeur > 0 ? '+' : ''}${relevantEvolution.valeur.toFixed(1).replace('.', ',')} pts">${icons[relevantEvolution.type] || ''} ${labels[relevantEvolution.type] || relevantEvolution.type}</span>`;
                }
                
                const errorHtml = result.errorMessage ? `<p style="color: var(--error-color); font-size: 0.85em; margin-top: 10px;">⚠️ ${result.errorMessage}</p>` : '';
                
                const { icon: generationIcon, tooltip: generationTooltip, text: generationText, isAI: isAiMode } = this.getGenerationModeInfo(result);
                const generationIconHtml = `<span class="ai-icon tooltip active" style="display:inline-block; vertical-align: middle; margin-left: 5px;" data-tooltip="${generationTooltip}">${generationIcon}</span>`;

                const copyButtonHtml = result.copied
                    ? `<button class="btn btn-secondary btn-small copy-btn was-copied" data-id="${result.id}" data-action="copy" tabindex="0">✔ Copié</button>`
                    : `<button class="btn btn-secondary btn-small copy-btn" data-id="${result.id}" data-action="copy" tabindex="0">📄 Copier</button>`;
                
                const refineButtonHtml = (isAiMode || result.errorMessage) ? `<button class="btn btn-ai btn-small refine-btn" data-id="${result.id}" data-action="refine" tabindex="0">✨ Améliorer</button>` : '';
                const regenerateButtonHtml = result.errorMessage ? `<button class="btn btn-warning btn-small regenerate-btn" data-id="${result.id}" data-action="regenerate" tabindex="0">🔄 Régénérer</button>` : '';

                return `<div class="student-name"><span>${result.prenom || 'Prénom?'} ${result.nom || 'Nom?'} ${generationIconHtml}</span> ${allMoyDisp}<div style="display: flex; gap: 10px; align-items: center;">${evoIndicatorHtml}</div></div><div class="student-summary-details"><span class="detail-chip">Matière : ${studentData.subject || 'N/A'}</span><span class="detail-chip">Trimestre : ${studentData.quarterMode || 'N/A'}</span><span class="detail-chip">Mode : ${generationText}</span>${studentData.statut ? `<span class="statut-chip">Statut : ${studentData.statut}</span>` : ''}</div><p class="appreciation-text" data-id="${result.id}" tabindex="0">${Utils.decodeHtmlEntities(Utils.cleanMarkdown(result.appreciation || ''))}</p><div class="word-count">${Utils.countWords(result.appreciation || '')} mots</div>${errorHtml}<div class="appreciation-actions"><div class="appreciation-actions-left">${copyButtonHtml}${refineButtonHtml}${regenerateButtonHtml}<button class="btn btn-secondary btn-small details-btn" data-id="${result.id}" data-action="details" tabindex="0">📊 Analyser</button><button class="btn btn-secondary btn-small" data-id="${result.id}" data-action="edit" tabindex="0">✏️ Modifier</button></div><button class="btn btn-danger btn-small delete-btn" data-id="${result.id}" data-action="delete" tabindex="0">🗑️ Supprimer</button></div>`;
            },
            exportToCsv() {
                if (appState.generatedResults.length === 0) { UI.showNotification('Aucune donnée à exporter.', 'warning'); return; }
                const headers = ["Nom", "Prénom", "Statut", "Moy T1", "App T1", "Moy T2", "App T2", "Moy T3", "App Générée", "Trimestre", "Matière", "Mode Génération", "Instructions Supplémentaires Individuelles", "Evo T1-T2 (val)", "Evo T1-T2 (type)", "Evo T2-T3 (val)", "Evo T2-T3 (type)", "Evo T1-T3 (val)", "Evo T1-T3 (type)", "Forces/Faiblesses", "Pistes Amélioration", "Prompt App", "Tokens App", "Prompt SW", "Tokens SW", "Prompt NS", "Tokens NS", "Date Génération", "Erreur"];
                const cleanCsv = (text) => { if (text === null || text === undefined) return ''; let cleaned = String(text).replace(/"/g, '""'); cleaned = Utils.decodeHtmlEntities(cleaned); return (cleaned.includes(',') || cleaned.includes('\n') || cleaned.includes('\r') || cleaned.includes(';')) ? `"${cleaned}"` : cleaned; };
                const rows = appState.generatedResults.map(r => {
                    const getEvo = (p) => { const e = r.evolutions.find(ev => ev.periode === p); return { v: e && typeof e.valeur === 'number' ? e.valeur.toFixed(1).replace('.', ',') : '', t: e ? e.type : '' }; };
                    const e12=getEvo('T1-T2'), e23=getEvo('T2-T3'), e13=getEvo('T1-T3');
                    const tokensApp = r.tokenUsage?.appreciation ? `${r.tokenUsage.appreciation.total_tokens}` : '';
                    const tokensSW = r.tokenUsage?.sw ? `${r.tokenUsage.sw.total_tokens}` : '';
                    const tokensNS = r.tokenUsage?.ns ? `${r.tokenUsage.ns.total_tokens}` : '';
                    return [
                        r.nom, r.prenom, r.studentData.statut,
                        r.studentData.moyT1 !== null && typeof r.studentData.moyT1 === 'number' ? r.studentData.moyT1.toFixed(1).replace('.', ',') : '', r.studentData.appT1,
                        r.studentData.moyT2 !== null && typeof r.studentData.moyT2 === 'number' ? r.studentData.moyT2.toFixed(1).replace('.', ',') : '', r.studentData.appT2,
                        r.studentData.moyT3 !== null && typeof r.studentData.moyT3 === 'number' ? r.studentData.moyT3.toFixed(1).replace('.', ',') : '',
                        r.appreciation, r.studentData.quarterMode, r.studentData.subject, r.studentData.generationMode,
                        r.studentData.negativeInstructions || '',
                        e12.v, e12.t, e23.v, e23.t, e13.v, e13.t,
                        r.strengthsWeaknesses, r.nextSteps?.join('; ') || '',
                        r.studentData.prompts?.appreciation || '', tokensApp,
                        r.studentData.prompts?.sw || '', tokensSW,
                        r.studentData.prompts?.ns || '', tokensNS,
                        new Date(r.timestamp).toLocaleString(), r.errorMessage
                    ].map(cleanCsv).join(';');
                });
                const csvContent = "\uFEFF" + headers.join(';') + '\n' + rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trimestre-en-main_export_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UI.showNotification('Données exportées en CSV.', 'success');
            },
            clearAllResults() { UI.showCustomConfirm('Effacer TOUTES les appréciations ? Action irréversible.', () => { appState.generatedResults = []; appState.filteredResults = []; AppreciationsManager.renderResults(); StorageManager.saveAppState(); UI.showNotification('Toutes les appréciations effacées.', 'success'); }); },
            loadSampleData() {
                const sampleData = `MARTIN Lucas | | 12,5 | Bon travail en début d'année, des bases solides. | 13,8 | Progression notable, continue ses efforts. | 14,2\nDURAND Sophie | Nouveau T2 | | | 9,1 | Doit s'investir davantage. | 10,5\nLEFEVRE Thomas | | 15,0 | Très bonne participation. | 14,5 | Léger recul, à surveiller. | 13,9\nPETIT Camille | | 8,2 | Des difficultés persistantes. | 7,0 | Nécessite un accompagnement. | 6,5\nROUSSEAU Emma | | 17,1 | Excellents résultats et autonomie. | 18,0 | Très forte progression. | 19,1`.trim();
                if (DOM.massData) {
                    DOM.massData.value = sampleData;
                    DOM.massData.dispatchEvent(new Event('paste')); // Pour déclencher les listeners si besoin
                }
                UI.showNotification('Données d\'exemple chargées.', 'info');
            }
        };

        // ====================================================================
        // 6. Initialisation de l'Application et Gestion des Événements
        // ====================================================================
        const App = {
            init() {
                StorageManager.loadAppState(); App.setupEventListeners(); App.updateUIOnLoad(); App.setupAutoSave(); App.setupPWA();
                if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = APP_VERSION; 
                App.handleFirstVisit();
                console.log(`Application initialisée (${APP_VERSION}).`);
            },
            
            handleFirstVisit() {
                if (!localStorage.getItem(CONFIG.LS_FIRST_VISIT_KEY)) {
                    UI.openModal(DOM.welcomeModal);
                    App.setupWelcomeModal();
                }
            },
            
            setupWelcomeModal() {
                let currentWelcomeStep = 1;
                const totalWelcomeSteps = 3;

                const showWelcomeStep = (step) => {
                    document.querySelectorAll('.welcome-step').forEach(s => s.classList.remove('active'));
                    const currentStepEl = document.getElementById(`welcome-step-${step}`);
                    if(currentStepEl) currentStepEl.classList.add('active');

                    DOM.welcomeDots.querySelectorAll('.dot').forEach((dot, index) => {
                        dot.classList.toggle('active', index + 1 === step);
                    });

                    DOM.welcomePrevBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
                    DOM.welcomeNextBtn.style.display = step === totalWelcomeSteps ? 'none' : 'inline-flex';
                    DOM.welcomeFinishOptions.style.display = step === totalWelcomeSteps ? 'flex' : 'none';
                    
                    currentWelcomeStep = step;
                };

                const finishWelcome = (hidePermanently) => {
                    const welcomeApiKey = DOM.welcomeApiKeyInput.value.trim();
                    if (welcomeApiKey) {
                        appState.openaiApiKey = welcomeApiKey;
                        StorageManager.saveAppState();
                        UI.updateSettingsFields();
                        UI.showNotification('Clé API enregistrée ! Vous pouvez maintenant utiliser le mode IA.', 'success');
                    }
                    if (hidePermanently) {
                        localStorage.setItem(CONFIG.LS_FIRST_VISIT_KEY, 'true');
                    }
                    UI.closeModal(DOM.welcomeModal);
                };

                showWelcomeStep(1); // Initialize first step

                DOM.welcomeNextBtn.onclick = () => {
                    if (currentWelcomeStep < totalWelcomeSteps) {
                        showWelcomeStep(currentWelcomeStep + 1);
                    }
                };
                DOM.welcomePrevBtn.onclick = () => {
                     if (currentWelcomeStep > 1) {
                        showWelcomeStep(currentWelcomeStep - 1);
                    }
                };

                DOM.welcomeFinishBtn.onclick = () => finishWelcome(false);
                DOM.welcomeFinishAndHideBtn.onclick = () => finishWelcome(true);

                DOM.getApiKeyHelpBtnWelcome.onclick = (e) => {
                    e.preventDefault();
                    UI.openModal(DOM.helpModal);
                    const apiKeyHelpSection = document.getElementById('apiKeyHelpSection');
                    if (apiKeyHelpSection) {
                        apiKeyHelpSection.open = true;
                        setTimeout(() => {
                           apiKeyHelpSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                };
                
                 DOM.welcomeLoadSampleBtn.onclick = () => {
                    finishWelcome(false); // Finish without hiding
                    AppreciationsManager.loadSampleData();
                    UI.showNotification("Données d'exemple chargées. Cliquez sur 'Importer et générer' !", 'info');
                 };
            },

            setupEventListeners() {
                const addClickListener = (id, handler) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('click', handler);
                    } else {
                        console.warn(`Élément non trouvé pour l'écouteur d'événement : ${id}`);
                    }
                };

                addClickListener('darkModeToggle', UI.toggleDarkMode);
                addClickListener('settingsButton', () => { StorageManager.loadAppState(); UI.openModal(DOM.settingsModal); App.renderSubjectManagementList(); UI.updateSettingsPromptFields(); UI.updateSettingsFields(); UI.updateAIPromptDisplays(); UI.showSettingsTab('options'); });
                addClickListener('helpButton', () => { UI.openModal(DOM.helpModal); UI.updateAIPromptDisplays(); UI.updateHelpImportFormat('T1'); });
                addClickListener('getApiKeyHelpBtn', (e) => {
                    e.preventDefault();
                    UI.openModal(DOM.helpModal);
                    const apiKeyHelpSection = document.getElementById('apiKeyHelpSection');
                    if (apiKeyHelpSection) {
                        apiKeyHelpSection.open = true;
                        setTimeout(() => {
                           apiKeyHelpSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                });
                addClickListener('validateApiKeyBtn', () => App.validateApiKey(DOM.openaiApiKey.value, 'openai'));
                addClickListener('validateGeminiApiKeyBtn', () => App.validateApiKey(DOM.geminiApiKey.value, 'gemini'));
                addClickListener('relaunchWelcomeGuideBtn', (e) => {
                    e.preventDefault();
                    UI.closeModal(DOM.helpModal);
                    UI.openModal(DOM.welcomeModal);
                    App.setupWelcomeModal();
                });
                
                DOM.quarterRadios.forEach(radio => radio.addEventListener('change', (e) => UI.setQuarterMode(e.target.value)));
                DOM.subjectSelect?.addEventListener('change', (e) => { appState.currentSubject = e.target.value; StorageManager.saveAppState(); AppreciationsManager.renderResults(); });
                DOM.subjectManagementContainer?.addEventListener('click', (e) => {
                    const item = e.target.closest('.subject-list-item');
                    if (item) {
                        const subjectName = item.dataset.subject;
                        if(e.target.closest('.subject-delete-btn')) {
                            e.stopPropagation();
                            App.deleteSubject(subjectName);
                        } else {
                            appState.currentSettingsSubject = subjectName;
                            App.renderSubjectManagementList();
                            UI.updateSettingsPromptFields();
                        }
                    }
                });
                DOM.generationModeRadios.forEach(radio => radio.addEventListener('change', (e) => { const newMode = e.target.value; if (newMode === 'AI' && !UI.checkAPIKeyPresence()) { UI.setGenerationMode('Template'); return; } UI.setGenerationMode(newMode); }));
                
                addClickListener('massImportTab', () => UI.setInputMode('mass'));
                addClickListener('singleStudentTab', () => UI.setInputMode('single'));
                addClickListener('importGenerateBtn', AppreciationsManager.processMassImport);
                addClickListener('clearImportBtn', () => { if(DOM.massData) DOM.massData.value = ''; UI.showNotification('Zone d\'import vidée.', 'info'); });
                addClickListener('loadSampleDataLink', AppreciationsManager.loadSampleData);
                addClickListener('cancelImportBtn', () => { appState.isMassImportCancelled = true; UI.showNotification('Annulation de l\'import en cours...', 'info'); });
                
                DOM.massData?.addEventListener('paste', () => setTimeout(() => DOM.importGenerateBtn.focus(), 100));

                if (DOM.dropZone) { ['dragover', 'drop'].forEach(evtName => DOM.dropZone.addEventListener(evtName, e => e.preventDefault())); DOM.dropZone.addEventListener('dragover', () => DOM.dropZone.classList.add('highlight')); DOM.dropZone.addEventListener('dragleave', () => DOM.dropZone.classList.remove('highlight')); DOM.dropZone.addEventListener('drop', (e) => { DOM.dropZone.classList.remove('highlight'); if (e.dataTransfer.files.length > 0) App.handleFileImport(e.dataTransfer.files[0]); }); }
                addClickListener('importFileBtn', () => DOM.fileInput?.click());
                DOM.fileInput?.addEventListener('change', (e) => { if (e.target.files.length > 0) App.handleFileImport(e.target.files[0]); e.target.value = ''; });
                
                addClickListener('generateAppreciationBtn', () => AppreciationsManager.generateSingleAppreciation(false));
                addClickListener('previewAppreciationBtn', () => AppreciationsManager.generateSingleAppreciation(true));
                addClickListener('resetFormBtn', AppreciationsManager.resetForm);
                addClickListener('cancelEditBtn', AppreciationsManager.resetForm);

                DOM.searchInput?.addEventListener('input', Utils.debounce(AppreciationsManager.renderResults, CONFIG.DEBOUNCE_TIME_MS));
                addClickListener('clearAllResultsBtn', AppreciationsManager.clearAllResults);
                addClickListener('copyAllBtn', AppreciationsManager.copyAllResults);
                addClickListener('regenerateAllBtn', () => AppreciationsManager.regenerateVisible(false));
                addClickListener('regenerateErrorsBtn', () => AppreciationsManager.regenerateVisible(true));
                addClickListener('exportJsonBtn', StorageManager.exportToJson);
                addClickListener('exportCsvBtn', AppreciationsManager.exportToCsv);
                addClickListener('exportSettingsBtn', StorageManager.exportSettings);
                addClickListener('importSettingsBtn', () => DOM.fileInput?.click());
                DOM.sortSelect?.addEventListener('change', AppreciationsManager.renderResults);
                document.querySelectorAll('.stat-card').forEach(card => card.addEventListener('click', (e) => { if(e.currentTarget.dataset.statId) UI.showStatDetails(e.currentTarget.dataset.statId); }));
                document.querySelectorAll('.stat-card').forEach(card => card.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.currentTarget.dataset.statId) { UI.showStatDetails(e.currentTarget.dataset.statId); } }));
                DOM.resultsDiv?.addEventListener('click', (e) => { const button = e.target.closest('button[data-action]'); if (!button) return; const id = button.dataset.id; const action = button.dataset.action; switch (action) { case 'copy': AppreciationsManager.copyAppreciation(id, button); break; case 'delete': AppreciationsManager.deleteAppreciation(id); break; case 'details': AppreciationsManager.showAppreciationDetails(id); break; case 'refine': AppreciationsManager.refineAppreciation(id); break; case 'edit': AppreciationsManager.editAppreciation(id); break; case 'regenerate': AppreciationsManager.regenerateFailedAppreciation(id, button); break; } });
                
                addClickListener('closeSettingsModalBtn', () => UI.closeModal(DOM.settingsModal));
                addClickListener('resetAllSettingsBtn', StorageManager.resetAllSettings);
                DOM.templatesTabContent.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-reset-template]');
                    if (button) {
                        const quarter = button.dataset.resetTemplate;
                        const subject = appState.currentSettingsSubject;
                        UI.showCustomConfirm(`Réinitialiser le template du ${quarter} pour "${subject}" ?`, () => {
                             const defaultTemplate = DEFAULT_PROMPT_TEMPLATES[subject]?.templates?.[quarter] || DEFAULT_PROMPT_TEMPLATES['Standard'].templates[quarter];
                             Utils.renderTemplateToEditor(`promptTemplate${quarter}`, defaultTemplate);
                             App.recordEditorState(`promptTemplate${quarter}`);
                             UI.showNotification(`Template ${quarter} pour "${subject}" réinitialisé.`, 'success');
                        });
                    }
                    if (e.target.closest('.template-preview-details summary')) {
                        const details = e.target.closest('.template-preview-details');
                        const editorId = details.closest('.template-group').querySelector('.template-editor').id;
                        App.updateTemplatePreview(editorId);
                    }
                });
                
                DOM.optionsTabContent.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-reset-prompt]');
                    if (button) {
                        const quarter = button.dataset.resetPrompt;
                        UI.showCustomConfirm(`Réinitialiser le prompt système du ${quarter} à sa valeur par défaut ?`, () => {
                            const promptTextarea = document.getElementById(`systemPrompt${quarter}`);
                            if (promptTextarea) {
                                promptTextarea.value = DEFAULT_SYSTEM_PROMPTS[quarter];
                                UI.showNotification(`Prompt système ${quarter} réinitialisé.`, 'success');
                            }
                        });
                    }
                });

                addClickListener('resetVocabBtn', () => {
                    const subject = appState.currentSettingsSubject;
                    if (subject === "Standard") {
                        UI.showNotification("Le vocabulaire standard ne peut pas être réinitialisé.", 'warning');
                        return;
                    }
                    UI.showCustomConfirm(`Voulez-vous vraiment réinitialiser le vocabulaire pour "${subject}" ?`, () => {
                        appState.subjects[subject].vocabulaire = JSON.parse(JSON.stringify(DEFAULT_VOCABULAIRE));
                        UI.renderVocabLists();
                        UI.showNotification(`Vocabulaire pour "${subject}" réinitialisé.`, 'success');
                    });
                });
                addClickListener('saveSettingsBtn', App.saveSettings);
                addClickListener('cancelSettingsBtn', () => UI.closeModal(DOM.settingsModal));
                DOM.settingsTabs.forEach(tab => tab.addEventListener('click', (e) => UI.showSettingsTab(e.target.dataset.tab)));
                
                [DOM.settingsPromptT1, DOM.settingsPromptT2, DOM.settingsPromptT3].forEach(el => {
                    if (el) {
                        el.addEventListener('blur', () => {
                            const selection = window.getSelection();
                            if(selection.rangeCount > 0) lastSelectionRange = selection.getRangeAt(0);
                        });
                        App.setupEditorObserver(el.id);
                        el.addEventListener('click', (e) => { if(e.target.classList.contains('delete-tag')){ e.target.parentElement.remove(); App.recordEditorState(el.id); } });
                        el.addEventListener('keydown', (e) => {
                            if(e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); App.undoEditorState(el.id); }
                            if(e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); App.redoEditorState(el.id); }
                        });
                    }
                });
                
                DOM.templatesTabContent.addEventListener('click', (e) => { 
                    const pill = e.target.closest('.tag-pill');
                    if(pill && !pill.classList.contains('disabled')) { 
                        const editor = document.getElementById(pill.dataset.targetEditor); 
                        if(editor.isContentEditable) {
                            const tag = pill.textContent;
                            const tagSpan = document.createElement('span');
                            tagSpan.className = 'editor-tag';
                            tagSpan.contentEditable = 'false';
                            tagSpan.dataset.tag = tag;
                            tagSpan.textContent = tag;
                            const deleteBtn = document.createElement('span');
                            deleteBtn.className = 'delete-tag';
                            deleteBtn.textContent = '×';
                            tagSpan.appendChild(deleteBtn);
                            Utils.insertNodeAtCursor(editor, tagSpan);
                            App.recordEditorState(editor.id);
                        }
                    } 
                });

                DOM.openaiApiKey.addEventListener('input', () => {
                    const icon = DOM.openaiApiKeyValidationIcon;
                    if (DOM.openaiApiKey.value.length > 0) {
                        icon.classList.add('visible');
                        if (DOM.openaiApiKey.value.startsWith('sk-') && DOM.openaiApiKey.value.length > 40) {
                           icon.textContent = '✅';
                           icon.style.color = 'var(--success-color)';
                        } else {
                           icon.textContent = '❌';
                           icon.style.color = 'var(--error-color)';
                        }
                    } else {
                        icon.classList.remove('visible');
                    }
                });

                DOM.aiModelSelect?.addEventListener('change', () => { appState.currentAIModel = DOM.aiModelSelect.value; UI.toggleAIKeyFields(); UI.checkAPIKeyPresence(); UI.updateHeaderPremiumLook(); });
                addClickListener('addCompetenceBtn', () => { App.addVocabItem('competences', DOM.addCompetenceInput); DOM.addCompetenceInput.focus(); });
                addClickListener('addQualiteBtn', () => { App.addVocabItem('qualites', DOM.addQualiteInput); DOM.addQualiteInput.focus(); });
                addClickListener('addActiviteBtn', () => { App.addVocabItem('activites', DOM.addActiviteInput); DOM.addActiviteInput.focus(); });
                addClickListener('addBrickBtn', () => { App.addPhraseBrick(DOM.addBrickNameInput, DOM.addBrickTextInput); DOM.addBrickNameInput.focus(); });
                DOM.vocabulaireSection?.addEventListener('click', App.handleVocabListAction);
                DOM.vocabulaireSection?.addEventListener('focusout', App.saveVocabItemEdit);
                DOM.vocabulaireSection?.addEventListener('keydown', App.handleVocabItemKeydown);
                addClickListener('closeStudentDetailsModalBtn', () => UI.closeModal(DOM.studentDetailsModal));
                addClickListener('closeDetailsModalBtn', () => UI.closeModal(DOM.studentDetailsModal));
                addClickListener('nextStudentBtn', () => App.navigateStudentDetails(1));
                addClickListener('prevStudentBtn', () => App.navigateStudentDetails(-1));
                addClickListener('closeRefinementModalBtn', () => UI.closeModal(DOM.refinementModal));
                addClickListener('cancelRefinementBtn', () => UI.closeModal(DOM.refinementModal));
                addClickListener('applyRefinedAppreciationBtn', AppreciationsManager.applyRefinedAppreciation);
                addClickListener('resetRefinementBtn', App.resetRefinementChanges);
                addClickListener('swapRefinementBtn', AppreciationsManager.swapRefinementTexts);
                addClickListener('nextRefinementStudentBtn', () => App.navigateRefinementModal(1));
                addClickListener('prevRefinementStudentBtn', () => App.navigateRefinementModal(-1));
                DOM.refinementModal.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const action = button.dataset.action;
                    if(action === 'copy-original') AppreciationsManager.copyRefinementText('original');
                    if(action === 'copy-suggested') AppreciationsManager.copyRefinementText('suggested');
                    if(action === 'regenerate') AppreciationsManager.regenerateFailedAppreciation(button.dataset.id, button);
                });
                DOM.refineStyleOptions?.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.refineType) AppreciationsManager.generateRefinedAppreciation(e.target.dataset.refineType, e.target); });
                addClickListener('refineWithContextBtn', (e) => AppreciationsManager.generateRefinedAppreciation('context', e.target));
                DOM.refinementContext?.addEventListener('input', Utils.debounce(App.saveRefinementEdit, 300));
                DOM.originalAppreciationText?.addEventListener('input', Utils.debounce(App.saveRefinementEdit, 300));
                DOM.refinementContext?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); AppreciationsManager.generateRefinedAppreciation('context', DOM.refineWithContextBtn); } });
                
                addClickListener('closeHelpModalBtn', () => UI.closeModal(DOM.helpModal));
                
                addClickListener('addSubjectBtn', App.addSubject);
                addClickListener('backToTopBtn', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

                const helpGoToSettingsBtn = document.getElementById('helpGoToSettingsBtn');
                const helpFormatSelector = document.getElementById('helpFormatSelector');

                helpGoToSettingsBtn?.addEventListener('click', (e) => {
                    e.preventDefault();
                    UI.closeModal(DOM.helpModal);
                    UI.openModal(DOM.settingsModal);
                    UI.showSettingsTab('templates'); 
                });

                helpFormatSelector?.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' && e.target.dataset.format) {
                        UI.updateHelpImportFormat(e.target.dataset.format);
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (activeModal) {
                        if (e.key === 'Escape') {
                            if (stackedModal) {
                                UI.closeModal(activeModal);
                            } else {
                                UI.closeAllModals();
                            }
                        }
                        if (e.key === 'Tab') App.handleFocusTrap(e);
                        if (activeModal.id === 'studentDetailsModal') {
                            if (e.key === 'ArrowLeft' && !DOM.prevStudentBtn.disabled) { e.preventDefault(); App.navigateStudentDetails(-1); }
                            if (e.key === 'ArrowRight' && !DOM.nextStudentBtn.disabled) { e.preventDefault(); App.navigateStudentDetails(1); }
                        }
                        if (activeModal.id === 'refinementModal') {
                            if (e.key === 'ArrowLeft' && !DOM.prevRefinementStudentBtn.disabled) { e.preventDefault(); App.navigateRefinementModal(-1); }
                            if (e.key === 'ArrowRight' && !DOM.nextRefinementStudentBtn.disabled) { e.preventDefault(); App.navigateRefinementModal(1); }
                        }
                    } else {
                        if (e.ctrlKey && e.key.toLowerCase() === 'z') {
                            const editor = document.activeElement;
                            if (editor && editor.isContentEditable) {
                                e.preventDefault();
                                App.undoEditorState(editor.id);
                            }
                        }
                        if (e.ctrlKey && e.key.toLowerCase() === 'y') {
                            const editor = document.activeElement;
                            if (editor && editor.isContentEditable) {
                                e.preventDefault();
                                App.redoEditorState(editor.id);
                            }
                        }
                        App.handleResultListKeyboardNav(e);
                    }
                });
                
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 200) {
                        DOM.backToTopBtn.classList.add('show');
                    } else {
                        DOM.backToTopBtn.classList.remove('show');
                    }
                });
            },
            async fetchAnalysesForStudent(id) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (!result) return;
            
                // We create two independent paths for each analysis
                const analyzeSW = async () => {
                    if (result.strengthsWeaknesses === null) {
                        try {
                            await AppreciationsManager.generateStrengthsWeaknesses(id, true);
                            const updatedResult = appState.generatedResults.find(r => r.id === id);
                            DOM.strengthsWeaknessesContent.innerHTML = AppreciationsManager.parseStrengthsWeaknesses(updatedResult.strengthsWeaknesses);
                        } catch (error) {
                            DOM.strengthsWeaknessesContent.innerHTML = `<p style="color: var(--error-color); font-size:0.9em;">Échec de la génération.</p><div style="text-align: right; margin-top:10px;"><button class="btn btn-warning btn-small" onclick="App.refetchAnalyses('${id}', 'sw')">🔄 Régénérer</button></div>`;
                        }
                    } else {
                         DOM.strengthsWeaknessesContent.innerHTML = AppreciationsManager.parseStrengthsWeaknesses(result.strengthsWeaknesses);
                    }
                };
            
                const analyzeNS = async () => {
                     if (result.nextSteps === null) {
                        try {
                            await AppreciationsManager.generateNextSteps(id, true);
                            const updatedResult = appState.generatedResults.find(r => r.id === id);
                            DOM.nextStepsList.innerHTML = updatedResult.nextSteps?.length ? updatedResult.nextSteps.map(step => `<li>${Utils.cleanMarkdown(Utils.decodeHtmlEntities(step))}</li>`).join('') : '<li>Aucune piste générée.</li>';
                        } catch (error) {
                            DOM.nextStepsList.innerHTML = `<li><p style="color: var(--error-color);font-size:0.9em;">Échec de la génération.</p><div style="text-align: right; margin-top:10px;"><button class="btn btn-warning btn-small" onclick="App.refetchAnalyses('${id}', 'ns')">🔄 Régénérer</button></div></li>`;
                        }
                    } else {
                        DOM.nextStepsList.innerHTML = result.nextSteps?.length ? result.nextSteps.map(step => `<li>${Utils.cleanMarkdown(Utils.decodeHtmlEntities(step))}</li>`).join('') : '<li>Aucune piste disponible.</li>';
                    }
                };
                
                // Run both analyses in parallel
                Promise.all([analyzeSW(), analyzeNS()]);
            },
            refetchAnalyses(id, type) {
                if(type === 'sw') {
                    DOM.strengthsWeaknessesContent.innerHTML = `<div class="analysis-loading-state"><div class="loading-spinner" style="width: 16px; height: 16px;"></div><span>Génération de l'analyse...</span></div>`;
                }
                if(type === 'ns') {
                    DOM.nextStepsList.innerHTML = `<li><div class="analysis-loading-state"><div class="loading-spinner" style="width: 16px; height: 16px;"></div><span>Génération des pistes...</span></div></li>`;
                }
                const result = appState.generatedResults.find(r => r.id === id);
                if(result) {
                    if(type === 'sw') result.strengthsWeaknesses = null;
                    if(type === 'ns') result.nextSteps = null;
                    App.fetchAnalysesForStudent(id);
                }
            },
            handleFocusTrap(e) {
                 const focusableElements = activeModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                const visibleFocusableElements = Array.from(focusableElements).filter(el => el.offsetParent !== null && !el.disabled);
                if (visibleFocusableElements.length === 0) { e.preventDefault(); return; }
                const firstElement = visibleFocusableElements[0];
                const lastElement = visibleFocusableElements[visibleFocusableElements.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        lastElement.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        firstElement.focus();
                        e.preventDefault();
                    }
                }
            },
            updateUIOnLoad() {
                UI.updateDarkModeButtonIcon();
                UI.populateSubjectSelect();
                UI.setQuarterMode(appState.currentQuarterMode || 'T1');
                const initialQuarterRadio = document.getElementById(`quarter${appState.currentQuarterMode || 'T1'}`); if (initialQuarterRadio) initialQuarterRadio.checked = true;
                UI.setInputMode(appState.currentInputMode || 'mass'); UI.setGenerationMode(appState.generationMode); AppreciationsManager.renderResults(); UI.updateHeaderPremiumLook();
                if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = APP_VERSION;
            },
            setupAutoSave() { setInterval(() => StorageManager.saveAppState(), CONFIG.AUTO_SAVE_INTERVAL_MS); },
            
            handleFileImport(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    try {
                        if (file.name.endsWith('.json')) {
                            const importedData = JSON.parse(content);
                            if (importedData.generatedResults && importedData.settings) {
                                UI.showCustomConfirm("Ce fichier contient des données complètes (élèves et paramètres). Voulez-vous tout écraser ?", () => {
                                    appState.generatedResults = importedData.generatedResults || [];
                                    Object.assign(appState, importedData.settings || {});
                                    StorageManager.saveAppState();
                                    App.updateUIOnLoad();
                                    UI.showNotification('État complet de l\'application importé !', 'success');
                                });
                            } 
                            else if (importedData.subjects) {
                                 UI.showCustomConfirm("Ce fichier contient uniquement des paramètres. Voulez-vous écraser vos paramètres actuels (hors clés API) ?", () => {
                                    StorageManager.importSettings(content);
                                 });
                            } else {
                                throw new Error('Format JSON non reconnu.');
                            }
                        } else if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                            if (DOM.massData) {
                                DOM.massData.value = content;
                                DOM.massData.dispatchEvent(new Event('paste')); // Déclenche le focus
                                UI.setInputMode('mass');
                                UI.showNotification('Fichier copié dans la zone de saisie.', 'success');
                            }
                        } else {
                            UI.showNotification('Format de fichier non supporté (.json, .csv, .txt).', 'error');
                        }
                    } catch (error) {
                        console.error('Erreur importation:', error);
                        UI.showNotification(`Erreur importation : ${error.message}`, 'error');
                    }
                };
                reader.onerror = () => UI.showNotification('Impossible de lire le fichier.', 'error');
                reader.readAsText(file);
            },
            async validateApiKey(apiKey, provider) {
                const buttonId = provider === 'openai' ? 'validateApiKeyBtn' : 'validateGeminiApiKeyBtn';
                const inputId = provider === 'openai' ? 'openaiApiKey' : 'geminiApiKey';
                const errorId = provider === 'openai' ? 'openaiApiKeyError' : 'geminiApiKeyError';
                const button = DOM[buttonId];
                const input = DOM[inputId];
                const errorEl = DOM[errorId];
                
                if (!apiKey.trim()) {
                    UI.showNotification('Veuillez entrer une clé API à vérifier.', 'warning');
                    return;
                }

                UI.showInlineSpinner(button);
                input.classList.remove('input-error', 'input-success');
                if(errorEl) errorEl.style.display = 'none';
                
                try {
                    let validationUrl = '';
                    let headers = {};
                    if (provider === 'openai') {
                         validationUrl = `${CONFIG.OPENAI_API_BASE}/models`;
                         headers['Authorization'] = `Bearer ${apiKey}`;
                    } else if (provider === 'gemini') {
                         validationUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                    } else {
                        throw new Error("Validation pour ce fournisseur non implémentée.");
                    }
                    const response = await fetch(validationUrl, { headers });
                    if(!response.ok) throw new Error(`Clé API invalide ou problème réseau (${response.status})`);
                    
                    if (provider === 'openai') appState.openaiApiKey = apiKey;
                    if (provider === 'gemini') appState.geminiApiKey = apiKey;
                    StorageManager.saveAppState();
                    
                    UI.showNotification(`Clé API ${provider.charAt(0).toUpperCase() + provider.slice(1)} valide et enregistrée !`, 'success');
                    input.classList.add('input-success');
                } catch (error) {
                    UI.showNotification(`Clé API invalide : ${error.message}`, 'error');
                    input.classList.add('input-error');
                } finally {
                    UI.hideInlineSpinner(button);
                }
            },
            saveSettings() {
                appState.subjects[appState.currentSettingsSubject].templates = {
                    T1: Utils.serializeEditorToString(DOM.settingsPromptT1),
                    T2: Utils.serializeEditorToString(DOM.settingsPromptT2),
                    T3: Utils.serializeEditorToString(DOM.settingsPromptT3)
                };
                const newPositive = parseFloat(DOM.settingsEvolutionThresholdPositive.value); const newVeryPositive = parseFloat(DOM.settingsEvolutionThresholdVeryPositive.value);
                const newNegative = parseFloat(DOM.settingsEvolutionThresholdNegative.value); const newVeryNegative = parseFloat(DOM.settingsEvolutionThresholdVeryNegative.value);
                if (isNaN(newPositive) || newPositive < 0 || isNaN(newVeryPositive) || newVeryPositive < 0 || isNaN(newNegative) || newNegative > 0 || isNaN(newVeryNegative) || newVeryNegative > 0) { UI.showNotification('Seuils d\'évolution invalides.', 'error'); return; }
                if (newPositive >= newVeryPositive) { UI.showNotification('Le seuil de "très forte progression" doit être supérieur à celui de "progression notable".', 'error'); return; }
                if (newNegative <= newVeryNegative) { UI.showNotification('Le seuil de "forte baisse" doit être inférieur à celui de "léger recul".', 'error'); return; }
                appState.evolutionThresholds = { positive: newPositive, veryPositive: newVeryPositive, negative: newNegative, veryNegative: newVeryNegative };
                const newWordCount = parseInt(DOM.wordCountLimitInput.value);
                if (isNaN(newWordCount) || newWordCount < 10) { UI.showNotification('Limite de mots invalide (min 10).', 'error'); return; }
                appState.wordCountLimit = newWordCount;
                appState.instructionsGlobal = DOM.negativeInstructionsGlobal.value.trim();
                appState.systemPrompts.T1 = DOM.systemPromptT1.value;
                appState.systemPrompts.T2 = DOM.systemPromptT2.value;
                appState.systemPrompts.T3 = DOM.systemPromptT3.value;
                appState.currentAIModel = DOM.aiModelSelect.value; appState.openaiApiKey = DOM.openaiApiKey.value.trim(); appState.geminiApiKey = DOM.geminiApiKey.value.trim();
                appState.mistralApiKey = DOM.mistralApiKey.value.trim(); appState.qwenApiKey = DOM.qwenApiKey.value.trim(); appState.deepseekApiKey = DOM.deepseekApiKey.value.trim();
                StorageManager.saveAppState(); UI.updateAIPromptDisplays(); UI.updateHeaderPremiumLook();
                if (appState.generationMode === 'AI' && !UI.checkAPIKeyPresence(true)) { UI.showNotification(`Clé API pour ${appState.currentAIModel} est manquante. Le mode Automate pourrait être utilisé.`, 'warning'); }
                else { UI.showNotification('Paramètres enregistrés !', 'success'); }
                UI.closeModal(DOM.settingsModal);
            },
            setupPWA() {
                let deferredPrompt; window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.add('show'); });
                DOM.pwaInstallBtn?.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; console.log(`PWA install prompt outcome: ${outcome}`); deferredPrompt = null; if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.remove('show'); } });
                DOM.pwaDismissBtn?.addEventListener('click', () => { if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.remove('show'); });
                window.addEventListener('appinstalled', () => { if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.remove('show'); UI.showNotification('Application installée !', 'success'); });
            },
            saveRefinementEdit() {
                const id = appState.currentRefiningAppreciationId;
                if (!id) return;

                if (!appState.refinementEdits[id]) {
                    appState.refinementEdits[id] = {};
                }
                appState.refinementEdits[id].originalText = DOM.originalAppreciationText.textContent;
                appState.refinementEdits[id].context = DOM.refinementContext.value;
                
                UI.updateWordCount('originalWordCount', DOM.originalAppreciationText.textContent);
            },
            resetRefinementChanges() {
                const id = appState.currentRefiningAppreciationId;
                const result = appState.generatedResults.find(r => r.id === id);
                if (result) {
                    delete appState.refinementEdits[id];
                    AppreciationsManager.refineAppreciation(id); // Re-render the modal with original data
                    UI.showNotification("Modifications annulées.", "info");
                }
            },
            addVocabItem(type, inputElement) {
                const subject = appState.currentSettingsSubject;
                if(subject === "Standard") return;
                const item = inputElement.value.trim();
                if (item && !appState.subjects[subject].vocabulaire[type].includes(item)) { appState.subjects[subject].vocabulaire[type].push(item); inputElement.value = ''; UI.renderVocabLists(); StorageManager.saveAppState(); UI.showNotification(`${item} ajouté aux ${type}.`, 'success'); }
                else if (!item) { UI.showNotification('Veuillez entrer un élément.', 'warning'); }
                else { UI.showNotification('Cet élément existe déjà.', 'warning'); }
            },
            addPhraseBrick(nameInput, textInput) {
                const subject = appState.currentSettingsSubject;
                if(subject === "Standard") return;
                const name = nameInput.value.trim(); const text = textInput.value.trim();
                if (name && text) {
                    if (appState.subjects[subject].vocabulaire.phraseBricks[name]) {
                        UI.showCustomConfirm(`La brique "${name}" existe déjà. Voulez-vous la modifier ?`, () => {
                            appState.subjects[subject].vocabulaire.phraseBricks[name] = text; nameInput.value = ''; textInput.value = ''; UI.renderVocabLists(); StorageManager.saveAppState(); UI.showNotification(`Brique "${name}" modifiée.`, 'success');
                        });
                    } else { appState.subjects[subject].vocabulaire.phraseBricks[name] = text; nameInput.value = ''; textInput.value = ''; UI.renderVocabLists(); StorageManager.saveAppState(); UI.showNotification(`Brique "${name}" ajoutée.`, 'success'); }
                } else { UI.showNotification('Veuillez entrer un nom ET un texte pour la brique.', 'warning'); }
            },
            handleVocabListAction(e) {
                const subject = appState.currentSettingsSubject;
                if(subject === "Standard") return;
                const button = e.target.closest('button[data-action]'); if (!button) return;
                const action = button.dataset.action; const type = button.dataset.type;
                if (action === 'delete') {
                    UI.showCustomConfirm('Supprimer cet élément ?', () => {
                        if (type === 'phraseBrick') { const keyToDelete = button.dataset.key; delete appState.subjects[subject].vocabulaire.phraseBricks[keyToDelete]; UI.showNotification(`Brique "${keyToDelete}" supprimée.`, 'success'); }
                        else { const indexToDelete = parseInt(button.dataset.index); appState.subjects[subject].vocabulaire[type].splice(indexToDelete, 1); UI.showNotification('Élément supprimé.', 'success'); }
                        UI.renderVocabLists(); StorageManager.saveAppState();
                    });
                }
            },
            saveVocabItemEdit(e) {
                const subject = appState.currentSettingsSubject;
                if(subject === "Standard") return;
                const editableSpan = e.target.closest('.vocab-item-text'); if (!editableSpan) return;
                const type = editableSpan.dataset.type; const newValue = editableSpan.textContent.trim();
                if (type === 'phraseBrick') {
                    const oldKey = editableSpan.dataset.key; const newKeyMatch = newValue.match(/^(\S+):\s*(.*)/);
                    if (newKeyMatch) {
                        const newKey = newKeyMatch[1]; const newText = newKeyMatch[2].trim();
                        if (newKey !== oldKey) {
                            if (appState.subjects[subject].vocabulaire.phraseBricks[newKey] && newKey !== oldKey) { UI.showNotification(`Une brique avec le nom "${newKey}" existe déjà.`, 'error'); editableSpan.innerHTML = `<b>${oldKey}</b>: ${appState.subjects[subject].vocabulaire.phraseBricks[oldKey]}`; return; }
                            delete appState.subjects[subject].vocabulaire.phraseBricks[oldKey]; appState.subjects[subject].vocabulaire.phraseBricks[newKey] = newText;
                            editableSpan.dataset.key = newKey; editableSpan.innerHTML = `<b>${newKey}</b>: ${newText}`; UI.showNotification(`Brique "${oldKey}" renommée et modifiée en "${newKey}".`, 'success');
                        } else { appState.subjects[subject].vocabulaire.phraseBricks[oldKey] = newText; editableSpan.innerHTML = `<b>${oldKey}</b>: ${newText}`; UI.showNotification(`Brique "${oldKey}" modifiée.`, 'success'); }
                    } else { UI.showNotification('Format de brique invalide. Utilisez "Nom: Texte".', 'error'); editableSpan.innerHTML = `<b>${oldKey}</b>: ${appState.subjects[subject].vocabulaire.phraseBricks[oldKey]}`; return; }
                } else {
                    const index = parseInt(editableSpan.dataset.index);
                    if (newValue && (!appState.subjects[subject].vocabulaire[type].includes(newValue) || appState.subjects[subject].vocabulaire[type][index] === newValue) ) { appState.subjects[subject].vocabulaire[type][index] = newValue; UI.showNotification('Élément modifié.', 'success'); }
                    else if (!newValue) { UI.showNotification('Un élément ne peut pas être vide. Supprimez-le si vous ne le voulez plus.', 'warning'); editableSpan.textContent = appState.subjects[subject].vocabulaire[type][index]; }
                    else { UI.showNotification('Cet élément existe déjà. Revert.', 'warning'); editableSpan.textContent = appState.subjects[subject].vocabulaire[type][index]; }
                }
                StorageManager.saveAppState();
            },
            handleVocabItemKeydown(e) { const editableSpan = e.target.closest('.vocab-item-text'); if (editableSpan && e.key === 'Enter') { e.preventDefault(); editableSpan.blur(); } },
            addSubject() {
                const input = DOM.addSubjectInput;
                const newSubject = input.value.trim();
                if (Utils.validateInput(input)) {
                    appState.subjects[newSubject] = JSON.parse(JSON.stringify(appState.subjects.Standard));
                    appState.currentSettingsSubject = newSubject;
                    input.value = '';
                    App.renderSubjectManagementList();
                    UI.updateSettingsPromptFields();
                    StorageManager.saveAppState();
                    UI.showNotification(`Matière "${newSubject}" ajoutée.`, 'success');
                }
            },
            deleteSubject(subject) {
                if (subject === "Standard") {
                    UI.showNotification("La matière 'Standard' ne peut pas être supprimée.", 'warning');
                    return;
                }
                UI.showCustomConfirm(`Voulez-vous vraiment supprimer la matière "${subject}" et tous ses templates ?`, () => {
                    delete appState.subjects[subject];
                    if (appState.currentSubject === subject) {
                        appState.currentSubject = "Standard";
                    }
                    if (appState.currentSettingsSubject === subject) {
                        appState.currentSettingsSubject = "Standard";
                    }
                    UI.populateSubjectSelect();
                    UI.updateSettingsPromptFields();
                    StorageManager.saveAppState();
                    UI.showNotification(`Matière "${subject}" supprimée.`, 'success');
                });
            },
            renderSubjectManagementList() {
                if (!DOM.subjectManagementContainer) return;
                const selectedSubject = appState.currentSettingsSubject;
                DOM.subjectManagementContainer.innerHTML = '';
                
                const subjects = Object.keys(appState.subjects);
                const sortedSubjects = ["Standard", ...subjects.filter(s => s !== "Standard").sort()];

                sortedSubjects.forEach(subject => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'subject-list-item';
                    if (subject === selectedSubject) {
                        itemDiv.classList.add('active');
                    }
                    itemDiv.dataset.subject = subject;
                    
                    let deleteButton = '';
                    let icon = '';
                    if (subject === "Standard") {
                       icon = '<span style="margin-right: 8px;">🔒</span>';
                    } else { 
                       deleteButton = `<button class="subject-delete-btn" data-subject="${subject}" title="Supprimer la matière">🗑️</button>`;
                    }
                    itemDiv.innerHTML = `<span>${icon}${subject}</span>${deleteButton}`;
                    DOM.subjectManagementContainer.appendChild(itemDiv);
                });
            },
            navigateStudentDetails(direction) {
                const newIndex = appState.currentDetailViewIndex + direction;
                if (newIndex >= 0 && newIndex < appState.filteredResults.length) {
                    const modalContent = DOM.studentDetailsModal.querySelector('.modal-content');
                    if(modalContent) {
                        modalContent.classList.remove('slide-in-right', 'slide-in-left');
                        void modalContent.offsetWidth; // Force reflow
                        modalContent.classList.add(direction > 0 ? 'slide-in-right' : 'slide-in-left');
                    }
                    const newStudentId = appState.filteredResults[newIndex].id;
                    AppreciationsManager.showAppreciationDetails(newStudentId);
                }
            },
            navigateRefinementModal(direction) {
                const newIndex = appState.currentRefiningIndex + direction;
                if (newIndex >= 0 && newIndex < appState.filteredResults.length) {
                    const modalContent = DOM.refinementModal.querySelector('.modal-content');
                     if(modalContent) {
                        modalContent.classList.remove('slide-in-right', 'slide-in-left');
                        void modalContent.offsetWidth; // Force reflow
                        modalContent.classList.add(direction > 0 ? 'slide-in-right' : 'slide-in-left');
                    }
                    const newStudentId = appState.filteredResults[newIndex].id;
                    AppreciationsManager.refineAppreciation(newStudentId);
                }
            },
            handleResultListKeyboardNav(e) {
                if (e.key !== 'ArrowDown' && e.key !== 'ArrowUp') return;
                
                const currentFocused = document.activeElement;
                if (!currentFocused || !currentFocused.classList.contains('appreciation-result')) {
                    const firstResult = DOM.resultsDiv.querySelector('.appreciation-result');
                    if (firstResult) firstResult.focus();
                    return;
                }

                e.preventDefault();
                let nextElement;
                if (e.key === 'ArrowDown') {
                    nextElement = currentFocused.nextElementSibling;
                } else if (e.key === 'ArrowUp') {
                    nextElement = currentFocused.previousElementSibling;
                }

                if (nextElement && nextElement.classList.contains('appreciation-result')) {
                    nextElement.focus();
                }
            },
            updateTemplatePreview(editorId) {
                const quarter = editorId.replace('promptTemplate', '');
                const previewElement = document.getElementById(`templatePreview${quarter}`);
                if (!previewElement) return;

                const templateString = Utils.serializeEditorToString(document.getElementById(editorId));
                
                const studentDataExample = { nom: "MARTIN", prenom: "Lucas", moyT1: 12.5, moyT2: 13.8, moyT3: 14.2, appT1: "Bon T1.", appT2: "En progrès.", statut: "", quarterMode: quarter };
                
                const previewText = AppreciationsManager.buildAppreciationTextFromTemplate(studentDataExample);

                previewElement.textContent = previewText || "Aperçu...";
            },
            setupEditorObserver(editorId) {
                const editor = document.getElementById(editorId);
                if (!editor) return;

                editorHistory[editorId] = {
                    states: [editor.innerHTML],
                    index: 0
                };
                
                const debouncedUpdate = Utils.debounce(() => {
                    App.recordEditorState(editorId);
                    App.updateTemplatePreview(editorId);
                }, 500);

                const observer = new MutationObserver(debouncedUpdate);

                observer.observe(editor, {
                    childList: true,
                    subtree: true,
                    characterData: true,
                });
                
                editorHistory[editorId].observer = observer;
            },
            recordEditorState(editorId) {
                const editor = document.getElementById(editorId);
                const history = editorHistory[editorId];
                if (!editor || !history) return;
                
                const currentState = editor.innerHTML;
                
                if (history.index < history.states.length - 1) {
                    history.states = history.states.slice(0, history.index + 1);
                }
                
                if (history.states[history.states.length - 1] !== currentState) {
                    history.states.push(currentState);
                    history.index++;
                }
            },
            undoEditorState(editorId) {
                const history = editorHistory[editorId];
                if (!history || history.index <= 0) return;
                
                history.index--;
                const editor = document.getElementById(editorId);
                const observer = history.observer;

                observer.disconnect();
                editor.innerHTML = history.states[history.index];
                App.updateTemplatePreview(editorId);
                observer.observe(editor, { childList: true, subtree: true, characterData: true });
            },
            redoEditorState(editorId) {
                const history = editorHistory[editorId];
                if (!history || history.index >= history.states.length - 1) return;

                history.index++;
                const editor = document.getElementById(editorId);
                const observer = history.observer;

                observer.disconnect();
                editor.innerHTML = history.states[history.index];
                App.updateTemplatePreview(editorId);
                observer.observe(editor, { childList: true, subtree: true, characterData: true });
            }
        };

        document.addEventListener('DOMContentLoaded', App.init);
</script>
