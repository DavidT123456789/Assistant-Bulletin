<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'appréciations - Version Pro Affinée v2.9.6</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables CSS pour les thèmes */
        :root {
            --bg-color: #f8fafc;
            --text-color: #334155;
            --header-bg-start: #4f46e5;
            --header-bg-end: #7c3aed;
            --section-bg: white;
            --section-shadow: rgba(0,0,0,0.07);
            --border-color: #e2e8f0;
            --label-color: #475569;
            --input-border: #cbd5e0;
            --input-focus: #6366f1;
            --appreciation-bg: #f0fdf4;
            --appreciation-border: #22c55e;
            --appreciation-text-color: #374151;
            --student-name-color: #1e293b;
            --summary-details-color: #64748b;
            --button-primary-start: #6366f1;
            --button-primary-end: #8b5cf6;
            --button-secondary-start: #64748b;
            --button-secondary-end: #475569;
            --button-danger: #ef4444;
            --modal-bg: #ffffff;
            --modal-overlay: rgba(0,0,0,0.5);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --progress-bg: #e5e7eb;
            --progress-fill: #6366f1;

            --evolution-very-positive-bg: rgba(5, 150, 105, 0.15);
            --evolution-very-positive-text: #047857;
            --evolution-positive-bg: rgba(16, 185, 129, 0.15);
            --evolution-positive-text: #059669;
            --evolution-stable-bg: rgba(100, 116, 139, 0.15);
            --evolution-stable-text: #475569;
            --evolution-negative-bg: rgba(245, 158, 11, 0.15);
            --evolution-negative-text: #d97706;
            --evolution-very-negative-bg: rgba(239, 68, 68, 0.15);
            --evolution-very-negative-text: #dc2626;

            --animated-bg-color1: #f0f4f8;
            --animated-bg-color2: #e6eaf0;

            --notification-success-bg: rgba(16, 185, 129, 0.8);
            --notification-error-bg: rgba(239, 68, 68, 0.8);
            --notification-warning-bg: rgba(245, 158, 11, 0.8);
            --notification-info-bg: rgba(230, 230, 250, 0.9);

            --stat-total-bg: rgba(99, 102, 241, 0.1);
            --stat-total-border: #6366f1;
            --stat-average-bg: rgba(6, 182, 212, 0.1);
            --stat-average-border: #06b6d4;
            --stat-progress-bg: rgba(16, 185, 129, 0.1);
            --stat-progress-border: #10b981;
            --stat-stable-bg: rgba(100, 116, 139, 0.1);
            --stat-stable-border: #64748b;
            --stat-regression-bg: rgba(239, 68, 68, 0.1);
            --stat-regression-border: #ef4444;
            --stat-words-bg: rgba(251, 191, 36, 0.1);
            --stat-words-border: #facc15;

            --statut-bg: #e0f2fe;
            --statut-text: #0284c7;

            --header-pill-bg: rgba(0, 0, 0, 0.2);
            --header-pill-active-bg: #fff;
            --header-pill-active-text: #4f46e5;
            --header-glass-bg: rgba(255, 255, 255, 0.1);
            --header-glass-border: rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] {
            --bg-color: #0b1120;
            --text-color: #e2e8f0;
            --header-bg-start: #24224b;
            --header-bg-end: #1a1936;
            --section-bg: #161f32;
            --section-shadow: rgba(0,0,0,0.3);
            --border-color: #2d3748;
            --label-color: #cbd5e0;
            --input-border: #4a5568;
            --appreciation-bg: #1a233a;
            --appreciation-border: #059669;
            --appreciation-text-color: #e5e7eb;
            --student-name-color: #f1f5f9;
            --summary-details-color: #a0aec0;
            --modal-bg: #161f32;
            --progress-bg: #2d3748;

            --evolution-very-positive-bg: rgba(6, 182, 212, 0.15);
            --evolution-very-positive-text: #22d3ee;
            --evolution-positive-bg: rgba(5, 150, 105, 0.15);
            --evolution-positive-text: #10b981;
            --evolution-stable-bg: rgba(100, 116, 139, 0.15);
            --evolution-stable-text: #94a3b8;
            --evolution-negative-bg: rgba(251, 191, 36, 0.15);
            --evolution-negative-text: #facc15;
            --evolution-very-negative-bg: rgba(239, 68, 68, 0.15);
            --evolution-very-negative-text: #f87171;

            --animated-bg-color1: #111827;
            --animated-bg-color2: #0f172a;

            --notification-success-bg: rgba(5, 150, 105, 0.8);
            --notification-error-bg: rgba(239, 68, 68, 0.8);
            --notification-warning-bg: rgba(251, 191, 36, 0.8);
            --notification-info-bg: rgba(55, 65, 81, 0.9);

            --stat-total-bg: rgba(99, 102, 241, 0.15);
            --stat-average-bg: rgba(6, 182, 212, 0.15);
            --stat-progress-bg: rgba(16, 185, 129, 0.15);
            --stat-stable-bg: rgba(100, 116, 139, 0.15);
            --stat-regression-bg: rgba(239, 68, 68, 0.15);
            --stat-words-bg: rgba(251, 191, 36, 0.15);

            --statut-bg: #075985;
            --statut-text: #7dd3fc;
            
            --header-pill-bg: rgba(0, 0, 0, 0.2);
            --header-pill-active-bg: #6366f1;
            --header-pill-active-text: #fff;
            --header-glass-bg: rgba(255, 255, 255, 0.08);
            --header-glass-border: rgba(255, 255, 255, 0.1);
        }

        html { scroll-behavior: smooth; }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1400px; margin: 0 auto; padding: 20px;
            background: linear-gradient(135deg, var(--animated-bg-color1) 0%, var(--animated-bg-color2) 100%);
            background-size: 200% 200%; color: var(--text-color); line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; position: relative;
        }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--input-border); border-radius: 10px; border: 2px solid var(--bg-color); }
        ::-webkit-scrollbar-thumb:hover { background: var(--input-focus); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .header {
            background: linear-gradient(120deg, var(--header-bg-start) 0%, var(--header-bg-end) 100%);
            color: white; padding: 25px 30px; border-radius: 20px;
            text-align: center; margin-bottom: 30px;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* --- AMÉLIORATION FINALE : DESIGN "GLASSMORPHISM & PILL" --- */
        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header h1 {
            margin: 0; font-size: 2em; font-weight: 700;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            flex-grow: 1;
        }

        .header-badges, .header-actions {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .badge {
            background: var(--header-glass-bg);
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--header-glass-border);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .icon-button {
            background: var(--header-glass-bg);
            border: 1px solid var(--header-glass-border);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
        }
        .icon-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .header-selectors {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .quarter-selector, .generation-mode-selector, .subject-filter {
            background: var(--header-pill-bg);
            border-radius: 50px;
            padding: 4px;
            height: 44px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .quarter-selector input[type="radio"],
        .generation-mode-selector input[type="radio"] {
            display: none;
        }
        
        .quarter-selector label,
        .generation-mode-selector label {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            padding: 0 18px;
            font-size: 0.9em;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.85);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            white-space: nowrap;
        }
        
        .quarter-selector label:hover,
        .generation-mode-selector label:hover {
             color: #fff;
             background-color: rgba(255, 255, 255, 0.05);
        }
        
        .quarter-selector input[type="radio"]:checked + label,
        .generation-mode-selector input[type="radio"]:checked + label {
            background-color: var(--header-pill-active-bg);
            color: var(--header-pill-active-text);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        .subject-filter {
            position: relative;
        }

        .subject-filter select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: transparent;
            border: none;
            height: 100%;
            padding: 0 35px 0 18px;
            font-size: 0.9em;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            transition: color 0.25s ease-in-out;
        }
        .subject-filter select:focus { outline: none; }
        .subject-filter select:hover { color: #fff; }

        .subject-filter::after {
            content: '▼';
            font-size: 0.65em;
            color: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
        }
        .subject-filter select option {
            background-color: var(--header-bg-start);
            color: white;
        }

        .generation-mode-selector .info-icon {
            margin-left: 8px;
            color: inherit;
        }
        /* --- FIN NOUVEAU DESIGN --- */
        
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .input-section, .output-section { background: var(--section-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px var(--section-shadow); transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .input-section.fade-in { animation: fadeInScale 0.3s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .section-header { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); position: relative; z-index: 1; }
        .section-title { color: var(--label-color); margin: 0; font-size: 1.8em; font-weight: 700; display: flex; align-items: center; gap: 12px; text-align: left; margin-bottom: 15px; width: 100%; }
        .section-title > span:first-child { flex-grow: 1; display: flex; align-items: center; gap: 12px;}
        .section-title .icon { font-size: 1.2em; color: var(--input-focus); }
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 45px 12px 15px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 14px; background-color: var(--section-bg); color: var(--text-color); transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--input-focus); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--summary-details-color); font-size: 1.2em; }
        .controls-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { background: linear-gradient(135deg, var(--button-primary-start) 0%, var(--button-primary-end) 100%); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); box-shadow: 0 2px 10px rgba(0,0,0,0.1); filter: brightness(1.0); }
        .btn-secondary { background: linear-gradient(135deg, var(--button-secondary-start) 0%, var(--button-secondary-end) 100%); }
        .btn-secondary:hover { box-shadow: 0 10px 30px rgba(100, 116, 139, 0.5); }
        .btn-danger { background: var(--button-danger); }
        .btn-danger:hover { box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5); }
        .btn-small { padding: 8px 12px; font-size: 12px; }
        .student-form, .import-section { margin-bottom: 25px; padding: 25px; border: 2px solid var(--border-color); border-radius: 12px; background-color: var(--bg-color); transition: all 0.3s ease; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-weight: 600; margin-bottom: 8px; color: var(--label-color); font-size: 14px; transition: color 0.3s ease; }
        input, textarea, select { padding: 12px 15px; border: 2px solid var(--input-border); border-radius: 10px; font-size: 14px; background-color: var(--section-bg); color: var(--text-color); transition: all 0.3s ease; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--input-focus); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); transform: translateY(-1px); }
        #appT1, #appT2 {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .input-error { border-color: var(--error-color) !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important; }
        .error-message { color: var(--error-color); font-size: 12px; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        textarea { min-height: 80px; resize: vertical; }
        .mass-import-buttons, .single-student-form-buttons, .settings-modal-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 20px; }
        .appreciation-result { background: var(--appreciation-bg); border: 2px solid var(--appreciation-border); border-radius: 12px; padding: 25px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); opacity: 0; transform: translateY(20px); animation: slideInFadeIn 0.5s ease-out forwards; }
        .appreciation-result.hidden { display: none; }
        .appreciation-result:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        @keyframes slideInFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .appreciation-result.highlight { animation: highlightPulse 2s ease-out; }
        @keyframes highlightPulse { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .student-name { font-weight: 700; color: var(--student-name-color); font-size: 1.2em; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .student-grades-display { font-size: 0.75em; font-weight: 500; color: var(--summary-details-color); margin-left: 10px; }
        .student-summary-details { font-size: 13px; color: var(--summary-details-color); margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; }
        .detail-chip { background: rgba(99, 102, 241, 0.1); color: var(--input-focus); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        #currentQuarterDisplayInputSection { margin-left: auto; }
        .statut-chip { background: var(--statut-bg); color: var(--statut-text); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .appreciation-text { font-style: italic; line-height: 1.8; color: var(--appreciation-text-color); margin-bottom: 15px; text-align: justify; }
        .word-count { text-align: right; font-size: 13px; color: var(--summary-details-color); margin-bottom: 15px; font-weight: 500; }
        .evolution-indicator { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; gap: 5px; }
        .evolution-very-positive { background-color: var(--evolution-very-positive-bg); color: var(--evolution-very-positive-text); }
        .evolution-positive { background-color: var(--evolution-positive-bg); color: var(--evolution-positive-text); }
        .evolution-stable { background-color: var(--evolution-stable-bg); color: var(--evolution-stable-text); }
        .evolution-negative { background-color: rgba(245, 158, 11, 0.15); color: var(--evolution-negative-text); }
        .evolution-very-negative { background-color: rgba(239, 68, 68, 0.15); color: var(--evolution-very-negative-text); }
        .appreciation-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .copy-btn.copied { background: var(--success-color); color: white; }
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 8px; background-color: var(--progress-bg); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--progress-fill), var(--button-primary-end)); border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        .progress-text { text-align: center; margin-top: 8px; font-size: 14px; color: var(--summary-details-color); font-weight: 500; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--section-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px var(--section-shadow); }
        .stat-card.total-color { background-color: var(--stat-total-bg); border-color: var(--stat-total-border); }
        .stat-card.average-color { background-color: var(--stat-average-bg); border-color: var(--stat-average-border); }
        .stat-card.progress-color { background-color: var(--stat-progress-bg); border-color: var(--stat-progress-border); }
        .stat-card.stable-color { background-color: var(--stat-stable-bg); border-color: var(--stat-stable-border); }
        .stat-card.regression-color { background-color: var(--stat-regression-bg); border-color: var(--stat-regression-border); }
        .stat-card.words-color { background-color: var(--stat-words-bg); border-color: var(--stat-words-border); }
        .stat-number { font-size: 2em; font-weight: 700; color: var(--input-focus); margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: var(--summary-details-color); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; transition: color 0.2s ease; display: block; padding: 5px 0; }
        .stat-label:hover { color: var(--text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: var(--modal-overlay); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--modal-bg); padding: 30px; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); animation: modalSlideIn 0.3s ease-out; border: 1px solid var(--border-color); position: relative; }
        .modal-content p { text-align: left; }
        .modal-body .link-to-settings { color: var(--input-focus); text-decoration: underline; font-weight: 500; cursor: pointer; }
        .modal-body .link-to-settings:hover { text-decoration: none; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .modal-title { margin: 0; color: var(--label-color); font-size: 1.5em; font-weight: 600; text-align: left; }
        .close-button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--summary-details-color); padding: 5px; border-radius: 5px; position: absolute; right: 15px; top: 15px; }
        .close-button:hover { color: var(--text-color); background: rgba(0,0,0,0.1); }
        #notification-container { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 2000; pointer-events: none; width: 300px; max-width: calc(100% - 40px); align-items: flex-end; }
        .notification { padding: 15px 20px; border-radius: 10px; color: white; font-weight: 500; transform: translateX(400px); transition: transform 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); border: 1px solid rgba(255, 255, 255, 0.2); pointer-events: auto; width: 100%; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--notification-success-bg); }
        .notification.error { background: var(--notification-error-bg); }
        .notification.warning { background: var(--notification-warning-bg); }
        .notification.info { background: var(--notification-info-bg); color: var(--text-color); border: 1px solid rgba(0, 0, 0, 0.1); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        [data-theme="dark"] .notification.info { background: var(--notification-info-bg); color: var(--text-color); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .keyboard-shortcuts { display: none; }
        .shortcut { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .shortcut:last-child { margin-bottom: 0; }
        .key { background: var(--border-color); padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        
        .import-section h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        @media (max-width: 900px) { /* Adjusted breakpoint for better wrapping */
            .header {
                padding-left: 15px;
                padding-right: 15px;
            }
            .header-top-row {
                flex-direction: column;
                gap: 15px;
            }
            .header-badges { order: 1; }
            .header h1 { order: 2; font-size: 1.8em; }
            .header-actions { order: 3; }

            .header-selectors {
                flex-direction: column;
                gap: 10px;
                display: flex;
            }
            .quarter-selector,
            .generation-mode-selector,
            .subject-filter {
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .controls-bar { flex-direction: column; }
            .keyboard-shortcuts { display: none; }
            .stats-container { grid-template-columns: repeat(2, 1fr); }
            .header-stats { display: none; }
            .stat-item { width: 100%; }
            .refinement-comparison { flex-direction: column; }
        }

        [data-quarter-mode="T1"] [data-quarter-field="T2"],
        [data-quarter-mode="T1"] [data-quarter-field="T3"] { display: none !important; }
        [data-quarter-mode="T2"] [data-quarter-field="T3"] { display: none !important; }
        [data-quarter-field] { display: grid; }
        [data-quarter-mode="T1"] [data-quarter-field="T1"],
        [data-quarter-mode="T2"] [data-quarter-field="T2"],
        [data-quarter-mode="T3"] [data-quarter-field="T3"] { display: grid; }

        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 100000;
            font-weight: normal;
            min-width: 220px;
            max-width: 500px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }
        .tooltip:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Tooltip position fix for header selectors */
        .generation-mode-selector .info-icon.tooltip::after {
            bottom: auto; 
            top: 50%;
            left: calc(100% + 10px); /* Position to the right of the icon */
            transform: translateY(-50%) translateX(10px);
        }
        .generation-mode-selector .info-icon.tooltip:hover::after {
             transform: translateY(-50%) translateX(0);
        }


        #templatesTabContent h3 .info-icon { position: relative; }
        #templatesTabContent h3 .info-icon.tooltip::after {
            bottom: auto;
            top: 50%;
            left: auto;
            right: calc(100% + 8px);
            transform: translateY(-50%);
            max-width: 300px;
        }
        #templatesTabContent h3 .info-icon.tooltip:hover::after {
            transform: translateY(-50%);
        }

        .input-mode-tabs { display: flex; margin-top: 15px; border-bottom: 2px solid var(--border-color); width: 100%; }
        .input-mode-tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: var(--summary-details-color); transition: all 0.3s ease; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .input-mode-tab:hover { color: var(--text-color); }
        .input-mode-tab.active { color: var(--input-focus); border-bottom: 2px solid var(--input-focus); }
        .tab-content { padding-top: 10px; }
        .template-list-placeholder { margin-bottom: 20px; }
        .refinement-options { display: flex; flex-direction: row; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; justify-content: center; align-items: center; padding-top: 10px; padding-bottom: 10px; }
        .refinement-options button { background: var(--button-secondary-start); color: white; padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; transition: background 0.3s ease; width: auto; }
        .refinement-options button:hover { background: var(--button-secondary-end); }
        .refinement-comparison { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .refinement-comparison > div { flex: 1; min-width: 300px; }
        .refinement-box { background: var(--appreciation-bg); border: 1px solid var(--appreciation-border); border-radius: 10px; padding: 15px; min-height: 80px; color: var(--appreciation-text-color); white-space: pre-wrap; margin-bottom: 0; display: flex; align-items: center; text-align: justify; }
        .refinement-box h4 { margin-top: 0; color: var(--label-color); font-size: 1.1em; margin-bottom: 10px; font-weight: bold; }
        .refinement-actions-bottom { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .next-steps-section, .strengths-weaknesses-section { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .next-steps-section h3, .strengths-weaknesses-section h3 { color: var(--label-color); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .next-steps-list { list-style: none; padding: 0; min-height: 40px; display: flex; flex-direction: column; }
        .next-steps-list li { background: rgba(99, 102, 241, 0.05); border-left: 4px solid var(--input-focus); padding: 10px 15px; margin-bottom: 8px; border-radius: 6px; color: var(--text-color); font-size: 0.95em; text-align: left; }
        
        .strengths-weaknesses-list { list-style: none; padding: 0; min-height: 80px; display: flex; flex-direction: column;}
        .strengths-weaknesses-list ul { list-style: none; margin-left: 0; padding-left: 0; margin-bottom: 15px; }
        .strengths-weaknesses-list h4 { display: flex; align-items: center; gap: 8px; margin-top: 15px; margin-bottom: 10px; font-size: 1.1em; font-weight: 700; }
        .strengths-weaknesses-list .strengths-title { color: var(--success-color); }
        .strengths-weaknesses-list .weaknesses-title { color: var(--error-color); }
        .strengths-weaknesses-list li { padding: 8px 12px; margin-bottom: 6px; border-radius: 6px; color: var(--text-color); font-size: 0.95em; text-align: left; }
        .strengths-weaknesses-list .strengths-list li { background: rgba(16, 185, 129, 0.05); border-left: 3px solid var(--success-color); }
        .strengths-weaknesses-list .weaknesses-list li { background: rgba(239, 68, 68, 0.05); border-left: 3px solid var(--error-color); }

        .settings-tab-container {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            width: 100%;
            flex-wrap: wrap;
        }
        .settings-tab {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--summary-details-color);
            transition: all 0.3s ease;
            margin-bottom: -2px;
            flex: 1;
            text-align: center;
            white-space: normal;
            position: relative;
        }
        .settings-tab:hover {
            color: var(--text-color);
            background-color: rgba(0,0,0,0.03);
        }
        [data-theme="dark"] .settings-tab:hover {
            background-color: rgba(255,255,255,0.03);
        }
        .settings-tab.active {
            color: var(--input-focus);
            font-weight: 700;
            border-bottom-color: var(--input-focus);
            background-color: transparent;
        }

        .tab-content h3 { margin-top: 15px; margin-bottom: 15px; color: var(--label-color); font-size: 1.3em; font-weight: 700; }
        .tab-content small { color: var(--summary-details-color); font-size: 0.85em; display: block; margin-top: 5px; }
        .tab-content label { color: var(--text-color); font-weight: 600; font-size: 1em; }
        #optionsTabContent .form-group { margin-bottom: 15px; }
        #optionsTabContent .form-group:last-of-type { margin-bottom: 0; }
        #vocabulaireTabContent .form-group {
            margin-bottom: 25px;
        }
        .template-list-placeholder { margin-bottom: 20px; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .details-grid .form-group { margin-bottom: 5px;  }
        .details-grid .form-group label { margin-bottom: 4px; }
        .details-grid .form-group p { margin-bottom: 5px; }
        .details-section { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .details-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .details-content-inner { padding: 0 15px 15px 15px; color: var(--appreciation-text-color); font-style: italic; line-height: 1.6; }
        .ai-model-info { display: flex; align-items: center; gap: 8px; margin-top: 20px; font-size: 0.9em; color: var(--summary-details-color); }
        .ai-model-info .tooltip::after { bottom: 150%; }
        .details-inline-group { display: flex; align-items: baseline; gap: 10px; margin-bottom: 8px; }
        .details-inline-group label { margin-bottom: 0; white-space: nowrap; flex-shrink: 0; }
        .details-inline-group p { margin: 0; font-weight: 600; color: var(--text-color); flex-grow: 1; text-align: left; }
        .details-inline-group p.statut-chip { flex-grow: 0; }
        .appreciation-text-display { font-style: italic; line-height: 1.6; color: var(--appreciation-text-color); background-color: var(--appreciation-bg); border: 1px solid var(--appreciation-border); border-radius: 8px; padding: 12px 15px; margin-top: 8px; margin-bottom: 10px; white-space: pre-wrap; text-align: justify; }
        .loading-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: 10px; display: flex; align-items: center; gap: 12px; font-size: 16px; z-index: 1000; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); display: none; min-width: 200px; justify-content: center; }
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .help-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .help-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .help-section h3 { color: var(--label-color); margin-top: 0; margin-bottom: 15px; font-size: 1.3em; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .help-list { list-style: none; padding: 0; margin: 0; }
        .help-list li { margin-bottom: 8px; color: var(--text-color); font-size: 0.95em; text-align: left; }
        .help-code-block { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap; word-break: break-all; margin-top: 10px; text-align: left !important; }
        .help-shortcut-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .help-shortcut-item { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }
        .help-shortcut-key { background: var(--input-border); color: var(--text-color); padding: 4px 8px; border-radius: 6px; font-weight: 600; font-family: monospace; }
        .prompt-display-group { position: relative; margin-bottom: 20px; }
        .prompt-display-group label { margin-bottom: 8px; display: block; }
        .prompt-display-group textarea { width: 100%; padding-right: 40px; }
        .copy-prompt-button { position: absolute; right: 10px; top: 35px; background: var(--button-secondary-start); color: white; border: none; border-radius: 6px; padding: 6px 10px; font-size: 0.8em; cursor: pointer; transition: background 0.2s ease; }
        .copy-prompt-button:hover { background: var(--button-secondary-end); }
        .pwa-install-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--section-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 20px; z-index: 1500; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .pwa-install-banner.show { opacity: 1; visibility: visible; }
        .pwa-install-banner p { margin: 0; color: var(--text-color); font-size: 1em; }
        .pwa-install-banner .actions { display: flex; gap: 10px; }
        .pwa-install-banner .btn { padding: 8px 15px; font-size: 0.9em; }
        .drop-zone { border: 2px dashed var(--input-border); border-radius: 10px; padding: 20px; text-align: center; color: var(--summary-details-color); font-size: 1.1em; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease; background-color: var(--bg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .drop-zone.highlight { background-color: rgba(99, 102, 241, 0.1); border-color: var(--input-focus); color: var(--input-focus); }
        .drop-zone p { margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9em; }
        .drop-zone .icon { font-size: 1.5em; }
        .btn-import-file { background: var(--button-secondary-start); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-import-file:hover { background: var(--button-secondary-end); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .ai-icon {
            display: inline-block;
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            opacity: 0;
            transform: scale(0.5);
        }
        .ai-icon.active {
            opacity: 1;
            transform: scale(1);
        }
        .generic-api-key-group { /* Styles for new API key groups */ }

        /* Styles for live editing */
        .appreciation-text.editable {
            border: 1px solid var(--input-focus);
            background-color: var(--section-bg);
            padding: 12px 15px;
            border-radius: 8px;
            cursor: text;
            min-height: 80px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .appreciation-text.editable:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .edit-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .edit-controls button {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 6px;
        }

        /* Vocabulary management list */
        .vocab-list-container {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--bg-color);
            margin-top: 15px;
        }
        .vocab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-color);
        }
        .vocab-item:last-child {
            border-bottom: none;
        }
        .vocab-item-text {
            flex-grow: 1;
            margin-right: 10px;
            text-align: left;
        }
        .vocab-item-actions button {
            background: none;
            border: none;
            color: var(--summary-details-color);
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 8px;
            transition: color 0.2s ease;
        }
        .vocab-item-actions button:hover {
            color: var(--input-focus);
        }
        .vocab-add-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .vocab-add-form input {
            flex-grow: 1;
        }

        /* Preview section in single student form */
        #singleAppreciationPreview {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed var(--input-focus);
            border-radius: 10px;
            background-color: rgba(99, 102, 241, 0.05);
            color: var(--text-color);
            min-height: 50px;
            display: none; /* Hidden by default */
            align-items: center;
            text-align: justify;
            font-style: italic;
        }
        #singleAppreciationPreview.show {
            display: flex;
        }

        .template-conditional-info {
            background-color: rgba(99, 102, 241, 0.05);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--input-focus);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
            color: var(--text-color);
        }
        .template-conditional-info p {
            margin: 0 0 8px 0;
            line-height: 1.5;
            text-align: left;
        }
        .template-conditional-info p:last-child {
            margin-bottom: 0;
        }
        .template-conditional-info code {
            background-color: var(--bg-color);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .app-version-display {
            color: var(--summary-details-color);
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top-row">
            <div class="header-badges">
                <span class="badge">✅ RGPD Conforme</span>
            </div>
            <h1>
                🎓 Générateur d'appréciations <span id="headerAiStatusIcon" class="ai-icon" title="Mode IA Actif">✨</span>
            </h1>
            <div class="header-actions">
                <button id="helpButton" class="icon-button" title="Aide et astuces">❓</button>
                <button id="darkModeToggle" class="icon-button" title="Changer de thème">🌓</button>
                <button class="icon-button" id="settingsButton" title="Paramètres">⚙️</button>
            </div>
        </div>
        <div class="header-selectors">
            <div class="quarter-selector">
                <input type="radio" id="quarterT1" name="quarterModeRadio" value="T1">
                <label for="quarterT1">Trimestre 1</label>
                <input type="radio" id="quarterT2" name="quarterModeRadio" value="T2">
                <label for="quarterT2">Trimestre 2</label>
                <input type="radio" id="quarterT3" name="quarterModeRadio" value="T3">
                <label for="quarterT3">Trimestre 3</label>
            </div>
            <div class="subject-filter">
                <select id="subjectSelect">
                    <option value="Technologie">Technologie</option>
                    <option value="Mathématiques">Mathématiques</option>
                    <option value="Français">Français</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="generation-mode-selector">
                <input type="radio" id="modeAI" name="generationModeRadio" value="AI">
                <label for="modeAI">Génération IA <span class="info-icon tooltip" data-tooltip="Génère une appréciation complète en utilisant l'intelligence artificielle. L'IA adapte le texte en fonction des données de l'élève et du template sélectionné."><i class="fas fa-info-circle"></i></span></label>
                <input type="radio" id="modeTemplate" name="generationModeRadio" value="Template">
                <label for="modeTemplate">Automate <span class="info-icon tooltip" data-tooltip="Génère une appréciation en remplissant automatiquement le template avec les données de l'élève. Aucune génération de texte par l'IA."><i class="fas fa-info-circle"></i></span></label>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="input-section" id="inputSection">
            <div class="section-header">
                <h2 class="section-title">
                    <span><span class="icon">📝</span> Saisie des données</span>
                    <span id="currentQuarterDisplayInputSection" class="detail-chip"></span>
                </h2>
                <div class="input-mode-tabs" role="tablist">
                    <div id="massImportTab" class="input-mode-tab active" role="tab" aria-selected="true" aria-controls="massImportSection">Import en masse</div>
                    <div id="singleStudentTab" class="input-mode-tab" role="tab" aria-selected="false" aria-controls="singleStudentFormDiv">Saisie individuelle</div>
                </div>
            </div>

            <div id="massImportSection" class="import-section" role="tabpanel" aria-labelledby="massImportTab">
                <h3 style="margin-top: 0; color: var(--label-color);">
                    <span>📋 Données à importer :</span>
                    <span class="tooltip" id="massDataTooltip" data-tooltip="Format: NOM Prénom | Statut | Moy T1 | App T1 | Moy T2 | App T2 | Moy T3. Les champs sont séparés par un '|'. Les champs après 'Nom Prénom' sont optionnels selon le trimestre.">ℹ️</span>
                </h3>

                <div id="dropZone" class="drop-zone">
                    <p><span class="icon">📁</span> Glissez-déposez votre fichier ici</p>
                    <button class="btn-import-file" id="importFileBtn">
                        <i class="fas fa-file-upload"></i> Cliquez pour importer
                    </button>
                </div>

                <div class="form-group">
                    <label for="massData">
                        Collez vos données :
                    </label>
                    <textarea id="massData" placeholder="Exemple: MARTIN Lucas | | 12,5 | Bon travail... | 13,8 | Progression notable... | 14,2"
                              style="min-height: 120px; font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0/0 élèves traités</div>
                </div>

                <div class="mass-import-buttons">
                    <button class="btn btn-secondary" id="clearImportBtn">
                        🗑️ Vider
                    </button>
                    <button class="btn btn-secondary" id="loadSampleDataBtn">
                        📄 Données d'exemple
                    </button>
                    <button class="btn" id="importGenerateBtn">
                        ✨ Importer et générer
                    </button>
                    <button class="btn btn-danger" id="cancelImportBtn" style="display: none; margin-left: auto;">
                        <i class="fas fa-stop-circle"></i> Annuler l'import
                    </button>
                </div>
            </div>

            <div id="singleStudentFormDiv" class="student-form" style="display: none;" role="tabpanel" aria-labelledby="singleStudentTab">
                <form id="actualSingleStudentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Nom :</label>
                            <input type="text" id="nom" placeholder="Nom de famille">
                            <div class="error-message" id="nomError" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="prenom">Prénom :</label>
                            <input type="text" id="prenom" placeholder="Prénom">
                            <div class="error-message" id="prenomError" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="statut">Statut particulier :</label>
                            <select id="statut">
                                <option value="">Aucun</option>
                                <option value="Nouveau T2">Nouveau T2</option>
                                <option value="Parti">Parti</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row" data-quarter-field="T1">
                        <div class="form-group">
                            <label for="moyT1">Moyenne T1 (/20) :</label>
                            <input type="text" id="moyT1" placeholder="ex: 14.5">
                            <div class="error-message" id="moyT1Error" style="display: none;"></div>
                        </div>
                        <div class="form-group full-width">
                            <label for="appT1">Appréciation T1 :</label>
                            <textarea id="appT1" placeholder="Appréciation du premier trimestre..."></textarea>
                        </div>
                    </div>

                    <div class="form-row" data-quarter-field="T2">
                        <div class="form-group">
                            <label for="moyT2">Moyenne T2 (/20) :</label>
                            <input type="text" id="moyT2" placeholder="ex: 15.2">
                            <div class="error-message" id="moyT2Error" style="display: none;"></div>
                        </div>
                        <div class="form-group full-width">
                            <label for="appT2">Appréciation T2 :</label>
                            <textarea id="appT2" placeholder="Appréciation du deuxième trimestre..."></textarea>
                        </div>
                    </div>

                    <div class="form-row" data-quarter-field="T3">
                        <div class="form-group full-width">
                             <label for="moyT3">Moyenne T3 (/20) :</label>
                             <input type="text" id="moyT3" placeholder="ex: 16.1">
                             <div class="error-message" id="moyT3Error" style="display: none;"></div>
                        </div>
                    </div>


                    <div class="form-group full-width">
                        <label for="negativeInstructions">Instructions négatives (pour l'IA) :</label>
                        <textarea id="negativeInstructions" placeholder="Ex: Ne pas utiliser le mot 'élève', Éviter les répétitions de 'il/elle a montré'."></textarea>
                        <small>Ces instructions seront transmises à l'IA pour affiner la génération.</small>
                    </div>

                    <div id="singleAppreciationPreview" class="appreciation-text-display" role="status" aria-live="polite">
                        Prévisualisation de l'appréciation ici...
                    </div>

                    <div class="single-student-form-buttons">
                        <button type="button" class="btn btn-secondary" id="resetFormBtn">
                            🔄 Réinitialiser
                        </button>
                        <button type="button" class="btn btn-secondary" id="previewAppreciationBtn">
                            👁️ Prévisualiser
                        </button>
                        <button type="button" class="btn" id="generateAppreciationBtn">
                            ✨ Générer l'appréciation
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="output-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span><span class="icon">📋</span> Appréciations générées</span>
                </h2>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Rechercher un élève...">
                <span class="search-icon">🔍</span>
            </div>

            <div class="stats-container" id="statsContainer">
                <div class="stat-card total-color" data-stat-id="totalCount" tabindex="0" role="button" aria-label="Détails du total d'élèves">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card average-color" data-stat-id="avgGradeOutput" tabindex="0" role="button" aria-label="Détails de la moyenne générale">
                    <div class="stat-number" id="avgGradeOutput">-</div>
                    <div class="stat-label">Moyenne</div>
                </div>
                <div class="stat-card progress-color" data-stat-id="progressCount" tabindex="0" role="button" aria-label="Détails des élèves en progrès">
                    <div class="stat-number" id="progressCount">0</div>
                    <div class="stat-label">En progrès</div>
                </div>
                <div class="stat-card stable-color" data-stat-id="stableCount" tabindex="0" role="button" aria-label="Détails des élèves stables">
                    <div class="stat-number" id="stableCount">0</div>
                    <div class="stat-label">Stable</div>
                </div>
                <div class="stat-card regression-color" data-stat-id="regressionCount" tabindex="0" role="button" aria-label="Détails des élèves en régression">
                    <div class="stat-number" id="regressionCount">0</div>
                    <div class="stat-label">En régression</div>
                </div>
                <div class="stat-card words-color" data-stat-id="avgWords" tabindex="0" role="button" aria-label="Détails des mots par appréciation">
                    <div class="stat-number" id="avgWords">0</div>
                    <div class="stat-label">Mots/app</div>
                </div>
            </div>

            <div class="controls-bar">
                <button class="btn btn-danger btn-small" id="clearAllResultsBtn" tabindex="0">
                    🗑️ Effacer tout
                </button>
                <button class="btn btn-small" id="exportJsonBtn" tabindex="0">
                    ⬇️ Exporter JSON
                </button>
                <button class="btn btn-small" id="exportCsvBtn" tabindex="0">
                    📊 Exporter CSV
                </button>
                <select id="sortSelect" style="padding: 8px 12px; border-radius: 8px; border: 2px solid var(--border-color);" tabindex="0">
                    <option value="name" selected>Nom A-Z</option>
                    <option value="recent">Plus récents</option>
                    <option value="grade">Moyenne</option>
                    <option value="progress">Évolution</option>
                </select>
            </div>

            <div id="results" role="region" aria-live="polite"></div>
            <p id="noResultsMessage" style="text-align: center; color: var(--summary-details-color); margin-top: 30px; display: none;">Aucun résultat ne correspond à votre recherche.</p>
        </div>
    </div>

    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="settingsModalTitle">⚙️ Paramètres avancés</h2>
                <button class="close-button" id="closeSettingsModalBtn" aria-label="Fermer les paramètres">&times;</button>
            </div>

            <div class="settings-tab-container" role="tablist">
                <button class="settings-tab active" data-tab="templates" role="tab" aria-selected="true" aria-controls="templatesTabContent" tabindex="0">Templates</button>
                <button class="settings-tab" data-tab="vocabulaire" role="tab" aria-selected="false" aria-controls="vocabulaireTabContent" tabindex="0">Vocabulaire</button>
                <button class="settings-tab" data-tab="options" role="tab" aria-selected="false" aria-controls="optionsTabContent" tabindex="0">Options</button>
            </div>

            <div id="templatesTabContent" class="tab-content active" role="tabpanel" aria-labelledby="templatesTabButton">
                <h3>Édition du Modèle de Texte d'Appréciation Actuel (<span id="currentSubjectTemplate">Technologie</span>) :
                    <span class="info-icon tooltip" data-tooltip="Ces modèles de texte sont utilisés comme base. En mode 'Automate', ils sont remplis directement. En mode 'Génération IA', ils servent de guide pour l'IA.">ℹ️</span>
                </h3>
                <div class="template-conditional-info">
                    <p>💡 <b>Astuce pour le mode Automate :</b> utilisez une logique conditionnelle !</p>
                    <p>Syntaxe : <code>{{if [champ] [opérateur] [valeur]}} Texte si vrai {{else}} Texte si faux {{/if}}</code></p>
                    <p>Exemple : <code>{{if moyT3 > 15}}Excellent travail !{{else}}Bon travail.{{/if}}</code></p>
                    <p>Utilisez aussi vos briques de phrases : <code>{{brique:NomDeLaBrique}}</code></p>
                </div>
                <div class="form-group">
                    <label for="promptTemplateT1">Modèle de texte d'appréciation T1 :</label>
                    <textarea id="promptTemplateT1" placeholder="Utilisez des balises comme {{prenom}}, {{moyT1}}, {{niveauGlobal}}, {{encouragement}}, {{competence_aleatoire}}, {{qualite_aleatoire}}, {{activite_aleatoire}}"></textarea>
                    <small>Ce modèle est utilisé pour générer les appréciations du 1er trimestre.</small>
                </div>

                <div class="form-group">
                    <label for="promptTemplateT2">Modèle de texte d'appréciation T2 :</label>
                    <textarea id="promptTemplateT2" placeholder="Utilisez des balises comme {{prenom}}, {{moyT2}}, {{niveauGlobal}}, {{evolution_phrase}}, {{encouragement}}, {{competence_aleatoire}}, {{qualite_aleatoire}}, {{activite_aleatoire}}"></textarea>
                    <small>Ce modèle est utilisé pour générer les appréciations du 2ème trimestre.</small>
                </div>

                <div class="form-group">
                    <label for="promptTemplateT3">Modèle de texte d'appréciation T3 :</label>
                    <textarea id="promptTemplateT3" placeholder="Utilisez des balises comme {{prenom}}, {{moyT3}}, {{niveauGlobal}}, {{evolution_phrase}}, {{encouragement}}, {{competence_aleatoire}}, {{qualite_aleatoire}}, {{activite_aleatoire}}"></textarea>
                    <small>Ce modèle est utilisé pour générer les appréciations du 3ème trimestre.</small>
                </div>

                <h3>Aperçu du template sélectionné (live) :</h3>
                <div class="refinement-box">
                    <p id="templatePreviewText">Sélectionnez un trimestre pour prévisualiser le template.</p>
                </div>
            </div>

            <div id="vocabulaireTabContent" class="tab-content" style="display: none;" role="tabpanel" aria-labelledby="vocabulaireTabButton">
                <h3>Gérer le Vocabulaire et les Briques de Phrases</h3>

                <div class="form-group">
                    <label for="vocabulaireCompetences">Compétences :</label>
                    <div id="vocabCompetencesList" class="vocab-list-container"></div>
                    <div class="vocab-add-form">
                        <input type="text" id="addCompetenceInput" placeholder="Ajouter une compétence">
                        <button class="btn btn-small" id="addCompetenceBtn">Ajouter</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="vocabulaireQualites">Qualités :</label>
                    <div id="vocabQualitesList" class="vocab-list-container"></div>
                    <div class="vocab-add-form">
                        <input type="text" id="addQualiteInput" placeholder="Ajouter une qualité">
                        <button class="btn btn-small" id="addQualiteBtn">Ajouter</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="vocabulaireActivites">Activités :</label>
                    <div id="vocabActivitesList" class="vocab-list-container"></div>
                    <div class="vocab-add-form">
                        <input type="text" id="addActiviteInput" placeholder="Ajouter une activité">
                        <button class="btn btn-small" id="addActiviteBtn">Ajouter</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phraseBricks">Briques de phrases (Nom: Texte) :</label>
                    <div id="phraseBricksList" class="vocab-list-container"></div>
                    <div class="vocab-add-form">
                        <input type="text" id="addBrickNameInput" placeholder="Nom de la brique (ex: intro)">
                        <input type="text" id="addBrickTextInput" placeholder="Texte de la brique (ex: Bonjour)">
                        <button class="btn btn-small" id="addBrickBtn">Ajouter</button>
                    </div>
                    <small>Utilisez <code>{{brique:NomDeLaBrique}}</code> dans vos templates.</small>
                </div>
            </div>

            <div id="optionsTabContent" class="tab-content" style="display: none;" role="tabpanel" aria-labelledby="optionsTabButton">
                <h3>Options Générales</h3>
                <div class="form-group">
                    <label for="evolutionThresholdPositive">Seuil de progression notable (pts) :</label>
                    <input type="number" id="evolutionThresholdPositive" step="0.1" min="0" value="0.5">
                    <small>Différence minimale pour une progression "notable".</small>
                </div>
                <div class="form-group">
                    <label for="evolutionThresholdVeryPositive">Seuil de très forte progression (pts) :</label>
                    <input type="number" id="evolutionThresholdVeryPositive" step="0.1" min="0" value="2.0">
                    <small>Différence minimale pour une "très forte progression".</small>
                </div>
                <div class="form-group">
                    <label for="evolutionThresholdNegative">Seuil de léger recul (pts) :</label>
                    <input type="number" id="evolutionThresholdNegative" step="0.1" max="0" value="-0.5">
                    <small>Différence maximale pour un "léger recul".</small>
                </div>
                <div class="form-group">
                    <label for="evolutionThresholdVeryNegative">Seuil de forte baisse (pts) :</label>
                    <input type="number" id="evolutionThresholdVeryNegative" step="0.1" max="0" value="-2.0">
                    <small>Différence maximale pour une "forte baisse".</small>
                </div>
                <div class="form-group">
                    <label for="wordCountLimit">Nombre de mots max. pour l'appréciation :</label>
                    <input type="number" id="wordCountLimit" min="10" value="80">
                    <small>L'IA tentera de respecter cette limite. Le texte sera tronqué si nécessaire.</small>
                </div>
                <div class="form-group">
                    <label for="negativeInstructionsGlobal">Instructions négatives globales (pour l'IA) :</label>
                    <textarea id="negativeInstructionsGlobal" placeholder="Ex: Ne pas utiliser de langage familier, Éviter les phrases trop longues."></textarea>
                    <small>Ces instructions s'appliqueront à toutes les générations IA.</small>
                </div>
                <div class="form-group">
                    <label for="aiModelSelect">Modèle d'IA à utiliser :</label>
                    <select id="aiModelSelect">
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (par défaut)</option>
                        <option value="openai-gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
                        <option value="openai-gpt-4o">OpenAI GPT-4o</option>
                        <option value="deepseek-chat">DeepSeek Chat (Direct ou OpenRouter)</option>
                        <option value="mistral-large-latest">Mistral Large (non implémenté)</option>
                        <option value="mistral-small-latest">Mistral Small (non implémenté)</option>
                        <option value="qwen-turbo">Qwen Turbo (non implémenté)</option>
                        <option value="qwen-plus">Qwen Plus (non implémenté)</option>
                    </select>
                    <small>Choisissez le modèle d'IA pour la génération des appréciations.</small>
                </div>
                <div class="form-group" id="geminiApiKeyGroup" style="display: none;">
                    <label for="geminiApiKey">Clé API Gemini :</label>
                    <input type="password" id="geminiApiKey" placeholder="AIzaSy... (Votre clé API Gemini)">
                    <small id="geminiApiKeyHint" style="color: var(--summary-details-color);">Votre clé API Gemini. Elle est stockée localement dans votre navigateur et n'est jamais partagée.</small>
                    <div class="error-message" id="geminiApiKeyError" style="display: none;"></div>
                </div>
                <div class="form-group" id="openaiApiKeyGroup" style="display: none;">
                    <label for="openaiApiKey">Clé API OpenAI :</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
                    <small>Votre clé API OpenAI. Elle est stockée localement dans votre navigateur et n'est jamais partagée.</small>
                    <div class="error-message" id="openaiApiKeyError" style="display: none;"></div>
                </div>
                <div class="form-group generic-api-key-group" id="deepseekApiKeyGroup" style="display: none;">
                    <label for="deepseekApiKey">Clé API DeepSeek (Direct ou OpenRouter) :</label>
                    <input type="password" id="deepseekApiKey" placeholder="Votre clé API DeepSeek ou OpenRouter (sk-or-...)">
                    <small>Votre clé API DeepSeek ou OpenRouter. Stockée localement. Pour OpenRouter, utilisez votre clé OpenRouter et le modèle "DeepSeek Chat".</small>
                    <div class="error-message" id="deepseekApiKeyError" style="display: none;"></div>
                </div>
                <div class="form-group generic-api-key-group" id="mistralApiKeyGroup" style="display: none;">
                    <label for="mistralApiKey">Clé API Mistral :</label>
                    <input type="password" id="mistralApiKey" placeholder="Votre clé API Mistral">
                    <small>Votre clé API Mistral. Stockée localement.</small>
                    <div class="error-message" id="mistralApiKeyError" style="display: none;"></div>
                </div>
                <div class="form-group generic-api-key-group" id="qwenApiKeyGroup" style="display: none;">
                    <label for="qwenApiKey">Clé API Qwen (Alibaba Cloud) :</label>
                    <input type="password" id="qwenApiKey" placeholder="Votre clé API Qwen">
                    <small>Votre clé API Qwen. Stockée localement.</small>
                    <div class="error-message" id="qwenApiKeyError" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label>Version de l'application :</label>
                    <p id="appVersionDisplay" class="app-version-display"></p>
                </div>
            </div>

            <div class="settings-modal-buttons">
                <button class="btn btn-secondary" id="resetSettingsBtn" tabindex="0">
                    🔄 Réinitialiser
                </button>
                <button class="btn" id="saveSettingsBtn" tabindex="0">💾 Enregistrer</button>
                <button class="btn btn-secondary" id="cancelSettingsBtn" tabindex="0">Annuler</button>
            </div>
        </div>
    </div>

    <div id="studentDetailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="studentDetailsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="studentDetailsModalTitle">Détails de l'élève</h2>
                <button class="close-button" id="closeStudentDetailsModalBtn" aria-label="Fermer les détails de l'élève">&times;</button>
            </div>
            <div class="details-section">
                <div class="details-inline-group">
                    <label>Nom et Prénom :</label>
                    <p id="detailsStudentName"></p>
                </div>
                <div class="details-inline-group">
                    <label>Statut particulier :</label>
                    <p id="detailsStatut" class="statut-chip"></p> </div>
            </div>

            <div class="details-section">
                <div class="details-grid">
                    <div class="form-group">
                        <label>Moyenne T1 (/20) :</label>
                        <p id="detailsMoyT1" style="font-weight: 500;"></p>
                    </div>
                    <div class="form-group">
                        <label>Moyenne T2 (/20) :</label>
                        <p id="detailsMoyT2" style="font-weight: 500;"></p>
                    </div>
                    <div class="form-group">
                        <label>Moyenne T3 (/20) :</label>
                        <p id="detailsMoyT3" style="font-weight: 500;"></p>
                    </div>
                </div>
            </div>

            <div class="details-section">
                <div class="form-group">
                    <label>Appréciation T1 :</label>
                    <p id="detailsAppT1" class="appreciation-text-display"></p>
                </div>
                <div class="form-group">
                    <label>Appréciation T2 :</label>
                    <p id="detailsAppT2" class="appreciation-text-display"></p>
                </div>
                <div class="form-group">
                    <label>Appréciation actuelle :</label>
                    <p id="detailsGeneratedAppreciation" class="appreciation-text-display"></p>
                </div>
            </div>

            <div class="details-section" id="detailsTokenUsageSection" style="display: none;">
                <h4 style="color: var(--label-color); margin-bottom: 10px; font-size: 1.1em; font-weight: 600;" class="tooltip" data-tooltip="Nombre de 'mots' ou 'morceaux de mots' utilisés par l'IA pour traiter la requête et générer la réponse. Utile pour suivre les coûts si vous utilisez une API payante.">
                    <i class="fas fa-microchip"></i> Utilisation des Tokens (IA)
                </h4>
                <div class="details-grid">
                    <div class="form-group">
                        <label>Prompt :</label>
                        <p id="detailsPromptTokens" style="font-weight: 500;"></p>
                    </div>
                    <div class="form-group">
                        <label>Complétion :</label>
                        <p id="detailsCompletionTokens" style="font-weight: 500;"></p>
                    </div>
                    <div class="form-group">
                        <label>Total :</label>
                        <p id="detailsTotalTokens" style="font-weight: 500;"></p>
                    </div>
                </div>
            </div>


            <div class="strengths-weaknesses-section" id="strengthsWeaknessesSection">
                <h3><i class="fas fa-chart-line"></i> Forces et Faiblesses </h3>
                <div id="strengthsWeaknessesContent" class="strengths-weaknesses-list">
                    <p style="color: var(--summary-details-color);">Cliquez sur "Générer l'analyse" pour obtenir les forces et faiblesses.</p>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                    <button class="btn btn-secondary btn-small" id="generateStrengthsWeaknessesBtn" tabindex="0">✨ Générer l'analyse</button>
                </div>
            </div>

            <div class="next-steps-section" id="nextStepsSection">
                <h3><i class="fas fa-lightbulb"></i> Pistes d'amélioration </h3>
                <ul id="nextStepsList" class="next-steps-list">
                    <li style="color: var(--summary-details-color);">Cliquez sur "Générer les pistes" pour obtenir des suggestions.</li>
                </ul>
                <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                    <button class="btn btn-secondary btn-small" id="generateNextStepsBtn" tabindex="0">✨ Générer les pistes</button>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="closeDetailsModalBtn" tabindex="0">Fermer</button>
                <button class="btn" id="editFromModalBtn" tabindex="0">✏️ Modifier</button>
            </div>
        </div>
    </div>

    <div id="refinementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="refinementModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="refinementModalTitle">Améliorer l'appréciation</h2>
                <button class="close-button" id="closeRefinementModalBtn" aria-label="Fermer l'amélioration d'appréciation">&times;</button>
            </div>
            <div class="refinement-options">
                <button class="btn btn-secondary btn-small" data-refine-type="concise" tabindex="0">Rendre concise</button>
                <button class="btn btn-secondary btn-small" data-refine-type="detailed" tabindex="0">Rendre détaillée</button>
                <button class="btn btn-secondary btn-small" data-refine-type="encouraging" tabindex="0">Rendre encourageante</button>
                <button class="btn btn-secondary btn-small" data-refine-type="formal" tabindex="0">Rendre formelle</button>
            </div>
            <div class="refinement-comparison">
                <div>
                    <h4>Originale :</h4>
                    <p id="originalAppreciationText" class="refinement-box"></p>
                </div>
                <div>
                    <h4>Suggérée :</h4>
                    <p id="suggestedAppreciationText" class="refinement-box">Génération en cours...</p>
                </div>
            </div>
            <div class="refinement-actions-bottom">
                <button class="btn btn-secondary" id="cancelRefinementBtn" tabindex="0">Annuler</button>
                <button class="btn" id="applyRefinedAppreciationBtn" tabindex="0">Appliquer la suggestion</button>
            </div>
        </div>
    </div>

    <div id="statDetailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="statDetailsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="statDetailsModalTitle"></h2>
                <button class="close-button" id="closeStatDetailsModalBtn" aria-label="Fermer les détails de la statistique">&times;</button>
            </div>
            <div class="modal-body">
                <p id="statDetailsContent"></p>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="UI.closeModal(DOM.statDetailsModal)" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="helpModalTitle">❓ Aide et Astuces</h2>
                <button class="close-button" id="closeHelpModalBtn" aria-label="Fermer l'aide">&times;</button>
            </div>
            <div class="help-section">
                <h3>🚀 Démarrage rapide</h3>
                <ol class="help-list">
                    <li>Sélectionnez le trimestre actuel en haut de la page.</li>
                    <li>Choisissez entre importation en masse ou saisie individuelle.</li>
                    <li>Entrez les données des élèves et générez les appréciations.</li>
                    <li>Consultez et modifiez les résultats dans la section de droite.</li>
                </ol>
            </div>
            <div class="help-section">
                <h3>📋 Importer en masse</h3>
                <p>Le format attendu pour l'import en masse est le suivant :</p>
                <div class="help-code-block">NOM Prénom | Statut | Moy T1 | App T1 | Moy T2 | App T2 | Moy T3</div>
                <p style="margin-top: 10px;">Exemple :</p>
                <div class="help-code-block">MARTIN Lucas | | 12,5 | Bon travail... | 13,8 | Progression notable... | 14,2</div>
                <p style="margin-top: 10px; font-size: 0.9em; color: var(--summary-details-color);">
                    Les champs "Statut", "App T1", "Moy T2", "App T2", "Moy T3" sont optionnels et peuvent être laissés vides.
                    Le nombre de colonnes attendu dépend du trimestre sélectionné (T1, T2 ou T3).
                </p>
            </div>
             <div class="help-section">
                <h3>✍️ Édition Rapide</h3>
                 <p>Vous pouvez modifier une appréciation directement depuis sa carte.</p>
                <ul class="help-list">
                    <li>Cliquez sur le bouton "✏️ Édition" pour activer la modification.</li>
                    <li>Cliquez sur le bouton "💾 Enregistrer" pour sauvegarder vos changements.</li>
                    <li>Pour annuler, appuyez sur la touche <code>Echap</code> ou cliquez n'importe où en dehors de la carte de l'élève.</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>⌨️ Raccourcis clavier</h3>
                <div class="help-shortcut-grid">
                    <div class="help-shortcut-item">
                        <span>Nouveau formulaire</span>
                        <span class="help-shortcut-key">Ctrl+N</span>
                    </div>
                    <div class="help-shortcut-item">
                        <span>Générer / Sauvegarder</span>
                        <span class="help-shortcut-key">Ctrl+S</span>
                    </div>
                    <div class="help-shortcut-item">
                        <span>Rechercher</span>
                        <span class="help-shortcut-key">Ctrl+F</span>
                    </div>
                    <div class="help-shortcut-item">
                        <span>Fermer / Annuler</span>
                        <span class="help-shortcut-key">Echap</span>
                    </div>
                </div>
            </div>
            <div class="help-section">
                <h3>✨ Modèles et personnalisation</h3>
                <p>Vous pouvez personnaliser les modèles d'appréciation dans les Paramètres (⚙️). Utilisez les balises suivantes pour insérer des données dynamiques :</p>
                <ul class="help-list">
                    <li><code>{{prenom}}</code> - Prénom de l'élève</li>
                    <li><code>{{moyT1}}</code>, <code>{{moyT2}}</code>, <code>{{moyT3}}</code> - Moyennes aux trimestres</li>
                    <li><code>{{niveauGlobal}}</code> - Niveau général (ex: "Bon travail")</li>
                    <li><code>{{evolution_phrase}}</code> - Phrase décrivant l'évolution (pour T2/T3)</li>
                    <li><code>{{encouragement}}</code> - Phrase d'encouragement</li>
                    <li><code>{{competence_aleatoire}}</code> - Une compétence aléatoire de votre vocabulaire</li>
                    <li><code>{{qualite_aleatoire}}</code> - Une qualité aléatoire de votre vocabulaire</li>
                    <li><code>{{activite_aleatoire}}</code> - Une activité aléatoire de votre vocabulaire</li>
                    <li><code>{{brique:NomDeLaBrique}}</code> - Une brique de phrase personnalisée</li>
                </ul>
                <p style="margin-top: 10px; font-size: 0.9em; color: var(--summary-details-color);">
                    Vous pouvez également gérer votre vocabulaire (compétences, qualités, activités, briques de phrases) et définir les seuils d'évolution dans les Paramètres.
                </p>
            </div>
            <div class="help-section">
                <h3>🧠 Prompts de l'IA</h3>
                <p style="font-size: 0.9em; color: var(--summary-details-color); margin-bottom: 15px;">
                    Ces prompts sont les instructions envoyées à l'IA pour générer les appréciations et suggestions.
                    Ils sont affichés ici à titre informatif et ne sont pas modifiables directement.
                </p>

                <div class="prompt-display-group">
                    <label for="mainGenerationPromptDisplay">Prompt de génération principal :</label>
                    <textarea id="mainGenerationPromptDisplay" readonly style="min-height: 150px; background-color: var(--bg-color); cursor: default;"></textarea>
                    <button class="copy-prompt-button" data-target="mainGenerationPromptDisplay" tabindex="0">Copier</button>
                </div>

                <div class="prompt-display-group">
                    <label for="refineConcisePromptDisplay">Prompt d'amélioration (concise) :</label>
                    <textarea id="refineConcisePromptDisplay" readonly style="min-height: 80px; background-color: var(--bg-color); cursor: default;"></textarea>
                    <button class="copy-prompt-button" data-target="refineConcisePromptDisplay" tabindex="0">Copier</button>
                </div>

                <div class="prompt-display-group">
                    <label for="nextStepsPromptDisplay">Prompt de suggestions de pistes d'amélioration :</label>
                    <textarea id="nextStepsPromptDisplay" readonly style="min-height: 100px; background-color: var(--bg-color); cursor: default;"></textarea>
                    <button class="copy-prompt-button" data-target="nextStepsPromptDisplay" tabindex="0">Copier</button>
                </div>

                <div class="prompt-display-group">
                    <label for="strengthsWeaknessesPromptDisplay">Prompt de suggestion de forces et faiblesses :</label>
                    <textarea id="strengthsWeaknessesPromptDisplay" readonly style="min-height: 100px; background-color: var(--bg-color); cursor: default;"></textarea>
                    <button class="copy-prompt-button" data-target="strengthsWeaknessesPromptDisplay" tabindex="0">Copier</button>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="UI.closeModal(DOM.helpModal)" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>


    <input type="file" id="fileInput" accept=".json,.csv,.txt" style="display: none;">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Génération en cours...</div>
    </div>

    <div id="pwaInstallBanner" class="pwa-install-banner">
        <p>Installez cette application pour un accès rapide et hors ligne !</p>
        <div class="actions">
            <button id="pwaInstallBtn" class="btn" tabindex="0">Installer l'application</button>
            <button id="pwaDismissBtn" class="btn btn-secondary" tabindex="0">Non merci</button>
        </div>
    </div>

    <script>
        // ====================================================================
        // 1. Configuration et Variables Globales
        // ====================================================================
        const APP_VERSION = "v2.9.6"; // Updated application version

        const CONFIG = {
            get API_KEY() { return typeof __api_key !== 'undefined' ? __api_key : ""; }, // For Canvas environment
            AUTO_SAVE_INTERVAL_MS: 30000,
            DEBOUNCE_TIME_MS: 300,
            DEFAULT_WORD_COUNT_LIMIT: 80,
            // Clés localStorage
            LS_APP_STATE_KEY: 'appreciationGeneratorState_v3.4',
            LS_VOCAB_COMPETENCES_KEY: 'vocabulaireCompetences_v3.4',
            LS_VOCAB_QUALITES_KEY: 'vocabulaireQualites_v3.4',
            LS_VOCAB_ACTIVITES_KEY: 'vocabulaireActivites_v3.4',
            LS_PHRASE_BRICKS_KEY: 'phraseBricks_v3.4',
            LS_EVOLUTION_POSITIVE_KEY: 'evolutionThresholdPositive_v3.4',
            LS_EVOLUTION_VERY_POSITIVE_KEY: 'evolutionThresholdVeryPositive_v3.4',
            LS_EVOLUTION_NEGATIVE_KEY: 'evolutionThresholdNegative_v3.4',
            LS_EVOLUTION_VERY_NEGATIVE_KEY: 'evolutionThresholdVeryNegative_v3.4',
            LS_CURRENT_SUBJECT_KEY: 'currentSubject_v3.4',
            LS_GENERATION_MODE_KEY: 'generationMode_v3.4',
            LS_WORD_COUNT_LIMIT_KEY: 'wordCountLimit_v3.4',
            LS_CURRENT_AI_MODEL_KEY: 'currentAIModel_v3.4',
            LS_OPENAI_API_KEY: 'openaiApiKey_v3.4',
            LS_GEMINI_API_KEY: 'geminiApiKey_v3.4',
            LS_MISTRAL_API_KEY: 'mistralApiKey_v3.4', 
            LS_QWEN_API_KEY: 'qwenApiKey_v3.4',
            LS_DEEPSEEK_API_KEY: 'deepseekApiKey_v3.4',
            LS_NEGATIVE_INSTRUCTIONS_GLOBAL_KEY: 'negativeInstructionsGlobal_v3.4',
            OPENROUTER_API_BASE: 'https://openrouter.ai/api/v1',
            DEEPSEEK_API_BASE: 'https://api.deepseek.com',
        };

        const DEFAULT_VOCABULAIRE = {
            competences: ['démarche de projet', 'compétences techniques', 'analyse', 'conception', 'réalisation', 'méthodologie', 'rigueur', 'autonomie'],
            qualites: ['créativité', 'innovation', 'collaboration', 'persévérance', 'curiosité', 'esprit critique', 'organisation'],
            activites: ['projets technologiques', 'recherches documentaires', 'réalisations pratiques', 'démarches d\'investigation', 'travaux collaboratifs'],
            phraseBricks: {
                "introduction_positive": "Dès le début de ce trimestre, {{prenom}} a fait preuve d'un engagement remarquable.",
                "conclusion_encouragement": "Je l'encourage à maintenir cette dynamique positive et à continuer ses efforts.",
                "transition_progression": "Suite à ses efforts constants, on observe une nette progression dans ses résultats."
            }
        };

        const DEFAULT_PROMPT_TEMPLATES = {
            "Technologie": {
                "T1": `{{niveauGlobal}} : {{prenom}} a débuté ce trimestre avec {{moyT1}} de moyenne. Il/Elle a montré une bonne {{qualite_aleatoire}} dans ses {{activite_aleatoire}}. {{encouragement}}`,
                "T2": `{{niveauGlobal}} : {{prenom}} a montré une bonne {{qualite_aleatoire}} dans ses {{activite_aleatoire}} et a obtenu {{moyT2}} de moyenne. Je l'encourage à renforcer sa {{competence_aleatoire}}.`,
                "T3": `{{niveauGlobal}} : {{prenom}} {{evolution_phrase}}. {{encouragement}}`
            },
            "Mathématiques": {
                "T1": `En mathématiques, {{prenom}} a obtenu une moyenne de {{moyT1}}. Il/Elle a démontré une bonne compréhension des concepts de {{competence_aleatoire}}. {{encouragement}}`,
                "T2": `Avec une moyenne de {{moyT2}} en mathématiques, {{prenom}} a montré {{evolution_phrase}}. Il/Elle doit continuer à travailler sa {{qualite_aleatoire}}.`,
                "T3": `En mathématiques, {{prenom}} {{evolution_phrase}}. {{encouragement}}`
            },
             "Français": {
                "T1": `En français, {{prenom}} a obtenu une moyenne de {{moyT1}}. Ses compétences en {{competence_aleatoire}} sont notables. {{encouragement}}`,
                "T2": `Avec une moyenne de {{moyT2}} en français, {{prenom}} {{evolution_phrase}}. Il/Elle est invité(e) à soigner sa {{qualite_aleatoire}}.`,
                "T3": `En français, {{prenom}} {{evolution_phrase}} au cours de ce dernier trimestre. {{encouragement}}`
            },
            "Autre": {
                "T1": `{{niveauGlobal}} : {{prenom}} a obtenu {{moyT1}} de moyenne. Il/Elle a montré une bonne {{qualite_aleatoire}} dans ses {{activite_aleatoire}}. {{encouragement}}`,
                "T2": `{{niveauGlobal}} : {{prenom}} a montré une bonne {{qualite_aleatoire}} dans ses {{activite_aleatoire}} et a obtenu {{moyT2}} de moyenne. Je l'encourage à renforcer sa {{competence_aleatoire}}.`,
                "T3": `{{niveauGlobal}} : {{prenom}} {{evolution_phrase}}. {{encouragement}}`
            }
        };

        const DEFAULT_EVOLUTION_THRESHOLDS = {
            positive: 0.5, veryPositive: 2.0, negative: -0.5, veryNegative: -2.0
        };

        let appState = {
            vocabulaire: { ...DEFAULT_VOCABULAIRE }, promptTemplates: {}, evolutionThresholds: { ...DEFAULT_EVOLUTION_THRESHOLDS },
            currentQuarterMode: 'T1', currentSubject: 'Technologie', generationMode: 'AI',
            generatedResults: [], filteredResults: [], currentEditingId: null, currentRefiningAppreciationId: null,
            currentInputMode: 'mass', wordCountLimit: CONFIG.DEFAULT_WORD_COUNT_LIMIT, currentAIModel: 'gemini-2.0-flash',
            openaiApiKey: '', geminiApiKey: '', mistralApiKey: '', qwenApiKey: '', deepseekApiKey: '',
            negativeInstructionsGlobal: '',
            isMassImportCancelled: false,
        };

        const DOM = {
            appVersionDisplay: document.getElementById('appVersionDisplay'),
            darkModeToggle: document.getElementById('darkModeToggle'), settingsButton: document.getElementById('settingsButton'),
            helpButton: document.getElementById('helpButton'), quarterRadios: document.querySelectorAll('input[name="quarterModeRadio"]'),
            subjectSelect: document.getElementById('subjectSelect'), generationModeRadios: document.querySelectorAll('input[name="generationModeRadio"]'),
            inputSection: document.getElementById('inputSection'), massImportTab: document.getElementById('massImportTab'),
            singleStudentTab: document.getElementById('singleStudentTab'), massImportSection: document.getElementById('massImportSection'),
            singleStudentFormDiv: document.getElementById('singleStudentFormDiv'), actualSingleStudentForm: document.getElementById('actualSingleStudentForm'),
            massData: document.getElementById('massData'), massDataTooltip: document.getElementById('massDataTooltip'),
            progressContainer: document.getElementById('progressContainer'), progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'), importGenerateBtn: document.getElementById('importGenerateBtn'),
            clearImportBtn: document.getElementById('clearImportBtn'), loadSampleDataBtn: document.getElementById('loadSampleDataBtn'),
            cancelImportBtn: document.getElementById('cancelImportBtn'),
            currentQuarterDisplayInputSection: document.getElementById('currentQuarterDisplayInputSection'), dropZone: document.getElementById('dropZone'),
            importFileBtn: document.getElementById('importFileBtn'), nomInput: document.getElementById('nom'),
            prenomInput: document.getElementById('prenom'), statutSelect: document.getElementById('statut'),
            moyT1Input: document.getElementById('moyT1'), appT1Textarea: document.getElementById('appT1'),
            moyT2Input: document.getElementById('moyT2'), appT2Textarea: document.getElementById('appT2'),
            moyT3Input: document.getElementById('moyT3'), nomError: document.getElementById('nomError'),
            prenomError: document.getElementById('prenomError'), moyT1Error: document.getElementById('moyT1Error'),
            moyT2Error: document.getElementById('moyT2Error'), moyT3Error: document.getElementById('moyT3Error'),
            negativeInstructions: document.getElementById('negativeInstructions'),
            previewAppreciationBtn: document.getElementById('previewAppreciationBtn'),
            singleAppreciationPreview: document.getElementById('singleAppreciationPreview'),
            generateAppreciationBtn: document.getElementById('generateAppreciationBtn'), resetFormBtn: document.getElementById('resetFormBtn'),
            resultsDiv: document.getElementById('results'), searchInput: document.getElementById('searchInput'),
            totalCountStat: document.getElementById('totalCount'), avgGradeOutputStat: document.getElementById('avgGradeOutput'),
            progressCountStat: document.getElementById('progressCount'), stableCountStat: document.getElementById('stableCount'),
            regressionCountStat: document.getElementById('regressionCount'), avgWordsStat: document.getElementById('avgWords'),
            clearAllResultsBtn: document.getElementById('clearAllResultsBtn'), exportJsonBtn: document.getElementById('exportJsonBtn'),
            exportCsvBtn: document.getElementById('exportCsvBtn'), sortSelect: document.getElementById('sortSelect'),
            fileInput: document.getElementById('fileInput'), settingsModal: document.getElementById('settingsModal'),
            closeSettingsModalBtn: document.getElementById('closeSettingsModalBtn'), settingsPromptT1: document.getElementById('promptTemplateT1'),
            settingsPromptT2: document.getElementById('promptTemplateT2'), settingsPromptT3: document.getElementById('promptTemplateT3'),
            settingsEvolutionThresholdPositive: document.getElementById('evolutionThresholdPositive'),
            settingsEvolutionThresholdVeryPositive: document.getElementById('evolutionThresholdVeryPositive'),
            settingsEvolutionThresholdNegative: document.getElementById('evolutionThresholdNegative'),
            settingsEvolutionThresholdVeryNegative: document.getElementById('evolutionThresholdVeryNegative'),
            vocabCompetencesList: document.getElementById('vocabCompetencesList'),
            addCompetenceInput: document.getElementById('addCompetenceInput'),
            addCompetenceBtn: document.getElementById('addCompetenceBtn'),
            vocabQualitesList: document.getElementById('vocabQualitesList'),
            addQualiteInput: document.getElementById('addQualiteInput'),
            addQualiteBtn: document.getElementById('addQualiteBtn'),
            vocabActivitesList: document.getElementById('vocabActivitesList'),
            addActiviteInput: document.getElementById('addActiviteInput'),
            addActiviteBtn: document.getElementById('addActiviteBtn'),
            phraseBricksList: document.getElementById('phraseBricksList'),
            addBrickNameInput: document.getElementById('addBrickNameInput'),
            addBrickTextInput: document.getElementById('addBrickTextInput'),
            addBrickBtn: document.getElementById('addBrickBtn'),
            resetSettingsBtn: document.getElementById('resetSettingsBtn'), saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            cancelSettingsBtn: document.getElementById('cancelSettingsBtn'), settingsTabs: document.querySelectorAll('.settings-tab'),
            templatesTabContent: document.getElementById('templatesTabContent'), vocabulaireTabContent: document.getElementById('vocabulaireTabContent'),
            optionsTabContent: document.getElementById('optionsTabContent'), currentSubjectTemplate: document.getElementById('currentSubjectTemplate'),
            templatePreviewText: document.getElementById('templatePreviewText'), wordCountLimitInput: document.getElementById('wordCountLimit'),
            negativeInstructionsGlobal: document.getElementById('negativeInstructionsGlobal'),
            aiModelSelect: document.getElementById('aiModelSelect'), openaiApiKey: document.getElementById('openaiApiKey'),
            openaiApiKeyGroup: document.getElementById('openaiApiKeyGroup'), openaiApiKeyError: document.getElementById('openaiApiKeyError'),
            geminiApiKey: document.getElementById('geminiApiKey'), geminiApiKeyGroup: document.getElementById('geminiApiKeyGroup'),
            geminiApiKeyError: document.getElementById('geminiApiKeyError'), geminiApiKeyHint: document.getElementById('geminiApiKeyHint'),
            mistralApiKey: document.getElementById('mistralApiKey'), mistralApiKeyGroup: document.getElementById('mistralApiKeyGroup'),
            mistralApiKeyError: document.getElementById('mistralApiKeyError'), qwenApiKey: document.getElementById('qwenApiKey'),
            qwenApiKeyGroup: document.getElementById('qwenApiKeyGroup'), qwenApiKeyError: document.getElementById('qwenApiKeyError'),
            deepseekApiKey: document.getElementById('deepseekApiKey'), deepseekApiKeyGroup: document.getElementById('deepseekApiKeyGroup'),
            deepseekApiKeyError: document.getElementById('deepseekApiKeyError'), mainGenerationPromptDisplay: document.getElementById('mainGenerationPromptDisplay'),
            refineConcisePromptDisplay: document.getElementById('refineConcisePromptDisplay'),
            nextStepsPromptDisplay: document.getElementById('nextStepsPromptDisplay'),
            strengthsWeaknessesPromptDisplay: document.getElementById('strengthsWeaknessesPromptDisplay'),
            studentDetailsModal: document.getElementById('studentDetailsModal'), closeStudentDetailsModalBtn: document.getElementById('closeStudentDetailsModalBtn'),
            detailsStudentName: document.getElementById('detailsStudentName'), detailsStatut: document.getElementById('detailsStatut'),
            detailsMoyT1: document.getElementById('detailsMoyT1'), detailsMoyT2: document.getElementById('detailsMoyT2'),
            detailsMoyT3: document.getElementById('detailsMoyT3'), detailsAppT1: document.getElementById('detailsAppT1'),
            detailsAppT2: document.getElementById('detailsAppT2'), detailsGeneratedAppreciation: document.getElementById('detailsGeneratedAppreciation'),
            detailsTokenUsageSection: document.getElementById('detailsTokenUsageSection'),
            detailsPromptTokens: document.getElementById('detailsPromptTokens'),
            detailsCompletionTokens: document.getElementById('detailsCompletionTokens'),
            detailsTotalTokens: document.getElementById('detailsTotalTokens'),
            strengthsWeaknessesSection: document.getElementById('strengthsWeaknessesSection'),
            strengthsWeaknessesContent: document.getElementById('strengthsWeaknessesContent'),
            generateStrengthsWeaknessesBtn: document.getElementById('generateStrengthsWeaknessesBtn'),
            nextStepsSection: document.getElementById('nextStepsSection'), nextStepsList: document.getElementById('nextStepsList'),
            generateNextStepsBtn: document.getElementById('generateNextStepsBtn'), closeDetailsModalBtn: document.getElementById('closeDetailsModalBtn'),
            editFromModalBtn: document.getElementById('editFromModalBtn'), refinementModal: document.getElementById('refinementModal'),
            closeRefinementModalBtn: document.getElementById('closeRefinementModalBtn'),
            originalAppreciationText: document.getElementById('originalAppreciationText'),
            suggestedAppreciationText: document.getElementById('suggestedAppreciationText'),
            refinementOptions: document.querySelector('.refinement-options'), cancelRefinementBtn: document.getElementById('cancelRefinementBtn'),
            applyRefinedAppreciationBtn: document.getElementById('applyRefinedAppreciationBtn'),
            statDetailsModal: document.getElementById('statDetailsModal'), statDetailsTitle: document.getElementById('statDetailsModalTitle'),
            statDetailsContent: document.getElementById('statDetailsContent'), closeStatDetailsModalBtn: document.getElementById('closeStatDetailsModalBtn'),
            helpModal: document.getElementById('helpModal'), closeHelpModalBtn: document.getElementById('closeHelpModalBtn'),
            copyPromptButtons: document.querySelectorAll('.copy-prompt-button'), loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'), pwaInstallBanner: document.getElementById('pwaInstallBanner'),
            pwaInstallBtn: document.getElementById('pwaInstallBtn'), pwaDismissBtn: document.getElementById('pwaDismissBtn'),
            headerAiStatusIcon: document.getElementById('headerAiStatusIcon'),
            noResultsMessage: document.getElementById('noResultsMessage')
        };

        // ====================================================================
        // 2. Gestion du Stockage Local (localStorage)
        // ====================================================================

        const StorageManager = {
            loadAppState() {
                try {
                    const savedState = localStorage.getItem(CONFIG.LS_APP_STATE_KEY);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        Object.assign(appState, parsedState);

                        appState.vocabulaire.phraseBricks = appState.vocabulaire.phraseBricks || {};
                        for (const key in DEFAULT_VOCABULAIRE.phraseBricks) {
                            if (!appState.vocabulaire.phraseBricks[key]) {
                                appState.vocabulaire.phraseBricks[key] = DEFAULT_VOCABULAIRE.phraseBricks[key];
                            }
                        }
                        appState.negativeInstructionsGlobal = appState.negativeInstructionsGlobal || '';

                        appState.generatedResults.forEach(result => {
                            if (!result.studentData.quarterMode) result.studentData.quarterMode = 'T3';
                            if (!result.studentData.subject) result.studentData.subject = 'Technologie';
                            if (!result.studentData.generationMode) result.studentData.generationMode = 'AI';
                            if (result.strengthsWeaknesses === undefined) result.strengthsWeaknesses = null;
                            if (result.nextSteps === undefined) result.nextSteps = null;
                            if (result.tokenUsage === undefined) result.tokenUsage = null;
                            if (result.studentData.negativeInstructions === undefined) result.studentData.negativeInstructions = '';
                        });
                    }
                } catch (e) {
                    console.error("Erreur lors du chargement de l'état depuis localStorage:", e);
                    UI.showNotification("Erreur lors du chargement des données sauvegardées. Réinitialisation.", 'error');
                    localStorage.removeItem(CONFIG.LS_APP_STATE_KEY);
                    appState = {
                        vocabulaire: { ...DEFAULT_VOCABULAIRE },
                        promptTemplates: JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES)),
                        evolutionThresholds: { ...DEFAULT_EVOLUTION_THRESHOLDS },
                        currentQuarterMode: 'T1', currentSubject: 'Technologie', generationMode: 'AI',
                        generatedResults: [], filteredResults: [], currentEditingId: null,
                        currentRefiningAppreciationId: null, currentInputMode: 'mass',
                        wordCountLimit: CONFIG.DEFAULT_WORD_COUNT_LIMIT, currentAIModel: 'gemini-2.0-flash',
                        openaiApiKey: '', geminiApiKey: '', mistralApiKey: '', qwenApiKey: '', deepseekApiKey: '',
                        negativeInstructionsGlobal: '', isMassImportCancelled: false,
                    };
                }

                if (!appState.promptTemplates || Object.keys(appState.promptTemplates).length === 0) {
                    appState.promptTemplates = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES));
                } else {
                    for (const subject in DEFAULT_PROMPT_TEMPLATES) {
                        if (!appState.promptTemplates[subject]) {
                            appState.promptTemplates[subject] = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES[subject]));
                        } else {
                            for (const quarter in DEFAULT_PROMPT_TEMPLATES[subject]) {
                                if (!appState.promptTemplates[subject][quarter]) {
                                    appState.promptTemplates[subject][quarter] = DEFAULT_PROMPT_TEMPLATES[subject][quarter];
                                }
                            }
                        }
                    }
                }

                appState.vocabulaire.competences = JSON.parse(localStorage.getItem(CONFIG.LS_VOCAB_COMPETENCES_KEY)) || DEFAULT_VOCABULAIRE.competences;
                appState.vocabulaire.qualites = JSON.parse(localStorage.getItem(CONFIG.LS_VOCAB_QUALITES_KEY)) || DEFAULT_VOCABULAIRE.qualites;
                appState.vocabulaire.activites = JSON.parse(localStorage.getItem(CONFIG.LS_VOCAB_ACTIVITES_KEY)) || DEFAULT_VOCABULAIRE.activites;
                appState.vocabulaire.phraseBricks = JSON.parse(localStorage.getItem(CONFIG.LS_PHRASE_BRICKS_KEY)) || DEFAULT_VOCABULAIRE.phraseBricks;

                appState.evolutionThresholds.positive = parseFloat(localStorage.getItem(CONFIG.LS_EVOLUTION_POSITIVE_KEY)) || DEFAULT_EVOLUTION_THRESHOLDS.positive;
                appState.evolutionThresholds.veryPositive = parseFloat(localStorage.getItem(CONFIG.LS_EVOLUTION_VERY_POSITIVE_KEY)) || DEFAULT_EVOLUTION_THRESHOLDS.veryPositive;
                appState.evolutionThresholds.negative = parseFloat(localStorage.getItem(CONFIG.LS_EVOLUTION_NEGATIVE_KEY)) || DEFAULT_EVOLUTION_THRESHOLDS.negative;
                appState.evolutionThresholds.veryNegative = parseFloat(localStorage.getItem(CONFIG.LS_EVOLUTION_VERY_NEGATIVE_KEY)) || DEFAULT_EVOLUTION_THRESHOLDS.veryNegative;

                appState.currentSubject = localStorage.getItem(CONFIG.LS_CURRENT_SUBJECT_KEY) || 'Technologie';
                if (DOM.subjectSelect) DOM.subjectSelect.value = appState.currentSubject;
                appState.wordCountLimit = parseInt(localStorage.getItem(CONFIG.LS_WORD_COUNT_LIMIT_KEY)) || CONFIG.DEFAULT_WORD_COUNT_LIMIT;
                appState.currentAIModel = localStorage.getItem(CONFIG.LS_CURRENT_AI_MODEL_KEY) || 'gemini-2.0-flash';
                appState.openaiApiKey = localStorage.getItem(CONFIG.LS_OPENAI_API_KEY) || '';
                appState.geminiApiKey = localStorage.getItem(CONFIG.LS_GEMINI_API_KEY) || '';
                appState.mistralApiKey = localStorage.getItem(CONFIG.LS_MISTRAL_API_KEY) || '';
                appState.qwenApiKey = localStorage.getItem(CONFIG.LS_QWEN_API_KEY) || '';
                appState.deepseekApiKey = localStorage.getItem(CONFIG.LS_DEEPSEEK_API_KEY) || '';
                appState.negativeInstructionsGlobal = localStorage.getItem(CONFIG.LS_NEGATIVE_INSTRUCTIONS_GLOBAL_KEY) || '';

                if (UI.checkAPIKeyPresence(true)) {
                    appState.generationMode = localStorage.getItem(CONFIG.LS_GENERATION_MODE_KEY) || 'AI';
                } else {
                    appState.generationMode = 'Template';
                }
                console.log('État de l\'application chargé.');
            },

            saveAppState() {
                localStorage.setItem(CONFIG.LS_APP_STATE_KEY, JSON.stringify({
                    generatedResults: appState.generatedResults,
                    currentQuarterMode: appState.currentQuarterMode,
                    currentSubject: appState.currentSubject,
                    currentInputMode: appState.currentInputMode,
                    generationMode: appState.generationMode,
                    promptTemplates: appState.promptTemplates,
                    evolutionThresholds: appState.evolutionThresholds,
                    vocabulaire: appState.vocabulaire,
                    wordCountLimit: appState.wordCountLimit,
                    currentAIModel: appState.currentAIModel,
                    openaiApiKey: appState.openaiApiKey,
                    geminiApiKey: appState.geminiApiKey,
                    mistralApiKey: appState.mistralApiKey,
                    qwenApiKey: appState.qwenApiKey,
                    deepseekApiKey: appState.deepseekApiKey,
                    negativeInstructionsGlobal: appState.negativeInstructionsGlobal,
                    isMassImportCancelled: appState.isMassImportCancelled
                }));
                localStorage.setItem(CONFIG.LS_VOCAB_COMPETENCES_KEY, JSON.stringify(appState.vocabulaire.competences));
                localStorage.setItem(CONFIG.LS_VOCAB_QUALITES_KEY, JSON.stringify(appState.vocabulaire.qualites));
                localStorage.setItem(CONFIG.LS_VOCAB_ACTIVITES_KEY, JSON.stringify(appState.vocabulaire.activites));
                localStorage.setItem(CONFIG.LS_PHRASE_BRICKS_KEY, JSON.stringify(appState.vocabulaire.phraseBricks));
                localStorage.setItem(CONFIG.LS_EVOLUTION_POSITIVE_KEY, appState.evolutionThresholds.positive);
                localStorage.setItem(CONFIG.LS_EVOLUTION_VERY_POSITIVE_KEY, appState.evolutionThresholds.veryPositive);
                localStorage.setItem(CONFIG.LS_EVOLUTION_NEGATIVE_KEY, appState.evolutionThresholds.negative);
                localStorage.setItem(CONFIG.LS_EVOLUTION_VERY_NEGATIVE_KEY, appState.evolutionThresholds.veryNegative);
                localStorage.setItem(CONFIG.LS_CURRENT_SUBJECT_KEY, appState.currentSubject);
                localStorage.setItem(CONFIG.LS_GENERATION_MODE_KEY, appState.generationMode);
                localStorage.setItem(CONFIG.LS_WORD_COUNT_LIMIT_KEY, appState.wordCountLimit);
                localStorage.setItem(CONFIG.LS_CURRENT_AI_MODEL_KEY, appState.currentAIModel);
                localStorage.setItem(CONFIG.LS_OPENAI_API_KEY, appState.openaiApiKey);
                localStorage.setItem(CONFIG.LS_GEMINI_API_KEY, appState.geminiApiKey);
                localStorage.setItem(CONFIG.LS_MISTRAL_API_KEY, appState.mistralApiKey);
                localStorage.setItem(CONFIG.LS_QWEN_API_KEY, appState.qwenApiKey);
                localStorage.setItem(CONFIG.LS_DEEPSEEK_API_KEY, appState.deepseekApiKey);
                localStorage.setItem(CONFIG.LS_NEGATIVE_INSTRUCTIONS_GLOBAL_KEY, appState.negativeInstructionsGlobal);
            },

            resetAllSettings() {
                appState.promptTemplates = JSON.parse(JSON.stringify(DEFAULT_PROMPT_TEMPLATES));
                appState.evolutionThresholds = { ...DEFAULT_EVOLUTION_THRESHOLDS };
                appState.vocabulaire = { ...DEFAULT_VOCABULAIRE };
                appState.currentSubject = 'Technologie';
                appState.wordCountLimit = CONFIG.DEFAULT_WORD_COUNT_LIMIT;
                appState.currentAIModel = 'gemini-2.0-flash';
                appState.openaiApiKey = '';
                appState.geminiApiKey = '';
                appState.mistralApiKey = '';
                appState.qwenApiKey = '';
                appState.deepseekApiKey = '';
                appState.negativeInstructionsGlobal = '';
                if (UI.checkAPIKeyPresence(true)) { appState.generationMode = 'AI'; } else { appState.generationMode = 'Template'; }
                for (const key in CONFIG) { if (key.startsWith('LS_')) { localStorage.removeItem(CONFIG[key]); } }
                localStorage.setItem(CONFIG.LS_GENERATION_MODE_KEY, appState.generationMode);
                UI.updateSettingsPromptFields();
                UI.updateSettingsFields();
                if (DOM.subjectSelect) DOM.subjectSelect.value = appState.currentSubject;
                UI.setGenerationMode(appState.generationMode);
                UI.renderVocabLists();
            }
        };

        // ====================================================================
        // 3. Fonctions Utilitaires Générales
        // ====================================================================

        const Utils = {
            validateInput(input) {
                const value = input.value.trim();
                const errorElement = document.getElementById(input.id + 'Error');
                let isValid = true; let errorMessage = '';
                if (input.id === 'nom' || input.id === 'prenom') {
                    if (value.length === 0) { isValid = false; errorMessage = 'Ce champ est requis'; }
                    else if (!/^[a-zA-ZÀ-ÿ\s\-']+$/.test(value)) { isValid = false; errorMessage = 'Caractères invalides détectés'; }
                }
                if (isValid) { input.classList.remove('input-error'); if (errorElement) errorElement.style.display = 'none'; }
                else { input.classList.add('input-error'); if (errorElement) { errorElement.textContent = '⚠️ ' + errorMessage; errorElement.style.display = 'block'; } }
                return isValid;
            },
            validateGrade(input) {
                const valueStr = input.value.trim().replace(',', '.');
                const errorElement = document.getElementById(input.id + 'Error');
                let isValid = true; let errorMessage = '';
                if (valueStr === '') { input.classList.remove('input-error'); if (errorElement) errorElement.style.display = 'none'; return true; }
                const value = parseFloat(valueStr);
                if (isNaN(value) || value < 0 || value > 20) { isValid = false; errorMessage = 'La note doit être entre 0 et 20'; }
                if (isValid) { input.classList.remove('input-error'); if (errorElement) errorElement.style.display = 'none'; }
                else { input.classList.add('input-error'); if (errorElement) { errorElement.textContent = '⚠️ ' + errorMessage; errorElement.style.display = 'block'; } }
                return isValid;
            },
            countWords(text) { if (typeof text !== 'string') return 0; return text.trim().split(/\s+/).filter(word => word.length > 0).length; },
            getRandomElement(array) { if (!array || array.length === 0) return ''; return array[Math.floor(Math.random() * array.length)]; },
            isNumeric(str) {
                if (typeof str !== 'string' && typeof str !== 'number') return false;
                if (typeof str === 'number') return str >= 0 && str <= 20;
                const cleaned = str.replace(',', '.'); const num = parseFloat(cleaned);
                return !isNaN(num) && num >= 0 && num <= 20;
            },
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => { clearTimeout(timeout); func(...args); };
                    clearTimeout(timeout); timeout = setTimeout(later, wait);
                };
            },
            parseStudentLine(line, quarterMode) {
                line = line.trim(); if (!line) return null;
                const parts = line.split('|').map(p => p.trim());
                const nomPrenomCombined = parts[0];
                const { nom, prenom } = Utils.parseNomPrenom(nomPrenomCombined);
                const isEmptyEffectively = (!nom && !prenom) && parts.slice(1).every(p => p === '');
                if (isEmptyEffectively) { console.warn("Ligne entièrement vide ignorée (après parsing nom/prénom):", line); return null; }
                const statut = parts[1] || '';
                const moyT1Str = parts[2]?.replace(',', '.'); const moyT1 = Utils.isNumeric(moyT1Str) ? parseFloat(moyT1Str) : null;
                const appT1 = parts[3] || '';
                const moyT2Str = parts[4]?.replace(',', '.'); const moyT2 = (parts.length > 4 && Utils.isNumeric(moyT2Str)) ? parseFloat(moyT2Str) : null;
                const appT2 = (parts.length > 5) ? parts[5] : '';
                const moyT3Str = parts[6]?.replace(',', '.'); const moyT3 = (parts.length > 6 && Utils.isNumeric(moyT3Str)) ? parseFloat(moyT3Str) : null;
                const negativeInstructions = (parts.length > 7) ? parts[7] : '';
                if (!nom && !prenom && !statut && moyT1 === null && !appT1 && moyT2 === null && !appT2 && moyT3 === null && !negativeInstructions) { console.warn("Ligne considérée comme vide (aucun champ significatif après parsing):", line); return null; }
                return { nom, prenom, statut, moyT1, appT1, moyT2, appT2, moyT3, quarterMode, negativeInstructions };
            },
            parseNomPrenom(fullNameCombined) {
                const words = fullNameCombined.split(/\s+/).filter(s => s.length > 0);
                if (words.length === 0) return { nom: '', prenom: '' };
                if (words.length === 1) return { nom: '', prenom: words[0] };
                const prenom = words.pop(); const nom = words.join(' ');
                return { nom: nom.toUpperCase(), prenom };
            },
            cleanMarkdown(text) { if (typeof text !== 'string') return text; return text.replace(/\*\*/g, '').replace(/\*/g, ''); },
            applyConditionalLogic(template, studentData) {
                const regex = /{{if\s+([^}]+?)\s*([<>=!]+)\s*([^}]+?)\s*}}(.*?)(?:{{else}}(.*?))?{{\/if}}/g;
                let processedTemplate = template;
                processedTemplate = processedTemplate.replace(regex, (match, field, operator, value, truePart, falsePart) => {
                    const fieldValueStr = String(studentData[field.trim()]).replace(',', '.');
                    let fieldValue = studentData[field.trim()]; let conditionMet = false;
                    let parsedValueStr = String(value).trim().replace(',', '.'); let parsedValue = parsedValueStr;
                    if (!isNaN(parseFloat(fieldValueStr)) && !isNaN(parseFloat(parsedValueStr))) { fieldValue = parseFloat(fieldValueStr); parsedValue = parseFloat(parsedValueStr); }
                    else { fieldValue = String(fieldValue).toLowerCase(); parsedValue = String(parsedValue).toLowerCase(); }
                    switch (operator.trim()) {
                        case '>': conditionMet = fieldValue > parsedValue; break; case '<': conditionMet = fieldValue < parsedValue; break;
                        case '>=': conditionMet = fieldValue >= parsedValue; break; case '<=': conditionMet = fieldValue <= parsedValue; break;
                        case '==': conditionMet = fieldValue == parsedValue; break; case '!=': conditionMet = fieldValue != parsedValue; break;
                        default: conditionMet = false;
                    }
                    return conditionMet ? truePart.trim() : (falsePart ? falsePart.trim() : '');
                });
                return processedTemplate;
            },
            applyPhraseBricks(template, phraseBricks) { const regex = /{{brique:([^}]+)}}/g; return template.replace(regex, (match, brickName) => { return phraseBricks[brickName.trim()] || ''; }); },
            decodeHtmlEntities(text) { if (typeof text !== 'string') return text; const textarea = document.createElement('textarea'); textarea.innerHTML = text; return textarea.value; },
            translateErrorMessage(englishMessage) {
                if (typeof englishMessage !== 'string') return String(englishMessage);
                if (englishMessage.includes('Failed to fetch')) return "Échec de la connexion au service IA. Vérifiez votre connexion internet ou si le service est en ligne.";
                if (englishMessage.includes('quota') || englishMessage.includes('429')) return "Quota API dépassé ou limite de requêtes atteinte.";
                if (englishMessage.includes('401')) return "Authentification échouée. Vérifiez votre clé API.";
                if (englishMessage.includes('402') && englishMessage.includes('more credits')) return "Crédits API insuffisants. Le service (ex: OpenRouter) requiert un paiement pour continuer. Veuillez recharger votre compte sur leur site.";
                return englishMessage;
            }
        };

        // ====================================================================
        // 4. Gestion de l'Interface Utilisateur (UI)
        // ====================================================================
        const UI = {
            showNotification(message, type = 'success') {
                let notificationContainer = document.getElementById('notification-container');
                if (!notificationContainer) { notificationContainer = document.createElement('div'); notificationContainer.id = 'notification-container'; document.body.appendChild(notificationContainer); }
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
                notification.innerHTML = `${icon} ${message}`;
                notificationContainer.appendChild(notification);
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => { if (notification.parentNode) notificationContainer.removeChild(notification); if (notificationContainer.children.length === 0 && notificationContainer.parentNode) { document.body.removeChild(notificationContainer); } }, 300);
                }, 3000);
            },
            showCustomConfirm(message, onConfirm) {
                const modalId = 'customConfirmModal'; let modal = document.getElementById(modalId);
                if (!modal) {
                    modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                    modal.setAttribute('role', 'alertdialog'); modal.setAttribute('aria-modal', 'true'); modal.setAttribute('aria-labelledby', 'confirmModalTitle');
                    modal.innerHTML = `<div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="confirmModalTitle">Confirmation</h2><button class="close-button" id="confirmCloseBtn" aria-label="Fermer la confirmation">&times;</button></div><p id="confirmMessage" style="margin-bottom: 25px;"></p><div style="display: flex; justify-content: flex-end; gap: 10px;"><button class="btn btn-secondary" id="confirmCancel" tabindex="0">Annuler</button><button class="btn btn-danger" id="confirmOk" tabindex="0">Confirmer</button></div></div>`;
                    document.body.appendChild(modal);
                }
                document.getElementById('confirmMessage').textContent = message; UI.openModal(modal);
                const confirmOk = document.getElementById('confirmOk'); const confirmCancel = document.getElementById('confirmCancel'); const confirmCloseBtn = document.getElementById('confirmCloseBtn');
                const newConfirmOk = confirmOk.cloneNode(true); confirmOk.parentNode.replaceChild(newConfirmOk, confirmOk);
                const newConfirmCancel = confirmCancel.cloneNode(true); confirmCancel.parentNode.replaceChild(newConfirmCancel, confirmCancel);
                const newConfirmCloseBtn = confirmCloseBtn.cloneNode(true); confirmCloseBtn.parentNode.replaceChild(newConfirmCloseBtn, confirmCloseBtn);
                newConfirmOk.addEventListener('click', () => { onConfirm(); UI.closeModal(modal); });
                newConfirmCancel.addEventListener('click', () => UI.closeModal(modal));
                newConfirmCloseBtn.addEventListener('click', () => UI.closeModal(modal));
            },
            toggleDarkMode() { const currentTheme = document.documentElement.getAttribute('data-theme'); document.documentElement.setAttribute('data-theme', currentTheme === 'dark' ? '' : 'dark'); UI.updateDarkModeButtonIcon(); },
            updateDarkModeButtonIcon() { if (DOM.darkModeToggle) { const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; DOM.darkModeToggle.innerHTML = isDark ? '☀️' : '🌙'; DOM.darkModeToggle.title = isDark ? 'Mode clair' : 'Mode sombre'; } },
            setQuarterMode(mode) {
                appState.currentQuarterMode = mode; document.documentElement.setAttribute('data-quarter-mode', appState.currentQuarterMode);
                DOM.quarterRadios.forEach(radio => radio.checked = (radio.value === mode)); UI.updateMassImportTooltip(mode);
                if (DOM.currentQuarterDisplayInputSection) DOM.currentQuarterDisplayInputSection.textContent = `Mode ${mode}`;
                if (DOM.inputSection) { DOM.inputSection.classList.remove('fade-in'); void DOM.inputSection.offsetWidth; DOM.inputSection.classList.add('fade-in'); }
                StorageManager.saveAppState();
            },
            updateMassImportTooltip(mode) {
                let tooltipText = "Format: NOM Prénom | Statut | Moy T1 | App T1";
                if (mode === 'T2') tooltipText += " | Moy T2 | App T2"; else if (mode === 'T3') tooltipText += " | Moy T2 | App T2 | Moy T3";
                tooltipText += ". Les champs sont séparés par un '|'. Les champs après 'Nom Prénom' sont optionnels selon le trimestre.";
                if (DOM.massDataTooltip) DOM.massDataTooltip.setAttribute('data-tooltip', tooltipText);
            },
            setInputMode(mode) {
                appState.currentInputMode = mode; const isMassMode = mode === 'mass';
                if (DOM.massImportSection) DOM.massImportSection.style.display = isMassMode ? 'block' : 'none';
                if (DOM.singleStudentFormDiv) DOM.singleStudentFormDiv.style.display = isMassMode ? 'none' : 'block';
                if (DOM.massImportTab) DOM.massImportTab.classList.toggle('active', isMassMode);
                if (DOM.massImportTab) DOM.massImportTab.setAttribute('aria-selected', isMassMode);
                if (DOM.singleStudentTab) DOM.singleStudentTab.classList.toggle('active', !isMassMode);
                if (DOM.singleStudentTab) DOM.singleStudentTab.setAttribute('aria-selected', !isMassMode);
                if (!isMassMode) AppreciationsManager.resetForm();
                if (DOM.inputSection) { DOM.inputSection.classList.remove('fade-in'); void DOM.inputSection.offsetWidth; DOM.inputSection.classList.add('fade-in'); }
                DOM.singleAppreciationPreview.classList.remove('show'); DOM.singleAppreciationPreview.textContent = 'Prévisualisation de l\'appréciation ici...';
                StorageManager.saveAppState();
            },
            setGenerationMode(mode) {
                appState.generationMode = mode; DOM.generationModeRadios.forEach(radio => radio.checked = (radio.value === mode));
                StorageManager.saveAppState(); UI.updateGenerateButtonIcons(); UI.updateHeaderAiIcon(); AppreciationsManager.renderResults();
            },
            updateGenerateButtonIcons() {
                const isAIMode = appState.generationMode === 'AI'; const icon = isAIMode ? '✨' : '🤖';
                if (DOM.importGenerateBtn) DOM.importGenerateBtn.innerHTML = `${icon} Importer et générer`;
                if (DOM.generateAppreciationBtn) DOM.generateAppreciationBtn.innerHTML = `${icon} Générer l'appréciation`;
                if (DOM.previewAppreciationBtn) DOM.previewAppreciationBtn.style.display = isAIMode ? 'inline-flex' : 'none';
            },
            updateHeaderAiIcon() {
                if (DOM.headerAiStatusIcon) {
                    if (appState.generationMode === 'AI' && UI.checkAPIKeyPresence(true)) {
                        DOM.headerAiStatusIcon.classList.add('active');
                    } else { 
                        DOM.headerAiStatusIcon.classList.remove('active');
                    }
                }
            },
            showLoadingOverlay(message = 'Génération en cours...') { if (DOM.loadingOverlay) DOM.loadingOverlay.style.display = 'flex'; if (DOM.loadingText) DOM.loadingText.textContent = message; },
            hideLoadingOverlay() { if (DOM.loadingOverlay) DOM.loadingOverlay.style.display = 'none'; },
            showInlineSpinner(element) {
                element.dataset.originalContent = element.innerHTML;
                element.innerHTML = `<div class="loading-spinner" style="margin: auto;"></div>`;
                element.style.display = 'flex';
                element.style.justifyContent = 'center';
                element.style.alignItems = 'center';
            },
            hideInlineSpinner(element) {
                if (element.dataset.originalContent) {
                    element.innerHTML = element.dataset.originalContent;
                    delete element.dataset.originalContent;
                }
                element.style.display = '';
                element.style.justifyContent = '';
                element.style.alignItems = '';
            },
            openModal(modalElement) { if (modalElement) { modalElement.style.display = 'flex'; const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'); if (focusableElements.length > 0) { focusableElements[0].focus(); } } },
            closeModal(modalElement) { if (modalElement) modalElement.style.display = 'none'; },
            closeAllModals() { [DOM.settingsModal, DOM.studentDetailsModal, DOM.refinementModal, DOM.statDetailsModal, DOM.helpModal, document.getElementById('customConfirmModal')].forEach(modal => { if (modal) UI.closeModal(modal); }); },
            updateSettingsPromptFields() {
                const prompts = appState.promptTemplates[appState.currentSubject] || DEFAULT_PROMPT_TEMPLATES['Autre'];
                if (DOM.settingsPromptT1) DOM.settingsPromptT1.value = prompts.T1 || '';
                if (DOM.settingsPromptT2) DOM.settingsPromptT2.value = prompts.T2 || '';
                if (DOM.settingsPromptT3) DOM.settingsPromptT3.value = prompts.T3 || '';
                if (DOM.currentSubjectTemplate) DOM.currentSubjectTemplate.textContent = appState.currentSubject;
                UI.updateTemplatePreview();
            },
            updateSettingsFields() {
                if (DOM.settingsEvolutionThresholdPositive) DOM.settingsEvolutionThresholdPositive.value = appState.evolutionThresholds.positive;
                if (DOM.settingsEvolutionThresholdVeryPositive) DOM.settingsEvolutionThresholdVeryPositive.value = appState.evolutionThresholds.veryPositive;
                if (DOM.settingsEvolutionThresholdNegative) DOM.settingsEvolutionThresholdNegative.value = appState.evolutionThresholds.negative;
                if (DOM.settingsEvolutionThresholdVeryNegative) DOM.settingsEvolutionThresholdVeryNegative.value = appState.evolutionThresholds.veryNegative;
                if (DOM.wordCountLimitInput) DOM.wordCountLimitInput.value = appState.wordCountLimit;
                if (DOM.negativeInstructionsGlobal) DOM.negativeInstructionsGlobal.value = appState.negativeInstructionsGlobal;
                if (DOM.aiModelSelect) DOM.aiModelSelect.value = appState.currentAIModel;
                if (DOM.openaiApiKey) DOM.openaiApiKey.value = appState.openaiApiKey;
                if (DOM.geminiApiKey) DOM.geminiApiKey.value = appState.geminiApiKey;
                if (DOM.mistralApiKey) DOM.mistralApiKey.value = appState.mistralApiKey;
                if (DOM.qwenApiKey) DOM.qwenApiKey.value = appState.qwenApiKey;
                if (DOM.deepseekApiKey) DOM.deepseekApiKey.value = appState.deepseekApiKey;
                if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = APP_VERSION;
                UI.toggleAIKeyFields(); UI.renderVocabLists();
            },
            updateTemplatePreview() {
                const currentQuarter = appState.currentQuarterMode;
                const template = document.getElementById(`promptTemplate${currentQuarter}`)?.value ||
                                appState.promptTemplates[appState.currentSubject]?.[currentQuarter] ||
                                DEFAULT_PROMPT_TEMPLATES['Autre'][currentQuarter];

                if (DOM.templatePreviewText) {
                    if (template) {
                        let filledTemplate = Utils.applyPhraseBricks(template, appState.vocabulaire.phraseBricks);
                        const studentDataForPreview = { prenom: 'Prénom', moyT1: 14.5, moyT2: 15.2, moyT3: 16.1, statut: 'Nouveau T2' };
                        let previewText = Utils.applyConditionalLogic(filledTemplate, studentDataForPreview);
                        previewText = previewText.replace(/{{prenom}}/g, 'Prénom').replace(/{{moyT1}}/g, '14,5').replace(/{{moyT2}}/g, '15,2').replace(/{{moyT3}}/g, '16,1').replace(/{{niveauGlobal}}/g, 'Bon travail').replace(/{{evolution_phrase}}/g, 'a bien progressé').replace(/{{encouragement}}/g, 'Il/Elle est encouragé(e) à continuer.').replace(/{{competence_aleatoire}}/g, 'la résolution de problèmes').replace(/{{qualite_aleatoire}}/g, 'la curiosité').replace(/{{activite_aleatoire}}/g, 'ses projets');
                        DOM.templatePreviewText.textContent = Utils.decodeHtmlEntities(previewText);
                    } else { DOM.templatePreviewText.textContent = 'Sélectionnez un trimestre pour prévisualiser le template.'; }
                }
            },
            updateAIPromptDisplays() {
                const studentDataExample = { nom: "MARTIN", prenom: "Lucas", moyT1: 12.5, moyT2: 13.8, moyT3: 14.2, appT1: "Bon travail en début d'année, des bases solides.", appT2: "Progression notable, continue ses efforts.", statut: "", quarterMode: "T2", subject: appState.currentSubject, generatedAppreciation: "Appréciation générée pour l'élève...", negativeInstructions: "Ne pas utiliser de jargon technique." };
                const evolutionsExample = AppreciationsManager.analyserEvolution(12.5, 13.8, 14.2);
                const templateTextExample = AppreciationsManager.buildAppreciationTextFromTemplate(studentDataExample.prenom, studentDataExample.moyT1, studentDataExample.moyT2, studentDataExample.moyT3, evolutionsExample, studentDataExample.appT1, studentDataExample.appT2, studentDataExample.statut, studentDataExample.quarterMode);
                const fullNegativeInstructions = [appState.negativeInstructionsGlobal, studentDataExample.negativeInstructions].filter(Boolean).join('. ').trim();
                const negativeInstructionsPromptPart = fullNegativeInstructions ? ` Instructions négatives : "${fullNegativeInstructions}".` : '';
                if (DOM.mainGenerationPromptDisplay) { DOM.mainGenerationPromptDisplay.value = `En tant que professeur de ${appState.currentSubject}, génère une appréciation pour l'élève ${studentDataExample.prenom} ${studentDataExample.nom} pour le ${studentDataExample.quarterMode} en te basant sur les informations suivantes et le template fourni. Adapte le ton et le contenu pour que cela ressemble à une appréciation scolaire, en restant concis (max ${appState.wordCountLimit} mots). Ne pas inclure de guillemets autour de la réponse.${negativeInstructionsPromptPart}\nInformations :\nNom : ${studentDataExample.nom}\nPrénom : ${studentDataExample.prenom}\nStatut : ${studentDataExample.statut || 'Aucun'}\nMoyenne T1 : ${studentDataExample.moyT1 !== null ? studentDataExample.moyT1.toFixed(1).replace('.', ',') : 'N/A'}\nAppréciation T1 : "${studentDataExample.appT1 || 'Non renseigné'}"\nMoyenne T2 : ${studentDataExample.moyT2 !== null ? studentDataExample.moyT2.toFixed(1).replace('.', ',') : 'N/A'}\nAppréciation T2 : "${studentDataExample.appT2 || 'Non renseigné'}"\nMoyenne T3 : ${studentDataExample.moyT3 !== null ? studentDataExample.moyT3.toFixed(1).replace('.', ',') : 'N/A'}\nTrimestre actuel : ${studentDataExample.quarterMode}\nÉvolution des moyennes : ${JSON.stringify(evolutionsExample)}\nTemplate : "${templateTextExample}"`; }
                if (DOM.refineConcisePromptDisplay) { DOM.refineConcisePromptDisplay.value = `Reformule l'appréciation suivante pour la rendre plus concise (max 30 mots). Retourne uniquement la version reformulée : "Appréciation originale de l'élève..."${negativeInstructionsPromptPart}`; }
                if (DOM.nextStepsPromptDisplay) { DOM.nextStepsPromptDisplay.value = `En tant que professeur de ${appState.currentSubject}, analyse l'appréciation suivante pour l'élève ${studentDataExample.prenom} ${studentDataExample.nom} :\n"${studentDataExample.generatedAppreciation}"\nSes moyennes sont : T1 : ${studentDataExample.moyT1}, T2 : ${studentDataExample.moyT2}, T3 : ${studentDataExample.moyT3}.\nLe trimestre actuel est le ${studentDataExample.quarterMode}.\nSuggère 3 à 5 pistes d'amélioration concrètes et actionnables pour cet élève en ${appState.currentSubject}, en tenant compte de son niveau et de son évolution. Chaque piste doit être une phrase courte. Retourne les pistes sous forme de liste numérotée.${negativeInstructionsPromptPart}`; }
                if (DOM.strengthsWeaknessesPromptDisplay) { DOM.strengthsWeaknessesPromptDisplay.value = `En tant que professeur de ${appState.currentSubject}, analyse les informations suivantes sur l'élève ${studentDataExample.prenom} ${studentDataExample.nom} :\nMoyennes : T1 : ${studentDataExample.moyT1?.toFixed(1) || 'N/A'}, T2 : ${studentDataExample.moyT2?.toFixed(1) || 'N/A'}, T3 : ${studentDataExample.moyT3?.toFixed(1) || 'N/A'}\nAppréciation T1 : "${studentDataExample.appT1 || 'Non renseigné'}"\nAppréciation T2 : "${studentDataExample.appT2 || 'Non renseigné'}"\nAppréciation actuelle : "${studentDataExample.generatedAppreciation || 'Non générée'}"\nStatut : "${studentDataExample.statut || 'Aucun'}"\nSuggère 2 à 3 points forts et 2 à 3 points faibles, basés uniquement sur les informations fournies.\nFormate ta réponse comme suit:\nPoints Forts :\n- Point fort 1\n- Point fort 2\nPoints Faibles :\n- Point faible 1\n- Point faible 2\nNe pas inventer d'informations. Si aucune information n'est pertinente, indique 'Non disponible'.${negativeInstructionsPromptPart}`; }
            },
            updateStats() {
                const total = appState.generatedResults.length;
                const filtered = appState.filteredResults.length;
                if (DOM.totalCountStat) DOM.totalCountStat.textContent = filtered !== total ? `${filtered}/${total}` : total;
                if (filtered > 0) {
                    let totalGrades = 0, gradeCount = 0, progressCount = 0, stableCount = 0, regressionCount = 0, totalWords = 0, errorFreeAppreciationsCount = 0;
                    appState.filteredResults.forEach(result => {
                        if (!result.errorMessage) {
                            errorFreeAppreciationsCount++;
                            let grade = result.studentData[`moy${result.studentData.quarterMode}`];
                            if (grade !== null && typeof grade === 'number') { totalGrades += grade; gradeCount++; }
                            if (result.studentData.quarterMode !== 'T1') {
                                const evolutionToShow = result.evolutions.find(e => (result.studentData.quarterMode === 'T3' && (e.periode === 'T2-T3' || e.periode === 'T1-T3')) || (result.studentData.quarterMode === 'T2' && e.periode === 'T1-T2'));
                                if (evolutionToShow) {
                                    if (['very-positive', 'positive'].includes(evolutionToShow.type)) progressCount++;
                                    else if (evolutionToShow.type === 'stable') stableCount++;
                                    else if (['negative', 'very-negative'].includes(evolutionToShow.type)) regressionCount++;
                                } else stableCount++;
                            }
                            totalWords += Utils.countWords(result.appreciation);
                        }
                    });
                    if (DOM.avgGradeOutputStat) DOM.avgGradeOutputStat.textContent = gradeCount > 0 ? (totalGrades / gradeCount).toFixed(1) : '-';
                    if (DOM.progressCountStat) DOM.progressCountStat.textContent = progressCount;
                    if (DOM.stableCountStat) DOM.stableCountStat.textContent = stableCount;
                    if (DOM.regressionCountStat) DOM.regressionCountStat.textContent = regressionCount;
                    if (DOM.avgWordsStat) DOM.avgWordsStat.textContent = errorFreeAppreciationsCount > 0 ? Math.round(totalWords / errorFreeAppreciationsCount) : 0;
                } else {
                    if (DOM.avgGradeOutputStat) DOM.avgGradeOutputStat.textContent = '-'; if (DOM.progressCountStat) DOM.progressCountStat.textContent = '0';
                    if (DOM.stableCountStat) DOM.stableCountStat.textContent = '0'; if (DOM.regressionCountStat) DOM.regressionCountStat.textContent = '0';
                    if (DOM.avgWordsStat) DOM.avgWordsStat.textContent = '0';
                }
            },
            updateProgressBar(current, total) { const progress = total > 0 ? (current / total) * 100 : 0; if (DOM.progressFill) DOM.progressFill.style.width = `${progress}%`; if (DOM.progressText) DOM.progressText.textContent = `${current}/${total} élèves traités`; },
            resetProgressBar() { if (DOM.progressContainer) DOM.progressContainer.style.display = 'none'; UI.updateProgressBar(0,0); },
            showSettingsTab(tabName) {
                DOM.settingsModal.querySelectorAll('.tab-content').forEach(content => { content.style.display = 'none'; content.classList.remove('active'); });
                DOM.settingsModal.querySelectorAll('.settings-tab').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-selected', 'false'); });
                const tabContent = document.getElementById(`${tabName}TabContent`); if (tabContent) { tabContent.style.display = 'block'; tabContent.classList.add('active'); }
                const tabButton = DOM.settingsModal.querySelector(`.settings-tab[data-tab="${tabName}"]`); if (tabButton) { tabButton.classList.add('active'); tabButton.setAttribute('aria-selected', 'true'); }
            },
            showStatDetails(statId) {
                let title = '', content = ''; const thresholds = appState.evolutionThresholds;
                switch (statId) {
                    case 'totalCount': title = "Total d'élèves"; content = "Nombre total d'appréciations générées et affichées (filtrées si recherche active)."; break;
                    case 'avgGradeOutput': title = "Moyenne générale"; content = "Moyenne des notes du trimestre en cours pour les élèves affichés (notes valides uniquement)."; break;
                    case 'progressCount': title = "Élèves en progrès"; content = `Élèves avec progression 'notable' (≥${thresholds.positive}pts) ou 'très forte' (≥${thresholds.veryPositive}pts) vs trimestre précédent. Les seuils sont <a href="#" class="link-to-settings" data-target-tab="options" data-target-element="evolutionThresholdPositive">paramétrables</a>.`; break;
                    case 'stableCount': title = "Élèves stables"; content = `Élèves dont la moyenne est restée stable (variation < seuils de progrès/régression) vs trimestre précédent. Les seuils sont <a href="#" class="link-to-settings" data-target-tab="options" data-target-element="evolutionThresholdPositive">paramétrables</a>.`; break;
                    case 'regressionCount': title = "Élèves en régression"; content = `Élèves avec recul 'léger' (≤${thresholds.negative}pts) ou 'forte baisse' (≤${thresholds.veryNegative}pts) vs trimestre précédent. Les seuils sont <a href="#" class="link-to-settings" data-target-tab="options" data-target-element="evolutionThresholdNegative">paramétrables</a>.`; break;
                    case 'avgWords': title = "Mots par appréciation"; content = "Nombre moyen de mots par appréciation générée (hors erreurs)."; break;
                    default: title = "Information"; content = "Détails non disponibles.";
                }
                const titleElement = document.getElementById('statDetailsModalTitle');
                if (titleElement) titleElement.textContent = title; 
                
                if (DOM.statDetailsContent) {
                    DOM.statDetailsContent.innerHTML = content;
                    const link = DOM.statDetailsContent.querySelector('.link-to-settings');
                    if (link) {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            UI.closeModal(DOM.statDetailsModal);
                            UI.openModal(DOM.settingsModal);
                            const tab = link.dataset.targetTab;
                            const elementId = link.dataset.targetElement;
                            UI.showSettingsTab(tab);
                            setTimeout(() => {
                                const targetElement = document.getElementById(elementId);
                                if (targetElement) {
                                    targetElement.focus();
                                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                        });
                    }
                }
                UI.openModal(DOM.statDetailsModal);
            },
            copyTextToClipboard(targetId) {
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    const textToCopy = targetElement.value || targetElement.textContent;
                    navigator.clipboard.writeText(textToCopy).then(() => { UI.showNotification('Copié dans le presse-papiers', 'success'); }).catch(err => {
                        console.error('Erreur de copie via Clipboard API:', err); const textarea = document.createElement('textarea');
                        textarea.value = textToCopy; document.body.appendChild(textarea); textarea.select();
                        try { document.execCommand('copy'); UI.showNotification('Copié dans le presse-papiers (fallback)', 'success'); }
                        catch (execErr) { console.error('Erreur de copie (fallback):', execErr); UI.showNotification('Échec de la copie.', 'error'); }
                        document.body.removeChild(textarea);
                    });
                } else { UI.showNotification('Élément à copier introuvable.', 'error'); }
            },
            toggleAIKeyFields() {
                if (!DOM.aiModelSelect) return; const selectedModel = DOM.aiModelSelect.value;
                const keyGroups = { openai: DOM.openaiApiKeyGroup, gemini: DOM.geminiApiKeyGroup, mistral: DOM.mistralApiKeyGroup, qwen: DOM.qwenApiKeyGroup, deepseek: DOM.deepseekApiKeyGroup };
                Object.values(keyGroups).forEach(group => { if (group) group.style.display = 'none'; });
                [DOM.openaiApiKeyError, DOM.geminiApiKeyError, DOM.mistralApiKeyError, DOM.qwenApiKeyError, DOM.deepseekApiKeyError].forEach(el => { if(el) el.style.display = 'none';});
                if (selectedModel.startsWith('openai')) { if (keyGroups.openai) keyGroups.openai.style.display = 'flex'; }
                else if (selectedModel.startsWith('gemini')) { if (keyGroups.gemini) keyGroups.gemini.style.display = 'flex'; if (DOM.geminiApiKeyHint) { DOM.geminiApiKeyHint.textContent = CONFIG.API_KEY ? 'Clé Canvas détectée. Laissez vide pour utiliser la clé par défaut ou saisissez la vôtre pour la remplacer.' : 'Saisissez votre clé API Gemini (Ex: AIzaSy...). Elle est stockée localement et n\'est jamais partagée.'; if (DOM.geminiApiKey) DOM.geminiApiKey.placeholder = CONFIG.API_KEY ? 'AIzaSy... (Clé Canvas/Utilisateur)' : 'AIzaSy... (Votre clé API Gemini)'; } }
                else if (selectedModel.startsWith('mistral')) { if (keyGroups.mistral) keyGroups.mistral.style.display = 'flex'; }
                else if (selectedModel.startsWith('qwen')) { if (keyGroups.qwen) keyGroups.qwen.style.display = 'flex'; }
                else if (selectedModel.startsWith('deepseek')) { if (keyGroups.deepseek) keyGroups.deepseek.style.display = 'flex'; }
            },
            checkAPIKeyPresence(silent = false) {
                const model = appState.currentAIModel; let keyToCheck = ''; let keyName = ''; let errorElementId = '';
                if (model.startsWith('gemini')) { keyToCheck = appState.geminiApiKey || CONFIG.API_KEY; keyName = 'Gemini'; errorElementId = 'geminiApiKeyError'; }
                else if (model.startsWith('openai')) { keyToCheck = appState.openaiApiKey; keyName = 'OpenAI'; errorElementId = 'openaiApiKeyError'; }
                else if (model.startsWith('deepseek')) { keyToCheck = appState.deepseekApiKey; keyName = 'DeepSeek/OpenRouter'; errorElementId = 'deepseekApiKeyError'; }
                else if (model.startsWith('mistral')) { keyToCheck = appState.mistralApiKey; keyName = 'Mistral'; errorElementId = 'mistralApiKeyError'; }
                else if (model.startsWith('qwen')) { keyToCheck = appState.qwenApiKey; keyName = 'Qwen'; errorElementId = 'qwenApiKeyError'; }
                const errorElement = document.getElementById(errorElementId);
                if (keyName && !keyToCheck) {
                    if (!silent) {
                        UI.showNotification(`Clé API ${keyName} manquante. Configurez-la dans les paramètres ou le mode Automate sera utilisé.`, 'warning');
                        if (errorElement && DOM.settingsModal.style.display === 'flex' && DOM.optionsTabContent.style.display === 'block') { errorElement.textContent = `⚠️ Clé API ${keyName} requise pour ce modèle.`; errorElement.style.display = 'block'; }
                    }
                    return false;
                }
                if (errorElement) errorElement.style.display = 'none'; return true;
            },
            renderVocabList(containerElement, vocabArray, type) {
                containerElement.innerHTML = ''; if (vocabArray.length === 0) { containerElement.innerHTML = '<p style="color: var(--summary-details-color); text-align: center;">Aucun élément.</p>'; return; }
                vocabArray.forEach((item, index) => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'vocab-item';
                    itemDiv.innerHTML = `<span class="vocab-item-text" contenteditable="true" data-index="${index}" data-type="${type}" tabindex="0">${item}</span><div class="vocab-item-actions"><button data-action="delete" data-index="${index}" data-type="${type}" aria-label="Supprimer cet élément">🗑️</button></div>`;
                    containerElement.appendChild(itemDiv);
                });
            },
            renderPhraseBricksList(containerElement, phraseBricksObject) {
                containerElement.innerHTML = ''; const keys = Object.keys(phraseBricksObject);
                if (keys.length === 0) { containerElement.innerHTML = '<p style="color: var(--summary-details-color); text-align: center;">Aucune brique de phrase.</p>'; return; }
                keys.forEach((key) => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'vocab-item';
                    itemDiv.innerHTML = `<span class="vocab-item-text" contenteditable="true" data-key="${key}" data-type="phraseBrick" tabindex="0"><b>${key}</b>: ${phraseBricksObject[key]}</span><div class="vocab-item-actions"><button data-action="delete" data-key="${key}" data-type="phraseBrick" aria-label="Supprimer cette brique de phrase">🗑️</button></div>`;
                    containerElement.appendChild(itemDiv);
                });
            },
            renderVocabLists() {
                UI.renderVocabList(DOM.vocabCompetencesList, appState.vocabulaire.competences, 'competences');
                UI.renderVocabList(DOM.vocabQualitesList, appState.vocabulaire.qualites, 'qualites');
                UI.renderVocabList(DOM.vocabActivitesList, appState.vocabulaire.activites, 'activites');
                UI.renderPhraseBricksList(DOM.phraseBricksList, appState.vocabulaire.phraseBricks);
            }
        };

        // ====================================================================
        // 5. Gestion des Appréciations
        // ====================================================================

        const AppreciationsManager = {
            createResultObject(nom, prenom, appreciation, evolutions, studentData, errorMessage = null, tokenUsage = null) {
                const uniqueId = Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                return {
                    id: uniqueId, nom, prenom, appreciation, evolutions,
                    studentData: {
                        ...studentData,
                        generatedAppreciation: appreciation,
                        quarterMode: appState.currentQuarterMode,
                        subject: appState.currentSubject,
                        generationMode: appState.generationMode,
                        negativeInstructions: studentData.negativeInstructions || ''
                    },
                    errorMessage, timestamp: new Date().toISOString(), strengthsWeaknesses: null, nextSteps: null,
                    tokenUsage: tokenUsage
                };
            },
            analyserEvolution(t1, t2, t3) {
                const evolutions = []; const thresholds = appState.evolutionThresholds;
                const determineEvolutionType = (diff) => {
                    if (diff === null || isNaN(diff)) return 'stable';
                    if (diff >= thresholds.veryPositive) return 'very-positive';
                    if (diff >= thresholds.positive) return 'positive';
                    if (diff <= thresholds.veryNegative) return 'very-negative';
                    if (diff <= thresholds.negative) return 'negative';
                    return 'stable';
                };
                if (t1 !== null && t2 !== null && typeof t1 === 'number' && typeof t2 === 'number') evolutions.push({ type: determineEvolutionType(t2 - t1), valeur: t2 - t1, periode: 'T1-T2' });
                if (t2 !== null && t3 !== null && typeof t2 === 'number' && typeof t3 === 'number') evolutions.push({ type: determineEvolutionType(t3 - t2), valeur: t3 - t2, periode: 'T2-T3' });
                if (t1 !== null && t3 !== null && typeof t1 === 'number' && typeof t3 === 'number') evolutions.push({ type: determineEvolutionType(t3 - t1), valeur: t3 - t1, periode: 'T1-T3' });
                return evolutions;
            },
            determineNiveauGlobal(grade) {
                if (grade === null || typeof grade !== 'number') return 'Niveau non renseigné';
                if (grade >= 17) return 'Très bon travail'; if (grade >= 14) return 'Bon travail';
                if (grade >= 10) return 'Travail satisfaisant'; if (grade >= 7) return 'Travail insuffisant';
                return 'Travail très insuffisant';
            },
            getEncouragementPhrase() {
                const encouragements = ["Il/Elle est encouragé(e) à poursuivre ses efforts.", "Il/Elle doit continuer sur cette voie.", "Une persévérance constante est attendue.", "Je l'encourage à maintenir ce niveau d'engagement.", "Il/Elle peut encore progresser avec de l'investissement."];
                return Utils.getRandomElement(encouragements);
            },
            getEvolutionPhrase(evolutions, currentQuarter) {
                let relevantEvolution = null;
                if (currentQuarter === 'T3') relevantEvolution = evolutions.find(e => e.periode === 'T2-T3') || evolutions.find(e => e.periode === 'T1-T3');
                else if (currentQuarter === 'T2') relevantEvolution = evolutions.find(e => e.periode === 'T1-T2');
                if (!relevantEvolution) return "Son évolution n'a pas pu être déterminée.";
                const diff = relevantEvolution.valeur;
                 if (diff === null || isNaN(diff)) return "maintient un niveau stable (données antérieures manquantes)";
                const absDiff = Math.abs(diff).toFixed(1).replace('.',',');
                switch (relevantEvolution.type) {
                    case 'very-positive': return `a réalisé une très forte progression de ${absDiff} point(s)`;
                    case 'positive': return `a bien progressé de ${absDiff} point(s)`;
                    case 'stable': return `maintient un niveau stable`;
                    case 'negative': return `a connu un léger recul de ${absDiff} point(s)`;
                    case 'very-negative': return `a rencontré de fortes difficultés avec une baisse de ${absDiff} point(s)`;
                    default: return `Son évolution n'a pas pu être déterminée.`;
                }
            },
            buildAppreciationTextFromTemplate(prenom, moyT1, moyT2, moyT3, evolutions, appT1, appT2, statut, quarterMode) {
                let template = appState.promptTemplates[appState.currentSubject]?.[quarterMode] || DEFAULT_PROMPT_TEMPLATES['Autre'][quarterMode];
                if (!template) return "Erreur : Template non trouvé.";
                const currentGrade = quarterMode === 'T1' ? moyT1 : quarterMode === 'T2' ? moyT2 : moyT3;
                const studentDataForTemplate = { prenom, moyT1, moyT2, moyT3, statut, niveauGlobal: AppreciationsManager.determineNiveauGlobal(currentGrade), evolution_phrase: AppreciationsManager.getEvolutionPhrase(evolutions, quarterMode), encouragement: AppreciationsManager.getEncouragementPhrase(), competence_aleatoire: Utils.getRandomElement(appState.vocabulaire.competences), qualite_aleatoire: Utils.getRandomElement(appState.vocabulaire.qualites), activite_aleatoire: Utils.getRandomElement(appState.vocabulaire.activites) };
                let appreciationText = Utils.applyConditionalLogic(template, studentDataForTemplate);
                appreciationText = Utils.applyPhraseBricks(appreciationText, appState.vocabulaire.phraseBricks);
                appreciationText = appreciationText.replace(/{{prenom}}/g, prenom).replace(/{{moyT1}}/g, moyT1 !== null && typeof moyT1 === 'number' ? moyT1.toFixed(1).replace('.', ',') : 'N/A').replace(/{{moyT2}}/g, moyT2 !== null && typeof moyT2 === 'number' ? moyT2.toFixed(1).replace('.', ',') : 'N/A').replace(/{{moyT3}}/g, moyT3 !== null && typeof moyT3 === 'number' ? moyT3.toFixed(1).replace('.', ',') : 'N/A').replace(/{{niveauGlobal}}/g, studentDataForTemplate.niveauGlobal).replace(/{{encouragement}}/g, studentDataForTemplate.encouragement).replace(/{{competence_aleatoire}}/g, studentDataForTemplate.competence_aleatoire).replace(/{{qualite_aleatoire}}/g, studentDataForTemplate.qualite_aleatoire).replace(/{{activite_aleatoire}}/g, studentDataForTemplate.activite_aleatoire);
                if (quarterMode !== 'T1') appreciationText = appreciationText.replace(/{{evolution_phrase}}/g, studentDataForTemplate.evolution_phrase);
                return appreciationText.replace(/{{[^}]+}}/g, '').trim();
            },
            async generateAppreciation(studentData, isPreview = false) {
                const { nom, prenom, statut, moyT1, appT1, moyT2, appT2, moyT3, quarterMode, negativeInstructions } = studentData;
                const evolutions = AppreciationsManager.analyserEvolution(moyT1, moyT2, moyT3);
                let appreciation = '', errorMessage = null, tokenUsage = null;
                const fullNegativeInstructions = [appState.negativeInstructionsGlobal, negativeInstructions].filter(Boolean).join('. ').trim();
                const negativeInstructionsPromptPart = fullNegativeInstructions ? ` Instructions négatives : "${fullNegativeInstructions}".` : '';

                if (appState.generationMode === 'AI') {
                    if (!UI.checkAPIKeyPresence()) {
                        errorMessage = "Clé API manquante. Appréciation générée via template.";
                        appreciation = AppreciationsManager.buildAppreciationTextFromTemplate(prenom, moyT1, moyT2, moyT3, evolutions, appT1, appT2, statut, quarterMode);
                        if (isPreview) return appreciation;
                        return AppreciationsManager.createResultObject(nom, prenom, appreciation, evolutions, studentData, errorMessage, tokenUsage);
                    }
                    try {
                        const templateText = AppreciationsManager.buildAppreciationTextFromTemplate(prenom, moyT1, moyT2, moyT3, evolutions, appT1, appT2, statut, quarterMode);
                        const prompt = `En tant que professeur de ${appState.currentSubject}, génère une appréciation pour l'élève ${prenom} ${nom} pour le ${quarterMode} en te basant sur les informations suivantes et le template fourni. Adapte le ton et le contenu pour que cela ressemble à une appréciation scolaire, en restant concis (max ${appState.wordCountLimit} mots). Ne pas inclure de guillemets autour de la réponse.${negativeInstructionsPromptPart}\nInformations :\nNom : ${nom}\nPrénom : ${prenom}\nStatut : ${statut || 'Aucun'}\nMoyenne T1 : ${moyT1 !== null && typeof moyT1 === 'number' ? moyT1.toFixed(1).replace('.', ',') : 'N/A'}\nAppréciation T1 : "${appT1 || 'Non renseigné'}"\nMoyenne T2 : ${moyT2 !== null && typeof moyT2 === 'number' ? moyT2.toFixed(1).replace('.', ',') : 'N/A'}\nAppréciation T2 : "${appT2 || 'Non renseigné'}"\nMoyenne T3 : ${moyT3 !== null && typeof moyT3 === 'number' ? moyT3.toFixed(1).replace('.', ',') : 'N/A'}\nTrimestre actuel : ${quarterMode}\nÉvolution des moyennes : ${JSON.stringify(evolutions)}\nTemplate : "${templateText}"`;
                        const aiResponse = await AppreciationsManager.callAI(prompt);
                        appreciation = aiResponse.text; tokenUsage = aiResponse.usage;
                        if (Utils.countWords(appreciation) > appState.wordCountLimit * 1.2) { appreciation = appreciation.split(/\s+/).slice(0, appState.wordCountLimit).join(' ') + '...'; }
                    } catch (error) {
                        console.error("Erreur IA:", error);
                        const translatedError = Utils.translateErrorMessage(error.message || String(error));
                        errorMessage = `Erreur IA : ${translatedError}. Appréciation via template.`;
                        appreciation = AppreciationsManager.buildAppreciationTextFromTemplate(prenom, moyT1, moyT2, moyT3, evolutions, appT1, appT2, statut, quarterMode);
                    }
                } else { appreciation = AppreciationsManager.buildAppreciationTextFromTemplate(prenom, moyT1, moyT2, moyT3, evolutions, appT1, appT2, statut, quarterMode); }
                if (isPreview) return appreciation;
                return AppreciationsManager.createResultObject(nom, prenom, appreciation, evolutions, studentData, errorMessage, tokenUsage);
            },
            async callAI(prompt) {
                const selectedModelOption = appState.currentAIModel; let apiKey = ''; let apiUrl = ''; const headers = { 'Content-Type': 'application/json' };
                let payload = {}; let modelForPayload = selectedModelOption; let usageData = null;
                const isUsingOpenRouter = appState.deepseekApiKey && appState.deepseekApiKey.startsWith('sk-or-');
                if (selectedModelOption.startsWith('gemini')) {
                    apiKey = appState.geminiApiKey || CONFIG.API_KEY; if (!apiKey) throw new Error(`Clé API Gemini non configurée.`);
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModelOption}:generateContent?key=${apiKey}`; payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                } else if (selectedModelOption.startsWith('openai')) {
                    apiKey = appState.openaiApiKey; if (!apiKey) throw new Error(`Clé API OpenAI non configurée.`);
                    apiUrl = `https://api.openai.com/v1/chat/completions`; headers['Authorization'] = `Bearer ${apiKey}`;
                    modelForPayload = selectedModelOption.replace('openai-', ''); payload = { model: modelForPayload, messages: [{ role: "user", content: prompt }] };
                } else if (selectedModelOption.startsWith('deepseek')) {
                    apiKey = appState.deepseekApiKey; if (!apiKey) throw new Error(`Clé API DeepSeek/OpenRouter non configurée.`);
                    if (isUsingOpenRouter) { apiUrl = `${CONFIG.OPENROUTER_API_BASE}/chat/completions`; headers['Authorization'] = `Bearer ${apiKey}`; headers['HTTP-Referer'] = `${window.location.protocol}//${window.location.hostname}`; headers['X-Title'] = `Générateur d'Appréciations`; modelForPayload = 'deepseek/deepseek-chat'; }
                    else { apiUrl = `${CONFIG.DEEPSEEK_API_BASE}/chat/completions`; headers['Authorization'] = `Bearer ${apiKey}`; modelForPayload = 'deepseek-chat'; }
                    headers['Accept'] = `application/json`; payload = { model: modelForPayload, messages: [{ role: "user", content: prompt }], };
                } else if (selectedModelOption.startsWith('mistral') || selectedModelOption.startsWith('qwen')) {
                    const modelName = selectedModelOption.startsWith('mistral') ? 'Mistral' : 'Qwen';
                    console.warn(`L'appel à l'API ${modelName} (${selectedModelOption}) n'est pas encore implémenté.`);
                    UI.showNotification(`L'API ${modelName} (${selectedModelOption}) n'est pas encore prise en charge pour la génération.`, 'warning');
                    return { text: `(Appel à ${modelName} API pour '${selectedModelOption}' non implémenté)`, usage: null };
                } else { throw new Error("Modèle d'IA non supporté ou configuration d'appel manquante."); }
                const response = await fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(payload) });
                const result = await response.json();
                if (!response.ok) { console.error("Erreur API:", result); let errorMessage = `Erreur API ${response.status}`; const errorDetails = result.error?.message || result.error || result.message || result.detail; if (errorDetails) errorMessage += `: ${errorDetails}`; throw new Error(errorMessage); }
                if (result.usage) { usageData = { prompt_tokens: result.usage.prompt_tokens, completion_tokens: result.usage.completion_tokens, total_tokens: result.usage.total_tokens }; }
                else if (selectedModelOption.startsWith('gemini') && result.usageMetadata) { usageData = { prompt_tokens: result.usageMetadata.promptTokenCount, completion_tokens: result.usageMetadata.candidatesTokenCount, total_tokens: result.usageMetadata.totalTokenCount }; }
                else if (selectedModelOption.startsWith('gemini')) { const promptTokens = Utils.countWords(prompt) * 1.5; const completionText = result.candidates?.[0]?.content?.parts?.[0]?.text || ""; const completionTokens = Utils.countWords(completionText) * 1.5; usageData = { prompt_tokens: Math.round(promptTokens), completion_tokens: Math.round(completionTokens), total_tokens: Math.round(promptTokens + completionTokens) }; console.warn("Token usage for Gemini not directly in response, estimated based on word count."); }
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) { return { text: result.candidates[0].content.parts[0].text, usage: usageData }; }
                if (result.choices?.[0]?.message?.content) { return { text: result.choices[0].message.content, usage: usageData }; }
                throw new Error("Réponse de l'IA inattendue ou non gérée pour le modèle sélectionné.");
            },
            async generateSingleAppreciation(isPreview = false) {
                [DOM.nomError, DOM.prenomError, DOM.moyT1Error, DOM.moyT2Error, DOM.moyT3Error].forEach(el => { if(el) el.style.display = 'none'; });
                let isValid = Utils.validateInput(DOM.nomInput) && Utils.validateInput(DOM.prenomInput);
                isValid = Utils.validateGrade(DOM.moyT1Input) && isValid;
                isValid = Utils.validateGrade(DOM.moyT2Input) && isValid;
                isValid = Utils.validateGrade(DOM.moyT3Input) && isValid;
                if (!isValid) { UI.showNotification('Veuillez corriger les erreurs.', 'error'); return; }
                UI.showLoadingOverlay(isPreview ? 'Prévisualisation en cours...' : 'Génération en cours...');
                const parseGradeInput = (inputElement) => { const valueStr = inputElement.value.trim().replace(',', '.'); return valueStr === '' ? null : parseFloat(valueStr); };
                const studentData = { nom: DOM.nomInput.value.trim().toUpperCase(), prenom: DOM.prenomInput.value.trim(), statut: DOM.statutSelect.value, moyT1: parseGradeInput(DOM.moyT1Input), appT1: DOM.appT1Textarea.value.trim(), moyT2: parseGradeInput(DOM.moyT2Input), appT2: DOM.appT2Textarea.value.trim(), moyT3: parseGradeInput(DOM.moyT3Input), quarterMode: appState.currentQuarterMode, subject: appState.currentSubject, negativeInstructions: DOM.negativeInstructions.value.trim() };
                try {
                    const result = await AppreciationsManager.generateAppreciation(studentData, isPreview);
                    if (isPreview) {
                        DOM.singleAppreciationPreview.textContent = Utils.decodeHtmlEntities(Utils.cleanMarkdown(result));
                        DOM.singleAppreciationPreview.classList.add('show');
                        UI.showNotification('Prévisualisation générée !', 'success');
                    } else {
                        appState.generatedResults.unshift(result);
                        AppreciationsManager.renderResults();
                        AppreciationsManager.resetForm();
                        UI.showNotification('Appréciation générée !', 'success');
                    }
                } catch (error) {
                    console.error('Erreur génération:', error);
                    UI.showNotification(`Erreur : ${Utils.translateErrorMessage(error.message)}`, 'error');
                    if (isPreview) { DOM.singleAppreciationPreview.textContent = `Erreur lors de la prévisualisation: ${Utils.translateErrorMessage(error.message)}`; DOM.singleAppreciationPreview.classList.add('show'); }
                } finally { UI.hideLoadingOverlay(); }
            },
            async processMassImport() {
                const massData = DOM.massData.value.trim();
                if (!massData) { UI.showNotification('Veuillez coller des données ou importer un fichier.', 'warning'); return; }
                const lines = massData.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) { UI.showNotification('Aucune donnée valide à traiter.', 'warning'); return; }
                if (DOM.progressContainer) DOM.progressContainer.style.display = 'block';
                UI.updateProgressBar(0, lines.length);
                if (DOM.cancelImportBtn) DOM.cancelImportBtn.style.display = 'inline-flex';
                appState.isMassImportCancelled = false;
                
                for (let i = 0; i < lines.length; i++) {
                    if (appState.isMassImportCancelled) { UI.showNotification('Importation annulée.', 'warning'); break; }
                    UI.updateProgressBar(i + 1, lines.length);
                    const studentData = Utils.parseStudentLine(lines[i], appState.currentQuarterMode);
                    let result;
                    if (studentData) {
                        if (!studentData.nom && !studentData.prenom) { console.warn(`Ligne ignorée (sans nom/prénom) : ${lines[i]}`); await new Promise(resolve => setTimeout(resolve, 10)); continue; }
                        try {
                            result = await AppreciationsManager.generateAppreciation(studentData);
                        } catch (error) {
                            console.error(`Erreur pour ${studentData.nom || 'Élève'} ${studentData.prenom || 'Inconnu'}:`, error);
                            result = AppreciationsManager.createResultObject(studentData.nom || 'Erreur Nom', studentData.prenom || 'Erreur Prénom', `Erreur: ${Utils.translateErrorMessage(error.message)}`, [], studentData, error.message, null);
                        }
                        appState.generatedResults.unshift(result);
                        AppreciationsManager.renderResults(); 
                    }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                if (!appState.isMassImportCancelled) {
                    UI.showNotification(`${lines.length} lignes traitées.`, 'success');
                }
                
                UI.resetProgressBar();
                if (DOM.cancelImportBtn) DOM.cancelImportBtn.style.display = 'none';
                appState.isMassImportCancelled = false;
                StorageManager.saveAppState();
            },
            resetForm() {
                if (DOM.actualSingleStudentForm) DOM.actualSingleStudentForm.reset();
                [DOM.nomError, DOM.prenomError, DOM.moyT1Error, DOM.moyT2Error, DOM.moyT3Error].forEach(el => { if(el) el.style.display = 'none'; });
                document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
                appState.currentEditingId = null;
                DOM.singleAppreciationPreview.classList.remove('show');
                DOM.singleAppreciationPreview.textContent = 'Prévisualisation de l\'appréciation ici...';
            },
            editAppreciation(id) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (result) {
                    UI.setInputMode('single'); appState.currentEditingId = id;
                    UI.setQuarterMode(result.studentData.quarterMode || appState.currentQuarterMode);
                    DOM.subjectSelect.value = result.studentData.subject || appState.currentSubject;
                    appState.currentSubject = DOM.subjectSelect.value;
                    DOM.nomInput.value = result.nom; DOM.prenomInput.value = result.prenom; DOM.statutSelect.value = result.studentData.statut || '';
                    DOM.moyT1Input.value = result.studentData.moyT1 !== null && typeof result.studentData.moyT1 === 'number' ? result.studentData.moyT1.toString().replace('.', ',') : '';
                    DOM.appT1Textarea.value = result.studentData.appT1 || '';
                    DOM.moyT2Input.value = result.studentData.moyT2 !== null && typeof result.studentData.moyT2 === 'number' ? result.studentData.moyT2.toString().replace('.', ',') : '';
                    DOM.appT2Textarea.value = result.studentData.appT2 || '';
                    DOM.moyT3Input.value = result.studentData.moyT3 !== null && typeof result.studentData.moyT3 === 'number' ? result.studentData.moyT3.toString().replace('.', ',') : '';
                    DOM.negativeInstructions.value = result.studentData.negativeInstructions || '';
                    UI.showNotification(`Modification de ${result.prenom} ${result.nom}.`, 'info');
                    if (DOM.inputSection) DOM.inputSection.scrollIntoView({ behavior: 'smooth' });
                }
            },
            deleteAppreciation(id) { UI.showCustomConfirm('Supprimer cette appréciation ?', () => { appState.generatedResults = appState.generatedResults.filter(result => result.id !== id); AppreciationsManager.renderResults(); UI.showNotification('Appréciation supprimée.', 'success'); }); },
            copyAppreciation(id, buttonElement) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (result?.appreciation) {
                    const appreciationText = `${result.prenom} ${result.nom} : ${Utils.decodeHtmlEntities(result.appreciation)}`;
                    navigator.clipboard.writeText(appreciationText).then(() => { if (buttonElement) { buttonElement.innerHTML = '✅ Copié !'; buttonElement.classList.add('copied'); buttonElement.disabled = true; } UI.showNotification('Appréciation copiée !', 'success'); }).catch(err => { console.error('Erreur copie (clipboard API):', err); const textarea = document.createElement('textarea'); textarea.value = appreciationText; document.body.appendChild(textarea); textarea.select(); try { document.execCommand('copy'); if (buttonElement) { buttonElement.innerHTML = '✅ Copié !'; buttonElement.classList.add('copied'); buttonElement.disabled = true; } UI.showNotification('Appréciation copiée (fallback)!', 'success'); } catch (execErr) { UI.showNotification('Échec de la copie.', 'error'); } document.body.removeChild(textarea); });
                } else UI.showNotification('Appréciation introuvable ou vide.', 'error');
            },
            showAppreciationDetails(id) {
                const result = appState.generatedResults.find(r => r.id === id);
                if (result) {
                    DOM.detailsStudentName.textContent = `${result.prenom} ${result.nom}`; DOM.detailsStatut.textContent = result.studentData.statut || 'Aucun';
                    DOM.detailsStatut.className = result.studentData.statut ? 'statut-chip' : '';
                    DOM.detailsMoyT1.textContent = result.studentData.moyT1 !== null && typeof result.studentData.moyT1 === 'number' ? result.studentData.moyT1.toFixed(1).replace('.', ',') : 'N/A';
                    DOM.detailsMoyT2.textContent = result.studentData.moyT2 !== null && typeof result.studentData.moyT2 === 'number' ? result.studentData.moyT2.toFixed(1).replace('.', ',') : 'N/A';
                    DOM.detailsMoyT3.textContent = result.studentData.moyT3 !== null && typeof result.studentData.moyT3 === 'number' ? result.studentData.moyT3.toFixed(1).replace('.', ',') : 'N/A';
                    DOM.detailsAppT1.textContent = Utils.decodeHtmlEntities(result.studentData.appT1 || 'Non renseigné'); DOM.detailsAppT2.textContent = Utils.decodeHtmlEntities(result.studentData.appT2 || 'Non renseigné');
                    DOM.detailsGeneratedAppreciation.textContent = Utils.decodeHtmlEntities(Utils.cleanMarkdown(result.appreciation) || 'Non générée');
                    if (DOM.detailsTokenUsageSection && DOM.detailsPromptTokens && DOM.detailsCompletionTokens && DOM.detailsTotalTokens) {
                        if (result.tokenUsage && result.studentData.generationMode === 'AI') {
                            DOM.detailsPromptTokens.textContent = result.tokenUsage.prompt_tokens || 'N/A'; DOM.detailsCompletionTokens.textContent = result.tokenUsage.completion_tokens || 'N/A';
                            DOM.detailsTotalTokens.textContent = result.tokenUsage.total_tokens || 'N/A'; DOM.detailsTokenUsageSection.style.display = 'block';
                        } else { DOM.detailsTokenUsageSection.style.display = 'none'; }
                    }
                    const isAIMode = result.studentData.generationMode === 'AI';
                    DOM.strengthsWeaknessesSection.style.display = isAIMode ? 'block' : 'none';
                    DOM.nextStepsSection.style.display = isAIMode ? 'block' : 'none';
                    DOM.strengthsWeaknessesContent.innerHTML = result.strengthsWeaknesses ? AppreciationsManager.parseStrengthsWeaknesses(Utils.decodeHtmlEntities(result.strengthsWeaknesses)) : '<p style="color: var(--summary-details-color);">Cliquez sur "Générer l\'analyse".</p>';
                    DOM.nextStepsList.innerHTML = result.nextSteps?.length ? result.nextSteps.map(step => `<li>${Utils.decodeHtmlEntities(step)}</li>`).join('') : '<li style="color: var(--summary-details-color);">Cliquez sur "Générer les pistes".</li>';
                    DOM.editFromModalBtn.onclick = () => { UI.closeModal(DOM.studentDetailsModal); AppreciationsManager.editAppreciation(id); };
                    DOM.generateStrengthsWeaknessesBtn.onclick = () => AppreciationsManager.generateStrengthsWeaknesses(id);
                    DOM.generateNextStepsBtn.onclick = () => AppreciationsManager.generateNextSteps(id);
                    UI.openModal(DOM.studentDetailsModal);
                }
            },
            parseStrengthsWeaknesses(text) {
                if (!text) return '<p style="color: var(--summary-details-color);">Aucune analyse disponible.</p>';
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                let html = '', currentList = null;
                lines.forEach(line => {
                    if (line.match(/^Points Forts:/i) ) { if (currentList) html += '</ul>'; html += '<h4 class="strengths-title"><i class="fas fa-thumbs-up"></i> Points Forts :</h4><ul class="strengths-list">'; currentList = 'strengths'; }
                    else if (line.match(/^Points Faibles:/i)) { if (currentList) html += '</ul>'; html += '<h4 class="weaknesses-title"><i class="fas fa-thumbs-down"></i> Points Faibles :</h4><ul class="weaknesses-list">'; currentList = 'weaknesses'; }
                    else if (line.startsWith('- ') && currentList) html += `<li>${Utils.cleanMarkdown(line.substring(2))}</li>`;
                    else { if (currentList) html += '</ul>'; html += `<p>${Utils.cleanMarkdown(line)}</p>`; currentList = null; }
                });
                if (currentList) html += '</ul>'; return html || '<p style="color: var(--summary-details-color);">Aucune analyse disponible.</p>';
            },
            async generateStrengthsWeaknesses(id) {
                const result = appState.generatedResults.find(r => r.id === id); if (!result || !UI.checkAPIKeyPresence()) return;
                UI.showInlineSpinner(DOM.strengthsWeaknessesContent);
                try {
                    const fullNegativeInstructions = [appState.negativeInstructionsGlobal, result.studentData.negativeInstructions].filter(Boolean).join('. ').trim();
                    const negativeInstructionsPromptPart = fullNegativeInstructions ? ` Instructions négatives : "${fullNegativeInstructions}".` : '';
                    const prompt = `En tant que professeur de ${appState.currentSubject}, analyse les informations suivantes sur l'élève ${result.prenom} ${result.nom} :\nMoyennes : T1 : ${result.studentData.moyT1?.toFixed(1) || 'N/A'}, T2 : ${result.studentData.moyT2?.toFixed(1) || 'N/A'}, T3 : ${result.studentData.moyT3?.toFixed(1) || 'N/A'}\nAppréciation T1 : "${result.studentData.appT1 || 'Non renseigné'}"\nAppréciation T2 : "${result.studentData.appT2 || 'Non renseigné'}"\nAppréciation actuelle : "${result.appreciation || 'Non générée'}"\nStatut : "${result.studentData.statut || 'Aucun'}"\nSuggère 2 à 3 points forts et 2 à 3 points faibles. Formate : Points Forts :\n- Point 1\nPoints Faibles :\n- Point 1. Si info non pertinente, indique 'Non disponible'.${negativeInstructionsPromptPart}`;
                    const aiResponse = await AppreciationsManager.callAI(prompt);
                    result.strengthsWeaknesses = aiResponse.text; 
                    StorageManager.saveAppState(); UI.showNotification('Analyse générée.', 'success');
                } catch (error) { console.error("Erreur forces/faiblesses:", error); let msg = `Erreur : ${Utils.translateErrorMessage(error.message)}`; UI.showNotification(msg, 'error'); DOM.strengthsWeaknessesContent.innerHTML = `<p style="color: var(--error-color);">${msg}</p>`;
                } finally { 
                    UI.hideInlineSpinner(DOM.strengthsWeaknessesContent); 
                    if(result.strengthsWeaknesses) DOM.strengthsWeaknessesContent.innerHTML = AppreciationsManager.parseStrengthsWeaknesses(Utils.decodeHtmlEntities(result.strengthsWeaknesses));
                }
            },
            async generateNextSteps(id) {
                const result = appState.generatedResults.find(r => r.id === id); if (!result || !UI.checkAPIKeyPresence()) return;
                UI.showInlineSpinner(DOM.nextStepsList);
                try {
                    const fullNegativeInstructions = [appState.negativeInstructionsGlobal, result.studentData.negativeInstructions].filter(Boolean).join('. ').trim();
                    const negativeInstructionsPromptPart = fullNegativeInstructions ? ` Instructions négatives : "${fullNegativeInstructions}".` : '';
                    const prompt = `En tant que professeur de ${appState.currentSubject}, analyse l'appréciation de ${result.prenom} ${result.nom} ("${result.appreciation}") et ses moyennes (T1 : ${result.studentData.moyT1?.toFixed(1) || 'N/A'}, T2 : ${result.studentData.moyT2?.toFixed(1) || 'N/A'}, T3 : ${result.studentData.moyT3?.toFixed(1) || 'N/A'}) pour le ${result.studentData.quarterMode}. Suggère 3-5 pistes d'amélioration concrètes et actionnables en ${appState.currentSubject}. Retourne une liste numérotée.${negativeInstructionsPromptPart}`;
                    const aiResponse = await AppreciationsManager.callAI(prompt); const nextStepsRaw = aiResponse.text;
                    const nextSteps = nextStepsRaw.split('\n').map(line => line.trim()).filter(line => line.match(/^\d+\.\s*(.*)/)).map(line => line.replace(/^\d+\.\s*/, ''));
                    result.nextSteps = nextSteps;
                    StorageManager.saveAppState(); UI.showNotification('Pistes générées.', 'success');
                } catch (error) { console.error("Erreur pistes:", error); let msg = `Erreur : ${Utils.translateErrorMessage(error.message)}`; UI.showNotification(msg, 'error'); DOM.nextStepsList.innerHTML = `<li style="color: var(--error-color);">${msg}</li>`;
                } finally { 
                    UI.hideInlineSpinner(DOM.nextStepsList); 
                    if(result.nextSteps?.length) DOM.nextStepsList.innerHTML = result.nextSteps.map(step => `<li>${Utils.decodeHtmlEntities(step)}</li>`).join('');
                }
            },
            async refineAppreciation(id) {
                const result = appState.generatedResults.find(r => r.id === id); if (!result || !UI.checkAPIKeyPresence()) return;
                appState.currentRefiningAppreciationId = id; DOM.originalAppreciationText.textContent = Utils.decodeHtmlEntities(result.appreciation);
                DOM.suggestedAppreciationText.textContent = 'Sélectionnez une option.'; UI.openModal(DOM.refinementModal);
            },
            applyRefinedAppreciation() {
                const result = appState.generatedResults.find(r => r.id === appState.currentRefiningAppreciationId);
                if (result && DOM.suggestedAppreciationText.textContent !== 'Génération en cours...' && DOM.suggestedAppreciationText.textContent !== 'Sélectionnez une option.') {
                    result.appreciation = DOM.suggestedAppreciationText.textContent;
                    AppreciationsManager.renderResults(); UI.closeModal(DOM.refinementModal); UI.showNotification('Appréciation mise à jour !', 'success');
                } else { UI.showNotification('Aucune suggestion à appliquer ou génération en cours.', 'warning'); }
            },
            async generateRefinedAppreciation(refineType) {
                const result = appState.generatedResults.find(r => r.id === appState.currentRefiningAppreciationId); if (!result || !UI.checkAPIKeyPresence()) return;
                DOM.suggestedAppreciationText.textContent = 'Génération en cours...'; UI.showLoadingOverlay('Amélioration en cours...');
                let prompt = '';
                const fullNegativeInstructions = [appState.negativeInstructionsGlobal, result.studentData.negativeInstructions].filter(Boolean).join('. ').trim();
                const negativeInstructionsPromptPart = fullNegativeInstructions ? ` Instructions négatives : "${fullNegativeInstructions}".` : '';
                switch (refineType) {
                    case 'concise': prompt = `Reformule de manière concise (max 30 mots) : "${result.appreciation}"`; break;
                    case 'detailed': prompt = `Développe en détail : "${result.appreciation}"`; break;
                    case 'encouraging': prompt = `Reformule de manière plus encourageante : "${result.appreciation}"`; break;
                    case 'formal': prompt = `Reformule de manière plus formelle : "${result.appreciation}"`; break;
                    default: UI.showNotification('Type d\'amélioration non reconnu.', 'error'); UI.hideLoadingOverlay(); return;
                }
                try {
                    const aiResponse = await AppreciationsManager.callAI(prompt + " Retourne UNIQUEMENT le texte de l'appréciation reformulée, sans aucun commentaire, sans guillemets et sans mention du nombre de mots." + negativeInstructionsPromptPart);
                    let refinedText = aiResponse.text.trim();
                    if ((refinedText.startsWith('"') && refinedText.endsWith('"')) || (refinedText.startsWith("'") && refinedText.endsWith("'"))) {
                        refinedText = refinedText.substring(1, refinedText.length - 1);
                    }
                    refinedText = refinedText.replace(/\s*\([^)]*\)$/, '').trim();
                    DOM.suggestedAppreciationText.textContent = Utils.decodeHtmlEntities(refinedText); 
                    UI.showNotification('Suggestion générée !', 'success');
                } catch (error) { console.error("Erreur amélioration:", error); let msg = `Erreur : ${Utils.translateErrorMessage(error.message)}`; UI.showNotification(msg, 'error'); DOM.suggestedAppreciationText.textContent = `Erreur : ${msg}`;
                } finally { UI.hideLoadingOverlay(); }
            },
            renderResults() {
                if (document.activeElement.classList.contains('editable')) { return; }

                const searchTerm = DOM.searchInput.value.toLowerCase();
                const sortOrder = DOM.sortSelect.value;
                const filteredAndSortedResults = appState.generatedResults
                    .filter(result => {
                        const nom = result.nom || '';
                        const prenom = result.prenom || '';
                        const appreciation = result.appreciation || '';
                        return `${nom} ${prenom} ${Utils.decodeHtmlEntities(appreciation)}`.toLowerCase().includes(searchTerm);
                    })
                    .sort((a, b) => {
                        if (sortOrder === 'recent') return new Date(b.timestamp) - new Date(a.timestamp);
                        if (sortOrder === 'name') return `${a.nom} ${a.prenom}`.localeCompare(`${b.nom} ${b.prenom}`);
                        if (sortOrder === 'grade') {
                            const studentDataA = a.studentData || {};
                            const studentDataB = b.studentData || {};
                            const gradeA = studentDataA[`moy${studentDataA.quarterMode}`] ?? -1;
                            const gradeB = studentDataB[`moy${studentDataB.quarterMode}`] ?? -1;
                            return gradeB - gradeA;
                        }
                        if (sortOrder === 'progress') {
                            const getEvolutionRank = (res) => {
                                if (!res || !res.evolutions || !res.studentData) return 0;
                                const evo = res.evolutions.find(e => (res.studentData.quarterMode === 'T3' && (e.periode === 'T2-T3' || e.periode === 'T1-T3')) || (res.studentData.quarterMode === 'T2' && e.periode === 'T1-T2'));
                                if (!evo) return 0;
                                return {'very-positive': 5, 'positive': 4, 'stable': 3, 'negative': 2, 'very-negative': 1}[evo.type] || 0;
                            };
                            return getEvolutionRank(b) - getEvolutionRank(a);
                        }
                        return 0;
                    });
                
                // *** CORRECTION APPLIQUÉE ICI ***
                appState.filteredResults = filteredAndSortedResults;

                DOM.resultsDiv.innerHTML = ''; // Clear previous results
                if (appState.generatedResults.length === 0) {
                     DOM.noResultsMessage.textContent = 'Aucune appréciation à afficher. Commencez par en générer une !';
                     DOM.noResultsMessage.style.display = 'block';
                } else if (appState.filteredResults.length === 0) {
                    DOM.noResultsMessage.textContent = 'Aucun résultat ne correspond à votre recherche.';
                    DOM.noResultsMessage.style.display = 'block';
                } else {
                    DOM.noResultsMessage.style.display = 'none';
                    const fragment = document.createDocumentFragment();
                    appState.filteredResults.forEach(result => {
                         const resultElement = document.createElement('div');
                        resultElement.className = 'appreciation-result';
                        resultElement.dataset.id = result.id;
                        resultElement.innerHTML = AppreciationsManager.createResultHtml(result);
                        fragment.appendChild(resultElement);
                    });
                    DOM.resultsDiv.appendChild(fragment);
                }

                UI.updateStats();
                StorageManager.saveAppState();
            },

            createResultHtml(result) {
                const studentData = result.studentData || {};
                const moyT1Disp = studentData.moyT1 !== null && typeof studentData.moyT1 === 'number' ? `T1 : ${studentData.moyT1.toFixed(1).replace('.', ',')}` : '';
                const moyT2Disp = studentData.moyT2 !== null && typeof studentData.moyT2 === 'number' ? `T2 : ${studentData.moyT2.toFixed(1).replace('.', ',')}` : '';
                const moyT3Disp = studentData.moyT3 !== null && typeof studentData.moyT3 === 'number' ? `T3 : ${studentData.moyT3.toFixed(1).replace('.', ',')}` : '';
                let allMoyDisp = [moyT1Disp, moyT2Disp, moyT3Disp].filter(Boolean).join(' | ');
                if (allMoyDisp) allMoyDisp = `<span class="student-grades-display">(${allMoyDisp})</span>`;
                let evoIndicatorHtml = '';
                if (studentData.quarterMode !== 'T1' && result.evolutions && result.evolutions.length > 0) {
                    const evoToShow = result.evolutions.find(e => (studentData.quarterMode === 'T3' && (e.periode === 'T2-T3' || e.periode === 'T1-T3')) || (studentData.quarterMode === 'T2' && e.periode === 'T1-T2'));
                    if (evoToShow && typeof evoToShow.valeur === 'number') {
                        const icons = {'very-positive':'📈', 'positive':'↗️', 'stable':'➡️', 'negative':'↘️', 'very-negative':'📉'};
                        const labels = {'very-positive':'Très fort progrès', 'positive':'Progrès', 'stable':'Stable', 'negative':'Léger recul', 'very-negative':'Forte baisse'};
                        evoIndicatorHtml = `<span class="evolution-indicator evolution-${evoToShow.type}" data-tooltip="Évolution ${evoToShow.periode} : ${evoToShow.valeur > 0 ? '+' : ''}${evoToShow.valeur.toFixed(1).replace('.', ',')} pts">${icons[evoToShow.type] || ''} ${labels[evoToShow.type] || evoToShow.type}</span>`;
                    }
                }
                const errorHtml = result.errorMessage ? `<p style="color: var(--error-color); font-size: 0.85em; margin-top: 10px;">⚠️ ${result.errorMessage}</p>` : '';
                const aiIconHtml = studentData.generationMode === 'AI' ? '<span class="ai-icon active" style="display:inline-block; vertical-align: middle; margin-left: 5px;" title="Généré par IA">✨</span>' : '';
                const generationModeText = studentData.generationMode === 'AI' ? 'IA' : 'Automate';
                return `<div class="student-name"><span>${result.prenom || 'Prénom?'} ${result.nom || 'Nom?'} ${aiIconHtml}</span> ${allMoyDisp}<div style="display: flex; gap: 10px; align-items: center;">${evoIndicatorHtml}</div></div><div class="student-summary-details"><span class="detail-chip">Matière : ${studentData.subject || 'N/A'}</span><span class="detail-chip">Trimestre : ${studentData.quarterMode || 'N/A'}</span><span class="detail-chip">Mode : ${generationModeText}</span>${studentData.statut ? `<span class="statut-chip">Statut : ${studentData.statut}</span>` : ''}</div><p class="appreciation-text" contenteditable="false" data-id="${result.id}" tabindex="0">${Utils.decodeHtmlEntities(Utils.cleanMarkdown(result.appreciation || ''))}</p><div class="word-count">${Utils.countWords(result.appreciation || '')} mots</div>${errorHtml}<div class="appreciation-actions"><button class="btn btn-secondary btn-small copy-btn" data-id="${result.id}" data-action="copy" tabindex="0">📄 Copier</button>${studentData.generationMode === 'AI' ? `<button class="btn btn-secondary btn-small refine-btn" data-id="${result.id}" data-action="refine" tabindex="0">✨ Améliorer</button>` : ''}<button class="btn btn-secondary btn-small details-btn" data-id="${result.id}" data-action="details" tabindex="0">👁️ Détails</button><button class="btn btn-secondary btn-small edit-live-btn" data-id="${result.id}" data-action="edit-live" tabindex="0">✏️ Édition</button><button class="btn btn-danger btn-small delete-btn" data-id="${result.id}" data-action="delete" tabindex="0">🗑️ Supprimer</button></div>`;
            },
            exportToJson() { const dataStr = JSON.stringify(appState.generatedResults, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `appreciations_export_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); UI.showNotification('Données exportées en JSON.', 'success'); },
            exportToCsv() {
                if (appState.generatedResults.length === 0) { UI.showNotification('Aucune donnée à exporter.', 'warning'); return; }
                const headers = ["Nom", "Prénom", "Statut", "Moy T1", "App T1", "Moy T2", "App T2", "Moy T3", "App Générée", "Trimestre", "Matière", "Mode Génération", "Instructions Négatives Individuelles", "Evo T1-T2 (val)", "Evo T1-T2 (type)", "Evo T2-T3 (val)", "Evo T2-T3 (type)", "Evo T1-T3 (val)", "Evo T1-T3 (type)", "Forces/Faiblesses", "Pistes Amélioration", "Tokens Prompt", "Tokens Complétion", "Tokens Totaux", "Date Génération", "Erreur"];
                const cleanCsv = (text) => { if (text === null || text === undefined) return ''; let cleaned = String(text).replace(/"/g, '""'); cleaned = Utils.decodeHtmlEntities(cleaned); return (cleaned.includes(',') || cleaned.includes('\n') || cleaned.includes('\r') || cleaned.includes(';')) ? `"${cleaned}"` : cleaned; };
                const rows = appState.generatedResults.map(r => { const getEvo = (p) => { const e = r.evolutions.find(ev => ev.periode === p); return { v: e && typeof e.valeur === 'number' ? e.valeur.toFixed(1).replace('.', ',') : '', t: e ? e.type : '' }; }; const e12=getEvo('T1-T2'), e23=getEvo('T2-T3'), e13=getEvo('T1-T3'); return [r.nom, r.prenom, r.studentData.statut, r.studentData.moyT1 !== null && typeof r.studentData.moyT1 === 'number' ? r.studentData.moyT1.toFixed(1).replace('.', ',') : '', r.studentData.appT1, r.studentData.moyT2 !== null && typeof r.studentData.moyT2 === 'number' ? r.studentData.moyT2.toFixed(1).replace('.', ',') : '', r.studentData.appT2, r.studentData.moyT3 !== null && typeof r.studentData.moyT3 === 'number' ? r.studentData.moyT3.toFixed(1).replace('.', ',') : '', r.appreciation, r.studentData.quarterMode, r.studentData.subject, r.studentData.generationMode, r.studentData.negativeInstructions || '', e12.v, e12.t, e23.v, e23.t, e13.v, e13.t, r.strengthsWeaknesses, r.nextSteps?.join('; ') || '', r.tokenUsage?.prompt_tokens || '', r.tokenUsage?.completion_tokens || '', r.tokenUsage?.total_tokens || '', new Date(r.timestamp).toLocaleString(), r.errorMessage].map(cleanCsv).join(';'); });
                const csvContent = "\uFEFF" + headers.join(';') + '\n' + rows.join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `appreciations_export_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                UI.showNotification('Données exportées en CSV.', 'success');
            },
            clearAllResults() { UI.showCustomConfirm('Effacer TOUTES les appréciations ? Action irréversible.', () => { appState.generatedResults = []; appState.filteredResults = []; AppreciationsManager.renderResults(); StorageManager.saveAppState(); UI.showNotification('Toutes les appréciations effacées.', 'success'); }); },
            loadSampleData() { const sampleData = `MARTIN Lucas | | 12,5 | Bon travail en début d'année, des bases solides. | 13,8 | Progression notable, continue ses efforts. | 14,2 | Ne pas utiliser de superlatifs\nDURAND Sophie | Nouveau T2 | | | 9,1 | Doit s'investir davantage. | 10,5 | Être très concis\nLEFEVRE Thomas | | 15,0 | Très bonne participation. | 14,5 | Léger recul, à surveiller. | 13,9\nPETIT Camille | | 8,2 | Des difficultés persistantes. | 7,0 | Nécessite un accompagnement. | 6,5\nROUSSEAU Emma | | 17,1 | Excellents résultats et autonomie. | 18,0 | Très forte progression. | 19,1`.trim(); if (DOM.massData) DOM.massData.value = sampleData; UI.showNotification('Données d\'exemple chargées.', 'info'); }
        };

        // ====================================================================
        // 6. Initialisation de l'Application et Gestion des Événements
        // ====================================================================
        const App = {
            init() {
                StorageManager.loadAppState(); App.setupEventListeners(); App.updateUIOnLoad(); App.setupAutoSave(); App.setupPWA();
                if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = APP_VERSION; console.log(`Application initialisée (${APP_VERSION}).`);
            },
            setupEventListeners() {
                DOM.darkModeToggle?.addEventListener('click', UI.toggleDarkMode);
                DOM.settingsButton?.addEventListener('click', () => { UI.openModal(DOM.settingsModal); UI.updateSettingsPromptFields(); UI.updateSettingsFields(); UI.updateAIPromptDisplays(); UI.showSettingsTab('templates'); });
                DOM.helpButton?.addEventListener('click', () => { UI.openModal(DOM.helpModal); UI.updateAIPromptDisplays(); });
                DOM.quarterRadios.forEach(radio => radio.addEventListener('change', (e) => UI.setQuarterMode(e.target.value)));
                DOM.subjectSelect?.addEventListener('change', (e) => { appState.currentSubject = e.target.value; StorageManager.saveAppState(); UI.updateSettingsPromptFields(); AppreciationsManager.renderResults(); });
                DOM.generationModeRadios.forEach(radio => radio.addEventListener('change', (e) => { const newMode = e.target.value; if (newMode === 'AI') { if (!UI.checkAPIKeyPresence()) { UI.setGenerationMode('Template'); return; } } UI.setGenerationMode(newMode); }));
                DOM.massImportTab?.addEventListener('click', () => UI.setInputMode('mass'));
                DOM.singleStudentTab?.addEventListener('click', () => UI.setInputMode('single'));
                DOM.importGenerateBtn?.addEventListener('click', AppreciationsManager.processMassImport);
                DOM.clearImportBtn?.addEventListener('click', () => { if(DOM.massData) DOM.massData.value = ''; UI.showNotification('Zone d\'import vidée.', 'info'); });
                DOM.loadSampleDataBtn?.addEventListener('click', AppreciationsManager.loadSampleData);
                DOM.cancelImportBtn?.addEventListener('click', () => { appState.isMassImportCancelled = true; UI.showNotification('Annulation de l\'import en cours...', 'info'); });
                if (DOM.dropZone) { ['dragover', 'drop'].forEach(evtName => DOM.dropZone.addEventListener(evtName, e => e.preventDefault())); DOM.dropZone.addEventListener('dragover', () => DOM.dropZone.classList.add('highlight')); DOM.dropZone.addEventListener('dragleave', () => DOM.dropZone.classList.remove('highlight')); DOM.dropZone.addEventListener('drop', (e) => { DOM.dropZone.classList.remove('highlight'); if (e.dataTransfer.files.length > 0) App.handleFileImport(e.dataTransfer.files[0]); }); }
                DOM.importFileBtn?.addEventListener('click', () => DOM.fileInput?.click());
                DOM.fileInput?.addEventListener('change', (e) => { if (e.target.files.length > 0) App.handleFileImport(e.target.files[0]); });
                DOM.generateAppreciationBtn?.addEventListener('click', () => AppreciationsManager.generateSingleAppreciation(false));
                DOM.previewAppreciationBtn?.addEventListener('click', () => AppreciationsManager.generateSingleAppreciation(true));
                DOM.resetFormBtn?.addEventListener('click', AppreciationsManager.resetForm);
                const debouncedValidateInput = Utils.debounce(Utils.validateInput, CONFIG.DEBOUNCE_TIME_MS);
                const debouncedValidateGrade = Utils.debounce(Utils.validateGrade, CONFIG.DEBOUNCE_TIME_MS);
                [DOM.nomInput, DOM.prenomInput].forEach(input => input?.addEventListener('input', () => debouncedValidateInput(input)));
                [DOM.moyT1Input, DOM.moyT2Input, DOM.moyT3Input].forEach(input => input?.addEventListener('input', () => debouncedValidateGrade(input)));
                DOM.searchInput?.addEventListener('input', Utils.debounce(AppreciationsManager.renderResults, CONFIG.DEBOUNCE_TIME_MS));
                DOM.clearAllResultsBtn?.addEventListener('click', AppreciationsManager.clearAllResults);
                DOM.exportJsonBtn?.addEventListener('click', AppreciationsManager.exportToJson);
                DOM.exportCsvBtn?.addEventListener('click', AppreciationsManager.exportToCsv);
                DOM.sortSelect?.addEventListener('change', AppreciationsManager.renderResults);
                document.querySelectorAll('.stat-card').forEach(card => card.addEventListener('click', (e) => { if(e.currentTarget.dataset.statId) UI.showStatDetails(e.currentTarget.dataset.statId); }));
                document.querySelectorAll('.stat-card').forEach(card => card.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.currentTarget.dataset.statId) { UI.showStatDetails(e.currentTarget.dataset.statId); } }));
                DOM.resultsDiv?.addEventListener('click', (e) => { const button = e.target.closest('button[data-action]'); if (!button) return; const id = button.dataset.id; const action = button.dataset.action; switch (action) { case 'copy': const result = appState.generatedResults.find(r => r.id === id); if (result) result.copied = true; AppreciationsManager.copyAppreciation(id, button); break; case 'delete': AppreciationsManager.deleteAppreciation(id); break; case 'details': AppreciationsManager.showAppreciationDetails(id); break; case 'refine': AppreciationsManager.refineAppreciation(id); break; case 'edit-live': App.toggleLiveEdit(id, button); break; } });
                document.body.addEventListener('click', (e) => { const activeEditor = document.querySelector('.appreciation-text.editable'); if (activeEditor && !activeEditor.closest('.appreciation-result').contains(e.target)) { App.cancelLiveEdit(activeEditor); } });
                DOM.resultsDiv?.addEventListener('keydown', (e) => { const editableText = e.target.closest('.appreciation-text.editable'); if (editableText && e.key === 'Escape') { e.preventDefault(); App.cancelLiveEdit(editableText); } });
                DOM.closeSettingsModalBtn?.addEventListener('click', () => UI.closeModal(DOM.settingsModal));
                DOM.resetSettingsBtn?.addEventListener('click', () => UI.showCustomConfirm('Réinitialiser TOUS les paramètres ?', () => { StorageManager.resetAllSettings(); UI.showNotification('Paramètres réinitialisés.', 'success'); }));
                DOM.saveSettingsBtn?.addEventListener('click', App.saveSettings);
                DOM.cancelSettingsBtn?.addEventListener('click', () => { StorageManager.loadAppState(); UI.updateSettingsPromptFields(); UI.updateSettingsFields(); UI.closeModal(DOM.settingsModal); });
                DOM.settingsTabs.forEach(tab => tab.addEventListener('click', (e) => UI.showSettingsTab(e.target.dataset.tab)));
                [DOM.settingsPromptT1, DOM.settingsPromptT2, DOM.settingsPromptT3].forEach(el => el?.addEventListener('input', UI.updateTemplatePreview));
                DOM.aiModelSelect?.addEventListener('change', () => { appState.currentAIModel = DOM.aiModelSelect.value; UI.toggleAIKeyFields(); UI.checkAPIKeyPresence(); UI.updateHeaderAiIcon(); });
                DOM.addCompetenceBtn?.addEventListener('click', () => App.addVocabItem('competences', DOM.addCompetenceInput));
                DOM.addQualiteBtn?.addEventListener('click', () => App.addVocabItem('qualites', DOM.addQualiteInput));
                DOM.addActiviteBtn?.addEventListener('click', () => App.addVocabItem('activites', DOM.addActiviteInput));
                DOM.addBrickBtn?.addEventListener('click', () => App.addPhraseBrick(DOM.addBrickNameInput, DOM.addBrickTextInput));
                DOM.vocabCompetencesList?.addEventListener('click', App.handleVocabListAction); DOM.vocabQualitesList?.addEventListener('click', App.handleVocabListAction); DOM.vocabActivitesList?.addEventListener('click', App.handleVocabListAction); DOM.phraseBricksList?.addEventListener('click', App.handleVocabListAction);
                DOM.vocabCompetencesList?.addEventListener('focusout', App.saveVocabItemEdit); DOM.vocabQualitesList?.addEventListener('focusout', App.saveVocabItemEdit); DOM.vocabActivitesList?.addEventListener('focusout', App.saveVocabItemEdit); DOM.phraseBricksList?.addEventListener('focusout', App.saveVocabItemEdit);
                DOM.vocabCompetencesList?.addEventListener('keydown', App.handleVocabItemKeydown); DOM.vocabQualitesList?.addEventListener('keydown', App.handleVocabItemKeydown); DOM.vocabActivitesList?.addEventListener('keydown', App.handleVocabItemKeydown); DOM.phraseBricksList?.addEventListener('keydown', App.handleVocabItemKeydown);
                DOM.closeStudentDetailsModalBtn?.addEventListener('click', () => UI.closeModal(DOM.studentDetailsModal));
                DOM.closeDetailsModalBtn?.addEventListener('click', () => UI.closeModal(DOM.studentDetailsModal));
                DOM.closeRefinementModalBtn?.addEventListener('click', () => UI.closeModal(DOM.refinementModal));
                DOM.cancelRefinementBtn?.addEventListener('click', () => UI.closeModal(DOM.refinementModal));
                DOM.applyRefinedAppreciationBtn?.addEventListener('click', AppreciationsManager.applyRefinedAppreciation);
                DOM.refinementOptions?.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.refineType) AppreciationsManager.generateRefinedAppreciation(e.target.dataset.refineType); });
                DOM.refinementOptions?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.target.tagName === 'BUTTON' && e.target.dataset.refineType) { AppreciationsManager.generateRefinedAppreciation(e.target.dataset.refineType); } });
                DOM.closeHelpModalBtn?.addEventListener('click', () => UI.closeModal(DOM.helpModal));
                DOM.copyPromptButtons.forEach(button => button.addEventListener('click', (e) => UI.copyTextToClipboard(e.target.dataset.target)));
                DOM.copyPromptButtons.forEach(button => button.addEventListener('keydown', (e) => { if (e.key === 'Enter') UI.copyTextToClipboard(e.target.dataset.target); }));
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { UI.closeAllModals(); const activeEditing = document.querySelector('.appreciation-text.editable'); if(activeEditing) App.cancelLiveEdit(activeEditing); } if (e.ctrlKey && e.key.toLowerCase() === 'n') { e.preventDefault(); AppreciationsManager.resetForm(); UI.setInputMode('single'); DOM.nomInput?.focus(); } if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); const activeEditing = document.querySelector('.appreciation-text.editable'); if (activeEditing) { App.saveLiveEdit(activeEditing); } else if (appState.currentInputMode === 'single') { DOM.generateAppreciationBtn?.click(); } else { DOM.importGenerateBtn?.click(); } } if (e.ctrlKey && e.key.toLowerCase() === 'f') { e.preventDefault(); DOM.searchInput?.focus(); } });
            },
            updateUIOnLoad() {
                UI.updateDarkModeButtonIcon();
                UI.setQuarterMode(appState.currentQuarterMode || 'T1');
                const initialQuarterRadio = document.getElementById(`quarter${appState.currentQuarterMode || 'T1'}`); if (initialQuarterRadio) initialQuarterRadio.checked = true;
                UI.setInputMode(appState.currentInputMode || 'mass'); UI.setGenerationMode(appState.generationMode); AppreciationsManager.renderResults(); UI.updateHeaderAiIcon();
                if (DOM.appVersionDisplay) DOM.appVersionDisplay.textContent = APP_VERSION;
            },
            setupAutoSave() { setInterval(() => StorageManager.saveAppState(), CONFIG.AUTO_SAVE_INTERVAL_MS); },
            handleFileImport(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        if (file.name.endsWith('.json')) { const importedData = JSON.parse(content); if (Array.isArray(importedData)) { appState.generatedResults = [...importedData.filter(item => item && item.nom && item.prenom), ...appState.generatedResults]; AppreciationsManager.renderResults(); UI.showNotification('Données JSON importées !', 'success'); } else throw new Error('Format JSON invalide.');
                        } else if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) { if (DOM.massData) DOM.massData.value = content; UI.showNotification('Fichier copié dans la zone de saisie.', 'success'); }
                        else UI.showNotification('Format de fichier non supporté (.json, .csv, .txt).', 'error');
                    } catch (error) { console.error('Erreur importation:', error); UI.showNotification(`Erreur importation : ${error.message}`, 'error'); }
                };
                reader.onerror = () => UI.showNotification('Impossible de lire le fichier.', 'error'); reader.readAsText(file);
            },
            saveSettings() {
                if (DOM.settingsPromptT1 && DOM.settingsPromptT2 && DOM.settingsPromptT3) { appState.promptTemplates[appState.currentSubject] = { T1: DOM.settingsPromptT1.value.trim(), T2: DOM.settingsPromptT2.value.trim(), T3: DOM.settingsPromptT3.value.trim() }; }
                const newPositive = parseFloat(DOM.settingsEvolutionThresholdPositive.value); const newVeryPositive = parseFloat(DOM.settingsEvolutionThresholdVeryPositive.value);
                const newNegative = parseFloat(DOM.settingsEvolutionThresholdNegative.value); const newVeryNegative = parseFloat(DOM.settingsEvolutionThresholdVeryNegative.value);
                if (isNaN(newPositive) || newPositive < 0 || isNaN(newVeryPositive) || newVeryPositive < 0 || isNaN(newNegative) || newNegative > 0 || isNaN(newVeryNegative) || newVeryNegative > 0) { UI.showNotification('Seuils d\'évolution invalides.', 'error'); return; }
                if (newPositive >= newVeryPositive) { UI.showNotification('Seuil "très forte progression" > "progression notable".', 'error'); return; }
                if (newNegative <= newVeryNegative) { UI.showNotification('Seuil "forte baisse" < "léger recul".', 'error'); return; }
                appState.evolutionThresholds = { positive: newPositive, veryPositive: newVeryPositive, negative: newNegative, veryNegative: newVeryNegative };
                const newWordCount = parseInt(DOM.wordCountLimitInput.value);
                if (isNaN(newWordCount) || newWordCount < 10) { UI.showNotification('Limite de mots invalide (min 10).', 'error'); return; }
                appState.wordCountLimit = newWordCount; appState.negativeInstructionsGlobal = DOM.negativeInstructionsGlobal.value.trim();
                appState.currentAIModel = DOM.aiModelSelect.value; appState.openaiApiKey = DOM.openaiApiKey.value.trim(); appState.geminiApiKey = DOM.geminiApiKey.value.trim();
                appState.mistralApiKey = DOM.mistralApiKey.value.trim(); appState.qwenApiKey = DOM.qwenApiKey.value.trim(); appState.deepseekApiKey = DOM.deepseekApiKey.value.trim();
                StorageManager.saveAppState(); UI.updateAIPromptDisplays(); UI.updateHeaderAiIcon();
                if (appState.generationMode === 'AI' && !UI.checkAPIKeyPresence(true)) { UI.showNotification(`Clé API pour ${appState.currentAIModel} est manquante. Le mode Automate pourrait être utilisé.`, 'warning'); }
                else { UI.showNotification('Paramètres enregistrés !', 'success'); }
                UI.closeModal(DOM.settingsModal);
            },
            setupPWA() {
                let deferredPrompt; window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.add('show'); });
                DOM.pwaInstallBtn?.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; console.log(`PWA install prompt outcome: ${outcome}`); deferredPrompt = null; if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.remove('show'); } });
                DOM.pwaDismissBtn?.addEventListener('click', () => { if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.remove('show'); });
                window.addEventListener('appinstalled', () => { if (DOM.pwaInstallBanner) DOM.pwaInstallBanner.classList.remove('show'); UI.showNotification('Application installée !', 'success'); });
            },
            toggleLiveEdit(id, button) {
                const appreciationTextElement = document.querySelector(`.appreciation-text[data-id="${id}"]`); if (!appreciationTextElement) return;
                const isEditing = appreciationTextElement.contentEditable === 'true';
                if (isEditing) { App.saveLiveEdit(appreciationTextElement); }
                else { 
                    const allOtherEditButtons = document.querySelectorAll('.edit-live-btn.btn-primary');
                    allOtherEditButtons.forEach(btn => {
                        const otherEditable = document.querySelector(`.appreciation-text[data-id="${btn.dataset.id}"]`);
                        if(otherEditable) App.cancelLiveEdit(otherEditable);
                    });
                    
                    appreciationTextElement.dataset.originalText = appreciationTextElement.textContent;
                    appreciationTextElement.contentEditable = 'true'; appreciationTextElement.classList.add('editable'); appreciationTextElement.focus(); 
                    button.innerHTML = '💾 Enregistrer'; button.classList.remove('btn-secondary'); button.classList.add('btn-primary');
                }
            },
            saveLiveEdit(element) {
                const id = element.dataset.id; const updatedText = element.textContent.trim(); const result = appState.generatedResults.find(r => r.id === id);
                if (result) { result.appreciation = updatedText; StorageManager.saveAppState(); UI.showNotification('Appréciation mise à jour.', 'success'); }
                App.cancelLiveEdit(element, false); // Cancel without showing notification
                AppreciationsManager.renderResults();
            },
            cancelLiveEdit(element, showNotif = true) {
                if(element.dataset.originalText){
                    element.textContent = element.dataset.originalText;
                    if(showNotif) UI.showNotification('Édition annulée.', 'warning');
                }
                element.contentEditable = 'false';
                element.classList.remove('editable');
                delete element.dataset.originalText;
                const button = element.closest('.appreciation-result')?.querySelector('[data-action="edit-live"]');
                if (button) {
                    button.innerHTML = '✏️ Édition';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                }
            },
            addVocabItem(type, inputElement) {
                const item = inputElement.value.trim();
                if (item && !appState.vocabulaire[type].includes(item)) { appState.vocabulaire[type].push(item); inputElement.value = ''; UI.renderVocabLists(); StorageManager.saveAppState(); UI.showNotification(`${item} ajouté aux ${type}.`, 'success'); }
                else if (!item) { UI.showNotification('Veuillez entrer un élément.', 'warning'); }
                else { UI.showNotification('Cet élément existe déjà.', 'warning'); }
            },
            addPhraseBrick(nameInput, textInput) {
                const name = nameInput.value.trim(); const text = textInput.value.trim();
                if (name && text) {
                    if (appState.vocabulaire.phraseBricks[name]) {
                        UI.showCustomConfirm(`La brique "${name}" existe déjà. Voulez-vous la modifier ?`, () => {
                            appState.vocabulaire.phraseBricks[name] = text; nameInput.value = ''; textInput.value = ''; UI.renderVocabLists(); StorageManager.saveAppState(); UI.showNotification(`Brique "${name}" modifiée.`, 'success');
                        });
                    } else { appState.vocabulaire.phraseBricks[name] = text; nameInput.value = ''; textInput.value = ''; UI.renderVocabLists(); StorageManager.saveAppState(); UI.showNotification(`Brique "${name}" ajoutée.`, 'success'); }
                } else { UI.showNotification('Veuillez entrer un nom ET un texte pour la brique.', 'warning'); }
            },
            handleVocabListAction(e) {
                const button = e.target.closest('button[data-action]'); if (!button) return;
                const action = button.dataset.action; const type = button.dataset.type;
                if (action === 'delete') {
                    UI.showCustomConfirm('Supprimer cet élément ?', () => {
                        if (type === 'phraseBrick') { const keyToDelete = button.dataset.key; delete appState.vocabulaire.phraseBricks[keyToDelete]; UI.showNotification(`Brique "${keyToDelete}" supprimée.`, 'success'); }
                        else { const indexToDelete = parseInt(button.dataset.index); appState.vocabulaire[type].splice(indexToDelete, 1); UI.showNotification('Élément supprimé.', 'success'); }
                        UI.renderVocabLists(); StorageManager.saveAppState();
                    });
                }
            },
            saveVocabItemEdit(e) {
                const editableSpan = e.target.closest('.vocab-item-text'); if (!editableSpan) return;
                const type = editableSpan.dataset.type; const newValue = editableSpan.textContent.trim();
                if (type === 'phraseBrick') {
                    const oldKey = editableSpan.dataset.key; const newKeyMatch = newValue.match(/^(\S+):\s*(.*)/);
                    if (newKeyMatch) {
                        const newKey = newKeyMatch[1]; const newText = newKeyMatch[2].trim();
                        if (newKey !== oldKey) {
                            if (appState.vocabulaire.phraseBricks[newKey] && newKey !== oldKey) { UI.showNotification(`Une brique avec le nom "${newKey}" existe déjà.`, 'error'); editableSpan.innerHTML = `<b>${oldKey}</b>: ${appState.vocabulaire.phraseBricks[oldKey]}`; return; }
                            delete appState.vocabulaire.phraseBricks[oldKey]; appState.vocabulaire.phraseBricks[newKey] = newText;
                            editableSpan.dataset.key = newKey; editableSpan.innerHTML = `<b>${newKey}</b>: ${newText}`; UI.showNotification(`Brique "${oldKey}" renommée et modifiée en "${newKey}".`, 'success');
                        } else { appState.vocabulaire.phraseBricks[oldKey] = newText; editableSpan.innerHTML = `<b>${oldKey}</b>: ${newText}`; UI.showNotification(`Brique "${oldKey}" modifiée.`, 'success'); }
                    } else { UI.showNotification('Format de brique invalide. Utilisez "Nom: Texte".', 'error'); editableSpan.innerHTML = `<b>${oldKey}</b>: ${appState.vocabulaire.phraseBricks[oldKey]}`; return; }
                } else {
                    const index = parseInt(editableSpan.dataset.index);
                    if (newValue && (!appState.vocabulaire[type].includes(newValue) || appState.vocabulaire[type][index] === newValue) ) { appState.vocabulaire[type][index] = newValue; UI.showNotification('Élément modifié.', 'success'); }
                    else if (!newValue) { UI.showNotification('Un élément ne peut pas être vide. Supprimez-le si vous ne le voulez plus.', 'warning'); editableSpan.textContent = appState.vocabulaire[type][index]; }
                    else { UI.showNotification('Cet élément existe déjà. Revert.', 'warning'); editableSpan.textContent = appState.vocabulaire[type][index]; }
                }
                StorageManager.saveAppState();
            },
            handleVocabItemKeydown(e) { const editableSpan = e.target.closest('.vocab-item-text'); if (editableSpan && e.key === 'Enter') { e.preventDefault(); editableSpan.blur(); } },
        };

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>